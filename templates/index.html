<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tour Chat Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  
  <!-- Cache busting -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Version indicator: v2.5px-margins -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700|Roboto:400,500,700|Open+Sans:400,600&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS and JS for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- QR Code Generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <style>
    /* ===================================================================
       GLOBAL RESPONSIVE FOUNDATIONS
       =================================================================== */
    
    *, *::before, *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    html {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      font-size: 16px; /* Base for rem calculations */
      overflow-x: hidden; /* Prevent horizontal scroll */
    }
    
    html::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    body {
      font-family: 'Inter', 'Roboto', 'Open Sans', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #005fa3 0%, #0cb4e7 40%, #0edfcc 100%);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      width: 100%;
      max-width: 100vw;
    }
    
    /* Responsive media defaults */
    img, video, iframe, embed, object {
      max-width: 100%;
      height: auto;
    }
    
    /* Prevent text overflow */
    p, h1, h2, h3, h4, h5, h6, span, div {
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    
    body::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    #main-layout {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
    }
    
    /* Top filter panel for touchscreen */
    #filter-panel {
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      color: white;
      padding: 40px 40px 50px 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: relative;
    }
    
    #filter-panel h1 {
      font-size: 3.5em;
      margin: 0 0 20px 0;
      font-weight: 700;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .filter-progress {
      font-size: 1.3em;
      color: rgba(255,255,255,0.9);
      margin-bottom: 30px;
      text-align: center;
      font-weight: 500;
    }
    
    /* Progress bar */
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: #fff;
      transition: width 0.4s ease;
      border-radius: 10px;
    }
    
    .filter-question {
      display: none;
      animation: fadeIn 0.4s ease;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .filter-question.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .question-text {
      font-size: 2.2em;
      font-weight: 700;
      color: white;
      margin-bottom: 30px;
      text-align: center;
      line-height: 1.3;
    }
    
    .filter-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .filter-option {
      padding: 30px 35px;
      border: 3px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      font-size: 1.5em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      user-select: none;
      color: white;
      border-radius: 12px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      line-height: 1.4;
    }
    
    .filter-option:active {
      transform: scale(0.97);
      background: rgba(255,255,255,0.25);
    }
    
    .filter-option-centered {
      grid-column: 2;
    }
    
    .filter-option-right {
      grid-column: 3;
    }
    
    /* Special layout for bottom row centered group */
    .filter-options.center-bottom-row {
      grid-template-columns: repeat(6, 1fr);
    }
    
    .filter-options.center-bottom-row .filter-option:nth-child(1),
    .filter-options.center-bottom-row .filter-option:nth-child(2),
    .filter-options.center-bottom-row .filter-option:nth-child(3) {
      grid-column: span 2;
    }
    
    .filter-options.center-bottom-row .filter-option:nth-child(4) {
      grid-column: 2 / span 2;
    }
    
    .filter-options.center-bottom-row .filter-option:nth-child(5) {
      grid-column: 4 / span 2;
    }
    
    .filter-option.selected {
      background: white;
      color: #0077b6;
      border-color: white;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    /* Budget Slider Styles */
    .budget-slider-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 30px;
    }
    
    .budget-label-display {
      font-size: 2em;
      font-weight: 700;
      color: white;
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .budget-slider {
      width: 100%;
      height: 20px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      outline: none;
      margin: 30px 0;
      cursor: pointer;
    }
    
    /* Slider Track */
    .budget-slider::-webkit-slider-runnable-track {
      width: 100%;
      height: 20px;
      background: linear-gradient(to right, 
        #4ade80 0%, 
        #4ade80 25%, 
        #fbbf24 25%, 
        #fbbf24 50%, 
        #fb923c 50%, 
        #fb923c 75%, 
        #ef4444 75%, 
        #ef4444 100%);
      border-radius: 10px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .budget-slider::-moz-range-track {
      width: 100%;
      height: 20px;
      background: linear-gradient(to right, 
        #4ade80 0%, 
        #4ade80 25%, 
        #fbbf24 25%, 
        #fbbf24 50%, 
        #fb923c 50%, 
        #fb923c 75%, 
        #ef4444 75%, 
        #ef4444 100%);
      border-radius: 10px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Slider Thumb */
    .budget-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 60px;
      height: 60px;
      background: white;
      border: 5px solid #0077b6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
      margin-top: -20px;
    }
    
    .budget-slider::-moz-range-thumb {
      width: 60px;
      height: 60px;
      background: white;
      border: 5px solid #0077b6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    
    .budget-slider:active::-webkit-slider-thumb {
      transform: scale(1.15);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    .budget-slider:active::-moz-range-thumb {
      transform: scale(1.15);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    .budget-markers {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding: 0 5px;
    }
    
    .budget-marker {
      font-size: 1.3em;
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      text-align: center;
      flex: 1;
    }
    
    .budget-action-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 40px;
    }
    
    .confirm-budget-btn {
      width: 100%;
      padding: 25px;
      background: white;
      color: #0077b6;
      border: none;
      font-size: 1.6em;
      font-weight: 700;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255,255,255,0.3);
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { 
        opacity: 0; 
        transform: translateY(-10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    .confirm-budget-btn:active {
      background: #e0eafc;
      transform: scale(0.98);
    }
    
    .skip-budget-btn {
      width: 100%;
      padding: 20px;
      background: rgba(255,255,255,0.15);
      color: white;
      border: 3px solid rgba(255,255,255,0.4);
      font-size: 1.4em;
      font-weight: 600;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .skip-budget-btn:active {
      background: rgba(255,255,255,0.25);
      transform: scale(0.98);
    }
    
    .filter-summary {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 25px 30px;
      margin-bottom: 30px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .filter-summary-title {
      font-size: 1.4em;
      font-weight: 700;
      color: white;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .filter-summary-content {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    
    .filter-summary-item {
      font-size: 1.1em;
      color: white;
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
    }
    
    /* Navigation buttons for filtered views */
    .nav-buttons {
      display: none;
      position: absolute;
      top: 30px;
      left: 30px;
      gap: 15px;
      z-index: 5;
    }
    
    .nav-buttons.active {
      display: flex;
    }
    
    .nav-btn {
      padding: 18px 35px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.4);
      font-size: 1.3em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }
    
    .nav-btn:active {
      background: rgba(255,255,255,0.35);
      transform: scale(0.97);
    }
    
    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    /* ===================================================================
       PAGE VISIBILITY SYSTEM
       =================================================================== */
    
    /* Hide all pages by default */
    .page {
      display: none !important;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 100vh;
    }
    
    /* Show only the active page */
    .page.active {
      display: block !important;
      position: relative;
    }
    
    /* ===================================================================
       VIDEO QUESTION PAGE - NEW PRIMARY FLOW
       =================================================================== */
    
    .page.video-question-page.active {
      display: flex !important; /* Override the block from .page.active */
      position: relative;
      width: 100%;
      height: 100vh;
      overflow-y: hidden !important; /* Prevent body scrolling */
      overflow-x: hidden !important; /* Prevent horizontal scrolling */
      align-items: flex-start; /* Align to top for scrollable content */
      justify-content: center;
      z-index: 10; /* Above video background */
      background: transparent !important; /* Let video show through */
    }
    
    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1; /* Behind all pages */
      object-fit: cover;
      filter: blur(8px);
      display: none; /* Hidden by default */
      pointer-events: none; /* Don't block clicks */
    }
    
    /* Show video when body has video-bg-active class */
    body.video-bg-active #bg-video {
      display: block !important;
      z-index: 1 !important; /* Bring above body but below home page */
    }
    
    /* Prevent scrolling when video page is active */
    body.video-bg-active {
      overflow: hidden !important;
      height: 100vh !important;
    }
    
    /* Hide ALL non-active pages and widgets when video question page is active */
    body.video-bg-active .page:not(.video-question-page),
    body.video-bg-active .home-page,
    body.video-bg-active .tour-list-page,
    body.video-bg-active .tour-detail-page {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Force modals and forms to stay hidden when video page is active */
    body.video-bg-active #booking-modal,
    body.video-bg-active .modal,
    body.video-bg-active #qr-modal,
    body.video-bg-active .top-button-bar {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Keep widgets visible and functional on video page */
    body.video-bg-active .weather-widget,
    body.video-bg-active #weather-widget {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      z-index: 999999 !important;
    }
    
    body.video-bg-active .chat-button,
    body.video-bg-active #chat-button {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      z-index: 999999 !important;
    }
    
    body.video-bg-active .chat-interface,
    body.video-bg-active #chat-interface {
      z-index: 999999 !important;
    }
    
    .video-question-container {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 1200px;
      padding: 40px;
      padding-top: 140px; /* Space for progress bar */
      padding-bottom: 120px; /* Space for continue button */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-y: auto; /* Allow scrolling */
      min-height: calc(100vh - 60px);
    }
    
    .video-question-card {
      background: transparent;
      backdrop-filter: none;
      border-radius: 0;
      padding: 40px 60px;
      box-shadow: none;
      text-align: center;
      animation: slideUpFadeIn 0.8s ease-out;
      transform-origin: center center;
      transition: all 0.5s ease-out;
      margin-top: 20px; /* Push down below progress bar */
    }
    
    .video-question-card.exit-animation {
      transform: scale(0.8);
      opacity: 0;
    }
    
    /* Language Selection Screen - First screen users see */
    .language-selection-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 50px;
      gap: 30px;
      z-index: 25;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      transition: opacity 0.5s ease, visibility 0.5s ease;
      overflow-y: auto;
    }
    
    .language-selection-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .language-selection-title {
      font-size: 3.2em;
      font-weight: 700;
      color: white;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.9);
      text-align: center;
      padding: 0 30px;
      line-height: 1.3;
    }
    
    .language-selection-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 90%;
      max-width: 500px;
      padding-bottom: 50px;
    }
    
    .language-select-btn {
      padding: 30px 50px;
      font-size: 2em;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, rgba(0, 119, 182, 0.85) 0%, rgba(0, 150, 215, 0.9) 50%, rgba(3, 169, 244, 0.85) 100%);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.6);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 30px rgba(0, 119, 182, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .language-select-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }
    
    .language-select-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 40px rgba(0, 119, 182, 0.6), 0 6px 20px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.9);
    }
    
    .language-select-btn:hover::before {
      left: 100%;
    }
    
    .language-select-btn:active {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 25px rgba(0, 119, 182, 0.5), 0 3px 12px rgba(0, 0, 0, 0.3);
    }
    
    .language-select-btn .flag {
      font-size: 1.3em;
    }
    
    .video-start-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none; /* Hidden by default, shown after language selection */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 40px;
      z-index: 20;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
    }
    
    .video-start-text {
      font-size: 2.5em;
      font-weight: 700;
      color: white;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
      padding: 20px 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 90%;
      line-height: 1.3;
    }
    
    /* Quick Decision Button (Green) */
    .quick-decision-btn-start {
      padding: 25px 60px;
      font-size: 1.8em;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.8) 0%, rgba(56, 161, 105, 0.9) 50%, rgba(34, 139, 87, 0.85) 100%);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.6);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 30px rgba(72, 187, 120, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1000;
    }
    
    .quick-decision-btn-start:hover {
      background: linear-gradient(135deg, rgba(92, 207, 140, 0.9) 0%, rgba(76, 181, 125, 1) 50%, rgba(54, 159, 107, 0.95) 100%);
      border-color: rgba(255, 255, 255, 0.8);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 40px rgba(72, 187, 120, 0.6), 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .quick-decision-btn-start:active {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4), 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    
    /* Browse All Tours Button (Orange) */
    .browse-all-tours-btn {
      padding: 25px 60px;
      font-size: 1.8em;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.8) 0%, rgba(255, 100, 0, 0.9) 50%, rgba(255, 69, 0, 0.85) 100%);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.6);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 30px rgba(255, 100, 0, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1000;
    }
    
    .browse-all-tours-btn:hover {
      background: linear-gradient(135deg, rgba(255, 160, 0, 0.9) 0%, rgba(255, 120, 0, 1) 50%, rgba(255, 89, 0, 0.95) 100%);
      border-color: rgba(255, 255, 255, 0.8);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 40px rgba(255, 100, 0, 0.6), 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .browse-all-tours-btn:active {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 100, 0, 0.4), 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    
    /* AI Assistant Button (Dark Lavender) */
    .ai-assistant-btn {
      padding: 25px 60px;
      font-size: 1.8em;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, rgba(115, 103, 171, 0.8) 0%, rgba(106, 90, 161, 0.9) 50%, rgba(88, 72, 140, 0.85) 100%);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.6);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 30px rgba(106, 90, 161, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1000;
    }
    
    .ai-assistant-btn:hover {
      background: linear-gradient(135deg, rgba(130, 118, 186, 0.9) 0%, rgba(121, 105, 176, 1) 50%, rgba(103, 87, 155, 0.95) 100%);
      border-color: rgba(255, 255, 255, 0.8);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 40px rgba(106, 90, 161, 0.6), 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .ai-assistant-btn:active {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 6px 20px rgba(106, 90, 161, 0.4), 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    
    /* Quick Decision Button in Header (Orange, smaller) */
    .quick-decision-btn-header {
      padding: 12px 20px;
      font-size: 1em;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
      white-space: nowrap;
    }
    
    .quick-decision-btn-header:hover {
      background: linear-gradient(135deg, #ffa05c 0%, #ff7b45 100%);
      border-color: rgba(255, 255, 255, 0.6);
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5);
    }
    
    .quick-decision-btn-header:active {
      transform: translateY(0) scale(1);
      box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
    }
    
    /* Browse All Tours button during questions (top right) */
    .browse-all-tours-btn-questions {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.8) 0%, rgba(255, 100, 0, 0.9) 50%, rgba(255, 69, 0, 0.85) 100%);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 100, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    
    .browse-all-tours-btn-questions:hover {
      background: linear-gradient(135deg, rgba(255, 160, 0, 0.9) 0%, rgba(255, 120, 0, 1) 50%, rgba(255, 89, 0, 0.95) 100%);
      border-color: rgba(255, 255, 255, 0.8);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 35px rgba(255, 100, 0, 0.6), 0 5px 18px rgba(0, 0, 0, 0.4);
    }
    
    /* Progress Indicator */
    .vq-progress-container {
      position: fixed;
      top: 85px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      z-index: 1000;
    }
    
    .vq-progress-text {
      font-size: 1em;
      font-weight: 600;
      color: white;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 18px;
      border-radius: 30px;
      backdrop-filter: blur(10px);
    }
    
    .vq-progress-bar {
      width: 200px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .vq-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d084, #0cb4e7);
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    
    @keyframes slideUpFadeIn {
      0% {
        opacity: 0;
        transform: translateY(100px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Swipe animations for card transitions */
    @keyframes swipeOutLeft {
      0% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(-100%);
      }
    }
    
    @keyframes swipeInRight {
      0% {
        opacity: 0;
        transform: translateX(100%);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideDownFromTop {
      0% {
        opacity: 0;
        transform: translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUpFadeInSections {
      0% {
        opacity: 0;
        transform: translateY(50px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Animation classes to trigger transitions */
    .swipe-out-left {
      animation: swipeOutLeft 0.4s ease-out forwards;
    }
    
    .swipe-in-right {
      animation: swipeInRight 0.5s ease-out forwards;
    }
    
    .slide-down-top {
      animation: slideDownFromTop 0.5s ease-out forwards;
    }
    
    .slide-up-fade {
      animation: slideUpFadeInSections 0.6s ease-out forwards;
    }
    
    .vq-question {
      font-size: 2.2em;
      font-weight: 700;
      color: #ffffff;
      margin: 0 0 30px 0;
      line-height: 1.3;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.9), 0 2px 10px rgba(0, 0, 0, 0.9);
    }
    
    .vq-subtitle {
      font-size: 1.1em;
      color: #90e0ef;
      margin: -20px 0 30px 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.9);
    }
    
    .vq-back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.4);
      color: white;
      font-size: 1.1em;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 15;
    }
    
    .vq-back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-5px);
    }
    
    .vq-answers {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      min-height: auto; /* Remove fixed height to allow natural flow */
      padding-bottom: 60px; /* Reserve space for continue button */
    }
    
    .vq-answer-btn {
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      color: white;
      border: 3px solid transparent;
      border-radius: 25px;
      padding: 22px 40px;
      font-size: 1.4em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(0, 119, 182, 0.4);
      text-align: center;
      width: 100%;
    }
    
    .vq-answer-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 119, 182, 0.6);
      background: linear-gradient(135deg, #0088cc 0%, #0066aa 100%);
    }
    
    .vq-answer-btn:active {
      transform: translateY(-2px);
    }
    
    .vq-answer-btn.selected {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.9), 0 12px 35px rgba(72, 187, 120, 0.8);
      border: 5px solid #ffffff !important;
      transform: scale(1.08);
    }
    
    .vq-continue-btn {
      background: linear-gradient(135deg, #0cb4e7 0%, #0077b6 100%) !important;
      margin-top: 30px !important;
      font-size: 2.2em !important;
      animation: bounceIn 0.5s ease-out;
      border: 3px solid #ffffff !important;
      box-shadow: 0 0 20px rgba(12, 180, 231, 0.8) !important;
    }
    
    .vq-tour-counter {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #ff4444;
      font-size: 1.2em;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.9);
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 25px;
      border-radius: 20px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    /* ===================================================================
       SWIPE RESULTS OVERLAY - APPEARS ON TOP OF VIDEO PAGE
       =================================================================== */
    
    .swipe-results-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 10; /* Above video background */
      pointer-events: none;
      overflow-y: auto;
      overflow-x: hidden;
      padding-bottom: 100px; /* Space for buttons at bottom */
      padding-top: 70px; /* Space from top */
    }
    
    .swipe-fixed-top {
      flex-shrink: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 25px 15px 25px;
      overflow: visible;
    }
    
    .swipe-scrollable-content {
      flex-shrink: 0;
      width: 100%;
      padding: 0 25px 15px 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .swipe-scrollable-content:empty {
      display: none;
    }
    
    .swipe-scrollable-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .swipe-scrollable-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    .swipe-scrollable-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    .swipe-scrollable-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    .swipe-results-overlay.active {
      display: flex;
      pointer-events: auto;
    }
    
    .skip-to-list-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .skip-to-list-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(5px);
    }
    
    .swipe-card-stack {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .swipe-card-header {
      text-align: center;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeInUp 0.6s ease-out 0.3s forwards;
    }
    
    .swipe-card-header h2 {
      font-size: 1.6em;
      font-weight: 700;
      color: #ffffff;
      margin: 0 0 8px 0;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.9);
    }
    
    .swipe-card-header .company-chip {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white;
      padding: 6px 16px;
      border-radius: 30px;
      font-size: 0.95em;
      font-weight: 600;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }
    
    .swipe-gallery-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .gallery-nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 28px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }
    
    .gallery-nav-arrow:hover {
      background: white;
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .gallery-nav-arrow:active {
      transform: translateY(-50%) scale(0.95);
    }
    
    .gallery-nav-arrow.left {
      left: 15px;
    }
    
    .gallery-nav-arrow.right {
      right: 15px;
    }
    
    .swipe-gallery-spread {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      transition: transform 0.3s ease;
    }
    
    .swipe-gallery-spread.rotating-right {
      animation: rotateRight 0.3s ease;
    }
    
    .swipe-gallery-spread.rotating-left {
      animation: rotateLeft 0.3s ease;
    }
    
    @keyframes rotateRight {
      0% { transform: translateX(0); opacity: 1; }
      50% { transform: translateX(-30px); opacity: 0.7; }
      100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes rotateLeft {
      0% { transform: translateX(0); opacity: 1; }
      50% { transform: translateX(30px); opacity: 0.7; }
      100% { transform: translateX(0); opacity: 1; }
    }
    
    .swipe-gallery-image {
      width: 160px;
      height: 200px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }
    
    .swipe-gallery-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .swipe-gallery-image.left {
      transform: scale(0.9) rotate(-3deg);
      opacity: 0;
      animation: slideInLeft 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s forwards;
    }
    
    .swipe-gallery-image.right {
      transform: scale(0.9) rotate(3deg);
      opacity: 0;
      animation: slideInRight 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s forwards;
    }
    
    .swipe-gallery-image.center {
      z-index: 2;
      width: 220px;
      height: 280px;
    }
    
    @keyframes slideInLeft {
      to {
        transform: scale(0.9) rotate(-3deg);
        opacity: 1;
      }
    }
    
    @keyframes slideInRight {
      to {
        transform: scale(0.9) rotate(3deg);
        opacity: 1;
      }
    }
    
    .swipe-info-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      z-index: 15;
      opacity: 0;
      animation: fadeInUp 0.6s ease-out 0.8s forwards;
      transition: all 0.3s ease;
    }
    
    .swipe-expanded-details {
      width: 100%;
      max-width: 900px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      padding: 15px 0;
      opacity: 1;
      animation: fadeInUp 0.4s ease-out;
      margin-bottom: 15px;
    }
    
    /* Make full-width sections span all columns */
    .swipe-expanded-details .description-section {
      grid-column: 1 / -1;
    }
    
    /* Reviews grid - Horizontal scrollable layout */
    .swipe-reviews-grid {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 15px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 10px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .swipe-reviews-grid::-webkit-scrollbar {
      height: 10px;
    }
    
    .swipe-reviews-grid::-webkit-scrollbar-track {
      background: rgba(0, 119, 182, 0.2);
      border-radius: 5px;
    }
    
    .swipe-reviews-grid::-webkit-scrollbar-thumb {
      background: rgba(0, 119, 182, 0.6);
      border-radius: 5px;
    }
    
    .swipe-reviews-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 119, 182, 0.8);
    }
    
    .swipe-review-card {
      background: rgba(240, 248, 255, 0.8);
      padding: 18px;
      border-radius: 12px;
      border: 2px solid rgba(0, 119, 182, 0.1);
      flex: 0 0 280px;
      min-width: 280px;
      max-width: 280px;
      height: auto;
      max-height: 350px;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    
    .swipe-review-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border-color: rgba(0, 119, 182, 0.3);
    }
    
    .swipe-detail-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 25px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      opacity: 0;
      animation: slideUpFadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    
    /* Stagger animations for each section */
    .swipe-detail-section:nth-child(1) { animation-delay: 0.1s; }
    .swipe-detail-section:nth-child(2) { animation-delay: 0.2s; }
    .swipe-detail-section:nth-child(3) { animation-delay: 0.3s; }
    .swipe-detail-section:nth-child(4) { animation-delay: 0.4s; }
    .swipe-detail-section:nth-child(5) { animation-delay: 0.5s; }
    .swipe-detail-section:nth-child(6) { animation-delay: 0.6s; }
    .swipe-detail-section:nth-child(7) { animation-delay: 0.7s; }
    .swipe-detail-section:nth-child(8) { animation-delay: 0.8s; }
    .swipe-detail-section:nth-child(9) { animation-delay: 0.9s; }
    .swipe-detail-section:nth-child(10) { animation-delay: 1.0s; }
    
    .swipe-detail-section.description-section {
      grid-column: 1 / -1;
    }
    
    .swipe-detail-section h3 {
      margin: 0 0 8px 0;
      font-size: 1.05em;
      font-weight: 700;
      color: #0077b6;
    }
    
    .swipe-detail-section p,
    .swipe-detail-section div {
      margin: 0;
      line-height: 1.5;
      color: #2c3e50;
      white-space: pre-wrap;
      font-size: 0.95em;
    }
    
    .swipe-detail-section ul {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .swipe-detail-section li {
      margin-bottom: 0;
      color: #2c3e50;
      line-height: 1.5;
      font-size: 0.95em;
      padding-left: 26px;
      position: relative;
    }
    
    .swipe-detail-section li:before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #00b4d8;
      font-weight: 900;
      font-size: 1.2em;
      top: 1px;
    }
    
    .pricing-display {
      font-size: 1.3em;
      font-weight: bold;
      color: #0077b6;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .swipe-info-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 25px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    
    .swipe-info-box h3 {
      font-size: 1.4em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 12px 0;
    }
    
    .swipe-info-box ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .swipe-info-box li {
      font-size: 1.05em;
      color: #2c3e50;
      padding: 6px 0;
      padding-left: 22px;
      position: relative;
      line-height: 1.5;
    }
    
    .swipe-info-box li:before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #48bb78;
      font-weight: bold;
    }
    
    .swipe-info-box p {
      font-size: 1.4em;
      color: #2c3e50;
      line-height: 1.6;
      margin: 0;
    }
    
      .swipe-actions {
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
        z-index: 100;
        transition: all 0.3s ease;
        justify-content: center;
        pointer-events: auto;
      }
    
    .swipe-actions.entering {
      animation: slideUpButtons 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s backwards;
    }
    
    @keyframes slideUpButtons {
      0% {
        transform: translateY(100px);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
      .swipe-btn {
        width: clamp(80px, 8vw, 110px);
        height: clamp(80px, 8vw, 110px);
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
        gap: 4px;
      transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      font-weight: 700;
      position: relative;
    }
    
    .swipe-btn:active {
      transform: scale(0.95);
    }
    
    .swipe-btn-reject {
      background: linear-gradient(135deg, #ff4757 0%, #ff3838 50%, #e84118 100%);
      color: white;
    }
    
    .swipe-btn-reject:before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b7a, #ff4757);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
      filter: blur(15px);
    }
    
    .swipe-btn-reject:hover {
      transform: scale(1.15);
      box-shadow: 0 25px 60px rgba(255, 71, 87, 0.6);
    }
    
    .swipe-btn-reject:hover:before {
      opacity: 0.7;
    }
    
    .swipe-btn-accept {
      background: linear-gradient(135deg, #0cb4e7 0%, #00a8cc 50%, #0077b6 100%);
      color: white;
    }
    
    .swipe-btn-accept:before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00d4ff, #0cb4e7);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
      filter: blur(15px);
    }
    
    .swipe-btn-accept:hover {
      transform: scale(1.15);
      box-shadow: 0 25px 60px rgba(12, 180, 231, 0.6);
    }
    
    /* Enhanced styling when button shows "Book Now" */
    .swipe-btn-accept.booking-mode {
      background: linear-gradient(135deg, #00d084 0%, #00b872 50%, #009960 100%);
      animation: pulse 2s ease-in-out infinite;
    }
    
    .swipe-btn-accept.booking-mode:hover {
      box-shadow: 0 25px 60px rgba(0, 208, 132, 0.6);
    }
    
    .swipe-btn-accept:hover:before {
      opacity: 0.7;
    }
    
      .swipe-btn-icon {
        font-size: clamp(1.6em, 2.5vw, 2.4em);
      line-height: 1;
      text-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    
    .swipe-btn-text {
        font-size: clamp(0.7em, 0.9vw, 0.95em);
      letter-spacing: 0.5px;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* ===================================================================
       MODERN KIOSK LAYOUT - Home Page
       =================================================================== */
    
    .page.home-page.active {
      min-height: auto;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, #005fa3 0%, #0cb4e7 40%, #0edfcc 100%);
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      z-index: 2; /* Above video background */
    }
    
    /* Kiosk Header */
    /* Global Header - Always visible on all pages */
    .global-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 70px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 40px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      z-index: 10000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .global-header-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
    }
    
    .global-back-button {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      font-size: 2em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #0077b6;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex !important;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
      z-index: 10001;
    }
    
    body.showing-language-selection .global-back-button {
      display: none !important;
    }
    
    .global-back-button:hover {
      background: #0077b6;
      color: white;
      transform: scale(1.1);
    }
    
    .global-back-button:active {
      transform: scale(0.95);
    }
    
    .global-logo-image {
      height: 45px;
      width: auto;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    
    .global-header-right {
      display: flex;
      gap: 15px;
      align-items: center;
      flex: 1;
      justify-content: flex-end;
    }
    
    /* Always show header except when language selection is active */
    .global-header {
      display: flex !important;
    }
    
    body.showing-language-selection .global-header {
      display: none !important;
    }
    
    /* Add padding to pages to account for fixed header */
    .page {
      padding-top: 70px;
    }
    
    .video-question-page {
      padding-top: 0; /* Video page fills full screen including behind header */
    }
    
    /* Video start screen - account for header at top */
    .video-start-screen {
      padding-top: 80px; /* Add padding so content doesn't hide behind header */
    }
    
    .kiosk-header {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px 50px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .header-right {
      position: absolute;
      right: 50px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo-image {
      height: 70px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    .logo-mark {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 8px;
      background-image: url('/static/Filtour_logo.png.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .logo-text {
      font-size: 2em;
      font-weight: 700;
      color: white;
      letter-spacing: -0.5px;
    }
    
    .chip {
      padding: 12px 24px;
      background: white;
      border: none;
      border-radius: 20px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #0077b6;
      min-width: 70px;
      min-height: 56px;
    }
    
    .chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .chip:active {
      transform: scale(0.95);
    }
    
    .chip-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
    }
    
    .chip-outline:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Home Main Content */
    .home-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 50px;
      gap: 60px;
    }
    
    /* Hero Section */
    .hero {
      width: 100%;
      max-width: 1200px;
      text-align: center;
    }
    
    .hero-title {
      font-size: 4em;
      font-weight: 700;
      color: white;
      margin: 0 0 30px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
      letter-spacing: -1px;
    }
    
    /* Filter Summary Bar */
    .filter-summary-bar {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px 30px;
      margin: 0 auto 30px;
      max-width: 900px;
    }
    
    .filter-summary-content {
      display: flex;
      align-items: center;
      gap: 20px;
      justify-content: space-between;
    }
    
    .back-nav-btn,
    .start-over-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.4);
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .back-nav-btn:hover,
    .start-over-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: white;
    }
    
    .selected-filters {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      min-height: 30px;
    }
    
    .filter-tag {
      background: white;
      color: #0077b6;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.95em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .hero-card {
      background: transparent;
      border-radius: 22px;
      padding: 50px 60px;
    }
    
    .hero-question {
      font-size: 2.5em;
      font-weight: 600;
      color: white;
      margin: 0 0 40px 0;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    /* Duration Grid (2x2) */
    .duration-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
    }
    
    .duration-pill {
      padding: 35px 40px;
      background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%);
      border: none;
      border-radius: 18px;
      font-size: 1.8em;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      height: 140px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.3;
      user-select: none;
    }
    
    .duration-pill span {
      font-size: 0.65em;
      font-weight: 400;
      opacity: 0.9;
      margin-top: 8px;
    }
    
    .duration-pill:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .duration-pill:active {
      transform: scale(0.97);
    }
    
    /* Center single button on its own row when there's an odd number */
    .filter-question-card[data-question="1"] .duration-pill:nth-child(3):not(.duration-pill--ghost) {
      grid-column: 1 / -1;
      max-width: calc(50% - 12.5px);
      margin: 0 auto;
    }
    
    .duration-pill--ghost {
      background: transparent;
      border: 3px solid rgba(255, 255, 255, 0.6);
      color: white;
      grid-column: 1 / -1;
      justify-self: center;
      max-width: 400px;
    }
    
    .duration-pill--ghost:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: white;
    }
    
    .duration-pill.selected,
    .duration-pill--selected {
      background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%) !important;
      box-shadow: 0 12px 30px rgba(0, 180, 216, 0.4);
      border-color: white;
      transform: scale(1.05);
    }
    
    .duration-pill--ghost.selected {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      border-color: white;
      box-shadow: 0 8px 20px rgba(255, 255, 255, 0.2);
    }
    
    /* Featured Tours Section */
    .featured-tours {
      width: 100%;
      max-width: 1400px;
    }
    
    .featured-tours h2 {
      font-size: 3em;
      font-weight: 700;
      color: white;
      margin: 0 0 15px 0;
      text-align: center;
    }
    
    .section-subtitle {
      font-size: 1.5em;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      margin: 0 0 40px 0;
    }
    
    .featured-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
    }
    
    /* Adjust featured grid on home page for better layout */
    .home-page .featured-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .tour-card-large {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .tour-card-large:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    
    .tour-card-large:active {
      transform: scale(0.98);
    }
    
    .tour-card-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      transition: transform 0.5s ease;
    }

/* Gold star for tours with working Rezdy booking */
.tour-card-star {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 48px;
  height: 48px;
  background: radial-gradient(circle at 30% 30%, #ffe680, #f5c400 70%);
  color: #8a5b00;
  font-size: 1.8em;
  line-height: 48px;
  text-align: center;
  border-radius: 50%;
  box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  z-index: 6;
  pointer-events: none;
    }
    
    .tour-card-large:hover .tour-card-image {
      transform: scale(1.05);
    }
    
    .tour-card-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 35px 30px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%);
      color: white;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .operator-chip {
      display: inline-block;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      font-size: 1em;
      font-weight: 500;
      max-width: fit-content;
    }
    
    .tour-name {
      font-size: 1.8em;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }
    
    .tour-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 1.1em;
      flex-wrap: wrap;
    }
    
    .rating {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .price-badge {
      padding: 6px 14px;
      background: rgba(255, 255, 255, 0.9);
      color: #0077b6;
      border-radius: 10px;
      font-weight: 600;
    }
    
    /* Tap Hint */
    .loading-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 40px;
      padding: 40px 0;
      gap: 20px;
    }
    
    .loading-indicator p {
      color: white;
      font-size: 1.3em;
      font-weight: 500;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .tap-hint {
      font-size: 1.5em;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      margin: 20px 0 0 0;
      font-weight: 300;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    
    /* Hide old elements when using new home layout (but not when in map view) */
    body:has(.home-page):not(.map-view-active) #content-area,
    body:has(.home-page):not(.map-view-active) #filter-panel,
    body:has(.home-page):not(.map-view-active) .top-button-bar,
    body:has(.home-page) #map-container,
    body:has(.home-page) .tour-list-page {
      display: none !important;
    }
    
    /* Also hide mobile menu when home page is visible (but keep chat interface) */
    body:has(.home-page):not(.map-view-active) .mobile-menu-btn {
      display: none !important;
    }
    
    /* Make main-layout transparent when home page is visible */
    body:has(.home-page):not(.map-view-active) #main-layout {
      background: transparent;
    }
    
    /* Restore main layout background when in map view */
    body.map-view-active #main-layout {
      background: linear-gradient(135deg, #006ba6 0%, #0077b6 50%, #00b4d8 100%) !important;
    }
    
    body.map-view-active #filter-panel,
    body.map-view-active #content-area {
      display: block !important;
    }
    
    /* ===================================================================
       MODERN KIOSK LAYOUT - Tour List Page
       =================================================================== */
    
    .page.tour-list-page.active {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, #005fa3 0%, #0cb4e7 40%, #0edfcc 100%);
    }
    
    /* Tour List Main Content */
    .tour-list-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 30px 50px 50px 50px;
      gap: 30px;
    }
    
    /* Filters Summary Section */
    .filters-summary {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px 30px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .filters-label {
      font-size: 1.3em;
      font-weight: 600;
      color: white;
    }
    
    .filters-chips {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      flex: 1;
    }
    
    .chip-solid {
      background: white;
      color: #0077b6;
    }
    
    /* Tour Grid Section */
    .tour-grid-section {
      flex: 1;
    }
    
    .list-title {
      font-size: 3.5em;
      font-weight: 700;
      color: #ffffff !important;
      margin: 0 0 15px 0;
      text-align: center;
      text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 0, 0, 0.5);
    }
    
    .tour-list-page .results-info {
      font-size: 1.4em;
      color: #ffffff !important;
      text-align: center;
      margin: 0 0 40px 0;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
    }
    
    /* 2-Column Tour Grid */
    .tour-grid--2col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 30px;
      margin-bottom: 40px;
    }
    
    /* Ensure tour-card-large works in the grid */
    .tour-grid--2col .tour-card-large {
      min-height: 350px;
    }
    
    /* Load More Button in Tour List */
    .tour-list-page .load-more-container {
      text-align: center;
      margin-top: 20px;
    }
    
    .tour-list-page .load-more-btn {
      padding: 18px 50px;
      font-size: 1.3em;
      background: white;
      color: #0077b6;
      border: none;
      border-radius: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .tour-list-page .load-more-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .tour-list-page .load-more-btn:active {
      transform: scale(0.97);
    }
    
    /* Hide elements when tour list page is active */
    body:has(.tour-list-page[style*="display: block"]) .top-button-bar,
    body:has(.tour-list-page[style*="display: block"]) #weather-widget,
    body:has(.tour-list-page[style*="display: block"]) .mobile-menu-btn {
      display: none !important;
    }
    
    /* Map container positioning for tour list page */
    .tour-list-page #map-container {
      position: relative;
      width: 100%;
      height: 50vh !important;
      min-height: 400px !important;
      max-height: 600px !important;
      z-index: 1;
      background: white;
      display: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin: 20px 0;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
    }
    
    .tour-list-page #map-container.active {
      display: block;
    }
    
    /* Carousel below map */
    .map-carousel-container {
      display: none;
      width: 100%;
      padding: 0;
      background: transparent;
      margin-top: 20px;
    }
    
    .map-carousel-container.active {
      display: block;
    }
    
    .carousel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 25px;
      background: white;
      border-radius: 12px 12px 0 0;
      border-bottom: 3px solid #0077b6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .carousel-header-text {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
    }
    
    .carousel-header-text .count {
      color: #0077b6;
    }
    
    .carousel-header-text .location {
      color: #0077b6;
      font-weight: 700;
    }
    
    .carousel-clear-btn {
      padding: 10px 20px;
      background: rgba(0,119,182,0.1);
      border: 2px solid #0077b6;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 600;
      color: #0077b6;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .carousel-clear-btn:hover {
      background: #0077b6;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,119,182,0.3);
    }
    
    .carousel-clear-btn:active {
      transform: translateY(0);
    }
    
    .map-carousel {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-behavior: smooth;
      padding: 25px 20px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,0.3) rgba(255,255,255,0.1);
      background: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .map-carousel.with-header {
      border-radius: 0 0 12px 12px;
    }
    
    .map-carousel::-webkit-scrollbar {
      height: 8px;
    }
    
    .map-carousel::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }
    
    .map-carousel::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.5);
      border-radius: 10px;
    }
    
    .map-carousel::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.7);
    }
    
    .carousel-card {
      flex: 0 0 280px;
      height: 180px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      animation: slideInCarousel 0.4s ease-out;
    }
    
    @keyframes slideInCarousel {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .carousel-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    
    .carousel-card.selected {
      border: 3px solid #0077b6;
      box-shadow: 0 8px 30px rgba(0,119,182,0.4);
      transform: translateY(-5px) scale(1.05);
    }
    
    /* Highlighted map marker styles */
    .custom-marker.highlighted {
      animation: markerPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes markerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Ensure map container stays large - LOCKED SIZE */
    #home-map-container {
      position: relative !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 1600px !important;
      height: 700px !important;
      min-height: 700px !important;
      max-height: 700px !important;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      overflow: hidden !important;
    }
    
    #home-map {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      min-height: 600px !important;
      max-height: 800px !important;
    }
    
    /* Lock leaflet container size */
    #home-map .leaflet-container {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      min-height: 600px !important;
      max-height: 800px !important;
    }
    
    /* Map view section - shown/hidden dynamically */
    #home-map-view-section {
      display: none;  /* Hidden by default, shown when user clicks Map View button */
      width: 100% !important;
      max-width: 1600px !important;
      margin: 0 auto !important;
    }
    
    #home-map-view-section > div {
      width: 100% !important;
    }
    
    .carousel-card-image {
      width: 100%;
      height: 110px;
      background-size: cover;
      background-position: center;
      transition: transform 0.3s ease;
    }
    
    .carousel-card:hover .carousel-card-image {
      transform: scale(1.05);
    }
    
    .carousel-card-info {
      padding: 10px 12px;
      background: white;
    }
    
    .carousel-card-name {
      font-size: 0.95em;
      font-weight: 600;
      color: #333;
      margin: 0 0 5px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.2s ease;
    }
    
    .carousel-card:hover .carousel-card-name {
      color: #0077b6;
    }
    
    .carousel-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
    }
    
    .carousel-card-rating {
      color: #f59e0b;
    }
    
    .carousel-card-price {
      color: #0077b6;
      font-weight: 600;
    }
    
    /* ===================================================================
       MODERN KIOSK LAYOUT - Tour Detail Page
       =================================================================== */
    
    .page.tour-detail-page.active {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: linear-gradient(180deg, #005fa3 0%, #0cb4e7 40%, #0edfcc 100%);
      display: none;
      flex-direction: column;
      z-index: 10 !important; /* Above video (z-index 1) */
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }
    
    /* Make background transparent when in video flow */
    body.video-bg-active .page.tour-detail-page.active {
      background: transparent !important;
    }
    
    .page.tour-detail-page::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    .page.tour-detail-page.active {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      z-index: 999999 !important;
    }
    
    /* Ensure all child sections within tour detail are transparent unless styled */
    .tour-detail-page section:not(.pricing-section):not(.details-section):not(.fine-print):not(.departure-section),
    .tour-detail-page section:not(.pricing-section):not(.details-section):not(.fine-print):not(.departure-section) *:not(.info-card):not(.pricing-card):not(.price-row) {
      background: transparent !important;
    }
    
    .tour-detail-page .tour-hero,
    .tour-detail-page .photo-carousel,
    .tour-detail-page .info-grid,
    .tour-detail-page header,
    .tour-detail-page main,
    .tour-detail-page .kiosk-header {
      background: transparent !important;
    }
    
    /* Force transparent on header with slight override */
    .tour-detail-page .kiosk-header {
      background: transparent !important;
      backdrop-filter: none !important;
    }
    
    /* Back Button */
    .back-button {
      padding: 0;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      font-size: 2.5em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #0077b6;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .back-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      background: white;
    }
    
    .back-button:active {
      transform: scale(0.95);
    }
    
    .header-spacer {
      flex: 1;
    }
    
    /* Tour Detail Main Content */
    .tour-detail-main {
      flex: 1;
      padding: 40px 80px 120px 80px;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      background: transparent !important;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      position: relative;
      z-index: 10; /* Above video background */
    }
    
    .tour-detail-main::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    /* Tour Hero Section */
    .tour-hero {
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: transparent !important;
    }
    
    .tour-title {
      font-size: 4em;
      font-weight: 700;
      color: #ffffff;
      margin: 0 0 15px 0;
      line-height: 1.2;
      text-shadow: 2px 4px 12px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 0, 0, 0.5);
    }
    
    .tour-hero .operator-chip {
      display: inline-block;
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      font-size: 1.4em;
      font-weight: 600;
      color: #0077b6;
      max-width: fit-content;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .tour-hero .operator-chip:hover {
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .tour-summary {
      font-size: 1.6em;
      color: #ffffff;
      line-height: 1.7;
      margin: 0;
      max-width: 1000px;
      text-shadow: 2px 3px 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.4);
    }
    
    /* Photo Carousel */
    .photo-carousel {
      width: 100%;
      max-width: 100%;
      margin: 0;
      background: transparent;
    }
    
    /* Pricing Section */
    .pricing-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 50px 60px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin: 32px 50px;
    }
    
    .pricing-section h2 {
      font-size: 2.8em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 15px 0;
      text-align: center;
    }
    
    .pricing-hint {
      font-size: 1.3em;
      color: #555;
      margin: 0 0 35px 0;
      font-style: italic;
      text-align: center;
    }
    
    .pricing-card {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 40px;
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      border: 3px solid transparent;
      border-radius: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.6em;
      font-weight: 600;
      color: white;
      min-height: 90px;
      user-select: none;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .price-row:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .price-row:active {
      transform: scale(0.97);
    }
    
    .price-row.selected {
      background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%);
      box-shadow: 0 12px 30px rgba(0, 180, 216, 0.4);
      border-color: white;
      color: white;
      border-color: #005a8b;
      box-shadow: 0 4px 15px rgba(0, 119, 182, 0.4);
    }
    
    .price-row:active {
      transform: scale(0.98);
    }
    
    /* Detail Info - Flex wrap for side-by-side boxes */
    #detail-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0;
      margin: 32px 0;
      justify-content: flex-start;
    }
    
    /* Info Grid - Two Cards Side by Side */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 30px;
      margin: 32px 50px;
      background: transparent !important;
    }
    
    @media (max-width: 900px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .info-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 40px 45px;
      border-radius: 22px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .info-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .info-card h3 {
      font-size: 2.2em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 25px 0;
    }
    
    .info-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .info-card li {
      font-size: 1.25em;
      color: #2c3e50;
      padding-left: 40px;
      position: relative;
      line-height: 1.6;
    }
    
    .info-card li::before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #00b4d8;
      font-weight: 900;
      font-size: 1.4em;
      top: 1px;
    }
    
    /* Details Section */
    .details-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 50px 60px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin: 32px 50px;
    }
    
    .details-section h3 {
      font-size: 2.8em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 25px 0;
    }
    
    .details-section #detail-description {
      font-size: 1.35em;
      line-height: 1.9;
      color: #2c3e50;
    }
    
    /* Fine Print */
    .fine-print {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 50px 60px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin: 32px 50px;
    }
    
    .fine-print h3 {
      font-size: 2.8em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 25px 0;
    }
    
    .fine-print p,
    .fine-print ul,
    .fine-print ol,
    .fine-print div {
      font-size: 1.35em;
      line-height: 1.9;
      color: #2c3e50;
    }
    
    /* Departure Section */
    .departure-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 50px 60px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin: 32px 50px 100px 50px;
    }
    
    .departure-section h3 {
      font-size: 1.8em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 15px 0;
    }
    
    .departure-section p,
    .departure-section div {
      font-size: 0.95em;
      line-height: 1.5;
      color: #2c3e50;
    }
    
    /* Reviews Section - Override departure section styles */
    #reviews-section-detail h3 {
      font-size: 4em !important;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 30px 0;
    }
    
    #reviews-section-detail .overall-rating {
      font-size: 3.5em !important;
    }
    
    #reviews-section-detail .stars-large {
      font-size: 2.2em !important;
      gap: 6px !important;
    }
    
    #reviews-section-detail .review-source {
      font-size: 1.2em !important;
    }
    
    #reviews-section-detail .review-card {
      padding: 35px !important;
      margin-bottom: 25px !important;
      border-radius: 16px !important;
      border-left: 5px solid #0077b6 !important;
    }
    
    #reviews-section-detail .review-author {
      font-size: 1.4em !important;
    }
    
    #reviews-section-detail .review-stars {
      font-size: 1.3em !important;
    }
    
    #reviews-section-detail .review-date {
      font-size: 1.1em !important;
    }
    
    #reviews-section-detail .review-title {
      font-size: 1.35em !important;
      margin-bottom: 12px !important;
    }
    
    }
    
    .btn-tertiary {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.5);
    }
    
    .btn-tertiary:hover {
      background: linear-gradient(135deg, #55cc88 0%, #44bb77 100%);
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(72, 187, 120, 0.6);
    }
    
    .btn-primary:active,
    .btn-secondary:active,
    .btn-tertiary:active {
      transform: scale(0.97);
    }
    
    /* ===================================================================
       MOBILE - Desktop View Scaled to Fit
       =================================================================== */
    /* Keep desktop layout on mobile, just let the browser zoom out */
    
    /* Hide ALL other pages when tour detail is open */
    body:has(.tour-detail-page.active) .page.home-page,
    body:has(.tour-detail-page.active) #weather-widget,
    body:has(.tour-detail-page.active) #main-layout,
    body:has(.tour-detail-page.active) #content-area,
    body:has(.tour-detail-page.active) #filter-panel,
    body:has(.tour-detail-page.active) .top-button-bar,
    body:has(.tour-detail-page.active) #tour-placeholder-row,
    body:has(.tour-detail-page.active) #map-container,
    body:has(.tour-detail-page.active) .tour-list-page {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Ensure tour detail page is on top with gradient visible */
    html:has(.tour-detail-page.active),
    body:has(.tour-detail-page.active) {
      background: linear-gradient(180deg, #005fa3 0%, #0cb4e7 40%, #0edfcc 100%) !important;
      overflow: hidden;
      min-height: 100vh !important;
    }
    
    html:has(.tour-detail-page.active) {
      height: 100% !important;
    }
    
    /* ===================================================================
       QR PAYMENT MODAL
       =================================================================== */
    
    .qr-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999999 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .qr-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .qr-card {
      position: relative;
      z-index: 10000000 !important;
      background: white;
      border-radius: 22px;
      padding: 50px 60px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      max-width: 600px;
      width: 90%;
      text-align: center;
      animation: slideUp 0.4s ease;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .qr-card h2 {
      font-size: 3em;
      font-weight: 700;
      color: #0077b6;
      margin: 0;
    }
    
    .qr-subtitle {
      font-size: 1.4em;
      color: #666;
      margin: 0;
      line-height: 1.5;
    }
    
    .qr-code-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      background: #f8f9fa;
      border-radius: 18px;
      margin: 10px 0;
      min-height: 300px;
    }
    
    .qr-code-wrapper canvas,
    .qr-code-wrapper img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      background: white;
      padding: 15px;
    }
    
    .qr-help-text {
      font-size: 1.2em;
      color: #888;
      margin: 0;
      font-style: italic;
    }
    
    .qr-actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 10px;
    }
    
    .qr-actions .btn-primary {
      width: 100% !important;
      max-width: none !important;
      padding: 22px 40px;
      font-size: 1.5em;
      min-height: 75px;
      flex-shrink: 1;
    }
    
    .btn-ghost {
      padding: 18px 40px;
      background: transparent;
      border: none;
      font-size: 1.3em;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 18px;
      min-height: 65px;
    }
    
    .btn-ghost:hover {
      background: #f0f4f8;
      color: #0077b6;
    }
    
    .btn-ghost:active {
      transform: scale(0.97);
    }
    
    /* Content area - tours grid */
    #content-area {
      flex: 1;
      padding: 50px 40px;
      background: #f5f9fc;
    }
    
    #tour-grid-header {
      font-size: 2.8em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 15px 0;
      text-align: center;
    }
    
    .results-info {
      text-align: center;
      margin: 0 0 40px 0;
      font-size: 1.6em;
      color: #666;
      font-weight: 500;
    }
    
    #tour-placeholder-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 450px;
      gap: 30px;
      padding-bottom: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* --- Touchscreen-optimized Tour Card Styles --- */
    .tour-card {
      position: relative;
      width: 100%;
      height: 100%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.12);
      overflow: hidden;
      margin: 0;
      border-radius: 16px;
      background: #eee;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .tour-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    
    .tour-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 16px;
    }
    
    .tour-overlay {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      padding: 30px;
      background: linear-gradient(to top, rgba(0,0,0,0.7) 60%, rgba(0,0,0,0.0) 100%);
      color: #fff;
      box-sizing: border-box;
    }
    
    .tour-type {
      font-size: 1.3rem;
      opacity: 0.9;
      font-weight: 500;
    }
    
    .tour-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-top: 8px;
      line-height: 1.3;
    }
    
    .tour-rating {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .stars {
      color: #fbbf24;
      display: flex;
      gap: 2px;
    }
    
    .review-count {
      opacity: 0.9;
      font-weight: 400;
      font-size: 1.1rem;
    }
    /* Chat widget styles */
    #chat-widget {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 340px;
      max-width: 90vw;
      background: #fff;
      border-radius: 0;
      box-shadow: 0 4px 24px rgba(0,0,0,0.13);
      z-index: 100;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chat-header {
      background: #0077b6;
      color: #fff;
      font-weight: 600;
      padding: 16px 20px;
      font-size: 1.1em;
    }
    #chatbox {
      height: 200px;
      overflow-y: auto;
      padding: 16px 20px;
      background: #fafafa;
      border-bottom: 1px solid #eee;
    }
    .chat-message {
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .user-message {
      text-align: right;
      color: #0077b6;
      font-weight: 500;
    }
    .assistant-message {
      text-align: left;
      color: #333;
    }
    #input-area {
      display: flex;
      padding: 16px 20px;
      background: #fff;
      position: relative;
    }
    #userInput {
    #sendBtn:hover {
      background: #005a8b;
    }
    #spinner {
      display: none;
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }
    /* Load More Button */
    .load-more-container {
      width: 100%;
      text-align: center;
      margin: 40px 0;
    }
    
    .load-more-btn {
      padding: 25px 60px;
      font-size: 1.6em;
      border-radius: 12px;
      background: #0077b6;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,119,182,0.3);
      transition: all 0.3s ease;
      /* Hide button visually - automatic loading happens when it scrolls into view */
      opacity: 0;
      pointer-events: none;
      height: 50px; /* Keep some height so IntersectionObserver still triggers */
    }
    
    .load-more-btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 10px rgba(0,119,182,0.3);
    }
    
    /* ===================================================================
       PROPORTIONAL SCALING - Scale EVERYTHING Down on Mobile
       =================================================================== */
    
    /* Tablet - Scale down to 75% */
    @media (max-width: 1024px) {
      html {
        font-size: 14px;
      }
      
      /* Make header buttons sticky on tablet */
      .kiosk-header .header-right {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 10000;
      }
    }
    
    /* Mobile - Responsive layout */
    
    /* Small phones - Further adjustments */
    @media (max-width: 480px) {
      html {
        font-size: 15px;
      }
      
      .question-text {
        font-size: 1.8em;
      }
      
      .filter-option {
        font-size: 1.3em;
        padding: 25px 30px;
      }
      
      .filter-options {
        grid-template-columns: 1fr;
      }
      
      .filter-option-centered {
        grid-column: 1;
      }
      
      #tour-placeholder-row {
        grid-template-columns: 1fr;
        grid-auto-rows: 400px;
      }
      
      .clear-filters-btn {
        top: 20px;
        right: 180px;  /* Position to the left of Map View on mobile */
        padding: 15px 25px;
        font-size: 1.1em;
      }
      
      .nav-buttons {
        top: 20px;
        left: 20px;
        flex-wrap: wrap;
      }
      
      .nav-btn {
        padding: 15px 25px;
        font-size: 1.1em;
      }
    }
    /* Old tour detail page styles - now using .page.tour-detail-page instead */
    #tour-detail-page {
      display: none !important;
      visibility: hidden !important;
    }
    #back-arrow,
    .back-button {
      position: fixed !important;
      top: 40px !important;
      left: 40px !important;
      font-size: 2.8em;
      color: #0077b6;
      background: #fff;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      cursor: pointer;
      z-index: 210;
      border: none;
      transition: all 0.3s ease;
    }
    #back-arrow:active,
    .back-button:active {
      transform: scale(0.95);
      background: #e0eafc;
    }
    
    /* Desktop - ensure header is always visible */
    @media (min-width: 769px) {
      .tour-detail-page .kiosk-header,
      .kiosk-header {
        display: flex !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 100 !important;
        background: rgba(255, 255, 255, 0.1) !important;
        backdrop-filter: blur(10px) !important;
        padding: 30px 50px !important;
        justify-content: center !important;
        align-items: center !important;
      }
      
      .tour-detail-page .header-right,
      .kiosk-header .header-right {
        display: flex !important;
        position: absolute !important;
        right: 50px !important;
        gap: 15px !important;
        align-items: center !important;
      }
      
      .tour-detail-page .back-button,
      .tour-detail-page #back-arrow {
        position: fixed !important;
        top: 40px !important;
        left: 40px !important;
      }
    }
    #detail-content {
      max-width: 1000px;
      margin: 120px auto 60px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 50px 40px 40px 40px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #detail-title {
      font-size: 2.8em;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 12px;
      line-height: 1.2;
      text-shadow: 3px 3px 12px rgba(0, 0, 0, 0.9), 0 0 40px rgba(0, 0, 0, 0.6);
    }
    #detail-company {
      font-size: 1.5em;
      color: #ffffff;
      margin-bottom: 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
      padding: 10px 20px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
    }
    
    #detail-company:hover {
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    
    #detail-company:active {
      transform: translateY(0);
    }
    #detail-summary {
      font-size: 1.4em;
      color: #222;
      margin-bottom: 24px;
      line-height: 1.5;
    }
    #detail-description {
      color: #1a1a1a;
      margin-bottom: 30px;
      font-size: 1.4em;
      line-height: 1.8;
      font-weight: 400;
      letter-spacing: 0.3px;
    }
    #detail-info {
      display: block;
      margin-bottom: 24px;
      color: #333;
      font-size: 1.2em;
      line-height: 1.8;
    }
    #detail-info ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #detail-info li {
      margin-bottom: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    #detail-info b {
      color: #0077b6;
      font-weight: 600;
    }
    #detail-gallery {
      width: 100%;
      margin: 32px 0 32px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
    }
    .carousel {
      position: relative;
      width: 100%;
      max-width: 100%;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }
    .carousel img {
      width: 100%;
      height: auto;
      max-height: 750px;
      object-fit: contain;
      cursor: pointer;
      display: block;
      border-radius: 0;
      box-shadow: none;
      outline: 5px solid #ffffff;
      outline-offset: -10px;
    }
    .carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(135deg, #0cb4e7 0%, #00b4d8 100%) !important;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 2.5em;
      cursor: pointer;
      color: #ffffff !important;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(12, 180, 231, 0.6);
      font-weight: 700;
      z-index: 10;
    }
    .carousel-arrow:hover {
      transform: translateY(-50%) scale(1.1);
      background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%) !important;
      box-shadow: 0 6px 30px rgba(12, 180, 231, 0.8);
    }
    .carousel-arrow:active {
      transform: translateY(-50%) scale(0.95);
    }
    .carousel-arrow.left { left: 30px; }
    .carousel-arrow.right { right: 30px; }
    .carousel-thumbnails {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 20px;
      width: 100%;
      overflow-x: visible;
      overflow-y: hidden;
    }
    .carousel-thumbnail {
      width: 120px;
      height: 80px;
      border-radius: 0;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      flex-shrink: 0;
      box-shadow: none;
    }
    .carousel-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .carousel-thumbnail:hover {
      transform: translateY(-4px);
      box-shadow: none;
    }
    .carousel-thumbnail:active {
      transform: scale(0.95);
    }
    .carousel-thumbnail.active {
      box-shadow: none;
      transform: scale(1.15);
    }
    
    /* Booking Modal Styles */
    .modal {
      display: none !important;
      position: fixed;
      z-index: 300;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }
    
    .modal.active {
      display: flex !important;
      align-items: center;
      justify-content: center;
      padding: 20px;
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      max-width: 700px;
      width: 100%;
      padding: 50px 40px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.8em;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    .modal-close:active {
      background: #e0e0e0;
      transform: scale(0.95);
    }
    
    .modal-title {
      font-size: 2.5em;
      font-weight: 700;
      color: #0077b6;
      margin: 0 0 15px 0;
      text-align: center;
    }
    
    .modal-subtitle {
      font-size: 1.3em;
      color: #666;
      margin: 0 0 30px 0;
      text-align: center;
      font-weight: 500;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-group label {
      display: block;
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 18px 20px;
      font-size: 1.2em;
      border: 3px solid #ddd;
      border-radius: 12px;
      box-sizing: border-box;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0077b6;
      background: #f8fbff;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .form-actions {
      margin-top: 30px;
    }
    
    .submit-booking-btn {
      width: 100%;
      padding: 25px;
      background: #0077b6;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.6em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,119,182,0.3);
    }
    
    .submit-booking-btn:active {
      background: #005a8b;
      transform: scale(0.98);
    }
    
    .submit-booking-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .form-note {
      text-align: center;
      font-size: 0.95em;
      color: #666;
      margin-top: 15px;
    }
    
    .booking-success {
      text-align: center;
      padding: 40px 20px;
    }
    
    .success-icon {
      width: 100px;
      height: 100px;
      background: #4ade80;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4em;
      color: white;
      margin: 0 auto 30px;
      animation: scaleIn 0.5s ease;
    }
    
    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }
    
    .booking-success h3 {
      font-size: 2em;
      color: #0077b6;
      margin-bottom: 15px;
    }
    
    .booking-success p {
      font-size: 1.2em;
      color: #666;
      margin-bottom: 30px;
    }
    
    .success-close-btn {
      padding: 18px 50px;
      background: #0077b6;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.4em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
      .success-close-btn:active {
      background: #005a8b;
      transform: scale(0.98);
    }
    
    /* Review Section Styles */
    .reviews-section {
      width: 100%;
      margin-top: 20px;
    }
    
    .reviews-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .reviews-title {
      font-size: 2.2em;
      font-weight: 700;
      color: #0077b6;
      display: none;
    }
    
    .reviews-summary {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .overall-rating {
      font-size: 5em !important;
      font-weight: 700;
      color: #0077b6;
    }
    
    .stars-large {
      color: #fbbf24;
      font-size: 3em !important;
      display: flex;
      gap: 8px;
    }
    
    .review-source {
      font-size: 1.8em !important;
      color: #555;
      margin-top: 8px;
    }
    
    .review-card {
      background: rgba(248, 249, 250, 0.95);
      padding: 45px !important;
      margin-bottom: 30px !important;
      border-radius: 20px !important;
      border-left: 6px solid #0077b6 !important;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .review-author {
      font-weight: 700;
      color: #333;
      font-size: 2em !important;
    }
    
    .review-stars {
      color: #fbbf24;
      font-size: 1.8em !important;
    }
    
    .review-date {
      color: #999;
      font-size: 1.5em !important;
      margin-top: 6px;
    }
    
    .review-title {
      font-weight: 600;
      color: #0077b6;
      font-size: 2em !important;
      margin-bottom: 15px;
    }
    
    .review-text {
      color: #444;
      line-height: 1.7;
      font-size: 1.8em !important;
    }
    
    .no-reviews {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 1.2em;
    }
    
    /* QR Code Modal Styles */
    #qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    
    .qr-modal-content {
      background: white;
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      position: relative;
      box-shadow: 0 10px 50px rgba(0,0,0,0.3);
    }
    
    .qr-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2em;
      cursor: pointer;
      color: #999;
      transition: color 0.3s;
      background: none;
      border: none;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .qr-modal-close:hover {
      color: #333;
    }
    
    .qr-modal-title {
      font-size: 2em;
      font-weight: 700;
      color: #0077b6;
      margin-bottom: 20px;
    }
    
    .qr-modal-subtitle {
      font-size: 1.2em;
      color: #666;
      margin-bottom: 30px;
    }
    
    .qr-code-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      display: inline-block;
      border: 3px solid #0077b6;
    }
    
    .qr-code-container img {
      display: block;
      width: 300px;
      height: 300px;
    }
    
    .qr-modal-instruction {
      margin-top: 25px;
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
    }
    
    .qr-button {
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .qr-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,119,182,0.3);
    }
    
    .qr-button:active {
      transform: translateY(0);
    }
    
    /* Map View Styles */
    #map-container {
      display: none;
      width: 100%;
      height: calc(100vh - 200px);  /* Full viewport height minus header space */
      min-height: 600px;
      position: relative;
    }
    
    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    #map-container.active {
      display: block;
    }
    
    /* Top Button Bar Container */
    .top-button-bar {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 1000;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    /* Unified button styles */
    .top-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.4);
      padding: 16px 28px;
      border-radius: 10px;
      font-size: 1.15em;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1;
      white-space: nowrap;
      box-sizing: border-box;
      justify-content: center;
      height: 56px;
    }
    
    /* Style buttons when tour detail is open (on white background) */
    body.tour-detail-open .top-btn {
      background: #0077b6;
      color: white;
      border: 2px solid #0077b6;
      box-shadow: 0 4px 12px rgba(0, 119, 182, 0.3);
    }
    
    body.tour-detail-open .top-btn:hover {
      background: #005a8b;
      border-color: #005a8b;
      box-shadow: 0 6px 20px rgba(0, 119, 182, 0.4);
    }
    
    .top-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,255,255,0.3);
    }
    
    .top-btn:active {
      background: rgba(255,255,255,0.35);
      transform: scale(0.97);
    }
    
    /* Language Selector */
    .language-selector {
      position: relative;
    }
    
    .language-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      overflow: hidden;
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-15px);
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  visibility 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
    }
    
    .language-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .language-option {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.2em;
      color: #2c3e50;
    }
    
    .language-option:hover {
      background: rgba(0,119,182,0.1);
    }
    
    .language-option span {
      font-size: 1.4em;
    }
    
    /* Currency Selector */
    .currency-selector {
      position: relative;
    }
    
    .currency-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      min-width: 280px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-15px);
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  visibility 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      z-index: 1000;
    }
    
    .currency-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .currency-option {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.1em;
      color: #2c3e50;
    }
    
    .currency-option:hover {
      background: rgba(0,119,182,0.1);
    }
    
    .currency-option span:first-child {
      font-size: 1.4em;
      min-width: 30px;
    }
    
    /* AI Chat Assistant */
    .chat-button {
      position: fixed;
      bottom: 30px;
      left: 30px;
      z-index: 999999 !important;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      font-size: 3em;
      cursor: pointer;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(255, 255, 255, 0.1) inset;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(0, 119, 182, 0.6);
    }
    
    .chat-button:active {
      transform: scale(0.95);
    }
    
    .chat-button.hidden {
      animation: shrinkOut 0.3s ease forwards;
      pointer-events: none;
    }
    
    .chat-button.show {
      animation: growIn 0.3s ease forwards;
    }
    
    @keyframes shrinkOut {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }
    
    @keyframes growIn {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .chat-interface {
      position: fixed;
      bottom: 120px;
      left: 30px;
      width: 450px;
      height: 600px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.2);
      display: none !important;
      flex-direction: column;
      z-index: 999999 !important;
      overflow: hidden;
      transition: all 0.4s ease;
    }
    
    .chat-interface.active {
      display: flex !important;
      animation: slideUp 0.3s ease;
    }
    
    .chat-interface.enlarged {
      width: 700px;
      height: 850px;
      bottom: 20px;
    }
    
    /* Larger text when enlarged */
    .chat-interface.enlarged .chat-message {
      font-size: 1.3em;
      line-height: 1.6;
      margin-bottom: 18px;
      padding: 16px 20px;
    }
    
    .chat-interface.enlarged .chat-input {
      font-size: 1.2em;
      padding: 16px 20px;
    }
    
    .chat-interface.enlarged .chat-send {
      font-size: 1.1em;
      padding: 14px 24px;
    }
    
    .chat-interface.enlarged .mic-button {
      font-size: 18px;
      padding: 16px 28px;
    }
    
    .chat-interface.enlarged .mic-text {
      font-size: 17px;
    }
    
    .chat-interface.enlarged .voice-status {
      padding: 14px 18px;
      font-size: 16px;
    }
    
    .chat-interface.enlarged .interim-text {
      font-size: 16px;
      padding: 14px 18px;
    }
    
    .chat-interface.enlarged .auto-speak-toggle {
      font-size: 16px;
    }
    
    .chat-interface.enlarged .chat-header h3 {
      font-size: 1.6em;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-header {
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-header h3 {
      margin: 0;
      font-size: 1.4em;
    }
    
    .chat-header-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .chat-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 2em;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-close:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .chat-restart {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.6em;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-restart:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(180deg);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .chat-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      animation: messageSlide 0.3s ease;
    }
    
    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-message.user {
      background: #0077b6;
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }
    
    .chat-message.assistant {
      background: #f0f4f8;
      color: #2c3e50;
      align-self: flex-start;
    }
    
    .chat-message.system {
      background: #e0eafc;
      color: #666;
      align-self: center;
      font-size: 0.9em;
      font-style: italic;
      max-width: 90%;
      text-align: center;
    }
    
    .chat-tours {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    
    .chat-tour-card {
      background: white;
      border: 2px solid #0077b6;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chat-tour-card:hover {
      background: #e0eafc;
      transform: translateX(5px);
    }
    
    .chat-tour-card h4 {
      margin: 0 0 5px 0;
      color: #0077b6;
      font-size: 1em;
    }
    
    .chat-tour-card p {
      margin: 0;
      color: #666;
      font-size: 0.9em;
    }
    
    .chat-input-container {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .chat-input:focus {
      border-color: #0077b6;
    }
    
    .chat-send {
      background: #0077b6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .chat-send:hover {
      background: #005a8b;
    }
    
    .chat-send:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Voice Controls */
    .voice-controls {
      padding: 16px 20px;
      border-top: 2px solid #e0e0e0;
      background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    .voice-divider {
      text-align: center;
      margin: 0 0 16px 0;
      color: #999;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .mic-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .mic-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .mic-button.listening {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      animation: pulse-mic 1.5s ease-in-out infinite;
    }
    
    .mic-button.speaking {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    @keyframes pulse-mic {
      0%, 100% { 
        box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 4px 30px rgba(245, 87, 108, 0.6);
        transform: scale(1.02);
      }
    }
    
    .mic-icon {
      width: 22px;
      height: 22px;
    }
    
    .voice-status {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      padding: 12px 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #f5576c;
    }
    
    .voice-indicator {
      position: relative;
      width: 16px;
      height: 16px;
    }
    
    .pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: #f5576c;
      animation: pulse-ring 1.5s ease-out infinite;
    }
    
    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 1;
      }
      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }
    
    .status-text {
      font-weight: 700;
      color: #f5576c;
      font-size: 14px;
    }
    
    .voice-status.speaking {
      border-color: #00f2fe;
    }
    
    .voice-status.speaking .pulse {
      background: #00f2fe;
    }
    
    .voice-status.speaking .status-text {
      color: #00a8b5;
    }
    
    .interim-text {
      margin-top: 12px;
      padding: 12px 16px;
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      border-radius: 8px;
      color: #856404;
      font-style: italic;
      font-size: 14px;
    }
    
    .auto-speak-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      user-select: none;
    }
    
    .auto-speak-toggle:hover {
      color: #333;
    }
    
    .auto-speak-toggle input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .chat-loading {
      display: flex;
      gap: 5px;
      padding: 12px 16px;
    }
    
    .chat-loading-dot {
      width: 8px;
      height: 8px;
      background: #0077b6;
      border-radius: 50%;
      animation: loadingDot 1.4s infinite;
    }
    
    .chat-loading-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .chat-loading-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes loadingDot {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }
    
    /* Audio Visualizer */
    .audio-visualizer {
      display: flex;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px 20px;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: height 0.3s ease;
    }
    
    /* Bars stay flat when idle */
    .visualizer-bar {
      width: 4px;
      height: 15%;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 2px;
      transition: height 0.2s ease, opacity 0.2s ease, background 0.2s ease;
    }
    
    /* Bars animate when active (speaking) */
    .audio-visualizer.active .visualizer-bar {
      background: rgba(255, 255, 255, 0.9);
      animation: visualize 0.5s ease-in-out infinite;
    }
    
    .audio-visualizer.active .visualizer-bar:nth-child(1) { animation-delay: 0s; }
    .audio-visualizer.active .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
    .audio-visualizer.active .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
    .audio-visualizer.active .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
    .audio-visualizer.active .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }
    .audio-visualizer.active .visualizer-bar:nth-child(6) { animation-delay: 0.3s; }
    .audio-visualizer.active .visualizer-bar:nth-child(7) { animation-delay: 0.2s; }
    .audio-visualizer.active .visualizer-bar:nth-child(8) { animation-delay: 0.1s; }
    .audio-visualizer.active .visualizer-bar:nth-child(9) { animation-delay: 0s; }
    .audio-visualizer.active .visualizer-bar:nth-child(10) { animation-delay: 0.1s; }
    
    @keyframes visualize {
      0%, 100% {
        height: 15%;
        opacity: 0.6;
      }
      50% {
        height: 85%;
        opacity: 1;
      }
    }
    
    /* Larger visualizer when chat is enlarged */
    .chat-interface.enlarged .audio-visualizer {
      height: 50px;
      padding: 12px 20px;
    }
    
    .chat-interface.enlarged .visualizer-bar {
      width: 6px;
    }
    
    /* Weather Widget */
    .weather-widget {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      max-width: 400px;
      z-index: 999;
      transition: all 0.3s ease;
    }
    
    .weather-widget.collapsed .weather-content {
      display: none;
    }
    
    .weather-widget.collapsed .weather-toggle {
      transform: rotate(-90deg);
    }
    
    .weather-header {
      padding: 20px;
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      color: white;
      border-radius: 16px 16px 0 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    
    .weather-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3em;
      font-weight: 600;
    }
    
    .weather-title span:first-child {
      font-size: 1.5em;
    }
    
    .weather-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2em;
      cursor: pointer;
      transition: transform 0.3s ease;
      padding: 5px;
    }
    
    .weather-content {
      padding: 20px;
      /* No max-height or overflow for touchscreen - show everything */
    }
    
    .current-weather {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e7ee;
    }
    
    .current-temp-display {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 10px;
    }
    
    .weather-icon-large {
      font-size: 3em;
    }
    
    .temp-info {
      flex: 1;
    }
    
    .temp-large {
      font-size: 2.5em;
      font-weight: 700;
      color: #0077b6;
      line-height: 1;
    }
    
    .weather-desc {
      font-size: 1.2em;
      color: #666;
      margin-top: 5px;
    }
    
    .wind-info {
      font-size: 1.1em;
      color: #666;
    }
    
    .forecast-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .forecast-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .forecast-day {
      flex: 0 0 calc(25% - 6px); /* 4 items per row (25% each minus gap) */
    }
    
    /* Last 3 days will auto-center due to justify-content: center */
    .forecast-container .forecast-day:nth-child(n+5) {
      flex: 0 0 calc(25% - 6px); /* Keep same width for consistency */
    }
    
    .forecast-day {
      background: #f8f9fa;
      padding: 10px 6px;
      border-radius: 8px;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .forecast-day:hover {
      background: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .forecast-day-name {
      font-size: 0.75em;
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
    }
    
    .forecast-icon {
      font-size: 1.6em;
      margin: 5px 0;
    }
    
    .forecast-temps {
      display: flex;
      justify-content: center;
      gap: 5px;
      font-size: 0.8em;
      margin-top: 3px;
    }
    
    .temp-max {
      color: #0077b6;
      font-weight: 600;
    }
    
    .temp-min {
      color: #999;
    }
    
    .forecast-rain {
      font-size: 0.7em;
      color: #0077b6;
      margin-top: 3px;
    }
    
    .best-time-section {
      padding: 12px;
        bottom: 20px;
        right: 20px;
        left: auto !important;
        max-width: none;
      }
      
      .forecast-container {
        /* Keep same 4-top, 3-bottom layout on mobile */
        gap: 5px;
      }
      
      .forecast-day {
        flex: 0 0 calc(25% - 4px); /* Slightly smaller gap on mobile */
      }
      
      .forecast-day {
        padding: 8px 4px;
      }
      
      .forecast-day-name {
        font-size: 0.7em;
      }
      
      .forecast-icon {
        font-size: 1.4em;
      }
      
      .forecast-temps {
        font-size: 0.75em;
      }
      
      .weather-icon-large {
        font-size: 2.5em;
      }
      
      .temp-large {
        font-size: 2em;
      }
    }
    
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      padding: 0;
      font-size: 16px; /* Increased base font size for better readability */
    }
    
    .leaflet-popup-content {
      margin: 0;
      min-width: 250px;
      font-size: 1.2em; /* Make all popup text larger */
      line-height: 1.6;
    }
    
    .map-popup-header {
      background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
      color: white;
      padding: 20px;
      font-size: 1.6em;
      font-weight: 700;
      border-radius: 12px 12px 0 0;
    }
    
    .map-popup-tours {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .map-tour-item {
      padding: 18px;
      margin-bottom: 12px;
      background: #f8f9fa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 5px solid #0077b6;
    }
    
    .map-tour-item:hover {
      background: #e8f4f8;
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .map-tour-name {
      font-weight: 700;
      color: #0077b6;
      font-size: 1.4em;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .map-tour-company {
      color: #666;
      font-size: 1.2em;
    }
    
    .map-tour-price {
      color: #2e7d32;
      font-weight: 600;
      margin-top: 8px;
      font-size: 1.2em;
    }
    
    
    /* Hide mobile menu on desktop */
    .mobile-menu-btn, .mobile-menu-dropdown {
      display: none;
    }
    
    /* ===========================
       COMPREHENSIVE MOBILE STYLES v2.0
       =========================== */
    @media screen and (max-width: 768px) {
      /* Filter Panel - much more compact */
      #filter-panel {
        padding: 10px 8px 12px 8px;
      }
      
      /* Budget Slider - Much smaller to fit on screen */
      .budget-slider-container {
        padding: 15px 10px !important;
        max-width: 100% !important;
      }
      
      .budget-label-display {
        font-size: 0.9em !important;
        margin-bottom: 12px !important;
      }
      
      .budget-slider {
        height: 12px !important;
      }
      
      .budget-slider::-webkit-slider-runnable-track {
        height: 12px !important;
      }
      
      .budget-slider::-moz-range-track {
        height: 12px !important;
      }
      
      .budget-slider::-webkit-slider-thumb {
        width: 45px !important;
        height: 45px !important;
        margin-top: -17px !important;
        border-width: 4px !important;
      }
      
      .budget-slider::-moz-range-thumb {
        width: 45px !important;
        height: 45px !important;
        border-width: 4px !important;
      }
      
      .budget-markers {
        margin-top: 25px !important;
        gap: 5px !important;
      }
      
      .budget-marker {
        font-size: 0.7em !important;
        padding: 5px 3px !important;
        line-height: 1.2 !important;
      }
      
      #filter-panel h1 {
        font-size: 1.2em !important;
        margin: 0 0 8px 0;
      }
      
      .filter-progress {
        font-size: 0.75em;
        margin-bottom: 6px;
      }
      
      .progress-bar-container {
        height: 3px;
        margin-bottom: 8px;
      }
      
      .question-text {
        font-size: 0.95em !important;
        margin-bottom: 10px;
      }
      
      .filter-option {
        font-size: 0.8em !important;
        padding: 10px 8px !important;
        min-height: 45px;
        border-width: 2px;
      }
      
      /* Tour Grid - 2 COLUMNS on mobile! */
      #tour-placeholder-row {
        padding: 8px;
        gap: 8px;
        grid-template-columns: 1fr !important;
        grid-auto-rows: auto;
      }
      
      /* Horizontal tour cards with background image */
      .tour-card {
        max-width: 100%;
        padding: 0 !important;
        border-radius: 10px;
        display: block !important;
        position: relative;
        height: 120px !important;
        min-height: 120px !important;
        overflow: hidden;
        cursor: pointer;
        /* Background set via inline style in JS */
      }
      
      /* Dark overlay for readability */
      .tour-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.75) 100%);
        z-index: 1;
        pointer-events: none;
      }
      
      .tour-card img {
        display: none !important;
      }
      
      .tour-card > div {
        position: relative;
        z-index: 2;
        padding: 6px 8px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        color: white !important;
      }
      
      .tour-card .tour-company {
        font-size: 7px !important;
        opacity: 0.95;
        margin-bottom: 1px;
        font-weight: 500;
        line-height: 1;
      }
      
      .tour-card h3 {
        font-size: 8px !important;
        margin-bottom: 2px;
        line-height: 1.1;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        color: white !important;
        font-weight: 600;
      }
      
      .tour-card p {
        display: none !important;
      }
      
      .tour-rating {
        font-size: 7px !important;
        margin: 1px 0 2px 0;
        color: white !important;
        line-height: 1;
      }
      
      .tour-rating .stars {
        font-size: 8px !important;
      }
      
      .tour-rating .review-count {
        font-size: 7px !important;
        margin-left: 1px;
      }
      
      .tour-duration, .tour-location {
        font-size: 6px !important;
        padding: 2px 3px;
        margin: 2px 2px 0 0;
        display: inline-block;
        background: rgba(255,255,255,0.3) !important;
        color: white !important;
        border-radius: 3px;
        line-height: 1;
      }
      
      .tour-price {
        font-size: 9px !important;
        margin-top: 2px;
        font-weight: 700;
        color: white !important;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        line-height: 1;
      }
      
      /* Tour Detail Page - Much more compact */
      #back-arrow {
        top: 10px;
        left: 10px;
        font-size: 1.4em;
        width: 38px;
        height: 38px;
      }
      
      #detail-content {
        margin: 60px 10px 20px 10px;
        padding: 15px 12px;
      }
      
      #detail-title {
        font-size: 1.2em;
        margin-bottom: 6px;
      }
      
      #detail-company {
        font-size: 0.85em;
        padding: 4px 8px;
        margin-bottom: 10px;
      }
      
      #detail-summary {
        font-size: 0.9em;
        margin-bottom: 10px;
      }
      
      #detail-description {
        font-size: 0.9em;
        line-height: 1.5;
        margin-bottom: 12px;
      }
      
      #detail-info {
        font-size: 0.75em;
        margin-bottom: 8px;
      }
      
      #detail-info ul {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      
      #detail-info li {
        padding: 4px 8px;
        margin-bottom: 0;
        display: inline-flex;
        align-items: center;
        flex: 0 1 auto;
      }
      
      .detail-section-title {
        font-size: 0.9em;
        margin-top: 10px;
        margin-bottom: 6px;
      }
      
      /* Make includes/highlights/etc display inline/horizontal */
      #detail-content > div > div {
        padding: 12px !important;
      }
      
      #detail-content h3 {
        font-size: 1em !important;
        margin: 0 0 8px 0 !important;
      }
      
      #detail-content ul {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 6px !important;
        font-size: 0.8em !important;
      }
      
      #detail-content ul li {
        display: inline-block !important;
        padding: 4px 8px !important;
        margin: 0 !important;
        background: rgba(255,255,255,0.5) !important;
        border-radius: 4px !important;
      }
      
      /* Force includes/highlights to stack vertically (1 column) on mobile */
      #detail-content > div[style*="display"],
      #detail-content > div[style*="grid"],
      #detail-content div[style*="grid-template-columns"] {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }
      
      #detail-content > div > div[style*="background"],
      #detail-content div[style*="padding:25px"] {
        padding: 15px !important;
        border-radius: 8px !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* Better text wrapping in detail sections */
      #detail-content div[style*="background"] * {
        word-wrap: break-word !important;
        word-break: normal !important;
        hyphens: auto !important;
      }
      
      #detail-content div[style*="background"] h3,
      #detail-content div[style*="background"] h4 {
        font-size: 1em !important;
        margin-bottom: 8px !important;
      }
      
      #detail-content div[style*="background"] p,
      #detail-content div[style*="background"] li {
        font-size: 0.85em !important;
        line-height: 1.5 !important;
      }
      
      /* Image Gallery - Smaller */
      .image-gallery {
        margin-bottom: 12px;
      }
      
      .main-image {
        height: 200px;
      }
      
      .thumbnail-strip {
        gap: 5px;
        padding: 5px 0;
      }
      
      .thumbnail {
        height: 50px;
      }
      
      /* Buttons - More compact */
      .detail-btn {
        padding: 10px 18px;
        font-size: 0.9em;
        margin: 5px 0;
      }
      
      
      /* Hide top navigation buttons on mobile - replace with hamburger menu */
      .clear-filters-btn, .view-toggle-btn {
        display: none !important;
      }
      
      .nav-buttons {
        display: none !important;
      }
      
      /* Hide top button bar (language/currency) on mobile - moved to hamburger */
      .top-button-bar {
        display: none !important;
      }
      
      /* Hamburger Menu Button - Moved to right */
      .mobile-menu-btn {
        display: flex !important;
        position: fixed;
        top: 10px;
        right: 10px !important;
        left: auto !important;
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.5em;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1001;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      /* Mobile Menu Dropdown - Positioned from right */
      .mobile-menu-dropdown {
        display: none;
        position: fixed;
        top: 60px;
        right: 10px !important;
        left: auto !important;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 200px;
        max-width: 280px;
        max-height: calc(100vh - 70px);
        overflow-y: auto;
      }
      
      .mobile-menu-dropdown.active {
        display: block !important;
      }
      
      .mobile-menu-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        font-size: 0.9em;
        background: white;
        border: none;
        width: 100%;
        text-align: left;
        transition: background 0.2s;
      }
      
      .mobile-menu-item:last-child {
        border-bottom: none;
      }
      
      .mobile-menu-item:active {
        background: #f5f5f5;
      }
      
      .mobile-menu-item span:first-child {
        font-size: 1.2em;
      }
      
      /* Submenu items */
      .mobile-submenu {
        background: #f9f9f9;
      }
      
      .mobile-submenu-item {
        font-size: 0.85em !important;
        padding: 10px 15px 10px 35px !important;
        background: #f9f9f9 !important;
      }
      
      .mobile-submenu-item:active {
        background: #eeeeee !important;
      }
      
      /* Chat Interface - Same size as weather widget */
      /* Old fixed 150px chat-button rule removed - using responsive sizing below */
      
      .chat-button::before {
        content: "🎤" !important;
        font-size: 1.6em !important;
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      .chat-button img {
        display: none !important;
      }
      
      #chat-interface {
        width: 85vw;
        height: 50vh;
        max-width: 85vw;
        max-height: 50vh;
        border-radius: 12px;
        bottom: 65px;
        left: 8px;
        right: auto;
      }
      
      .chat-header {
        padding: 4px 6px !important;
      }
      
      .chat-header h3 {
        font-size: 11px !important;
      }
      
      .chat-close, .chat-restart {
        width: 20px !important;
        height: 20px !important;
        font-size: 12px !important;
      }
      
      #chat-messages {
        padding: 4px !important;
        font-size: 10px !important;
      }
      
      .chat-message {
        padding: 4px 6px !important;
        font-size: 10px !important;
        max-width: 85%;
        margin-bottom: 4px !important;
      }
      
      .chat-message.system {
        font-size: 9px !important;
      }
      
      .tour-card-in-chat {
        padding: 4px !important;
      }
      
      .tour-card-in-chat h4 {
        font-size: 10px !important;
      }
      
      .tour-card-in-chat .tour-price {
        font-size: 10px !important;
      }
      
      #chat-input-container {
        padding: 4px !important;
        gap: 3px !important;
      }
      
      #chat-input {
        font-size: 10px !important;
        padding: 4px 6px !important;
      }
      
      #chat-send, #chat-voice {
        width: 24px !important;
        height: 24px !important;
        font-size: 11px !important;
      }
      
      /* Send to Phone Button - More compact */
      .send-to-phone-btn {
        font-size: 9px !important;
        padding: 5px 8px !important;
        margin: 4px 0 !important;
      }
      
      /* QR Modal - More compact */
      .qr-modal-content {
        width: 90%;
        max-width: 350px;
        padding: 15px;
      }
      
      .qr-modal-title {
        font-size: 1.1em;
        margin-bottom: 8px;
      }
      
      .qr-modal-subtitle {
        font-size: 0.85em;
        margin-bottom: 12px;
      }
      
      .qr-code-container {
        padding: 12px;
        margin: 12px 0;
      }
      
      .qr-code-container canvas {
        max-width: 180px !important;
        max-height: 180px !important;
      }
      
      .qr-link {
        font-size: 0.75em;
        padding: 8px;
        margin: 8px 0;
      }
      
      .qr-modal-actions {
        gap: 8px;
      }
      
      .qr-modal-btn {
        padding: 10px 16px;
        font-size: 0.9em;
      }
      
      /* Map View */
      #map-container {
        height: calc(100vh - 60px);
      }
      
      .leaflet-popup-content {
        font-size: 0.9em;
      }
      
      /* Reviews - More compact */
      .review-card {
        padding: 10px;
        margin-bottom: 8px;
      }
      
      .review-text {
        font-size: 0.85em;
        line-height: 1.4;
      }
      
      .review-author {
        font-size: 0.75em;
        margin-top: 6px;
      }
      
      .review-rating {
        font-size: 0.9em;
      }
      
      /* FAQ - More compact */
      .faq-item {
        padding: 10px;
        margin-bottom: 6px;
      }
      
      .faq-question {
        font-size: 0.9em;
        padding-right: 30px;
      }
      
      .faq-answer {
        font-size: 0.8em;
        padding-top: 6px;
      }
      
      /* Tags and Badges - Smaller */
      .activity-tag, .duration-badge, .location-tag {
        font-size: 0.7em;
        padding: 3px 6px;
        margin: 2px;
      }
      
      /* Company Tours View - More compact */
      .company-header h2 {
        font-size: 1.2em;
      }
      
      .company-description {
        font-size: 0.85em;
        line-height: 1.4;
      }
      
      /* Weather Widget - Removed fixed 150px size, using responsive sizing from main mobile section */
      
      .weather-widget.collapsed .weather-header,
      .weather-widget.collapsed .weather-content,
      .weather-widget.collapsed .weather-toggle,
      .weather-widget.collapsed h4,
      .weather-widget.collapsed > * {
        display: none !important;
      }
      
      .weather-widget.collapsed::before {
        content: "🌤️";
        font-size: 1.6em !important;
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
        pointer-events: none !important;
        position: relative;
        z-index: 1;
      }
      
      /* When expanded */
      .weather-widget:not(.collapsed) {
        bottom: 70px !important;
        right: 8px !important;
        left: auto !important;
        max-width: 280px !important;
        font-size: 0.75em;
        border-radius: 12px !important;
      }
      
      .weather-widget:not(.collapsed) .weather-header {
        padding: 8px 10px !important;
        border-radius: 12px 12px 0 0 !important;
      }
      
      .weather-widget:not(.collapsed) .weather-header h4 {
        font-size: 0.9em !important;
        margin: 0 !important;
      }
      
      .weather-widget:not(.collapsed) .weather-toggle {
        font-size: 0.9em !important;
      }
      
      .weather-content {
        padding: 8px !important;
      }
      
      .current-weather {
        padding: 8px !important;
      }
      
      .weather-icon {
        font-size: 2em !important;
      }
      
      .weather-temp {
        font-size: 1.8em !important;
      }
      
      .forecast-container {
        /* Keep 4-top, 3-bottom layout in kiosk mode */
        gap: 4px !important;
        padding: 8px 0 !important;
      }
      
      .forecast-day {
        flex: 0 0 calc(25% - 3px) !important; /* 4 per row in kiosk mode */
      }
      
      .forecast-day {
        padding: 4px 2px !important;
      }
      
      .forecast-day h5 {
        font-size: 0.7em !important;
      }
      
      .forecast-temp {
        font-size: 0.75em !important;
      }
      
      .best-time-card {
        padding: 8px !important;
        margin: 8px 0 !important;
      }
      
      .best-time-card h4 {
        font-size: 0.85em !important;
      }
      
      .best-time-card p {
        font-size: 0.75em !important;
      }
      
      /* Language Selector */
      .language-selector {
        padding: 8px 12px;
        font-size: 0.9em;
      }
      
      /* View Toggle */
      .view-toggle-btn {
        padding: 12px 18px !important;
        font-size: 0.95em !important;
      }
    }
    
    /* Extra small phones - Even more compact */
    @media (max-width: 480px) {
      #filter-panel {
        padding: 10px 8px 12px 8px;
      }
      
      #filter-panel h1 {
        font-size: 1.2em !important;
      }
      
      .question-text {
        font-size: 1em !important;
      }
      
      .filter-option {
        font-size: 0.85em !important;
        padding: 10px 8px !important;
        min-height: 45px;
      }
      
      #detail-title {
        font-size: 1.1em;
      }
      
      #detail-content {
        margin: 55px 8px 15px 8px;
        padding: 12px 10px;
      }
      
      .tour-card h3 {
        font-size: 0.95em;
      }
      
      .tour-card {
        padding: 10px;
      }
      
      .chat-message {
        font-size: 0.8em;
        padding: 6px 8px;
      }
      
      #chat-input {
        font-size: 0.85em;
        padding: 8px 10px;
      }
      
      .chat-header {
        padding: 8px 10px;
      }
      
      .nav-btn, .clear-filters-btn {
        padding: 6px 10px !important;
        font-size: 0.75em !important;
      }
      
      .weather-widget {
        font-size: 0.65em;
        padding: 4px 6px;
        min-width: 100px;
      }
    }
    
    
    
    /* Breakpoint: Extra Small (360px) */
    @media (max-width: 360px) {
      .video-question-card {
        max-width: 100%;
      }
      
      h2.vq-question,
      #vq-question-text {
        font-size: clamp(1.1rem, 6vw, 1.5rem) !important;
      }
    }
    
    /* Breakpoint: Small Phones (480px) */
    @media (min-width: 481px) and (max-width: 768px) {
      .video-question-card {
        max-width: 500px;
      }
    }

    /* ===================================================================
       RESPONSIVE BREAKPOINTS - Mobile First Approach
       =================================================================== */
    
    /* Tablet and below - adjust main layouts */
    @media (max-width: 1024px) {
      /* Reduce fixed widths */
      /* Global header mobile styles */
      .global-header {
        height: 60px !important;
        padding: 10px 15px !important;
      }
      
      .global-back-button {
        width: 40px !important;
        height: 40px !important;
        font-size: 1.5em !important;
        flex-shrink: 0 !important;
        z-index: 10001 !important;
        display: flex !important;
      }
      
      .global-logo-image {
        height: 32px !important;
        position: absolute !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        z-index: 1 !important;
      }
      
      .global-header-left {
        gap: 10px !important;
        flex: 0 0 auto !important;
        min-width: 50px !important;
        z-index: 10001 !important;
      }
      
      .global-header-right {
        gap: 8px !important;
        flex: 0 0 auto !important;
        justify-content: flex-end !important;
        z-index: 10001 !important;
      }
      
      .global-header .chip {
        font-size: 0.75em !important;
        padding: 6px 10px !important;
        min-height: 32px !important;
        height: 32px !important;
        min-width: 45px !important;
      }
      
      .page {
        padding-top: 60px !important;
      }
      
      .video-question-page {
        padding-top: 0 !important;
      }
      
      .video-start-screen {
        padding-top: 80px !important;
      }
      
      .kiosk-header {
        padding: 15px 30px !important;
      }
      
      .home-main, .tour-list-main {
        padding: 20px !important;
      }
      
      /* Stack filters vertically on smaller screens */
      .duration-grid {
        grid-template-columns: 1fr !important;
        max-width: 500px !important;
        margin: 0 auto !important;
      }
      
      /* Make tour cards responsive */
      .tour-card {
        max-width: 100% !important;
      }
      
      /* Adjust font sizes */
      .hero-title {
        font-size: 2.5em !important;
      }
      
      .hero-question {
        font-size: 1.8em !important;
      }
    }
    
    /* Mobile phones */
    @media (max-width: 768px) {
      /* HOME PAGE - Match device width with proper scaling */
      .page.home-page.active {
        width: 100vw !important;
        min-width: 100vw !important;
        transform: none !important;
      }
      
      /* Fix header - compact, at very top of screen - UNIFORM ACROSS ALL PAGES */
      .kiosk-header {
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0 !important;
        padding: 7px 0px !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        height: 52px !important;
        min-height: 52px !important;
        max-height: 52px !important;
        z-index: 10000 !important;
        background: rgba(255, 255, 255, 0.15) !important;
        backdrop-filter: blur(10px) !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
      }
      
      /* Show logo in center - same across all pages */
      .kiosk-header .logo-image {
        display: block !important;
        height: 38px !important;
        width: auto !important;
        position: absolute !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        z-index: 1 !important;
        max-width: 140px !important;
        object-fit: contain !important;
      }
      
      .kiosk-header .header-left {
        display: flex !important;
        align-items: center !important;
        flex: 0 0 auto !important;
        margin-right: 0 !important;
        position: relative !important;
      }
      
      .header-spacer {
        display: none !important;
      }
      
      /* Back button - compact, left aligned, same height as other buttons */
      .back-button,
      .tour-detail-page .back-button,
      .kiosk-header .back-button {
        width: 38px !important;
        height: 38px !important;
        padding: 0 !important;
        font-size: 1.2em !important;
        border-radius: 8px !important;
        flex-shrink: 0 !important;
        z-index: 2 !important;
        position: relative !important;
        margin: 0 !important;
        left: 0 !important;
      }
      
      .kiosk-header .header-right {
        position: absolute !important;
        right: 0 !important;
        left: auto !important;
        top: 0 !important;
        bottom: 0 !important;
        transform: none !important;
        display: flex !important;
        gap: 3px !important;
        flex: 0 0 auto !important;
        align-items: center !important;
        justify-content: flex-end !important;
        z-index: 2 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-right: 3px !important;
        padding-left: 0 !important;
      }
      
      /* Hide map view button on mobile tour detail */
      .tour-detail-page .header-right .chip-outline,
      .tour-detail-page .header-right #map-toggle-btn,
      .kiosk-header .header-right .chip-outline,
      .kiosk-header .header-right #map-toggle-btn {
        display: none !important;
      }
      
      /* Language and currency buttons - MATCH BACK ARROW HEIGHT (38px) */
      .kiosk-header .header-right .chip,
      .kiosk-header .language-selector button,
      .kiosk-header .currency-selector button,
      .kiosk-header .header-right .language-selector button,
      .kiosk-header .header-right .currency-selector button {
        padding: 0 !important;
        font-size: 0.7em !important;
        min-width: 38px !important;
        max-width: 38px !important;
        width: 38px !important;
        min-height: 38px !important;
        height: 38px !important;
        max-height: 38px !important;
        line-height: 38px !important;
        text-align: center !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        vertical-align: middle !important;
        overflow: hidden !important;
      }
      
      /* Language and currency DROPDOWN MENUS - mobile styles */
      .language-menu,
      .currency-menu {
        position: absolute !important;
        top: 100% !important;
        bottom: auto !important;
        right: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px) !important;
        border-radius: 8px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
        min-width: 180px !important;
        max-width: 250px !important;
        font-size: 0.85em !important;
        margin-top: 8px !important;
        z-index: 10000 !important;
        overflow: hidden !important;
        /* Animation properties */
        opacity: 0 !important;
        visibility: hidden !important;
        transform: translateY(-15px) !important;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      .language-menu.active,
      .currency-menu.active {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
      }
      
      .language-option,
      .currency-option {
        padding: 10px 15px !important;
        font-size: 0.95em !important;
        color: #2c3e50 !important;
        background: transparent !important;
      }
      
      .language-option:hover,
      .currency-option:hover {
        background: rgba(0,119,182,0.15) !important;
      }
      
      /* Ensure all pages have padding for fixed header */
      .page.home-page,
      .page.tour-list-page {
        padding-top: 50px !important;
      }
      
      /* HOME PAGE & TOUR LIST - Headers inherit from main .kiosk-header styles above */
      
      /* Home/Tour List page - hide map view, show search bar */
      .page.home-page #home-map-toggle-btn,
      .page.tour-list-page #map-toggle-btn {
        display: none !important;
      }
      
      /* Search bar - FULL SCREEN WIDTH - Override inline styles */
      .page.home-page .search-wrapper,
      .page.tour-list-page .search-wrapper {
        display: block !important;
        position: relative !important;
        width: 98% !important;
        max-width: none !important;
        margin: 10px auto 15px auto !important;
        z-index: 5 !important;
        padding: 0 !important;
      }
      
      .page.home-page .search-wrapper input,
      .page.tour-list-page .search-wrapper input {
        width: 100% !important;
        font-size: 1.6em !important;
        padding: 22px 35px !important;
        text-align: center !important;
        border-radius: 50px !important;
        font-weight: 500 !important;
      }
      
      /* Override inline styles on search input by ID */
      #home-search-input {
        width: 96% !important;
        max-width: 96% !important;
        min-width: 96% !important;
        padding: 20px 30px !important;
        font-size: 1.6em !important;
        margin: 0 auto !important;
        display: block !important;
      }
      
      /* Override parent div inline styles */
      #home-search-input + button {
        display: none !important;
      }
      
      .page.home-page > div[style*="padding: 0 100px"],
      .page.home-page div[style*="max-width: 1600px"] {
        padding: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
      }
      
      /* Home/Tour List - Apply same logo styling */
      .page.home-page .kiosk-header .logo-image,
      .page.tour-list-page .kiosk-header .logo-image {
        display: block !important;
        height: 38px !important;
        width: auto !important;
        position: absolute !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        z-index: 1 !important;
        max-width: 140px !important;
        object-fit: contain !important;
      }
      
      /* Home/Tour List - Apply same header-right styling */
      .page.home-page .kiosk-header .header-right,
      .page.tour-list-page .kiosk-header .header-right {
        position: absolute !important;
        right: 0 !important;
        left: auto !important;
        top: 0 !important;
        bottom: 0 !important;
        transform: none !important;
        display: flex !important;
        gap: 3px !important;
        flex: 0 0 auto !important;
        align-items: center !important;
        justify-content: flex-end !important;
        z-index: 2 !important;
        margin: 0 !important;
        padding-right: 3px !important;
      }
      
      /* Tour list - hide header-left content */
      .page.tour-list-page .kiosk-header .header-left {
        display: none !important;
      }
      
      /* Home page - show header-left with back arrow */
      .page.home-page .kiosk-header .header-left {
        display: flex !important;
        position: relative !important;
        z-index: 2 !important;
      }
      
      /* Home page quick decision button - top left corner */
      .page.home-page .quick-decision-btn-header {
        display: flex !important;
        position: absolute !important;
        left: 6px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        z-index: 2 !important;
        font-size: 0.75em !important;
        padding: 8px 12px !important;
        min-height: 38px !important;
        height: 38px !important;
        align-items: center !important;
        justify-content: center !important;
      }
      
      /* Home page header-left just for logo (back arrow positioned separately) */
      .page.home-page .kiosk-header .header-left {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
      
      /* Show logo on home page in center */
      .page.home-page .kiosk-header .logo-image {
        display: block !important;
        position: absolute !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        height: 38px !important;
        z-index: 1 !important;
      }
      
      /* Tour list page - hide back button */
      .page.tour-list-page .back-button {
        display: none !important;
      }
      
      /* Back arrow - top left corner */
      #back-arrow,
      .back-btn {
        position: fixed !important;
        top: 8px !important;
        left: 8px !important;
        z-index: 10000 !important;
        width: 36px !important;
        height: 36px !important;
        padding: 6px !important;
        font-size: 1em !important;
      }
      
      .search-wrapper {
        display: none !important;
      }
      
      .home-main {
        padding: 15px !important;
      }
      
      /* Scale down home page headings MORE */
      .home-main h1,
      .home-main .hero-title {
        font-size: 1.4em !important;
        margin: 10px 0 !important;
      }
      
      .home-main h2 {
        font-size: 1.1em !important;
        margin: 8px 0 !important;
      }
      
      .home-main h3 {
        font-size: 1em !important;
      }
      
      .home-main p {
        font-size: 0.95em !important;
      }
      
      /* Hero card - reduce padding to use full screen width */
      .hero-card {
        padding: 30px 15px !important;
      }
      
      /* Filter summary bar - compact and horizontal */
      .filter-summary,
      .filter-summary-bar {
        padding: 10px 12px !important;
        margin-bottom: 12px !important;
      }
      
      .filter-summary-title {
        font-size: 0.9em !important;
        margin-bottom: 6px !important;
      }
      
      .filter-summary-content {
        display: flex !important;
        gap: 6px !important;
        overflow-x: auto !important;
        flex-wrap: nowrap !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important;
        align-items: center !important;
      }
      
      /* Selected filters - horizontal with scroll */
      .selected-filters {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        gap: 6px !important;
        flex: 1 !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      .filter-summary-item,
      .filter-tag {
        font-size: 0.8em !important;
        padding: 5px 10px !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
      }
      
      /* Back and Start Over buttons in summary */
      .back-nav-btn,
      .start-over-btn {
        font-size: 0.8em !important;
        padding: 6px 12px !important;
        flex-shrink: 0 !important;
      }
      
      .duration-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
        max-width: 100% !important;
        padding: 0 !important;
        width: 100% !important;
        margin: 0 !important;
      }
      
      .duration-pill {
        font-size: 0.8em !important;
        padding: 10px 8px !important;
        min-height: auto !important;
        width: 100% !important;
      }
      
      .duration-pill span {
        font-size: 0.7em !important;
      }
      
      /* Selected activity buttons - green with white glow */
      .duration-pill.selected,
      .duration-pill--selected {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 8px 20px rgba(72, 187, 120, 0.4) !important;
        border: 2px solid rgba(255, 255, 255, 0.9) !important;
        transform: scale(1.02) !important;
      }
      
      /* "No preference" buttons span full width */
      .duration-pill--ghost {
        grid-column: 1 / -1 !important;
      }
      
      /* Continue button - ORANGE like browse all tours */
      .filter-continue-btn,
      .continue-btn,
      button[onclick*="advanceQuestion"],
      button[onclick*="showResultsPage"] {
        background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%) !important;
        color: white !important;
        box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4) !important;
        border: none !important;
      }
      
      /* Show me everything button - keep blue */
      button[onclick*="showEverything"] {
        background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%) !important;
      }
      
      .filter-option,
      .duration-option {
        font-size: 1em !important;
        padding: 18px 12px !important;
      }
      
      /* Browse All Tours page scaling - AGGRESSIVE */
      .tour-list-main h1,
      .tour-list-header h1 {
        font-size: 1.1em !important;
        padding: 6px !important;
        margin: 4px 0 !important;
      }
      
      .tour-list-main > p,
      .tour-list-main .subtitle {
        font-size: 0.9em !important;
        margin: 2px 0 !important;
      }
      
      .tour-list-main {
        padding: 10px 8px !important;
      }
      
      /* Tour list page headings - scale down */
      .list-title,
      .tour-list-page h1 {
        font-size: 1.4em !important;
        margin: 10px 0 !important;
        padding: 0 5px !important;
      }
      
      .results-info,
      .tour-list-page .results-info {
        font-size: 0.9em !important;
        margin: 5px 0 10px 0 !important;
        padding: 0 5px !important;
      }
      
      /* Tour grid - 3 COLUMNS, everything scales with screen width */
      .tour-grid,
      .tour-grid--2col {
        display: grid !important;
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: clamp(6px, 1.5vw, 10px) !important;
        width: 100% !important;
        padding: 0 clamp(5px, 1.5vw, 8px) !important;
      }
      
      /* Tour cards - scale with viewport */
      .tour-card,
      .tour-card-large {
        min-height: clamp(160px, 28vw, 220px) !important;
        max-height: clamp(180px, 30vw, 240px) !important;
      }
      
      /* Tour card images - scale with viewport */
      .tour-card img,
      .tour-card-large img,
      .tour-card-image {
        max-height: clamp(80px, 15vw, 110px) !important;
        min-height: clamp(80px, 15vw, 110px) !important;
        height: clamp(80px, 15vw, 110px) !important;
      }
      
      /* Tour card titles - scale with viewport */
      .tour-card h3,
      .tour-card .tour-name,
      .tour-card-large h3,
      .tour-card-title {
        font-size: clamp(0.65em, 1.8vw, 0.85em) !important;
        line-height: 1.15 !important;
        padding: 0 clamp(2px, 1vw, 4px) !important;
      }
      
      /* Tour card rating - scale with viewport */
      .tour-card .tour-rating,
      .tour-card .review-count,
      .tour-card-large .tour-rating,
      .tour-rating-display {
        font-size: clamp(0.6em, 1.5vw, 0.75em) !important;
      }
      
      /* Tour card price - scale with viewport */
      .tour-card .tour-price,
      .tour-card-large .tour-price,
      .price-display {
        font-size: clamp(0.65em, 1.6vw, 0.8em) !important;
        padding: clamp(3px, 1vw, 5px) clamp(6px, 1.5vw, 8px) !important;
      }
      
      /* Tour cards - scale down AGGRESSIVELY, FIX BLACK BOXES */
      .tour-card,
      .tour-card-large {
        min-height: 180px !important;
        height: auto !important;
        max-height: 220px !important;
        padding: 0 !important;
        margin: 0 !important;
        background: #fff !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        position: relative !important;
      }
      
      /* Tour card overlay - text over image with gradient */
      .tour-card-overlay {
        position: absolute !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%) !important;
        color: white !important;
        padding: clamp(6px, 2vw, 10px) clamp(8px, 2.5vw, 12px) !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-end !important;
        gap: clamp(3px, 1vw, 5px) !important;
      }
      
      /* Make tour card image fill entire card */
      .tour-card-image {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-size: cover !important;
        background-position: center !important;
      }
      
      /* Tour meta and text styling - white text over images */
      .tour-card-overlay .tour-name,
      .tour-card-overlay h2,
      .tour-card-overlay h3 {
        color: white !important;
        font-size: clamp(0.7em, 1.9vw, 0.9em) !important;
        margin: 0 !important;
        line-height: 1.2 !important;
        font-weight: 700 !important;
      }
      
      .tour-card-overlay .operator-chip {
        background: rgba(255,255,255,0.25) !important;
        backdrop-filter: blur(5px) !important;
        color: white !important;
        padding: 2px 6px !important;
        font-size: clamp(0.55em, 1.3vw, 0.7em) !important;
        display: inline-block !important;
        align-self: flex-start !important;
        border-radius: 4px !important;
      }
      
      .tour-card-overlay .tour-meta {
        font-size: clamp(0.6em, 1.5vw, 0.75em) !important;
        color: rgba(255,255,255,0.95) !important;
        display: flex !important;
        gap: 6px !important;
        flex-wrap: wrap !important;
        align-items: center !important;
      }
      
      .tour-card-overlay .price-badge {
        font-weight: 700 !important;
        color: #1a1a1a !important;
        background: white !important;
        font-size: clamp(0.7em, 1.7vw, 0.85em) !important;
        padding: 4px 10px !important;
        border-radius: 6px !important;
        display: inline-block !important;
      }
      
      .tour-card-overlay .rating {
        color: rgba(255,255,255,0.9) !important;
      }
      
      /* Tour card images - fill entire card with zoom */
      .tour-card img,
      .tour-card-large img,
      .tour-card-image {
        max-height: 100% !important;
        min-height: 100% !important;
        height: 100% !important;
        width: 100% !important;
        object-fit: cover !important;
        object-position: center !important;
        display: block !important;
        background-size: cover !important;
        background-position: center !important;
        filter: none !important;
        opacity: 1 !important;
        transform: scale(1.05) !important;
      }
      
      /* Remove any ::before or ::after overlays on tour card images */
      .tour-card::before,
      .tour-card::after,
      .tour-card-large::before,
      .tour-card-large::after,
      .tour-card-image::before,
      .tour-card-image::after {
        display: none !important;
        content: none !important;
        background: none !important;
      }
      
      /* Tour card content area */
      .tour-card-content,
      .tour-card-large .tour-card-content {
        padding: 6px 8px !important;
        background: #fff !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: space-between !important;
      }
      
      /* Tour card titles - make visible */
      .tour-card h3,
      .tour-card .tour-name,
      .tour-card-large h3,
      .tour-card-title {
        font-size: 0.75em !important;
        line-height: 1.15 !important;
        word-break: normal !important;
        overflow-wrap: break-word !important;
        margin: 0 0 4px 0 !important;
        padding: 0 !important;
        color: #1a1a1a !important;
        font-weight: 600 !important;
      }
      
      /* Tour card rating/reviews */
      .tour-card .tour-rating,
      .tour-card .review-count,
      .tour-card-large .tour-rating,
      .tour-rating-display {
        font-size: 0.7em !important;
        color: #666 !important;
        margin: 2px 0 !important;
      }
      
      /* Tour card price */
      .tour-card .tour-price,
      .tour-card-large .tour-price,
      .price-display {
        font-size: 0.75em !important;
        padding: 4px 8px !important;
        background: #0077b6 !important;
        color: white !important;
        border-radius: 4px !important;
        display: inline-block !important;
        margin-top: 4px !important;
      }
      
      /* Ensure dropdowns are hidden by default */
      .language-menu:not(.active) {
        display: none !important;
      }
      
      .currency-menu:not(.active) {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
      }
      
      /* Hide desktop-only elements */
      .top-button-bar {
        display: none !important;
      }
      
      /* Info sections - stack vertically on mobile (What To Bring, What's Included) */
      .swipe-info-sections,
      .tour-detail-page .swipe-info-sections,
      .info-sections,
      .detail-section-grid {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 15px !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
      }
      
      .swipe-info-box,
      .tour-detail-page .swipe-info-box,
      .info-box {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
      }
      
      /* Force info-grid to single column on tour detail */
      .tour-detail-page [style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      /* Tour detail sections - reduce padding and spacing (meet in the middle) */
      .tour-detail-page [style*="padding:40px 45px"],
      .tour-detail-page [style*="padding: 40px 45px"],
      .tour-detail-page main > div[style*="padding"],
      .tour-detail-page section > div[style*="padding"] {
        padding: 20px 22px !important;
      }
      
      /* Reduce heading margins in tour detail */
      .tour-detail-page h3[style*="margin"],
      .tour-detail-page h3 {
        margin: 0 0 12px 0 !important;
        font-size: 1.6em !important;
      }
      
      /* Reduce line-height and font size in tour detail content */
      .tour-detail-page [style*="line-height"],
      .tour-detail-page li,
      .tour-detail-page p {
        line-height: 1.5 !important;
        font-size: 1.05em !important;
      }
      
      /* Reduce gap between list items */
      .tour-detail-page ul[style*="gap"] {
        gap: 8px !important;
      }
      
      /* Reduce margins between sections */
      .tour-detail-page [style*="margin:0 2px 30px 2px"],
      .tour-detail-page [style*="margin: 0 2px 30px 2px"] {
        margin: 0 2px 15px 2px !important;
      }
      
      /* TOUR DETAIL PAGE - Use full width, scale everything down */
      .page.tour-detail-page.active {
        width: 100vw !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding-top: 60px !important;
      }
      
      /* Remove narrow width constraints - use full width */
      .tour-detail-page .tour-info,
      .tour-detail-page main,
      .tour-detail-page section,
      .tour-detail-page .info-grid {
        max-width: 98% !important;
        width: 98% !important;
        margin-left: auto !important;
        margin-right: auto !important;
        padding: 10px 8px !important;
        margin-top: 0 !important;
        margin-bottom: 10px !important;
      }
      
      /* Photo carousel - show it (contains swipe gallery) */
      .tour-detail-page .photo-carousel {
        display: flex !important;
        width: 100% !important;
        margin: 10px auto 15px auto !important;
      }
      
      /* Show swipe-style gallery on tour detail pages */
      .tour-detail-page .swipe-gallery-wrapper {
        display: flex !important;
        width: 100% !important;
        max-height: 300px !important;
        margin-bottom: 10px !important;
      }
      
      /* Scale down all headings */
      .tour-detail-page h1 {
        font-size: 1.5em !important;
      }
      
      .tour-detail-page h2 {
        font-size: 1.3em !important;
      }
      
      .tour-detail-page h3 {
        font-size: 1.2em !important;
      }
      
      /* Scale down body text */
      .tour-detail-page p,
      .tour-detail-page li,
      .tour-detail-page div {
        font-size: 0.95em !important;
      }
      
      .tour-detail-page .info-grid,
      .tour-detail-page .details-section .info-grid {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
        display: grid !important;
      }
      
      .tour-detail-page .info-card {
        padding: 12px !important;
        font-size: 0.95em !important;
        min-height: auto !important;
      }
      
      .tour-detail-page .info-card h3 {
        font-size: 1.1em !important;
        margin-bottom: 8px !important;
      }
      
      /* Pricing section - reduce massive padding */
      .tour-detail-page .pricing-section {
        padding: 10px 8px !important;
      }
      
      .tour-detail-page .pricing-card,
      .tour-detail-page .price-option {
        padding: 10px 12px !important;
        font-size: 0.95em !important;
        margin: 6px 0 !important;
      }
      
      .tour-detail-page .pricing-section h2,
      .tour-detail-page .pricing-section h3 {
        font-size: 1.2em !important;
        margin: 8px 0 !important;
      }
      
      .tour-detail-page .pricing-section p {
        font-size: 0.9em !important;
        margin: 5px 0 !important;
      }
      
      /* Make weather and chat widgets visible and properly styled */
      .weather-widget {
        bottom: 10px !important;
        right: 10px !important;
        left: auto !important;
        width: auto !important;
        max-width: calc(50vw - 15px) !important;
        font-size: 0.9em !important;
      }
      
      .chat-button {
        bottom: 10px !important;
        left: 10px !important;
        width: 70px !important;
        height: 70px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
        background: rgba(255, 255, 255, 0.15) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
      }
      
      .chat-button img {
        width: 40px !important;
        height: 40px !important;
        object-fit: contain !important;
      }
      
      .chat-interface {
        bottom: 90px !important;
        left: 10px !important;
        right: 10px !important;
        width: calc(100vw - 20px) !important;
        max-width: 100% !important;
        height: calc(100vh - 180px) !important;
        max-height: 500px !important;
        display: none !important;
      }
      
      .chat-interface.active {
        display: flex !important;
      }
      
      /* Video question container adjustment for mobile */
      .video-question-container {
        padding-top: 120px !important;
        padding-bottom: 80px !important;
        max-height: calc(100vh - 50px) !important;
      }
      
      /* Progress indicator positioning for mobile */
      .vq-progress-container {
        top: 75px !important;
      }
      
      /* Kiosk header adjustments */
      .kiosk-header {
        flex-direction: column !important;
        padding: 10px 15px !important;
        gap: 10px !important;
      }
      
      .header-left, .header-right {
        width: 100% !important;
        justify-content: center !important;
      }
      
      .logo-image {
        max-width: 150px !important;
        height: auto !important;
      }
      
      /* Hero section */
      .hero-title {
        font-size: 2em !important;
        padding: 0 15px !important;
      }
      
      .hero-question {
        font-size: 1.5em !important;
        padding: 0 15px !important;
      }
      
      /* Button adjustments - use more horizontal space */
      .duration-pill {
        font-size: 1.2em !important;
        padding: 20px 30px !important;
        min-height: 70px !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .duration-grid {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 20px !important;
        gap: 15px !important;
      }
      
      /* Search bar */
      #home-search-input {
        width: calc(100% - 30px) !important;
        font-size: 1.2em !important;
        padding: 15px 20px !important;
      }
      
      /* Tour cards in grid */
      .tour-grid {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
        padding: 0 15px !important;
      }
      
      /* Video question page - use full width */
      .video-start-screen h1 {
        font-size: 2.5em !important;
        padding: 0 20px !important;
      }
      
      .video-start-btn {
        font-size: 1.2em !important;
        padding: 18px 40px !important;
      }
      
      /* Mobile styling for language selection */
      .language-selection-title {
        font-size: 2em !important;
        padding: 0 20px !important;
      }
      
      .language-select-btn {
        font-size: 1.4em !important;
        padding: 20px 35px !important;
        width: 90% !important;
        max-width: 400px !important;
      }
      
      .language-select-btn .flag {
        font-size: 1.2em !important;
      }
      
      /* Mobile styling for start screen buttons */
      .quick-decision-btn-start,
      .browse-all-tours-btn,
      .ai-assistant-btn {
        font-size: 1.2em !important;
        padding: 18px 40px !important;
        width: 85% !important;
        max-width: 350px !important;
      }
      
      .video-question-card {
        width: 100% !important;
        max-width: 100% !important;
        padding: 20px 15px !important;
        margin: 0 !important;
        margin-top: 15px !important;
      }
      
      .vq-question {
        font-size: 1.5em !important;
        padding: 0 !important;
        margin-bottom: 20px !important;
      }
      
      .vq-subtitle {
        font-size: 1em !important;
        margin: -15px 0 20px 0 !important;
      }
      
      .vq-answers {
        width: 100% !important;
        max-width: 100% !important;
        gap: 12px !important;
        padding: 0 !important;
        padding-bottom: 50px !important;
      }
      
      .vq-answer-btn {
        font-size: 1.05em !important;
        padding: 18px !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .vq-tour-counter {
        font-size: 1.1em !important;
        padding: 15px 25px !important;
      }
      
      /* Swipe results overlay */
      .swipe-card-stack {
        height: auto !important;
        margin-bottom: 20px !important;
      }
      
      .swipe-card-header h2 {
        font-size: 1.6em !important;
        margin-bottom: 8px !important;
      }
      
      .swipe-card-header .company-chip {
        font-size: 0.95em !important;
        padding: 6px 16px !important;
      }
      
      .swipe-gallery-image {
        width: 140px !important;
        height: 180px !important;
      }
      
      .swipe-gallery-image.center {
        width: 200px !important;
        height: 260px !important;
      }
      
      .swipe-info-sections {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
        max-width: 100% !important;
        padding: 0 10px !important;
      }
      
      .swipe-detail-section {
        padding: 18px 20px !important;
      }
      
      .swipe-detail-section h3 {
        font-size: 1.3em !important;
        margin-bottom: 12px !important;
      }
      
      .swipe-detail-section p,
      .swipe-detail-section div,
      .swipe-detail-section li {
        font-size: 0.95em !important;
      }
      
      .swipe-actions {
        flex-direction: row !important;
        gap: 10px !important;
        padding: 15px !important;
      }
      
      .swipe-btn {
        font-size: 1em !important;
        padding: 15px 20px !important;
      }
      
      /* Progress bar */
      .vq-progress-bar {
        top: 70px !important;
        left: 10px !important;
        right: 10px !important;
        width: calc(100% - 20px) !important;
      }
      
      /* Browse all tours button */
      .browse-all-btn {
        top: 10px !important;
        right: 10px !important;
        font-size: 0.9em !important;
        padding: 10px 20px !important;
      }
    }
    
    /* Small phones */
    @media (max-width: 480px) {
      /* Further reduce text sizes but keep full width buttons */
      .hero-title {
        font-size: 1.8em !important;
        padding: 0 15px !important;
      }
      
      .hero-question {
        font-size: 1.3em !important;
      }
      
      .duration-pill {
        font-size: 1.1em !important;
        padding: 18px 20px !important;
        min-height: 65px !important;
        width: 100% !important;
      }
      
      .video-question-card {
        padding: 25px 15px !important;
      }
      
      .vq-question {
        font-size: 1.5em !important;
        margin-bottom: 20px !important;
      }
      
      .vq-answer-btn {
        font-size: 1em !important;
        padding: 18px !important;
        width: 100% !important;
      }
      
      .weather-widget {
        font-size: 0.85em !important;
        bottom: 10px !important;
        max-width: calc(50vw - 15px) !important;
      }
      
      .chat-button {
        width: 60px !important;
        height: 60px !important;
        background: rgba(255, 255, 255, 0.15) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
      }
      
      .chat-button img {
        width: 35px !important;
        height: 35px !important;
      }
    }
    
    /* Landscape mode adjustments */
    @media (max-height: 600px) and (orientation: landscape) {
      .hero-title {
        font-size: 1.5em !important;
        margin-bottom: 10px !important;
      }
      
      .hero-question {
        font-size: 1.2em !important;
      }
      
      .duration-pill {
        padding: 10px !important;
        min-height: 50px !important;
      }
      
      .vq-question {
        font-size: 1.3em !important;
      }
    }

  </style>
</head>
<body class="video-bg-active">
  <div id="main-layout">
    <!-- Mobile Hamburger Menu (Mobile Only) -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>
    <div class="mobile-menu-dropdown" id="mobile-menu">
      <button class="mobile-menu-item" onclick="clearFilters(); toggleMobileMenu();">
        <span>↻</span>
        <span>Start Over</span>
      </button>
      <button class="mobile-menu-item" onclick="toggleView(); toggleMobileMenu();">
        <span id="mobile-menu-map-icon">🗺️</span>
        <span id="mobile-menu-map-text">Map View</span>
      </button>
      <button class="mobile-menu-item" onclick="toggleMobileLanguageMenu()">
        <span id="mobile-menu-lang-flag">🇬🇧</span>
        <span id="mobile-menu-lang-text">EN</span>
        <span style="margin-left: auto; font-size: 0.8em;">▶</span>
      </button>
      <div class="mobile-submenu" id="mobile-lang-submenu" style="display: none;">
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('en'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇬🇧</span>
          <span>English</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('zh'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇨🇳</span>
          <span>中文</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('ja'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇯🇵</span>
          <span>日本語</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('ko'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇰🇷</span>
          <span>한국어</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('es'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇪🇸</span>
          <span>Español</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('fr'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇫🇷</span>
          <span>Français</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('de'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇩🇪</span>
          <span>Deutsch</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeLanguage('hi'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>🇮🇳</span>
          <span>हिन्दी</span>
        </button>
      </div>
      <button class="mobile-menu-item" onclick="toggleMobileCurrencyMenu()">
        <span>💱</span>
        <span id="mobile-menu-currency-text">AUD</span>
        <span style="margin-left: auto; font-size: 0.8em;">▶</span>
      </button>
      <div class="mobile-submenu" id="mobile-currency-submenu" style="display: none;">
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('AUD'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>A$</span>
          <span>AUD</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('USD'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>$</span>
          <span>USD</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('EUR'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>€</span>
          <span>EUR</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('GBP'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>£</span>
          <span>GBP</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('JPY'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>¥</span>
          <span>JPY</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('CNY'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>¥</span>
          <span>CNY</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('KRW'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>₩</span>
          <span>KRW</span>
        </button>
        <button class="mobile-menu-item mobile-submenu-item" onclick="changeCurrency('INR'); toggleMobileMenu();" style="padding-left: 35px;">
          <span>₹</span>
          <span>INR</span>
        </button>
      </div>
      <button class="mobile-menu-item" onclick="goHome(); toggleMobileMenu();">
        <span>🏠</span>
        <span>Home</span>
      </button>
    </div>
    
    <!-- Global Header - Always visible on all pages -->
    <header class="global-header" id="global-header">
      <div class="global-header-left">
        <button class="global-back-button" id="global-back-button" onclick="goBackInHistory()">←</button>
        <img src="{{ url_for('static', filename='Filtour_logo.png.png') }}" alt="FilTour" class="global-logo-image">
      </div>
      <div class="global-header-right">
        <div class="language-selector" style="position: relative; display: inline-block;">
          <button class="chip" id="global-language-btn" onclick="toggleGlobalLanguageMenu(event)">EN</button>
          <div class="language-menu" id="global-language-menu" style="position: absolute; top: 100%; right: 0; margin-top: 10px;">
            <div class="language-option" data-lang="en" onclick="selectGlobalLanguage('en')"><span>🇬🇧</span> English</div>
            <div class="language-option" data-lang="zh" onclick="selectGlobalLanguage('zh')"><span>🇨🇳</span> 中文</div>
            <div class="language-option" data-lang="ja" onclick="selectGlobalLanguage('ja')"><span>🇯🇵</span> 日本語</div>
            <div class="language-option" data-lang="ko" onclick="selectGlobalLanguage('ko')"><span>🇰🇷</span> 한국어</div>
            <div class="language-option" data-lang="de" onclick="selectGlobalLanguage('de')"><span>🇩🇪</span> Deutsch</div>
            <div class="language-option" data-lang="fr" onclick="selectGlobalLanguage('fr')"><span>🇫🇷</span> Français</div>
          </div>
        </div>
        <div class="currency-selector" style="position: relative; display: inline-block;">
          <button class="chip" id="global-currency-btn" onclick="toggleGlobalCurrencyMenu(event)">AUD</button>
          <div class="currency-menu" id="global-currency-menu" style="position: absolute; top: 100%; right: 0; margin-top: 10px;">
            <div class="currency-option" data-currency="AUD" onclick="selectGlobalCurrency('AUD')"><span>A$</span> AUD</div>
            <div class="currency-option" data-currency="USD" onclick="selectGlobalCurrency('USD')"><span>$</span> USD</div>
            <div class="currency-option" data-currency="EUR" onclick="selectGlobalCurrency('EUR')"><span>€</span> EUR</div>
            <div class="currency-option" data-currency="GBP" onclick="selectGlobalCurrency('GBP')"><span>£</span> GBP</div>
            <div class="currency-option" data-currency="CNY" onclick="selectGlobalCurrency('CNY')"><span>¥</span> CNY</div>
            <div class="currency-option" data-currency="JPY" onclick="selectGlobalCurrency('JPY')"><span>¥</span> JPY</div>
            <div class="currency-option" data-currency="KRW" onclick="selectGlobalCurrency('KRW')"><span>₩</span> KRW</div>
            <div class="currency-option" data-currency="INR" onclick="selectGlobalCurrency('INR')"><span>₹</span> INR</div>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Global Video Background - Visible on video flow and tour detail pages -->
    <video id="bg-video" autoplay muted loop playsinline>
      <source src="{{ url_for('static', filename='b_roll/background.mp4') }}" type="video/mp4">
    </video>
    
    <!-- Video Question Page - NEW PRIMARY FLOW -->
    <div class="page video-question-page active" id="video-question-page">
      <!-- Language Selection Screen - First thing users see -->
      <div class="language-selection-screen" id="language-selection-screen">
        <div class="language-selection-title">Select Your Language to Begin</div>
        <div class="language-selection-buttons">
          <button class="language-select-btn" onclick="selectInitialLanguage('en')">
            <span class="flag">🇬🇧</span>
            <span>English</span>
          </button>
          <button class="language-select-btn" onclick="selectInitialLanguage('zh')">
            <span class="flag">🇨🇳</span>
            <span>中文</span>
          </button>
          <button class="language-select-btn" onclick="selectInitialLanguage('ja')">
            <span class="flag">🇯🇵</span>
            <span>日本語</span>
          </button>
          <button class="language-select-btn" onclick="selectInitialLanguage('ko')">
            <span class="flag">🇰🇷</span>
            <span>한국어</span>
          </button>
          <button class="language-select-btn" onclick="selectInitialLanguage('de')">
            <span class="flag">🇩🇪</span>
            <span>Deutsch</span>
          </button>
          <button class="language-select-btn" onclick="selectInitialLanguage('fr')">
            <span class="flag">🇫🇷</span>
            <span>Français</span>
          </button>
        </div>
      </div>
      
      <!-- Click to Start Screen -->
      <div class="video-start-screen" id="video-start-screen">
        <div class="video-start-text">{{ _('How Would You Like to Find Your Tour?') }}</div>
        <button class="ai-assistant-btn" onclick="event.stopPropagation(); console.log('AI Assistant - Coming Soon!')">
          🤖 {{ _('Talk To Our AI Assistant') }}
        </button>
        <button class="quick-decision-btn-start" onclick="event.stopPropagation(); window.startVideoQuestions && window.startVideoQuestions()">
          ⚡ {{ _('Quick Decision') }}
        </button>
        <button class="browse-all-tours-btn" onclick="event.stopPropagation(); window.goToHomePage && window.goToHomePage()">
          🗂️ {{ _('Browse All Tours') }}
        </button>
      </div>
      
      <!-- Browse All Tours Button (Always visible during questions) -->
      <button class="browse-all-tours-btn-questions" id="browse-all-tours-questions" style="display: none;" onclick="event.stopPropagation(); window.goToHomePage && window.goToHomePage()">Browse All Tours</button>
      
      <!-- Progress Indicator -->
      <div class="vq-progress-container" id="vq-progress-container" style="display: none;">
        <div class="vq-progress-text" id="vq-progress-text">Question 1 of 3</div>
        <div class="vq-progress-bar">
          <div class="vq-progress-fill" id="vq-progress-fill" style="width: 33.33%;"></div>
        </div>
      </div>
      
      <!-- Back Button -->
      <button class="vq-back-btn" id="vq-back-btn" style="display: none;">← Back</button>
      
      <!-- Question Container -->
      <div class="video-question-container" id="video-question-container" style="display: none;">
        <div class="video-question-card" id="vq-card">
          <h2 class="vq-question" id="vq-question-text">How long can you be away?</h2>
          <div class="vq-answers" id="vq-answers">
            <!-- Buttons will be inserted here -->
          </div>
        </div>
      </div>
      
      <!-- Tour Counter (debug) -->
      <div class="vq-tour-counter" id="vq-tour-counter" style="display: none;">
        Loading...
      </div>
      
      <!-- Swipe Results Overlay - APPEARS ON TOP OF VIDEO -->
      <div class="swipe-results-overlay" id="swipe-results-overlay">
        <!-- Skip to full list button -->
        <button class="skip-to-list-btn" id="skip-to-list-btn">
          See All Tours →
        </button>
        
        <!-- Fixed Top Section -->
        <div class="swipe-fixed-top" id="swipe-fixed-top">
          <!-- Card stack with gallery spread -->
          <div class="swipe-card-stack" id="swipe-card-stack">
            <!-- Gallery spread will be inserted here dynamically -->
          </div>
          
          <!-- Info sections (Highlights & What's Included) -->
          <div class="swipe-info-sections" id="swipe-info-sections">
            <!-- What's Included and Highlights will be inserted here -->
          </div>
        </div>
        
        <!-- Scrollable Content Area (for expanded details) -->
        <div class="swipe-scrollable-content" id="swipe-scrollable-content">
          <!-- Expanded details will be inserted here -->
        </div>
        
        <!-- Fixed Action buttons -->
        <div class="swipe-actions" id="swipe-actions">
          <button class="swipe-btn swipe-btn-reject" id="reject-btn">
            <span class="swipe-btn-icon">✕</span>
            <span class="swipe-btn-text">Not For Me</span>
          </button>
          <button class="swipe-btn swipe-btn-accept" id="accept-btn">
            <span class="swipe-btn-icon">✓</span>
            <span class="swipe-btn-text">Book Now</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Home Page - Modern Kiosk Layout -->
    <div class="page home-page" id="home-page">
      <!-- Kiosk Header -->
      <header class="kiosk-header">
        <div class="header-left">
          <button class="quick-decision-btn-header" onclick="goToStartPage()">⚡ Quick Decision</button>
          <img src="{{ url_for('static', filename='Filtour_logo.png.png') }}" alt="FilTour" class="logo-image">
      </div>
        <div class="header-right">
          <div class="language-selector" style="position: relative; display: inline-block;">
            <button class="chip" id="header-language-btn" onclick="toggleHomeLanguageMenu(event)">EN</button>
            <div class="language-menu" id="home-language-menu" style="position: absolute; top: 100%; right: 0; margin-top: 10px;">
              <div class="language-option" data-lang="en" onclick="selectHomeLanguage('en')"><span>🇬🇧</span> English</div>
              <div class="language-option" data-lang="zh" onclick="selectHomeLanguage('zh')"><span>🇨🇳</span> 中文</div>
              <div class="language-option" data-lang="ja" onclick="selectHomeLanguage('ja')"><span>🇯🇵</span> 日本語</div>
              <div class="language-option" data-lang="ko" onclick="selectHomeLanguage('ko')"><span>🇰🇷</span> 한국어</div>
              <div class="language-option" data-lang="de" onclick="selectHomeLanguage('de')"><span>🇩🇪</span> Deutsch</div>
              <div class="language-option" data-lang="fr" onclick="selectHomeLanguage('fr')"><span>🇫🇷</span> Français</div>
        </div>
          </div>
          <div class="currency-selector" style="position: relative; display: inline-block;">
            <button class="chip" id="header-currency-btn" onclick="toggleHomeCurrencyMenu(event)">AUD</button>
            <div class="currency-menu" id="home-currency-menu" style="position: absolute; top: 100%; right: 0; margin-top: 10px;">
              <div class="currency-option" data-currency="AUD" onclick="selectHomeCurrency('AUD')"><span>A$</span> AUD</div>
              <div class="currency-option" data-currency="USD" onclick="selectHomeCurrency('USD')"><span>$</span> USD</div>
              <div class="currency-option" data-currency="EUR" onclick="selectHomeCurrency('EUR')"><span>€</span> EUR</div>
              <div class="currency-option" data-currency="GBP" onclick="selectHomeCurrency('GBP')"><span>£</span> GBP</div>
              <div class="currency-option" data-currency="CNY" onclick="selectHomeCurrency('CNY')"><span>¥</span> CNY</div>
              <div class="currency-option" data-currency="JPY" onclick="selectHomeCurrency('JPY')"><span>¥</span> JPY</div>
            </div>
          </div>
          <button class="chip chip-outline" id="home-map-toggle-btn" onclick="showMapFromHome()">Map view</button>
        </div>
      </header>

      <!-- Main Content -->
      <main class="home-main">
        
        <!-- Search Bar -->
        <div style="margin-bottom: 20px; padding: 0 2%;">
          <div style="max-width: 100%; margin: 0 auto; position: relative; display: flex; align-items: center; justify-content: center;">
            <input type="text" id="home-search-input" placeholder="🔍 Search tours by name or company..." style="
              width: 96%;
              padding: 20px 30px;
              font-size: 1.6em;
              border: 3px solid #fff;
              border-radius: 50px;
              outline: none;
              transition: all 0.3s;
              background: rgba(255,255,255,0.95);
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
              color: #000;
            " oninput="quickSearch(this.value)">
            <button onclick="document.getElementById('home-search-input').value=''; quickSearch('');" style="
              display: none;
              position: absolute;
              right: 15px;
              top: 50%;
              transform: translateY(-50%);
              background: rgba(0,0,0,0.1);
              border: none;
              border-color: rgba(0, 0, 0, 0);
              border-image: none;
              font-size: 1.6em;
              cursor: pointer;
              color: #666;
              padding: 0;
              border-radius: 50%;
              width: 50px;
              height: 50px;
              transition: all 0.2s;
              z-index: 10;
            " onmouseover="this.style.background='rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(0,0,0,0.1)'">✕</button>
          </div>
        </div>
        
        <!-- Company Filter Navigation (shown when filtering by company) -->
        <section class="company-filter-nav" id="company-filter-nav" style="display: none; padding: 30px 50px; text-align: center;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 900px; margin: 0 auto;">
            <button class="duration-pill" onclick="goBackToTourDetail()" id="back-to-tour-btn">
              ← Back to Previous Tour
            </button>
            <button class="duration-pill" onclick="clearFilters()">
              🏠 Back to Home Page
            </button>
          </div>
        </section>
        
        <!-- Hero / Question Area -->
        <section class="hero" id="hero-section">
          <h1 class="hero-title">Find Your Perfect Tour</h1>

          <!-- Filter Summary & Navigation -->
          <div class="filter-summary-bar" id="filter-summary-bar" style="display: none;">
            <div class="filter-summary-content">
              <button class="back-nav-btn" id="back-question-btn" onclick="goBackQuestion()">
                ← Back
              </button>
              <div class="selected-filters" id="selected-filters">
                <!-- Selected filters will appear here -->
              </div>
              <button class="start-over-btn" onclick="startOverFilters()">
                Start Over
              </button>
            </div>
      </div>
      
      <!-- Question 1: Duration -->
          <div class="hero-card filter-question-card" data-question="1">
            <p class="hero-question">How long can you be away?</p>
            <div class="duration-grid">
              <button class="duration-pill" data-value="half_day" onclick="selectDuration('half_day')">
                Half Day<br><span>2–4 hours</span>
              </button>
              <button class="duration-pill" data-value="full_day" onclick="selectDuration('full_day')">
                Full Day<br><span>5–8 hours</span>
              </button>
              <button class="duration-pill" data-value="multi_day" onclick="selectDuration('multi_day')">
                Multi-day Adventure
              </button>
              <button class="duration-pill duration-pill--ghost" data-value="" onclick="selectDuration('')">
                No preference
              </button>
          </div>
          </div>

          <!-- Question 2: Family -->
          <div class="hero-card filter-question-card" data-question="2" style="display: none;">
            <p class="hero-question">Who's coming along?</p>
            <div class="duration-grid">
              <button class="duration-pill" onclick="selectFamily('true')">
                👨‍👩‍👧‍👦 Family with Kids
              </button>
              <button class="duration-pill" onclick="selectFamily('false')">
                👥 Adults Only
              </button>
              <button class="duration-pill duration-pill--ghost" onclick="selectFamily('')">
                No preference
              </button>
        </div>
      </div>
      
          <!-- Question 3: Activity -->
          <div class="hero-card filter-question-card" data-question="3" style="display: none;">
            <p class="hero-question">What interests you most?</p>
            <p style="font-size: 1.2em; color: #90e0ef; margin-top: -15px; margin-bottom: 20px;">Select all that apply</p>
            <div class="duration-grid" style="grid-template-columns: 1fr 1fr; max-width: 800px; margin: 0 auto;">
              <button class="duration-pill" data-activity="great_barrier_reef" onclick="toggleActivity('great_barrier_reef', this)">
                🐠 Great Barrier Reef
              </button>
              <button class="duration-pill" data-activity="whitehaven_beach" onclick="toggleActivity('whitehaven_beach', this)">
                🏖️ Whitehaven Beach
              </button>
              <button class="duration-pill" data-activity="island_tours" onclick="toggleActivity('island_tours', this)">
                🏝️ Island Tours
              </button>
              <button class="duration-pill" data-activity="sailing" onclick="toggleActivity('sailing', this)">
                ⛵ Sailing
              </button>
              <button class="duration-pill" data-activity="snorkeling" onclick="toggleActivity('snorkeling', this)">
                🤿 Snorkeling
              </button>
              <button class="duration-pill" data-activity="swimming" onclick="toggleActivity('swimming', this)">
                🏊 Swimming
              </button>
              <button class="duration-pill" data-activity="scenic_views" onclick="toggleActivity('scenic_views', this)">
                🌅 Scenic Views
              </button>
            </div>
            <div style="margin-top: 30px; display: flex; gap: 20px; justify-content: center;">
              <button class="duration-pill duration-pill--ghost" style="max-width: 400px; height: auto; min-height: 80px;" onclick="skipActivity()">
                Show me everything
              </button>
              <button class="duration-pill continue-btn" style="max-width: 400px; height: auto; min-height: 80px; background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);" onclick="confirmActivity()">
                Continue
              </button>
            </div>
          </div>
      
          <!-- Question 4: Price (Slider) -->
          <div class="hero-card filter-question-card" data-question="4" style="display: none;">
            <p class="hero-question">What's your budget per person?</p>
            <div class="budget-slider-container">
              <div class="budget-label-display">
                <span class="budget-icon">💰</span>
                <span id="budget-display">Any Price</span>
              </div>
              <input 
                type="range" 
                id="budget-slider" 
                class="budget-slider" 
                min="0" 
                max="4" 
                value="4" 
                step="1"
                oninput="updateBudgetDisplay(this.value)"
              >
              <div class="budget-markers">
                <span class="budget-marker">$100</span>
                <span class="budget-marker">$250</span>
                <span class="budget-marker">$500</span>
                <span class="budget-marker">$1000</span>
                <span class="budget-marker">Any</span>
              </div>
            </div>
            <div class="budget-action-buttons" style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
              <button class="skip-budget-btn" onclick="selectPrice('')">Show All Prices</button>
              <button class="confirm-budget-btn" onclick="confirmBudget()">Continue</button>
        </div>
      </div>
        </section>

        <!-- Featured Tours - Always Visible -->
        <section class="featured-tours" id="featured-tours-section" style="background: transparent;">
          <h2 id="home-tours-title" style="color: white;">Tap Any Card For Booking and More Info</h2>
          <p class="section-subtitle" id="home-tours-subtitle" style="color: rgba(255,255,255,0.9);">
            Showing all available tours
          </p>

          <div class="featured-grid" id="featured-grid">
            <!-- Featured tours will be populated here -->
        </div>
      
          <div class="loading-indicator" id="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Loading more tours...</p>
      </div>
        </section>
        
        <!-- Map View Section (replaces featured tours when active) -->
        <section class="map-view-section" id="home-map-view-section" style="display: none; width: 100% !important; max-width: 1600px !important; margin: 0 auto !important;">
          <h2 style="font-size: 3.5em; font-weight: 700; color: #ffffff; text-align: center; margin: 0 0 15px 0; text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.8);">Tour Locations</h2>
          <p style="font-size: 1.4em; color: #ffffff; text-align: center; margin: 0 0 40px 0; text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);">
            <strong>📍 Answer the questions above, click a map pin, or scroll the carousel below</strong>
          </p>
          
          <!-- Map Container -->
          <div id="home-map-container" style="position: relative; width: 100% !important; min-width: 100% !important; height: 700px !important; min-height: 700px !important; max-height: 700px !important; z-index: 1; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 20px auto; max-width: 1600px; flex-shrink: 0 !important; flex-grow: 0 !important;">
            <div id="home-map" style="width: 100% !important; height: 100% !important;"></div>
        </div>
          
          <!-- Carousel below map -->
          <div class="map-carousel-container active" id="home-map-carousel-container" style="max-width: 1600px; margin: 0 auto;">
            <div class="carousel-header">
              <div class="carousel-header-text" id="home-carousel-header-text">
                Showing <span class="count">0</span> tours
      </div>
              <button class="carousel-clear-btn" id="home-carousel-clear-btn" onclick="clearLocationFilter()" style="display: none;">
                × Clear filter
              </button>
            </div>
            <div class="map-carousel with-header" id="home-map-carousel" onclick="handleCarouselBackgroundClick(event)">
              <!-- Tour cards will be inserted here by JavaScript -->
            </div>
          </div>
        </section>
      </main>
    </div>
    
    <!-- Top Button Bar -->
    <div class="top-button-bar">
      <!-- Language Selector -->
      <div class="language-selector">
        <button class="language-btn top-btn" id="current-language" onclick="toggleLanguageMenu()">
          <span id="current-language-flag">🇬🇧</span>
          <span id="current-language-code">EN</span>
        </button>
        <div class="language-menu" id="language-menu">
          <div class="language-option" data-lang="en"><span>🇬🇧</span> English</div>
          <div class="language-option" data-lang="zh"><span>🇨🇳</span> 中文</div>
          <div class="language-option" data-lang="ja"><span>🇯🇵</span> 日本語</div>
          <div class="language-option" data-lang="ko"><span>🇰🇷</span> 한국어</div>
          <div class="language-option" data-lang="de"><span>🇩🇪</span> Deutsch</div>
          <div class="language-option" data-lang="fr"><span>🇫🇷</span> Français</div>
          <div class="language-option" data-lang="es"><span>🇪🇸</span> Español</div>
          <div class="language-option" data-lang="hi"><span>🇮🇳</span> हिन्दी</div>
        </div>
      </div>
      
      <!-- Currency Selector -->
      <div class="currency-selector">
        <button class="currency-btn top-btn" id="currency-btn" onclick="toggleCurrencyMenu()">
          <span>💱</span>
          <span id="currency-btn-text">AUD</span>
        </button>
        <div class="currency-menu" id="currency-menu">
          <div class="currency-option" data-currency="AUD"><span>A$</span> AUD - Australian Dollar</div>
          <div class="currency-option" data-currency="USD"><span>$</span> USD - US Dollar</div>
          <div class="currency-option" data-currency="EUR"><span>€</span> EUR - Euro</div>
          <div class="currency-option" data-currency="GBP"><span>£</span> GBP - British Pound</div>
          <div class="currency-option" data-currency="CNY"><span>¥</span> CNY - Chinese Yuan</div>
          <div class="currency-option" data-currency="JPY"><span>¥</span> JPY - Japanese Yen</div>
          <div class="currency-option" data-currency="KRW"><span>₩</span> KRW - Korean Won</div>
          <div class="currency-option" data-currency="INR"><span>₹</span> INR - Indian Rupee</div>
        </div>
      </div>
      
      <!-- Start Over Button -->
      <button class="clear-filters-btn top-btn" onclick="clearFilters()">
        <span>↻</span>
        <span>Start Over</span>
      </button>
      
      <!-- View Toggle Button -->
      <button class="view-toggle-btn top-btn" id="view-toggle-btn" onclick="toggleView()">
        <span id="view-toggle-icon">🗺️</span>
        <span id="view-toggle-text">Map View</span>
      </button>
    </div>
    
    <!-- AI Chat Assistant -->
    <button class="chat-button" id="chat-button" onclick="toggleChat()">
      <img src="{{ url_for('static', filename='microphone_icon.png') }}" alt="Microphone" style="width: 50px; height: 50px; object-fit: contain;">
    </button>
    
    <div class="chat-interface" id="chat-interface">
      <div class="chat-header">
        <h3>🤖 Tour Assistant</h3>
        <div class="chat-header-buttons">
          <button class="chat-restart" onclick="restartChat()" title="Restart conversation">🔄</button>
          <button class="chat-close" onclick="closeChat()">×</button>
        </div>
      </div>
      
      <!-- Audio Visualizer -->
      <div class="audio-visualizer" id="audio-visualizer">
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
        <div class="visualizer-bar"></div>
      </div>
      
      <div class="chat-messages" id="chat-messages">
        <div class="chat-message system">
          👋 Hi! I'm your AI tour assistant. I'll help you find the perfect Whitsundays tour!
        </div>
        <div class="chat-message assistant">
          Let's start simple - what would you like to experience? 🌊
          <br><br>
          1. Great Barrier Reef<br>
          2. Whitehaven Beach<br>
          3. Sailing & Cruises<br>
          4. Diving & Snorkeling<br>
          5. Something else?
        </div>
      </div>
      <div class="chat-input-container">
        <input 
          type="text" 
          class="chat-input" 
          id="chat-input" 
          placeholder="Tell me what interests you..."
          onkeypress="if(event.key==='Enter') sendChatMessage()"
        />
        <button class="chat-send" id="chat-send" onclick="sendChatMessage()">
          Send
        </button>
      </div>
      
      <!-- Voice Controls -->
      <div class="voice-controls">
        <div class="voice-divider">OR</div>
        
        <button id="micButton" class="mic-button" title="Click to speak your question">
          <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
          </svg>
          <span class="mic-text">🎤 Tap to Speak</span>
        </button>
        
        <div class="voice-status" id="voiceStatus" style="display: none;">
          <div class="voice-indicator">
            <div class="pulse"></div>
          </div>
          <span class="status-text">Listening...</span>
        </div>
        
        <div class="interim-text" id="interimText" style="display: none;"></div>
        
        <label class="auto-speak-toggle">
          <input type="checkbox" id="autoSpeakToggle" checked>
          <span>🔊 Speak responses aloud</span>
        </label>
      </div>
    </div>
    
    <!-- Weather Widget -->
    <div class="weather-widget collapsed" id="weather-widget" onclick="toggleWeatherWidget()">
      <div class="weather-header">
        <div class="weather-title">
          <span>🌤️</span>
          <span>Airlie Beach Weather</span>
        </div>
        <button class="weather-toggle" onclick="event.stopPropagation(); toggleWeatherWidget();">▼</button>
      </div>
      
      <div class="weather-content">
        <!-- Current Weather -->
        <div class="current-weather">
          <div class="current-temp-display">
            <span id="current-weather-icon" class="weather-icon-large">☀️</span>
            <div class="temp-info">
              <div id="current-temp" class="temp-large">25°C</div>
              <div id="current-weather-desc" class="weather-desc">Clear</div>
            </div>
          </div>
          <div id="current-wind" class="wind-info">Wind: 15 km/h</div>
        </div>
        
        <!-- 7-Day Forecast -->
        <div class="forecast-title">7-Day Forecast</div>
        <div id="forecast-days" class="forecast-container">
          <!-- Forecast days will be populated by JavaScript -->
        </div>
        
        <!-- Best Time to Visit -->
        <div id="best-time-section" class="best-time-section">
          <div class="best-time-title">
            <span id="best-time-icon">✨</span>
            <span>Best Time to Visit</span>
          </div>
          <div id="best-time-message" class="best-time-message">
            Perfect time to visit! Dry season with calm waters and great visibility.
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tour List Page - Modern Kiosk Layout -->
    <div class="page tour-list-page" id="tour-list-page">
      <!-- Kiosk Header (same as home) -->
      <header class="kiosk-header">
        <div class="header-left">
          <img src="{{ url_for('static', filename='Filtour_logo.png.png') }}" alt="FilTour" class="logo-image">
        </div>
        <div class="header-right">
          <button class="chip" id="list-language-btn" onclick="toggleLanguageMenu()">EN</button>
          <button class="chip" id="list-currency-btn" onclick="toggleCurrencyMenu()">AUD</button>
          <button class="chip chip-outline" id="map-toggle-btn" onclick="toggleMapView()">Map view</button>
        </div>
      </header>

      <!-- Main Content -->
      <main class="tour-list-main">

        <!-- Tour Grid Section -->
        <section class="tour-grid-section">
          <h1 class="list-title" id="tour-grid-header">Available Tours</h1>
          <p class="results-info" id="results-info">Tap an option above to start filtering</p>

          <div class="tour-grid tour-grid--2col" id="tour-placeholder-row">
      {% for tour in tours %}
            <article class="tour-card-large" data-key="{{ tour.key }}" data-departure="{{ tour.departure_location }}" onclick="openTourDetail('{{ tour.key }}')">
              <div class="tour-card-image" style="background-image: url('{{ tour.thumbnail }}');"></div>
              <div class="tour-card-overlay">
                <span class="operator-chip">{{ tour.company_name|replace('_',' ')|title }}</span>
                <h2 class="tour-name">{{ tour.name }}</h2>
                <div class="tour-meta">
                  {% if tour.review_rating and tour.review_rating > 0 and tour.review_count > 0 %}
                  <span class="rating">★ {{ "%.1f"|format(tour.review_rating) }} ({{ tour.review_count }})</span>
            {% endif %}
                  <span class="price-badge">From {{ tour.price_adult }}</span>
        </div>
      </div>
            </article>
      {% endfor %}
    </div>

          <div class="load-more-container">
            <button id="load-more-btn" class="load-more-btn">Load More Tours</button>
    </div>
    
    <!-- Map View Container -->
    <div id="map-container">
      <div id="map"></div>
    </div>
    
          <!-- Carousel below map -->
          <div class="map-carousel-container" id="map-carousel-container">
            <div class="carousel-header" id="carousel-header">
              <div class="carousel-header-text" id="carousel-header-text">
                Showing <span class="count">0</span> tours
      </div>
              <button class="carousel-clear-btn" id="carousel-clear-btn" onclick="clearLocationFilter()" style="display: none;">
                × Clear filter
              </button>
            </div>
            <div class="map-carousel with-header" id="map-carousel" onclick="handleCarouselBackgroundClick(event)">
              <!-- Tour cards will be inserted here by JavaScript -->
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
  <script id="initial-shown-keys" type="application/json">{{ shown_keys|tojson|safe }}</script>
  <!-- Chat Widget - Commented out for now, can re-enable later
  <div id="chat-widget">
    <div id="chat-header">Tour Chat Assistant</div>
    <div id="chatbox"></div>
    <form id="input-area" onsubmit="sendMessage(); return false;">
      <input type="text" id="userInput" placeholder="Ask a tour question..." autocomplete="off" />
      <button id="sendBtn" type="submit">Send</button>
      <div id="spinner">
        <svg width="28" height="28" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="none" stroke="#0077b6" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.415, 31.415" transform="rotate(72.5041 25 25)"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 25 25;360 25 25" keyTimes="0;1"></animateTransform></circle></svg>
      </div>
    </form>
  </div>
  -->
  <!-- Tour Detail Page - Modern Kiosk Layout -->
  <div class="page tour-detail-page">
    <!-- Kiosk Header -->
    <header class="kiosk-header">
      <button class="back-button" id="back-arrow">←</button>
      <img src="{{ url_for('static', filename='Filtour_logo.png.png') }}" alt="FilTour" class="logo-image">
      <div class="header-right">
        <div class="language-selector" style="position: relative;">
          <button class="chip" id="detail-language-btn" onclick="toggleDetailLanguageMenu(event)">EN</button>
          <div class="language-menu" id="detail-language-menu">
            <div class="language-option" data-lang="en" onclick="selectLanguageFromDetail('en')"><span>🇬🇧</span> English</div>
            <div class="language-option" data-lang="zh" onclick="selectLanguageFromDetail('zh')"><span>🇨🇳</span> 中文</div>
            <div class="language-option" data-lang="ja" onclick="selectLanguageFromDetail('ja')"><span>🇯🇵</span> 日本語</div>
            <div class="language-option" data-lang="ko" onclick="selectLanguageFromDetail('ko')"><span>🇰🇷</span> 한국어</div>
            <div class="language-option" data-lang="de" onclick="selectLanguageFromDetail('de')"><span>🇩🇪</span> Deutsch</div>
            <div class="language-option" data-lang="fr" onclick="selectLanguageFromDetail('fr')"><span>🇫🇷</span> Français</div>
          </div>
        </div>
        <div class="currency-selector" style="position: relative;">
          <button class="chip" id="detail-currency-btn" onclick="toggleDetailCurrencyMenu(event)">AUD</button>
          <div class="currency-menu" id="detail-currency-menu">
            <div class="currency-option" data-currency="AUD" onclick="selectCurrencyFromDetail('AUD')"><span>A$</span> AUD - Australian Dollar</div>
            <div class="currency-option" data-currency="USD" onclick="selectCurrencyFromDetail('USD')"><span>$</span> USD - US Dollar</div>
            <div class="currency-option" data-currency="EUR" onclick="selectCurrencyFromDetail('EUR')"><span>€</span> EUR - Euro</div>
            <div class="currency-option" data-currency="GBP" onclick="selectCurrencyFromDetail('GBP')"><span>£</span> GBP - British Pound</div>
            <div class="currency-option" data-currency="CNY" onclick="selectCurrencyFromDetail('CNY')"><span>¥</span> CNY - Chinese Yuan</div>
            <div class="currency-option" data-currency="JPY" onclick="selectCurrencyFromDetail('JPY')"><span>¥</span> JPY - Japanese Yen</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="tour-detail-main">
      <!-- Hero Section -->
      <section class="tour-hero">
        <h1 class="tour-title" id="detail-title"></h1>
        <div class="operator-chip" id="detail-company"></div>
        <p class="tour-summary" id="detail-summary"></p>

        <!-- Photo Carousel -->
        <div class="photo-carousel" id="detail-gallery"></div>
      </section>

      <!-- Pricing Section -->
      <section class="pricing-section" id="pricing-section">
        <h2>Pricing</h2>
        <p class="pricing-hint">Tap to select your pricing option.</p>
        <div class="pricing-card" id="pricing-tiers-container"></div>
      </section>

      <!-- Info Grid (What's Included & Highlights) -->
      <section class="info-grid" id="info-grid">
        <!-- Cards will be populated by JavaScript -->
      </section>

      <!-- Description & Details -->
      <section class="details-section">
        <h3>About This Tour</h3>
      <div id="detail-description"></div>
      </section>

      <!-- Additional Info -->
      <div id="detail-info"></div>

      <!-- Fine Print -->
      <section class="fine-print" id="fine-print">
        <!-- Will be populated with terms, cancellation policy, etc. -->
      </section>

      <!-- Departure Section (now in detail-info) -->
      <section class="departure-section" id="departure-section" style="display: none;">
        <!-- Map will be added here by JavaScript -->
      </section>

      <!-- Reviews Section (now in detail-info) -->
      <section class="departure-section" id="reviews-section-detail" style="display: none;">
        <!-- Reviews will be added here by JavaScript -->
      </section>
    </main>

    <!-- Sticky Footer -->
    <footer class="detail-footer">
      <button class="btn-tertiary" id="share-tour-btn">Share Tour</button>
      <button class="btn-primary" id="book-now-btn">Book Now</button>
      <button class="btn-secondary" id="continue-phone-btn">Send to My Phone</button>
    </footer>
  </div>
  
  <!-- QR Payment Modal -->
  <div class="qr-overlay" id="qr-payment-modal" style="display: none;">
    <div class="qr-backdrop" onclick="closeQRModal()"></div>
    
    <div class="qr-card">
      <button class="qr-modal-close" onclick="closeQRModal()">×</button>
      <h2>Complete Your Booking</h2>
      <p class="qr-subtitle">
        Scan this code to pay securely on your phone.
      </p>
      
      <div class="qr-code-wrapper" id="qr-code-container">
        <!-- QR code will be generated here -->
      </div>
      
      <p class="qr-help-text">
        Apple Pay, Google Pay and cards supported.
      </p>
      
      <div class="qr-actions">
        <button class="btn-primary" id="qr-continue-btn">Continue on this screen</button>
        <button class="btn-ghost" id="qr-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Booking Modal -->
  <div id="booking-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="close-booking-modal">✕</button>
      <h2 class="modal-title">📬 Book Your Tour</h2>
      <p class="modal-subtitle" id="booking-tour-name"></p>
      
      <form id="booking-form">
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="guest-name" name="name" required>
        </div>
        
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="guest-email" name="email" required>
        </div>
        
        <div class="form-group">
          <label>Phone Number *</label>
          <input type="tel" id="guest-phone" name="phone" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Adults *</label>
            <input type="number" id="guest-adults" name="adults" min="1" value="2" required>
          </div>
          
          <div class="form-group">
            <label>Children</label>
            <input type="number" id="guest-children" name="children" min="0" value="0">
          </div>
        </div>
        
        <div class="form-group">
          <label>Preferred Date *</label>
          <input type="date" id="guest-date" name="date" required>
        </div>
        
        <div class="form-group">
          <label>Message / Special Requests</label>
          <textarea id="guest-message" name="message" rows="4" placeholder="Any questions or special requirements..."></textarea>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="submit-booking-btn" id="submit-booking-btn">
            Send Inquiry ✉️
          </button>
        </div>
        
        <p class="form-note">* Required fields. Your inquiry will be sent directly to the tour operator.</p>
      </form>
      
      <div id="booking-success" class="booking-success" style="display:none;">
        <div class="success-icon">✓</div>
        <h3>Inquiry Sent Successfully!</h3>
        <p>The tour operator will contact you shortly at the email address provided.</p>
        <button class="success-close-btn" onclick="closeBookingModal()">Done</button>
      </div>
    </div>
  </div>
  
  <!-- Rezdy Booking Modal (Full Screen with iframe) -->
  <div id="rezdy-modal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:999999;background:white;">
    <div style="position:relative;width:100%;height:100%;overflow:hidden;">
      <!-- Back Arrow Button - Same style as tour detail back arrow -->
      <button onclick="closeRezdyModal()" onmousedown="this.style.transform='scale(0.95)';this.style.background='#e0eafc';" onmouseup="this.style.transform='';this.style.background='#fff';" onmouseleave="this.style.transform='';this.style.background='#fff';" style="position:fixed;top:20px;left:20px;z-index:9999999;width:80px;height:80px;background:#fff;color:#0077b6;border:none;border-radius:50%;font-size:3.5em;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;">
        &#8592;
      </button>
      
      <!-- Loading indicator -->
      <div id="rezdy-loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em;color:#0077b6;z-index:1;">
        Loading booking system...
      </div>
      
      <!-- iframe for Rezdy - NO sandbox so booking flow works fully, zoomed 30% -->
      <div style="width:100%;height:100%;overflow:auto;">
        <iframe id="rezdy-iframe" style="width:77%;height:77%;border:none;transform:scale(1.3);transform-origin:top left;"></iframe>
      </div>
    </div>
  </div>
  
  <script>
    // =====================================================================
    // GLOBAL VARIABLES - Inactivity Timer & Language
    // =====================================================================
    let inactivityTimer;
    const urlParams = new URLSearchParams(window.location.search);
    let currentLanguage = urlParams.get('lang') || localStorage.getItem('preferred_language') || 'en';
    let currentCurrency = 'AUD';
    
    // Translation strings from Flask (for JavaScript use)
    const translations = {
      howLongCanYouBeAway: "{{ _('How long can you be away?') }}",
      whatInterestsYouMost: "{{ _('What interests you most?') }}",
      whatsYourBudget: "{{ _('What\\'s your budget per person?') }}",
      halfDay: "{{ _('Half Day') }}",
      fullDay: "{{ _('Full Day') }}",
      multiDayAdventure: "{{ _('Multi-day Adventure') }}",
      noPreference: "{{ _('No Preference') }}",
      nature: "{{ _('Nature & Wildlife') }}",
      adventure: "{{ _('Adventure & Thrills') }}",
      relaxation: "{{ _('Relaxation & Beaches') }}",
      culture: "{{ _('Culture & History') }}",
      familyFun: "{{ _('Family Fun') }}",
      luxury: "{{ _('Luxury Experiences') }}",
      budget: "{{ _('Budget-Friendly') }}",
      midRange: "{{ _('Mid-Range') }}",
      premium: "{{ _('Premium') }}",
      splurge: "{{ _('Splurge-Worthy') }}",
      anyBudget: "{{ _('Any Budget') }}",
      toursMatch: "{{ _('tours match') }}",
      notForMe: "{{ _('Not For Me') }}",
      bookNow: "{{ _('Book Now') }}",
      whatsIncluded: "{{ _('What\\'s Included') }}",
      highlights: "{{ _('Highlights') }}",
      importantInfo: "{{ _('Important Information') }}",
      whatToBring: "{{ _('What to Bring') }}",
      whatsExtra: "{{ _('What\\'s Extra') }}",
      departureLocation: "{{ _('Departure Location') }}",
      customerReviews: "{{ _('Customer Reviews') }}",
      basedOnReviews: "{{ _('Based on') }}",
      reviews: "{{ _('reviews') }}",
      times: "{{ _('Times') }}",
      ages: "{{ _('Ages') }}",
      idealFor: "{{ _('Ideal For') }}",
      questionOf: "{{ _('Question') }}",
      of: "{{ _('of') }}"
    };
    
    // =====================================================================
    // VIDEO QUESTION FLOW - NEW PRIMARY EXPERIENCE
    // =====================================================================
    
    const videoQuestions = [
      {
        get question() { return translations.howLongCanYouBeAway; },
        answers: [
          { get text() { return translations.halfDay + "<br><span style='font-size:0.6em;opacity:0.8;'>2–4 hours</span>"; }, value: "half_day", filter: "duration" },
          { get text() { return translations.fullDay + "<br><span style='font-size:0.6em;opacity:0.8;'>5–8 hours</span>"; }, value: "full_day", filter: "duration" },
          { get text() { return translations.multiDayAdventure; }, value: "multi_day", filter: "duration" },
          { get text() { return translations.noPreference; }, value: "", filter: "duration" }
        ]
      },
      {
        question: "{{ _('Who\\'s coming along?') }}",
        answers: [
          { text: "👨‍👩‍👧‍👦 {{ _('Family with Kids') }}", value: "true", filter: "family_friendly" },
          { text: "👥 {{ _('Adults Only') }}", value: "adults_only", filter: "family_friendly" },
          { get text() { return translations.noPreference; }, value: "", filter: "family_friendly" }
        ]
      },
      {
        get question() { return translations.whatInterestsYouMost; },
        multiple: true,
        answers: [
          { text: "🐠 {{ _('Great Barrier Reef') }}", value: "great_barrier_reef", filter: "activities" },
          { text: "🏖️ {{ _('Whitehaven Beach') }}", value: "whitehaven_beach", filter: "activities" },
          { text: "🏝️ {{ _('Island Tours') }}", value: "island_tours", filter: "activities" },
          { text: "⛵ {{ _('Sailing') }}", value: "sailing", filter: "activities" },
          { text: "🤿 {{ _('Snorkeling') }}", value: "snorkeling", filter: "activities" },
          { text: "🏊 {{ _('Swimming') }}", value: "swimming", filter: "activities" },
          { text: "🌅 {{ _('Scenic Views') }}", value: "scenic_views", filter: "activities" },
          { get text() { return translations.noPreference; }, value: "", filter: "activities", isSkip: true }
        ]
      }
    ];
    
    let currentVideoQuestion = 0;
    let videoAnswers = {
      duration: "",
      family_friendly: "",
      activities: []
    };
    let hasStarted = false;
    
    function handleStartScreenClick(event) {
      // Don't start if clicking on buttons or interactive elements
      const target = event.target;
      if (target.tagName === 'BUTTON' || 
          target.closest('button') || 
          target.closest('.browse-all-tours-btn') ||
          target.closest('.language-selector') ||
          target.closest('.mobile-menu-btn') ||
          target.closest('.voice-chat-container')) {
        return; // Let the button handle its own click
      }
      
      // Start the questions
      if (window.startVideoQuestions) {
        window.startVideoQuestions();
      }
    }
    
    function initVideoQuestionFlow() {
      console.log('🔧 Setting up video question flow...');
      
      const startScreen = document.getElementById('video-start-screen');
      if (!startScreen) {
        console.error('❌ Start screen element not found!');
        return;
      }
      
      console.log('✅ Start screen found');
      
      const backBtn = document.getElementById('vq-back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', goBackVideoQuestion);
      }
      
      resetInactivityTimer();
      console.log('✅ Inactivity timer started');
    }
    
    window.startVideoQuestions = function() {
      console.log('🚀 Starting video questions!');
      hasStarted = true;
      isInVideoFlow = true; // Mark that we're in video flow
      
      // Show video background
      document.body.classList.add('video-bg-active');
      
      const startScreen = document.getElementById('video-start-screen');
      const questionContainer = document.getElementById('video-question-container');
      const backBtn = document.getElementById('vq-back-btn');
      const tourCounter = document.getElementById('vq-tour-counter');
      const browseBtnQuestions = document.getElementById('browse-all-tours-questions');
      const progressContainer = document.getElementById('vq-progress-container');
      
      if (startScreen) startScreen.style.display = 'none';
      if (questionContainer) questionContainer.style.display = 'flex';
      if (backBtn) backBtn.style.display = 'block';
      if (tourCounter) {
        tourCounter.style.display = 'block';
        updateTourCounter();
      }
      if (browseBtnQuestions) browseBtnQuestions.style.display = 'block';
      if (progressContainer) {
        progressContainer.style.display = 'flex';
        updateProgressIndicator();
      }
      
      renderVideoQuestion(0);
      resetInactivityTimer();
    }
    
    async function updateTourCounter() {
      const counter = document.getElementById('vq-tour-counter');
      if (!counter) return;
      
      try {
        const params = new URLSearchParams();
        if (videoAnswers.duration) params.append('duration', videoAnswers.duration);
        if (videoAnswers.family_friendly) params.append('family_friendly', videoAnswers.family_friendly);
        
        if (videoAnswers.activities && videoAnswers.activities.length > 0) {
          videoAnswers.activities.forEach(act => {
            if (act) params.append('activities', act);
          });
        }
        
        const response = await fetch(`/api/tours?${params.toString()}`);
        if (!response.ok) {
          counter.textContent = 'Error loading count';
          return;
        }
        
        const data = await response.json();
        const count = data.tours ? data.tours.length : 0;
        counter.textContent = `${count} tours match`;
      } catch (error) {
        console.error('Error fetching tour count:', error);
        counter.textContent = 'Error loading count';
      }
    }
    
    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      
      inactivityTimer = setTimeout(() => {
        if (hasStarted) {
          resetVideoQuestionFlow();
        }
      }, 120000);
    }
    
    function resetVideoQuestionFlow() {
      hasStarted = false;
      currentVideoQuestion = 0;
      videoAnswers = {
        duration: "",
        family_friendly: "",
        activities: []
      };
      document.getElementById('video-start-screen').style.display = 'flex';
      document.getElementById('video-question-container').style.display = 'none';
      document.getElementById('vq-back-btn').style.display = 'none';
      document.getElementById('vq-tour-counter').style.display = 'none';
    }
    
    async function goBackVideoQuestion() {
      if (currentVideoQuestion > 0) {
        currentVideoQuestion--;
        renderVideoQuestion(currentVideoQuestion);
        updateProgressIndicator();
        await updateTourCounter();
        resetInactivityTimer();
      }
    }
    
    function updateProgressIndicator() {
      const progressText = document.getElementById('vq-progress-text');
      const progressFill = document.getElementById('vq-progress-fill');
      
      if (progressText) {
        progressText.textContent = `${translations.questionOf} ${currentVideoQuestion + 1} ${translations.of} 3`;
      }
      if (progressFill) {
        const percentage = ((currentVideoQuestion + 1) / 3) * 100;
        progressFill.style.width = `${percentage}%`;
      }
    }
    
    function renderVideoQuestion(index) {
      const question = videoQuestions[index];
      const questionText = document.getElementById('vq-question-text');
      const answersContainer = document.getElementById('vq-answers');
      
      questionText.textContent = question.question;
      answersContainer.innerHTML = '';
      
      // Update progress indicator
      updateProgressIndicator();
      
      if (question.multiple) {
        const subtitle = document.createElement('p');
        subtitle.className = 'vq-subtitle';
        subtitle.textContent = 'Select all that apply';
        answersContainer.appendChild(subtitle);
      }
      
      question.answers.forEach((answer, idx) => {
        const btn = document.createElement('button');
        btn.className = 'vq-answer-btn';
        btn.innerHTML = answer.text;
        btn.dataset.index = idx;
        btn.dataset.value = answer.value;
        btn.dataset.isSkip = answer.isSkip || false;
        
        if (question.multiple && !answer.isSkip && videoAnswers[answer.filter] && videoAnswers[answer.filter].includes(answer.value)) {
          btn.classList.add('selected');
        }
        
        btn.onclick = (e) => handleVideoAnswer(answer, question.multiple, answer.filter, e.target);
        answersContainer.appendChild(btn);
      });
      
      const firstAnswer = question.answers[0];
      if (question.multiple && firstAnswer && videoAnswers[firstAnswer.filter] && videoAnswers[firstAnswer.filter].length > 0) {
        addContinueButton();
      }
      
      const card = document.getElementById('vq-card');
      card.style.animation = 'none';
      setTimeout(() => {
        card.style.animation = 'slideUpFadeIn 0.8s ease-out';
      }, 10);
      
      document.getElementById('vq-back-btn').style.display = currentVideoQuestion > 0 ? 'block' : 'none';
    }
    
    function addContinueButton() {
      const answersContainer = document.getElementById('vq-answers');
      if (document.getElementById('vq-continue-btn')) return;
      
      const continueBtn = document.createElement('button');
      continueBtn.id = 'vq-continue-btn';
      continueBtn.className = 'vq-answer-btn vq-continue-btn';
      continueBtn.innerHTML = 'Continue →';
      continueBtn.onclick = nextVideoQuestion;
      continueBtn.style.opacity = '0';
      continueBtn.style.transform = 'translateY(20px)';
      answersContainer.appendChild(continueBtn);
      
      // Animate in after a tiny delay to prevent layout shift
      setTimeout(() => {
        continueBtn.style.transition = 'all 0.3s ease';
        continueBtn.style.opacity = '1';
        continueBtn.style.transform = 'translateY(0)';
      }, 10);
    }
    
    async function handleVideoAnswer(answer, isMultiple, filterType, btnElement) {
      resetInactivityTimer();
      
      if (isMultiple) {
        if (answer.isSkip) {
          videoAnswers[filterType] = [];
          document.querySelectorAll('.vq-answer-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
          });
          await updateTourCounter();
          nextVideoQuestion();
        } else {
          const index = videoAnswers[filterType].indexOf(answer.value);
          if (index > -1) {
            videoAnswers[filterType].splice(index, 1);
            btnElement.classList.remove('selected');
          } else {
            videoAnswers[filterType].push(answer.value);
            btnElement.classList.add('selected');
          }
          
          await updateTourCounter();
          
          const continueBtn = document.getElementById('vq-continue-btn');
          if (videoAnswers[filterType].length > 0) {
            if (!continueBtn) addContinueButton();
          } else {
            if (continueBtn) continueBtn.remove();
          }
        }
      } else {
        videoAnswers[filterType] = answer.value;
        await updateTourCounter();
        nextVideoQuestion();
      }
    }
    
    function nextVideoQuestion() {
      resetInactivityTimer();
      currentVideoQuestion++;
      if (currentVideoQuestion < videoQuestions.length) {
        renderVideoQuestion(currentVideoQuestion);
        updateProgressIndicator();
      } else {
        clearTimeout(inactivityTimer);
        
        // Hide progress bar and browse button when showing results
        const progressContainer = document.getElementById('vq-progress-container');
        const browseBtnQuestions = document.getElementById('browse-all-tours-questions');
        if (progressContainer) progressContainer.style.display = 'none';
        if (browseBtnQuestions) browseBtnQuestions.style.display = 'none';
        
        showSwipeResults();
      }
    }
    
    // ===================================================================
    // SWIPE RESULTS - TINDER-STYLE CARD INTERFACE
    // ===================================================================
    
    let swipeCards = [];
    let currentCardIndex = 0;
    let isDragging = false;
    let startX = 0;
    let currentX = 0;
    let isInVideoFlow = false; // Track if we're in the video question flow
    
    async function showSwipeResults() {
      console.log('[TRANSITION] Starting swipe results transition');
      
      const questionCard = document.getElementById('vq-card');
      const backBtn = document.getElementById('vq-back-btn');
      const tourCounter = document.getElementById('vq-tour-counter');
      const swipeOverlay = document.getElementById('swipe-results-overlay');
      
      if (questionCard) questionCard.classList.add('exit-animation');
      if (backBtn) backBtn.style.opacity = '0';
      if (tourCounter) tourCounter.style.opacity = '0';
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      if (questionCard) questionCard.style.display = 'none';
      if (backBtn) backBtn.style.display = 'none';
      if (tourCounter) tourCounter.style.display = 'none';
      
      try {
        const params = new URLSearchParams();
        
        if (videoAnswers.duration && videoAnswers.duration !== '') {
          params.append('duration', videoAnswers.duration);
        }
        if (videoAnswers.family_friendly && videoAnswers.family_friendly !== '') {
          params.append('family_friendly', videoAnswers.family_friendly);
        }
        
        if (videoAnswers.activities && Array.isArray(videoAnswers.activities) && videoAnswers.activities.length > 0) {
          videoAnswers.activities.forEach(act => {
            if (act && act !== '') {
              params.append('activities', act);
            }
          });
        }
        
        const url = `/api/tours${params.toString() ? '?' + params.toString() : ''}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        swipeCards = data.tours || [];
        
        if (swipeCards.length === 0) {
          console.log('[WARNING] No matching tours found');
          window.goToHomePage();
          return;
        }
        
        swipeOverlay.classList.add('active');
        renderSwipeCards();
        
        setTimeout(() => {
          const firstCard = document.querySelector('.swipe-card');
          const actions = document.getElementById('swipe-actions');
          
          if (firstCard) firstCard.classList.add('entering');
          if (actions) actions.classList.add('entering');
        }, 50);
        
      } catch (error) {
        console.error('[ERROR] Error fetching tours:', error);
        window.goToHomePage();
      }
    }
    
    async function renderSwipeCards() {
      if (swipeCards.length === 0) return;
      
      currentCardIndex = 0;
      await displayCurrentCard();
    }
    
    async function displayCurrentCard() {
      if (currentCardIndex >= swipeCards.length) {
        console.log('[SWIPE] No more tours to show');
        window.goToHomePage();
        return;
      }
      
      // Clear any existing animation classes from the container
      const stack = document.getElementById('swipe-card-stack');
      if (stack) {
        const oldElements = stack.querySelectorAll('.swipe-out-left');
        oldElements.forEach(el => el.classList.remove('swipe-out-left'));
      }
      
      const tour = swipeCards[currentCardIndex];
      const fullTourData = await fetchTourDetails(tour.key);
      
      renderGallerySpread(fullTourData);
      renderInfoSections(fullTourData);
      
      // Automatically expand all details
      await expandTourDetails(tour);
    }
    
    async function fetchTourDetails(tourKey) {
      try {
        const response = await fetch(`/tour-detail/${tourKey}?lang=${currentLanguage}`);
        if (!response.ok) throw new Error('Failed to fetch tour details');
        const data = await response.json();
        console.log('[FETCH] Tour details received:', data);
        return data;
      } catch (error) {
        console.error('[ERROR] Failed to fetch tour details:', error);
        return swipeCards[currentCardIndex];
      }
    }
    
    let currentGalleryIndex = 0;
    let currentTourGallery = [];
    
    function renderGallerySpread(tour) {
      const stack = document.getElementById('swipe-card-stack');
      stack.innerHTML = '';
      
      console.log('[GALLERY] Tour object:', tour);
      console.log('[GALLERY] Tour image:', tour.image);
      console.log('[GALLERY] Tour thumbnail:', tour.thumbnail_url);
      console.log('[GALLERY] Tour gallery array:', tour.gallery);
      
      currentTourGallery = tour.gallery || [];
      currentGalleryIndex = 0;
      
      const gallery = tour.gallery || [];
      let images = [];
      
      // Get the main image from gallery (first item) or fallback
      const mainImage = (gallery && gallery.length > 0) ? gallery[0] : '/static/placeholder.jpg';
      console.log('[GALLERY] Main image URL:', mainImage);
      
      if (gallery.length >= 3) {
        // Use first 3 gallery images
        images = [gallery[0], gallery[1], gallery[2]];
      } else if (gallery.length === 2) {
        // Use both gallery images and the first one again
        images = [gallery[0], gallery[1], gallery[0]];
      } else if (gallery.length === 1) {
        // Use the one gallery image 3 times
        images = [gallery[0], gallery[0], gallery[0]];
      } else {
        // No gallery images, use placeholder
        images = [mainImage, mainImage, mainImage];
      }
      
      console.log('[GALLERY] Final images array:', images);
      
      const header = document.createElement('div');
      header.className = 'swipe-card-header slide-down-top';
      header.innerHTML = `
        <h2>${tour.name}</h2>
        <div class="company-chip">${tour.company_name || tour.company || ''}</div>
      `;
      stack.appendChild(header);
      
      const galleryWrapper = document.createElement('div');
      galleryWrapper.className = 'swipe-gallery-wrapper swipe-in-right';
      
      // Always show left arrow
      const leftArrow = document.createElement('button');
      leftArrow.className = 'gallery-nav-arrow left';
      leftArrow.innerHTML = '‹';
      leftArrow.onclick = (e) => {
        e.stopPropagation();
        rotateGallery('left', tour);
      };
      galleryWrapper.appendChild(leftArrow);
      
      const spreadContainer = document.createElement('div');
      spreadContainer.className = 'swipe-gallery-spread';
      spreadContainer.id = 'swipe-gallery-spread';
      
      const leftImg = document.createElement('div');
      leftImg.className = 'swipe-gallery-image left';
      leftImg.innerHTML = `<img src="${images[0]}" alt="Gallery 1">`;
      spreadContainer.appendChild(leftImg);
      
      const centerCard = document.createElement('div');
      centerCard.className = 'swipe-gallery-image center';
      centerCard.innerHTML = `<img src="${images[1]}" alt="${tour.name}">`;
      centerCard.dataset.tourId = tour.key;
      spreadContainer.appendChild(centerCard);
      
      const rightImg = document.createElement('div');
      rightImg.className = 'swipe-gallery-image right';
      rightImg.innerHTML = `<img src="${images[2]}" alt="Gallery 3">`;
      spreadContainer.appendChild(rightImg);
      
      galleryWrapper.appendChild(spreadContainer);
      
      // Always show right arrow
      const rightArrow = document.createElement('button');
      rightArrow.className = 'gallery-nav-arrow right';
      rightArrow.innerHTML = '›';
      rightArrow.onclick = (e) => {
        e.stopPropagation();
        rotateGallery('right', tour);
      };
      galleryWrapper.appendChild(rightArrow);
      
      stack.appendChild(galleryWrapper);
      setupSwipeHandlers(centerCard);
    }
    
    function rotateGallery(direction, tour) {
      const gallery = currentTourGallery;
      if (!gallery || gallery.length === 0) return;
      
      const spreadContainer = document.getElementById('swipe-gallery-spread');
      if (!spreadContainer) return;
      
      // Update index based on direction
      if (direction === 'right') {
        currentGalleryIndex = (currentGalleryIndex + 1) % gallery.length;
      } else {
        currentGalleryIndex = (currentGalleryIndex - 1 + gallery.length) % gallery.length;
      }
      
      // Get the 3 images to display (wrapping around if needed)
      const img1 = gallery[currentGalleryIndex];
      const img2 = gallery[(currentGalleryIndex + 1) % gallery.length];
      const img3 = gallery[(currentGalleryIndex + 2) % gallery.length];
      
      // Add rotation animation
      spreadContainer.classList.add(`rotating-${direction}`);
      
      // Update images after brief delay for animation
      setTimeout(() => {
        const images = spreadContainer.querySelectorAll('.swipe-gallery-image');
        if (images[0]) images[0].querySelector('img').src = img1;
        if (images[1]) images[1].querySelector('img').src = img2;
        if (images[2]) images[2].querySelector('img').src = img3;
        
        // Remove animation class
        spreadContainer.classList.remove(`rotating-${direction}`);
      }, 50);
    }
    
    function renderInfoSections(tour) {
      const container = document.getElementById('swipe-info-sections');
      container.innerHTML = '';
      
      let sectionsAdded = 0;
      
      if (tour.includes && tour.includes.trim() && tour.includes !== 'N/A') {
        const includesBox = document.createElement('div');
        includesBox.className = 'swipe-info-box slide-up-fade';
        
        let items = tour.includes.split(/[\n•]/).filter(item => item.trim() && item.trim() !== '-');
        
        if (items.length === 1) {
          items = tour.includes.split(/[;,]/).filter(item => item.trim());
        }
        
        const itemsList = items.map(item => {
          const cleaned = item.replace(/^[-•✓\s]+/, '').trim();
          return cleaned ? `<li>${cleaned}</li>` : '';
        }).filter(item => item).join('');
        
        if (itemsList) {
          includesBox.innerHTML = `
            <h3>✓ ${translations.whatsIncluded}</h3>
            <ul>${itemsList}</ul>
          `;
          container.appendChild(includesBox);
          sectionsAdded++;
        }
      }
      
      if (tour.highlights && tour.highlights.trim() && tour.highlights !== 'N/A') {
        const highlightsBox = document.createElement('div');
        highlightsBox.className = 'swipe-info-box slide-up-fade';
        
        let highlights = tour.highlights.split(/[\n•]/).filter(item => item.trim() && item.trim() !== '-');
        
        if (highlights.length === 1) {
          highlights = tour.highlights.split(/[;,]/).filter(item => item.trim());
        }
        
        const highlightsList = highlights.map(item => {
          const cleaned = item.replace(/^[-•✓\s]+/, '').trim();
          return cleaned ? `<li>${cleaned}</li>` : '';
        }).filter(item => item).join('');
        
        if (highlightsList) {
          highlightsBox.innerHTML = `
            <h3>⭐ ${translations.highlights}</h3>
            <ul>${highlightsList}</ul>
          `;
          container.appendChild(highlightsBox);
          sectionsAdded++;
        }
      }
      
      if (sectionsAdded === 1) {
        container.style.gridTemplateColumns = '1fr';
        container.style.maxWidth = '600px';
      }
    }
    
    function setupSwipeHandlers(card) {
      if (!card) return;
      
      card.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);
      
      card.addEventListener('touchstart', startDrag);
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', endDrag);
    }
    
    function startDrag(e) {
      isDragging = true;
      startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
      e.currentTarget.classList.add('grabbing');
    }
    
    function drag(e) {
      if (!isDragging) return;
      
      currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
      const diff = currentX - startX;
      const spread = document.querySelector('.swipe-gallery-spread');
      
      if (spread) {
        const rotation = diff / 30;
        spread.style.transform = `translateX(${diff}px) rotate(${rotation}deg)`;
        spread.style.transition = 'none';
      }
    }
    
    function endDrag(e) {
      if (!isDragging) return;
      
      isDragging = false;
      const spread = document.querySelector('.swipe-gallery-spread');
      
      if (!spread) return;
      
      const diff = currentX - startX;
      
      if (Math.abs(diff) > 150) {
        if (diff > 0) {
          acceptCard();
        } else {
          rejectCard();
        }
      } else {
        spread.style.transform = '';
        spread.style.transition = 'transform 0.3s ease';
      }
    }
    
    function rejectCard() {
      console.log('[ACTION] Rejecting tour');
      
      // Animate ALL elements out to the left
      const header = document.querySelector('.swipe-card-header');
      const galleryWrapper = document.querySelector('.swipe-gallery-wrapper');
      const infoSections = document.getElementById('swipe-info-sections');
      const expandedDetails = document.querySelector('.swipe-expanded-details');
      
      // Apply swipe-out animation to all visible elements
      if (header) header.classList.add('swipe-out-left');
      if (galleryWrapper) galleryWrapper.classList.add('swipe-out-left');
      if (infoSections) infoSections.classList.add('swipe-out-left');
      if (expandedDetails) expandedDetails.classList.add('swipe-out-left');
      
      setTimeout(() => {
        currentCardIndex++;
        displayCurrentCard();
      }, 400);
    }
    
    function acceptCard() {
      console.log('[ACTION] Booking tour - redirecting to tour page');
      
      if (currentCardIndex < swipeCards.length) {
        const tour = swipeCards[currentCardIndex];
        // Redirect to tour booking page
        window.location.href = `/tour/${tour.key}?lang=${currentLanguage}`;
      }
    }
    
    async function expandTourDetails(tour) {
      const fullTourData = await fetchTourDetails(tour.key);
      
      const scrollableContent = document.getElementById('swipe-scrollable-content');
      if (!scrollableContent) {
        console.error('[EXPAND] ERROR: scrollable content element not found!');
        return;
      }
      
      const acceptBtn = document.getElementById('accept-btn');
      if (acceptBtn) {
        acceptBtn.querySelector('.swipe-btn-text').textContent = translations.bookNow;
        acceptBtn.querySelector('.swipe-btn-icon').textContent = '✓';
        acceptBtn.classList.add('booking-mode');
        acceptBtn.onclick = () => acceptCard();
      }
      
      const rejectBtn = document.getElementById('reject-btn');
      if (rejectBtn) {
        rejectBtn.querySelector('.swipe-btn-text').textContent = translations.notForMe;
        rejectBtn.querySelector('.swipe-btn-icon').textContent = '✕';
        rejectBtn.onclick = () => rejectCard();
      }
      
      let detailsHtml = '<div class="swipe-expanded-details slide-up-fade">';
      
      // Times, Ages, and Ideal For sections
      const hasTimeInfo = fullTourData.departure_times && fullTourData.departure_times.trim();
      const hasAgeInfo = fullTourData.age_requirements && fullTourData.age_requirements.trim() && !/\band\s+under\b/i.test(fullTourData.age_requirements);
      const hasIdealFor = fullTourData.ideal_for && fullTourData.ideal_for.trim();
      
      if (hasTimeInfo) {
        // Times section always spans full width for better visibility
        const cleanedTimes = cleanBracketFormatting(fullTourData.departure_times);
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>🕐 ${translations.times}</h3>
            <div>${cleanedTimes}</div>
          </div>
        `;
      }
      
      if (hasAgeInfo) {
        // If ages is alone (no ideal for), make it full width
        const ageClass = !hasIdealFor ? 'description-section' : '';
        const cleanedAges = cleanBracketFormatting(fullTourData.age_requirements);
        detailsHtml += `
          <div class="swipe-detail-section ${ageClass}">
            <h3>👥 ${translations.ages}</h3>
            <div>${cleanedAges}</div>
          </div>
        `;
      }
      
      if (hasIdealFor) {
        // If ideal for is alone (no ages), make it full width
        const idealClass = !hasAgeInfo ? 'description-section' : '';
        const cleanedIdealFor = cleanBracketFormatting(fullTourData.ideal_for);
        detailsHtml += `
          <div class="swipe-detail-section ${idealClass}">
            <h3>🎯 ${translations.idealFor}</h3>
            <div>${cleanedIdealFor}</div>
          </div>
        `;
      }
      
      if (fullTourData.description) {
        const cleanedDescription = cleanBracketFormatting(fullTourData.description);
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>📝 About This Tour</h3>
            <div>${cleanedDescription}</div>
          </div>
        `;
      }
      
      if (fullTourData.itinerary && fullTourData.itinerary.trim() && fullTourData.itinerary !== 'N/A') {
        const formattedItinerary = cleanBracketFormatting(fullTourData.itinerary);
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>📅 Itinerary</h3>
            <div>${formattedItinerary}</div>
          </div>
        `;
      }
      
      if (fullTourData.menu && fullTourData.menu.trim() && fullTourData.menu !== 'N/A') {
        const formattedMenu = cleanBracketFormatting(fullTourData.menu);
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>🍽️ Menu</h3>
            <div>${formattedMenu}</div>
          </div>
        `;
      }
      
      if (fullTourData.important_information && fullTourData.important_information.trim() && fullTourData.important_information !== 'N/A' && fullTourData.important_information !== 'null') {
        const formattedInfo = cleanBracketFormatting(fullTourData.important_information);
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>⚠️ ${translations.importantInfo}</h3>
            <div>${formattedInfo}</div>
          </div>
        `;
      }
      
      const hasBring = fullTourData.what_to_bring && fullTourData.what_to_bring.trim() && fullTourData.what_to_bring !== 'N/A' && fullTourData.what_to_bring !== 'null';
      const hasExtra = fullTourData.whats_extra && fullTourData.whats_extra.trim() && fullTourData.whats_extra !== 'N/A' && fullTourData.whats_extra !== 'null';
      
      if (hasBring) {
        const formattedBring = cleanBracketFormatting(fullTourData.what_to_bring);
        // If bring is alone (no extra), make it full width
        const bringClass = !hasExtra ? 'description-section' : '';
        detailsHtml += `
          <div class="swipe-detail-section ${bringClass}">
            <h3>🎒 ${translations.whatToBring}</h3>
            <div>${formattedBring}</div>
          </div>
        `;
      }
      
      if (hasExtra) {
        const formattedExtra = cleanBracketFormatting(fullTourData.whats_extra);
        // If extra is alone (no bring), make it full width
        const extraClass = !hasBring ? 'description-section' : '';
        detailsHtml += `
          <div class="swipe-detail-section ${extraClass}">
            <h3>💰 ${translations.whatsExtra}</h3>
            <div>${formattedExtra}</div>
          </div>
        `;
      }
      
      if (fullTourData.cancellation_policy && fullTourData.cancellation_policy.trim() && fullTourData.cancellation_policy !== 'N/A' && fullTourData.cancellation_policy !== 'null') {
        const formattedPolicy = cleanBracketFormatting(fullTourData.cancellation_policy);
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>📋 Cancellation Policy</h3>
            <div>${formattedPolicy}</div>
          </div>
        `;
      }
      
      if (fullTourData.departure_location && fullTourData.departure_location.trim()) {
        // Extract coordinates if available
        const lat = fullTourData.latitude || fullTourData.lat || -20.2781;
        const lng = fullTourData.longitude || fullTourData.lng || 148.7064;
        
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3>📍 ${translations.departureLocation}</h3>
            <div style="font-weight: 600; margin-bottom: 15px; color: #2c3e50; font-size: 1.15em;">${fullTourData.departure_location}</div>
            <div style="width: 100%; height: 350px; border-radius: 15px; overflow: hidden; margin-bottom: 10px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); position: relative;">
              <iframe 
                width="100%" 
                height="100%"
                frameborder="0" 
                style="border:0; display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(fullTourData.departure_location)}&zoom=14"
                allowfullscreen>
              </iframe>
            </div>
            <div style="color: #2c3e50; font-size: 1.05em;">Please arrive at least 15 minutes before departure time.</div>
          </div>
        `;
      }
      
      if (fullTourData.reviews && fullTourData.reviews.overall_rating > 0 && fullTourData.reviews.review_count > 0) {
        detailsHtml += `
          <div class="swipe-detail-section description-section">
            <h3 style="margin-bottom: 12px;">⭐ ${translations.customerReviews}</h3>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 2em; font-weight: 700; color: #0077b6; line-height: 1;">${fullTourData.reviews.overall_rating.toFixed(1)}</div>
              <div style="display: flex; flex-direction: column; gap: 3px;">
                <div style="font-size: 1.2em; color: #ffa500; line-height: 1; letter-spacing: 1px;">${'★'.repeat(Math.floor(fullTourData.reviews.overall_rating))}${'☆'.repeat(5 - Math.floor(fullTourData.reviews.overall_rating))}</div>
                <div style="color: #2c3e50; font-size: 0.9em; line-height: 1;">${translations.basedOnReviews} ${fullTourData.reviews.review_count} ${translations.reviews}</div>
              </div>
            </div>
            <div class="swipe-reviews-grid">
        `;
        
        if (fullTourData.reviews.reviews && fullTourData.reviews.reviews.length > 0) {
          // Show all reviews (up to 10) with horizontal scrolling - no truncation, let them wrap
          fullTourData.reviews.reviews.slice(0, 10).forEach(review => {
            detailsHtml += `
              <div class="swipe-review-card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <strong style="font-size: 1.15em; color: #2c3e50;">${review.author || 'Customer'}</strong>
                  ${review.rating ? `<span style="color: #ffa500; font-size: 1.3em; white-space: nowrap; margin-left: 10px;">${'★'.repeat(Math.floor(review.rating))}</span>` : ''}
                </div>
                ${review.title ? `<div style="font-weight: 600; color: #0077b6; margin-bottom: 10px; font-size: 1.1em; line-height: 1.3;">${review.title}</div>` : ''}
                ${review.text ? `<p style="margin: 0 0 10px 0; color: #2c3e50; line-height: 1.6; font-size: 1.05em;">${review.text}</p>` : ''}
                ${review.date ? `<div style="font-size: 0.9em; color: #999; margin-top: auto;">${review.date}</div>` : ''}
              </div>
            `;
          });
        }
        
        detailsHtml += '</div></div>';
      }
      
      detailsHtml += '</div>';
      
      scrollableContent.innerHTML = detailsHtml;
      scrollableContent.style.display = 'flex';
      
      // Smooth scroll to show the new sections
      setTimeout(() => {
        const swipeOverlay = document.getElementById('swipe-results-overlay');
        if (swipeOverlay) {
          swipeOverlay.scrollTo({ 
            top: 300, 
            behavior: 'smooth' 
          });
        }
      }, 100);
      
      console.log('[EXPAND] Tour details expanded with all sections');
    }
    
    window.goToStartPage = function() {
      console.log('⬅️ Going back to start screen');
      
      // Add to navigation history
      addToNavigationHistory('video-start');
      
      // Update URL hash
      window.location.hash = 'video-start';
      console.log('🔗 Updated hash to video-start:', window.location.href);
      
      // Hide home page
      const homePage = document.querySelector('.home-page');
      if (homePage) {
        homePage.classList.remove('active');
      }
      
      // Show video question page with start screen
      const videoPage = document.querySelector('.video-question-page');
      if (videoPage) {
        videoPage.classList.add('active');
      }
      
      // Show start screen, hide questions
      const startScreen = document.getElementById('video-start-screen');
      const questionContainer = document.getElementById('video-question-container');
      if (startScreen) startScreen.style.display = 'flex';
      if (questionContainer) questionContainer.style.display = 'none';
      
      // Enable video background
      document.body.classList.add('video-bg-active');
      const video = document.getElementById('bg-video');
      if (video) video.play();
      
      // Hide progress and back button
      const progress = document.getElementById('vq-progress-container');
      const backBtn = document.getElementById('vq-back-btn');
      const browseBtnQuestions = document.getElementById('browse-all-tours-questions');
      if (progress) progress.style.display = 'none';
      if (backBtn) backBtn.style.display = 'none';
      if (browseBtnQuestions) browseBtnQuestions.style.display = 'none';
    };
    
    window.goToHomePage = function() {
      console.log('🏠 Going to regular home page');
      
      activeFilters = {};
      isInVideoFlow = false; // Exit video flow
      
      // Add to navigation history
      addToNavigationHistory('home');
      
      // Update URL hash
      window.location.hash = 'home';
      console.log('🔗 Updated hash to home:', window.location.href);
      
      // Hide video background
      document.body.classList.remove('video-bg-active');
      
      const videoPage = document.querySelector('.video-question-page');
      if (videoPage) {
        videoPage.classList.remove('active');
        videoPage.style.display = 'none';
      }
      
      const swipeOverlay = document.getElementById('swipe-results-overlay');
      if (swipeOverlay) {
        swipeOverlay.classList.remove('active');
        swipeOverlay.style.display = 'none';
      }
      
      const homePage = document.querySelector('.home-page');
      if (homePage) {
        homePage.classList.add('active');
        homePage.style.display = 'flex';
        
        // Show hero section
        const heroSection = document.getElementById('hero-section');
        if (heroSection) heroSection.style.display = 'block';
        
        // Hide company filter nav
        const companyFilterNav = document.getElementById('company-filter-nav');
        if (companyFilterNav) companyFilterNav.style.display = 'none';
        
        // Reload tours
        if (typeof loadInitialFeaturedTours === 'function') {
          loadInitialFeaturedTours();
        }
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'auto' });
      
      resetVideoQuestionFlow();
      
      console.log('✅ Home page active, video flow exited');
    }
    
    function initializeApp() {
      console.log('🎬 Initializing video question flow');
      
      // Show video background on initial load
      document.body.classList.add('video-bg-active');
      
      initVideoQuestionFlow();
      
      const rejectBtn = document.getElementById('reject-btn');
      const acceptBtn = document.getElementById('accept-btn');
      const skipBtn = document.getElementById('skip-to-list-btn');
      
      if (rejectBtn) {
        rejectBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          rejectCard();
        });
      }
      if (acceptBtn) {
        acceptBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('[CLICK] Accept button clicked');
          acceptCard();
        });
      }
      if (skipBtn) {
        skipBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.goToHomePage();
        });
      }
      
      console.log('✅ Video flow initialized');
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
    
    // Helper function to generate star display
    function generateStars(rating, fullOnly = false) {
      const fullStars = Math.floor(rating);
      const hasHalfStar = !fullOnly && (rating % 1 >= 0.5);
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      
      let html = '';
      for (let i = 0; i < fullStars; i++) {
        html += '★';
      }
      if (hasHalfStar) {
        html += '☆';
      }
      for (let i = 0; i < emptyStars; i++) {
        html += '☆';
      }
      return html;
    }
    
    // Navigation history tracking - Enhanced for back button
    let navigationHistory = ['language-selection']; // Start with language selection
    let currentView = 'home'; // 'home', 'filtered', 'company'
    
    // Add to navigation history
    function addToNavigationHistory(pageName) {
      console.log('📝 Adding to history:', pageName);
      navigationHistory.push(pageName);
      console.log('📚 History stack:', navigationHistory);
      updateBackButtonVisibility();
    }
    
    // Go back in navigation history
    function goBackInHistory() {
      console.log('⬅️ Going back in history');
      console.log('📚 Current history stack:', navigationHistory);
      
      // Check if we're on video start page - go back to language selection
      const videoStartScreen = document.getElementById('video-start-screen');
      const isOnVideoStart = videoStartScreen && videoStartScreen.style.display !== 'none' && 
                             document.querySelector('.video-question-page.active');
      
      if (isOnVideoStart) {
        console.log('🌐 On video start - going back to language selection');
        goToLanguageSelection();
        return;
      }
      
      if (navigationHistory.length <= 1) {
        // At the beginning - go to video start page
        console.log('🏠 At start of history - going to video start');
        goToStartPage();
        return;
      }
      
      // Remove current page
      navigationHistory.pop();
      
      // Get previous page
      const previousPage = navigationHistory[navigationHistory.length - 1];
      console.log('🎯 Going back to:', previousPage);
      
      // Navigate based on page type
      if (previousPage === 'video-start') {
        goToStartPage();
      } else if (previousPage === 'language-selection') {
        goToLanguageSelection();
      } else if (previousPage === 'home') {
        goToHomePage();
      } else if (previousPage.startsWith('tour-')) {
        const tourKey = previousPage.substring(5); // Remove 'tour-'
        openTourDetail(tourKey);
      } else if (previousPage.startsWith('swipe-')) {
        // Can't really go back to specific swipe position, so go home
        goToHomePage();
      } else {
        // Default to home
        goToHomePage();
      }
    }
    
    // Go back to language selection screen
    function goToLanguageSelection() {
      console.log('🌐 Going to language selection');
      
      // Clear language preference
      localStorage.removeItem('preferred_language');
      
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
        page.style.display = 'none';
      });
      
      // Show video page
      const videoPage = document.querySelector('.video-question-page');
      if (videoPage) {
        videoPage.classList.add('active');
        videoPage.style.display = 'block';
      }
      
      // Show language selection screen
      const langScreen = document.getElementById('language-selection-screen');
      if (langScreen) {
        langScreen.classList.remove('hidden');
        langScreen.style.display = 'flex';
      }
      
      // Hide video start screen
      const videoStartScreen = document.getElementById('video-start-screen');
      if (videoStartScreen) {
        videoStartScreen.style.display = 'none';
      }
      
      // Add body class to hide header
      document.body.classList.add('showing-language-selection');
      
      // Hide header
      updateBackButtonVisibility();
      
      // Reset navigation history
      navigationHistory = ['language-selection'];
      
      // Update hash
      window.location.hash = '';
    }
    
    // Update back button and header visibility
    function updateBackButtonVisibility() {
      const backBtn = document.getElementById('global-back-button');
      
      // Check if we're at language selection
      const langScreen = document.getElementById('language-selection-screen');
      const isAtLanguageSelection = langScreen && !langScreen.classList.contains('hidden');
      
      // Toggle body class for header visibility
      if (isAtLanguageSelection) {
        document.body.classList.add('showing-language-selection');
      } else {
        document.body.classList.remove('showing-language-selection');
      }
      
      if (backBtn) {
        // Always show back button unless we're at language selection
        if (isAtLanguageSelection) {
          backBtn.style.display = 'none';
        } else {
          backBtn.style.display = 'flex';
        }
      }
    }
    
    // Progressive filter functionality
    let activeFilters = {};
    let currentQuestion = 1;
    const totalQuestions = 5;
    
    const filterLabels = {
      duration: {
        half_day: 'Half Day',
        full_day: 'Full Day', 
        multi_day: 'Multi-day'
      },
      family: {
        true: 'Family-friendly',
        false: 'Adults only'
      },
      price: {
        budget: 'Up to $100',
        mid_range: 'Up to $250',
        premium: 'Up to $500',
        luxury: 'Up to $1000'
      },
      activity: {
        great_barrier_reef: 'Great Barrier Reef',
        whitehaven_beach: 'Whitehaven Beach',
        island_tours: 'Island Tours',
        scenic_adventure: 'Scenic & Adventure'
      },
      meals: {
        true: 'Meals included'
      },
      equipment: {
        true: 'Equipment provided'
      }
    };
    
    function updateFilterSummary() {
      const summaryContent = document.getElementById('filter-summary-content');
      const summary = document.getElementById('filter-summary');
      
      // If these elements don't exist (new home page design), skip this function
      if (!summaryContent || !summary) {
        return;
      }
      
      let html = '';
      let hasFilters = false;
      
      const lang = translations && translations[currentLanguage] ? translations[currentLanguage] : translations['en'];
      
      if (activeFilters.duration) {
        const durationKey = activeFilters.duration === 'half_day' ? 'half_day' :
                           activeFilters.duration === 'full_day' ? 'full_day' : 'multi_day';
        html += `<div class="filter-summary-item">⏰ ${t(durationKey)}</div>`;
        hasFilters = true;
      }
      if (activeFilters.family) {
        const familyText = activeFilters.family === 'true' ? t('family_with_kids') : t('adults_only');
        html += `<div class="filter-summary-item">👨‍👩‍👧‍👦 ${familyText}</div>`;
        hasFilters = true;
      }
      if (activeFilters.price) {
        html += `<div class="filter-summary-item">💰 ${filterLabels.price[activeFilters.price]}</div>`;
        hasFilters = true;
      }
      if (activeFilters.activity) {
        // Handle both array (multi-select) and string (single select)
        const activities = Array.isArray(activeFilters.activity) ? activeFilters.activity : [activeFilters.activity];
        activities.forEach(activity => {
          html += `<div class="filter-summary-item">🎯 ${filterLabels.activity[activity]}</div>`;
        });
        hasFilters = true;
      }
      if (activeFilters.meals) {
        html += `<div class="filter-summary-item">🍽️ ${t('meals_included')}</div>`;
        hasFilters = true;
      }
      if (activeFilters.equipment) {
        html += `<div class="filter-summary-item">🎒 ${t('equipment_provided')}</div>`;
        hasFilters = true;
      }
      
      summaryContent.innerHTML = html;
      summary.style.display = hasFilters ? 'block' : 'none';
    }
    
    function applyFilters() {
      const params = new URLSearchParams();
      
      // Handle the inclusions question specially (question 5)
      if (activeFilters.inclusions) {
        const val = activeFilters.inclusions;
        if (val === 'meals') {
          params.append('meals', 'true');
        } else if (val === 'equipment') {
          params.append('equipment', 'true');
        } else if (val === 'both') {
          params.append('meals', 'true');
          params.append('equipment', 'true');
        }
      } else {
        // Add regular filters
        if (activeFilters.meals) params.append('meals', activeFilters.meals);
        if (activeFilters.equipment) params.append('equipment', activeFilters.equipment);
      }
      
      // Add other filters
      for (const [key, value] of Object.entries(activeFilters)) {
        if (key !== 'inclusions' && key !== 'meals' && key !== 'equipment' && value) {
        params.append(key, value);
        }
      }
      
      // Add language parameter
      params.append('lang', currentLanguage);
      
      document.getElementById('results-info').innerHTML = '🔍 Searching for tours...';
      
      fetch(`/filter-tours?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          displayFilteredTours(data.tours);
          document.getElementById('results-info').innerHTML = 
            `Found ${data.total_found} tour${data.total_found !== 1 ? 's' : ''} matching your preferences`;
        })
        .catch(error => {
          console.error('Filter error:', error);
          document.getElementById('results-info').innerHTML = 'Error filtering tours. Please try again.';
        });
    }
    
    function nextQuestion() {
      if (currentQuestion < totalQuestions) {
        // Hide current question
        document.querySelector(`.filter-question[data-question="${currentQuestion}"]`).classList.remove('active');
        
        // Show next question
        currentQuestion++;
        document.querySelector(`.filter-question[data-question="${currentQuestion}"]`).classList.add('active');
        
        // Update progress bar
        const progressPercent = (currentQuestion / totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = progressPercent + '%';
        
        // Update progress text
        if (currentQuestion === totalQuestions) {
          document.getElementById('filter-progress').textContent = 'Almost done! Last question...';
        } else {
          const progressText = t('question_of').replace('{current}', currentQuestion).replace('{total}', totalQuestions);
          document.getElementById('filter-progress').textContent = progressText;
        }
        
        // Scroll to top of filter panel smoothly
        document.getElementById('filter-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        // All questions answered - scroll to results
        document.getElementById('content-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    function clearFilters() {
      activeFilters = {};
      currentQuestion = 1;
      budgetSelected = false;
      previousTourKey = null; // Clear the previous tour key
      
      // Show hero section and hide company filter nav
      const heroSection = document.getElementById('hero-section');
      const companyFilterNav = document.getElementById('company-filter-nav');
      if (heroSection) heroSection.style.display = 'block';
      if (companyFilterNav) companyFilterNav.style.display = 'none';
      
      // Reset tour titles
      const title = document.getElementById('home-tours-title');
      const subtitle = document.getElementById('home-tours-subtitle');
      if (title) title.textContent = 'Tap Any Card For Booking and More Info';
      if (subtitle) subtitle.textContent = 'Showing all available tours';
      
      // Clear budget slider
      const budgetSliderEl = document.getElementById('budget-slider');
      const budgetLabelEl = document.getElementById('budget-label-display');
      const confirmBudgetBtnEl = document.getElementById('confirm-budget-btn');
      if (budgetSliderEl) {
        budgetSliderEl.value = 1;
      }
      if (budgetLabelEl) {
        budgetLabelEl.textContent = 'Move the slider to set your budget';
      }
      if (confirmBudgetBtnEl) {
        confirmBudgetBtnEl.style.display = 'none';
      }
      
      // Clear all filter options
      document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelectorAll('.filter-question').forEach(q => q.classList.remove('active'));
      const firstQuestion = document.querySelector('.filter-question-card[data-question="1"]');
      if (firstQuestion) firstQuestion.style.display = 'block';
      
      // Clear duration pills selection
      document.querySelectorAll('.duration-pill').forEach(pill => pill.classList.remove('selected'));
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Reload all tours from scratch
      loadInitialFeaturedTours();
    }
    
    function displayFilteredTours(tours) {
      console.log('📋 displayFilteredTours called with', tours.length, 'tours');
      const grid = document.getElementById('tour-placeholder-row');
      if (!grid) {
        console.error('❌ Grid not found!');
        return;
      }
      
      grid.innerHTML = '';
      
      tours.forEach(tour => {
        // Skip Ocean Dynamics results
        if (shouldHideTour(tour)) return;
        
        const card = document.createElement('article');
        card.className = 'tour-card-large';
        card.setAttribute('data-key', tour.key);
        card.setAttribute('data-departure', tour.departure_location || '');
        
        // Force visibility with inline styles
        card.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; min-height: 400px !important; border-radius: 20px !important; overflow: hidden !important; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important; z-index: 5 !important;';
        
        // Generate rating display
        let ratingHtml = '';
        if (tour.review_rating && tour.review_rating > 0 && tour.review_count && tour.review_count > 0) {
          ratingHtml = `<span class="rating">★ ${tour.review_rating.toFixed(1)} (${tour.review_count})</span>`;
        }
        
        // Use tour-card-large format (matches template)
        card.innerHTML = `
          <div class="tour-card-image" style="background-image: url('${tour.thumbnail || '/static/placeholder.jpg'}'); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center;"></div>
          <div class="tour-card-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; padding: 35px 30px; background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%); color: white;">
            <span class="operator-chip" style="display: inline-block; padding: 8px 16px; background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); border-radius: 20px; font-size: 0.9em; margin-bottom: 12px;">${tour.company_name ? tour.company_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}</span>
            <h2 class="tour-name" style="font-size: 1.8em; font-weight: 700; margin: 0 0 15px 0;">${tour.name}</h2>
            <div class="tour-meta" style="display: flex; align-items: center; gap: 15px; font-size: 1.1em;">
              ${ratingHtml}
              <span class="price-badge" style="font-weight: 700; font-size: 1.2em;">From ${tour.price_adult || 'Contact for price'}</span>
            </div>
          </div>
        `;
        
        card.onclick = () => openTourDetail(tour.key);
        grid.appendChild(card);
      });
      
      console.log('✅ Added', grid.children.length, 'cards to grid');
      
      // Hide load more button when filtering
      document.getElementById('load-more-btn').style.display = 'none';
    }
    
    // Budget slider configuration (function to get translations)
    function getBudgetRanges() {
      return [
        { value: 0, label: '💰 Up to $100', category: 'budget' },
        { value: 1, label: '💰 Up to $250', category: 'mid_range' },
        { value: 2, label: '💰 Up to $500', category: 'premium' },
        { value: 3, label: '💰 Up to $1000', category: 'luxury' },
        { value: 4, label: 'Any Price', category: '' }
      ];
    }
    
    let budgetSliderTimer = null;
    let budgetSelected = false;
    
    // Budget slider handlers
    const budgetSlider = document.getElementById('budget-slider');
    const budgetLabel = document.getElementById('budget-label-display');
    const skipBudgetBtn = document.getElementById('skip-budget-btn');
    const confirmBudgetBtn = document.getElementById('confirm-budget-btn');
    
    if (budgetSlider) {
      // Update label and filter in real-time as slider moves
      budgetSlider.addEventListener('input', (e) => {
        const sliderValue = parseInt(e.target.value);
        const range = getBudgetRanges()[sliderValue];
        
        // Update display label
        budgetLabel.textContent = range.label;
        
        // Update filter in real-time
        if (range.category) {
          activeFilters.price = range.category;
        } else {
          delete activeFilters.price;
        }
        
        // Update summary
        updateFilterSummary();
        
        // Apply filters immediately for live feedback
        applyFilters();
        
        // Show/hide confirm button based on slider position
        if (confirmBudgetBtn) {
          if (sliderValue > 0) {
            confirmBudgetBtn.style.display = 'block';
          } else {
            confirmBudgetBtn.style.display = 'none';
          }
        }
      });
      
      // When user releases the slider, scroll to show results
      budgetSlider.addEventListener('change', (e) => {
        budgetSelected = true;
        
        // Brief scroll to peek at results
        setTimeout(() => {
          const contentArea = document.getElementById('content-area');
          const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
          const contentTop = contentArea.offsetTop;
          
          if (currentScroll < contentTop - 100) {
            window.scrollTo({ 
              top: Math.min(currentScroll + 200, contentTop - 50), 
              behavior: 'smooth' 
            });
          }
        }, 200);
      });
      
      // Confirm button - proceed to next question
      if (confirmBudgetBtn) {
        confirmBudgetBtn.onclick = () => {
          setTimeout(() => {
            nextQuestion();
          }, 300);
        };
      }
      
      // Skip button for budget
      if (skipBudgetBtn) {
        skipBudgetBtn.onclick = () => {
          delete activeFilters.price;
          budgetSlider.value = 0;
          budgetLabel.textContent = t('move_slider');
          confirmBudgetBtn.style.display = 'none';
          updateFilterSummary();
          applyFilters();
          
          setTimeout(() => {
            nextQuestion();
          }, 400);
        };
      }
    }
    
    // Add click handlers to filter options (for non-slider questions)
    document.querySelectorAll('.filter-option').forEach(option => {
      option.onclick = () => {
        const question = option.closest('.filter-question');
        const filterType = question.getAttribute('data-filter');
        const value = option.getAttribute('data-value');
        
        // Remove selected class from all options in this question
        question.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
        
        // Mark this option as selected
        option.classList.add('selected');
        
        // Update active filters
        if (value) {
          activeFilters[filterType] = value;
        } else {
          delete activeFilters[filterType];
        }
        
        // Update summary
        updateFilterSummary();
        
        // Apply filters immediately
        applyFilters();
        
        // Brief scroll to peek at results (touchscreen feedback)
        setTimeout(() => {
          const contentArea = document.getElementById('content-area');
          const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
          const contentTop = contentArea.offsetTop;
          
          // If user is at top, scroll down a bit to show results are updating
          if (currentScroll < contentTop - 100) {
            window.scrollTo({ 
              top: Math.min(currentScroll + 200, contentTop - 50), 
              behavior: 'smooth' 
            });
          }
        }, 200);
        
        // Move to next question after a delay
        setTimeout(() => {
          nextQuestion();
        }, 600);
      };
    });
    
    // =====================================================================
    // MODERN KIOSK HOME PAGE - Duration Pill Handlers
    // =====================================================================
    
    // Update header chips with current language and currency
    function updateHeaderChips() {
      // Update global header
      updateGlobalHeaderChips();
      
      // Update home page header
      const langBtn = document.getElementById('header-language-btn');
      const currBtn = document.getElementById('header-currency-btn');
      
      if (langBtn) {
        langBtn.textContent = currentLanguage ? currentLanguage.toUpperCase() : 'EN';
      }
      if (currBtn) {
        currBtn.textContent = currentCurrency || 'AUD';
      }
      
      // Update tour list page header
      const listLangBtn = document.getElementById('list-language-btn');
      const listCurrBtn = document.getElementById('list-currency-btn');
      
      if (listLangBtn) {
        listLangBtn.textContent = currentLanguage ? currentLanguage.toUpperCase() : 'EN';
      }
      if (listCurrBtn) {
        listCurrBtn.textContent = currentCurrency || 'AUD';
      }
      
      // Update tour detail page header
      const detailLangBtn = document.getElementById('detail-language-btn');
      const detailCurrBtn = document.getElementById('detail-currency-btn');
      
      if (detailLangBtn) {
        detailLangBtn.textContent = currentLanguage ? currentLanguage.toUpperCase() : 'EN';
      }
      if (detailCurrBtn) {
        detailCurrBtn.textContent = currentCurrency || 'AUD';
      }
    }
    
    // Call this when language or currency changes
    document.addEventListener('DOMContentLoaded', () => {
      updateHeaderChips();
      
      // Auto-open tour if tour_to_open parameter is passed from Flask
      {% if tour_to_open %}
      console.log('🎯 Auto-opening tour from shared link:', '{{ tour_to_open }}');
      
      // Check if video page is active - if so, don't auto-open (user is in video flow)
      const videoPage = document.querySelector('.video-question-page');
      const isVideoActive = videoPage && videoPage.classList.contains('active');
      
      if (!isVideoActive) {
        setTimeout(() => {
          openTourDetail('{{ tour_to_open }}');
        }, 500); // Small delay to ensure page is fully loaded
      } else {
        console.log('🚫 Skipping auto-open because video page is active');
      }
      {% endif %}
    });
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
      console.log('🔙 Browser back/forward button clicked', event.state);
      
      // Since we no longer change URLs, just close tour detail if it's open
      const tourDetailPage = document.querySelector('.page.tour-detail-page');
      if (tourDetailPage && tourDetailPage.classList.contains('active')) {
        document.getElementById('back-arrow').click();
      }
    });
    
    // Show map view from home page
    async function showMapFromHome() {
      console.log('🗺️ ============ SWITCHING TO MAP VIEW ============');
      console.log('   activeFilters:', JSON.stringify(activeFilters, null, 2));
      console.log('   Filter keys:', Object.keys(activeFilters));
      console.log('   Filter count:', Object.keys(activeFilters).length);
      console.log('   mapTourData length:', mapTourData.length);
      
      // List each filter individually for debugging
      if (activeFilters.duration) console.log('   ✓ Duration filter:', activeFilters.duration);
      if (activeFilters.family) console.log('   ✓ Family filter:', activeFilters.family);
      if (activeFilters.price) console.log('   ✓ Price filter:', activeFilters.price);
      if (activeFilters.activity) console.log('   ✓ Activity filter:', activeFilters.activity);
      if (activeFilters.meals) console.log('   ✓ Meals filter:', activeFilters.meals);
      if (activeFilters.equipment) console.log('   ✓ Equipment filter:', activeFilters.equipment);
      
      // Hide featured tours section
      const featuredSection = document.getElementById('featured-tours-section');
      if (featuredSection) {
        featuredSection.style.display = 'none';
      }
      
      // Show map view section
      const mapSection = document.getElementById('home-map-view-section');
      if (mapSection) {
        mapSection.style.display = 'block';
      }
      
      // Update the map view button text
      const mapViewBtn = document.querySelector('.home-page .chip-outline');
      if (mapViewBtn) {
        mapViewBtn.textContent = 'Grid view';
        mapViewBtn.onclick = () => showGridFromHome();
      }
      
      // Initialize map if not already done
      initializeHomeMap();
      
      // Check if we have filters
      const hasFilters = Object.keys(activeFilters).length > 0;
      
      if (hasFilters) {
        // We have filters - always fetch to ensure correct data
        // (handles race condition where user clicks Map view before grid fetch completes)
        console.log('   ✅ HAS FILTERS - Fetching filtered tours for map view');
        console.log('   Filter keys before fetch:', Object.keys(activeFilters));
        console.log('   Filter values:', JSON.stringify(activeFilters, null, 2));
        await fetchFilteredToursForMap();  // Wait for fetch to complete
        console.log('   ✅ Fetch complete, mapTourData.length:', mapTourData.length);
      } else if (mapTourData.length > 0) {
        // No filters, but we have data - use it
        console.log('   Using existing mapTourData (no filters):', mapTourData.length, 'tours');
        setTimeout(() => {
          updateHomeMapPins();
          populateHomeCarousel(null);
          
          if (homeMap) {
            homeMap.invalidateSize();
            console.log('✅ Home map size refreshed');
          }
        }, 150);
      } else {
        // No filters and no data - fetch all tours
        console.log('   Fetching all tours for map view');
        const params = new URLSearchParams();
        params.append('for_map', 'true');
        params.append('lang', currentLanguage);
        
        fetch(`/filter-tours?${params.toString()}`)
          .then(response => response.json())
          .then(data => {
            mapTourData = data.tours;
            console.log(`   Loaded ${mapTourData.length} tours`);
            updateHomeMapPins();
            populateHomeCarousel(null);
            
            // Refresh map size after data is loaded
            setTimeout(() => {
              if (homeMap) {
                homeMap.invalidateSize();
                console.log('✅ Home map size refreshed');
              }
            }, 100);
          });
      }
    }
    
    // Show grid view from home page map
    function showGridFromHome() {
      console.log('📋 Switching back to grid view...');
      console.log('   Current activeFilters:', JSON.stringify(activeFilters, null, 2));
      console.log('   Filter count:', Object.keys(activeFilters).length);
      console.log('   mapTourData length:', mapTourData.length);
      
      // Show featured tours section
      const featuredSection = document.getElementById('featured-tours-section');
      if (featuredSection) {
        featuredSection.style.display = 'block';
      }
      
      // Hide map view section
      const mapSection = document.getElementById('home-map-view-section');
      if (mapSection) {
        mapSection.style.display = 'none';
      }
      
      // Update the button text
      const mapViewBtn = document.querySelector('.home-page .chip-outline');
      if (mapViewBtn) {
        mapViewBtn.textContent = 'Map view';
        mapViewBtn.onclick = () => showMapFromHome();
      }
      
      // Clear location filter (but keep questionnaire filters)
      selectedLocation = null;
      
      // Remove all marker highlights
      Object.entries(markers).forEach(([name, marker]) => {
        const markerElement = marker.getElement();
        if (markerElement) {
          markerElement.querySelector('.custom-marker')?.classList.remove('highlighted');
          markerElement.style.opacity = '1';
        }
      });
      
      // If we have mapTourData, display it in grid view
      // Otherwise fetch with filters
      if (mapTourData.length > 0) {
        console.log('   Using existing mapTourData for grid view');
        displayFilteredTours(mapTourData, mapTourData.length);
      } else {
        // No data - fetch it
        const hasFilters = Object.keys(activeFilters).length > 0;
        if (hasFilters) {
          console.log('   Fetching filtered tours for grid view');
          applyFiltersModern();
        } else {
          console.log('   Loading all tours for grid view');
          loadInitialFeaturedTours();
        }
      }
    }
    
    // Track home page state
    let homePageOffset = 0;
    let homePageLoadedKeys = [];
    let homePageHasMore = true;
    let homePageTotalCount = 0;
    let isLoadingMoreTours = false;
    
    // Initialize home page
    document.addEventListener('DOMContentLoaded', function() {
      // Reset question counter
      currentQuestion = 1;
      activeFilters = {};
      
      // Load initial tours immediately
      loadInitialFeaturedTours();
      
      // Setup infinite scroll
      setupInfiniteScroll();
      
      console.log('Home page initialized - Question 1 ready, tours loading');
    });
    
    // Setup infinite scroll detection
    function setupInfiniteScroll() {
      const homePage = document.querySelector('.home-page');
      if (!homePage) return;
      
      // Listen to both home page scroll and window scroll (for mobile)
      const checkScroll = () => {
        if (isLoadingMoreTours || !homePageHasMore) return;
        
        // Check if home page is visible
        if (homePage.style.display === 'none') return;
        
        // Check window scroll position
        const scrollPosition = window.scrollY + window.innerHeight;
        const scrollHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 500px from bottom
        if (scrollPosition >= scrollHeight - 500) {
          loadMoreHomePageTours();
        }
      };
      
      // Listen to home page scroll (for desktop with scrollable container)
      homePage.addEventListener('scroll', () => {
        if (isLoadingMoreTours || !homePageHasMore) return;
        
        const scrollPosition = homePage.scrollTop + homePage.clientHeight;
        const scrollHeight = homePage.scrollHeight;
        
        if (scrollPosition >= scrollHeight - 500) {
          loadMoreHomePageTours();
        }
      });
      
      // Listen to window scroll (for mobile and when home page fills viewport)
      window.addEventListener('scroll', checkScroll);
      
      console.log('Infinite scroll setup complete (window + home page)');
    }
    
    // Load initial featured tours for home page
    function loadInitialFeaturedTours() {
      homePageOffset = 0;
      homePageLoadedKeys = [];
      homePageHasMore = true;
      
      fetch(`/more-tours?offset=0&count=12&exclude=&lang=${currentLanguage}`)
        .then(response => response.json())
        .then(tours => {
          homePageOffset = tours.length;
          // homePageLoadedKeys will be set by displayFeaturedTours
          displayFeaturedTours(tours, false); // false = replace, not append
          
          // Enable infinite scroll if we got a full page
          homePageHasMore = tours.length >= 12;
          
          // Update subtitle with total count
          const subtitle = document.getElementById('home-tours-subtitle');
          if (subtitle) {
            subtitle.textContent = 'Showing all available tours';
          }
          
          // Also fetch ALL tours for map view (with location data)
          console.log('📡 Also fetching all tours for map view');
          fetch(`/filter-tours?for_map=true&lang=${currentLanguage}`)
            .then(response => response.json())
            .then(mapData => {
              mapTourData = mapData.tours || [];
              console.log(`✅ Stored ${mapTourData.length} tours in mapTourData`);
            })
            .catch(error => {
              console.error('❌ Error fetching map data:', error);
            });
        })
        .catch(error => {
          console.error('Error loading featured tours:', error);
        });
    }
    
    // Progressive filtering - Question handlers
    // Restore visual selections when going back to a question
    function restoreQuestionSelections(questionNum) {
      console.log('🔄 Restoring selections for question', questionNum);
      
      if (questionNum === 1) {
        // Duration - highlight selected button
        const duration = activeFilters.duration;
        if (duration) {
          document.querySelectorAll('[data-value]').forEach(btn => {
            if (btn.getAttribute('data-value') === duration) {
              btn.classList.add('selected');
            } else {
              btn.classList.remove('selected');
            }
          });
        }
      } else if (questionNum === 2) {
        // Family - no special restoration needed, single-select
      } else if (questionNum === 3) {
        // Activity - restore multi-select
        const activities = activeFilters.activity;
        if (Array.isArray(activities)) {
          activities.forEach(activity => {
            selectedActivities.add(activity);
            const btn = document.querySelector(`[data-activity="${activity}"]`);
            if (btn) {
              btn.classList.add('duration-pill--selected');
            }
          });
        }
      } else if (questionNum === 4) {
        // Extras - restore multi-select
        if (activeFilters.meals) {
          selectedExtras.add('meals');
          const btn = document.querySelector('[data-extra="meals"]');
          if (btn) btn.classList.add('duration-pill--selected');
        }
        if (activeFilters.equipment) {
          selectedExtras.add('equipment');
          const btn = document.querySelector('[data-extra="equipment"]');
          if (btn) btn.classList.add('duration-pill--selected');
        }
      } else if (questionNum === 4) {
        // Price slider - restore slider position
        const slider = document.getElementById('budget-slider');
        const display = document.getElementById('budget-display');
        if (slider && activeFilters.price) {
          const priceMap = {
            'budget': 0,
            'mid_range': 1,
            'premium': 2,
            'luxury': 3,
            '': 4
          };
          const value = priceMap[activeFilters.price] || 4;
          slider.value = value;
          updateBudgetDisplay(value);
        }
      }
    }
    
    function selectDuration(value) {
      console.log('⏱️ Duration selected:', value);
      if (value) {
        activeFilters.duration = value;
      } else {
        delete activeFilters.duration;
      }
      console.log('   activeFilters after:', JSON.stringify(activeFilters));
      updateToursAndAdvance();
    }
    
    function selectFamily(value) {
      console.log('👨‍👩‍👧 Family selected:', value);
      if (value) {
        activeFilters.family = value;
      } else {
        delete activeFilters.family;
      }
      console.log('   activeFilters after:', JSON.stringify(activeFilters));
      updateToursAndAdvance();
    }
    
    function selectPrice(value) {
      console.log('💰 Price selected:', value);
      if (value) {
        activeFilters.price = value;
      } else {
        delete activeFilters.price;
      }
      console.log('   activeFilters after:', JSON.stringify(activeFilters));
      updateToursAndAdvance();
    }
    
    // Update budget display as slider moves
    function updateBudgetDisplay(value) {
      const display = document.getElementById('budget-display');
      const labels = ['💰 Up to $100', '💰 Up to $250', '💰 Up to $500', '💰 Up to $1000', 'Any Price'];
      const prices = ['budget', 'mid_range', 'premium', 'luxury', ''];
      
      if (display) {
        display.textContent = labels[value];
      }
      
      // Real-time filtering as user drags
      const priceFilter = prices[value];
      if (priceFilter) {
        activeFilters.price = priceFilter;
      } else {
        delete activeFilters.price;
      }
      
      // Update tours in real-time without advancing to next question
      const hasFilters = Object.keys(activeFilters).length > 0;
      
      // Check if we're in map view
      const homeMapSection = document.getElementById('home-map-view-section');
      const isInMapView = homeMapSection && homeMapSection.style.display !== 'none';
      
      if (hasFilters) {
        if (isInMapView) {
          console.log('🗺️ Updating map view with price filter');
          fetchFilteredToursForMap();
        } else {
          console.log('📊 Updating grid view with price filter');
          applyFiltersModern();
        }
      }
      
      // Update the filter summary to show current selection
      updateFilterSummaryDisplay();
    }
    
    // Confirm budget selection and advance
    function confirmBudget() {
      const slider = document.getElementById('budget-slider');
      const value = slider ? slider.value : 4;
      const prices = ['budget', 'mid_range', 'premium', 'luxury', ''];
      const priceFilter = prices[value];
      
      console.log('💰 Budget confirmed:', priceFilter);
      
      if (priceFilter) {
        activeFilters.price = priceFilter;
      } else {
        delete activeFilters.price;
      }
      
      // Advance to next question or finish
      updateToursAndAdvance();
    }
    
    // Multi-select activity toggle
    let selectedActivities = new Set();
    
    function toggleActivity(value, button) {
      const wasSelected = selectedActivities.has(value);
      console.log('🎯 Activity toggled:', value, wasSelected ? '(UNSELECTING)' : '(SELECTING)');
      
      if (wasSelected) {
        selectedActivities.delete(value);
        button.classList.remove('duration-pill--selected');
        console.log('   ❌ Removed from selection');
      } else {
        selectedActivities.add(value);
        button.classList.add('duration-pill--selected');
        console.log('   ✅ Added to selection');
      }
      
      console.log('   Current selections:', Array.from(selectedActivities));
      
      // Update filters with multiple activities
      if (selectedActivities.size > 0) {
        activeFilters.activity = Array.from(selectedActivities);
        console.log('   📋 Updated activeFilters.activity:', activeFilters.activity);
      } else {
        delete activeFilters.activity;
        console.log('   🗑️ Cleared activeFilters.activity (no selections)');
      }
      
      // Update tours in real-time
      const hasFilters = Object.keys(activeFilters).length > 0;
      const homeMapSection = document.getElementById('home-map-view-section');
      const isInMapView = homeMapSection && homeMapSection.style.display !== 'none';
      
      console.log('   🔄 Updating tour display... (hasFilters:', hasFilters, ', isMapView:', isInMapView, ')');
      
      if (hasFilters) {
        if (isInMapView) {
          fetchFilteredToursForMap();
        } else {
          applyFiltersModern();
        }
      } else {
        // No filters at all - show all tours
        console.log('   🌍 No filters active, showing all tours');
        if (isInMapView) {
          const params = new URLSearchParams();
          params.append('for_map', 'true');
          params.append('lang', currentLanguage);
          fetch(`/filter-tours?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
              mapTourData = data.tours;
              updateHomeMapPins();
              populateHomeCarousel(null);
            });
        } else {
          loadInitialFeaturedTours();
        }
      }
      updateFilterSummaryDisplay();
    }
    
    function confirmActivity() {
      console.log('✅ Confirming activities:', Array.from(selectedActivities));
      updateToursAndAdvance();
    }
    
    function skipActivity() {
      console.log('⏭️ Skipping activity selection');
      selectedActivities.clear();
      delete activeFilters.activity;
      
      // Clear all selected states
      document.querySelectorAll('[data-activity]').forEach(btn => {
        btn.classList.remove('duration-pill--selected');
      });
      
      updateToursAndAdvance();
    }
    
    function selectActivity(value) {
      console.log('🎯 Activity selected:', value);
      if (value) {
        activeFilters.activity = value;
      } else {
        delete activeFilters.activity;
      }
      console.log('   activeFilters after:', JSON.stringify(activeFilters));
      updateToursAndAdvance();
    }
    
    // Multi-select extras toggle
    let selectedExtras = new Set();
    
    function toggleExtra(value, button) {
      const wasSelected = selectedExtras.has(value);
      console.log('🎒 Extra toggled:', value, wasSelected ? '(UNSELECTING)' : '(SELECTING)');
      
      if (wasSelected) {
        selectedExtras.delete(value);
        button.classList.remove('duration-pill--selected');
        console.log('   ❌ Removed from selection');
        
        // Remove from activeFilters
        if (value === 'meals') {
          delete activeFilters.meals;
        } else if (value === 'equipment') {
          delete activeFilters.equipment;
        }
      } else {
        selectedExtras.add(value);
        button.classList.add('duration-pill--selected');
        console.log('   ✅ Added to selection');
        
        // Add to activeFilters
        if (value === 'meals') {
          activeFilters.meals = 'true';
        } else if (value === 'equipment') {
          activeFilters.equipment = 'true';
        }
      }
      
      console.log('   Current selections:', Array.from(selectedExtras));
      console.log('   Active filters:', activeFilters);
      
      // Update tours in real-time
      const hasFilters = Object.keys(activeFilters).length > 0;
      const homeMapSection = document.getElementById('home-map-view-section');
      const isInMapView = homeMapSection && homeMapSection.style.display !== 'none';
      
      console.log('   🔄 Updating tour display... (hasFilters:', hasFilters, ', isMapView:', isInMapView, ')');
      
      if (hasFilters) {
        if (isInMapView) {
          fetchFilteredToursForMap();
        } else {
          applyFiltersModern();
        }
      } else {
        // No filters at all - show all tours
        console.log('   🌍 No filters active, showing all tours');
        if (isInMapView) {
          const params = new URLSearchParams();
          params.append('for_map', 'true');
          params.append('lang', currentLanguage);
          fetch(`/filter-tours?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
              mapTourData = data.tours;
              updateHomeMapPins();
              populateHomeCarousel(null);
            });
        } else {
          loadInitialFeaturedTours();
        }
      }
      updateFilterSummaryDisplay();
    }
    
    function confirmExtras() {
      console.log('✅ Confirming extras:', Array.from(selectedExtras));
      updateToursAndAdvance();
    }
    
    function skipExtras() {
      console.log('⏭️ Skipping extras selection');
      selectedExtras.clear();
      delete activeFilters.meals;
      delete activeFilters.equipment;
      
      // Clear all selected states
      document.querySelectorAll('[data-extra]').forEach(btn => {
        btn.classList.remove('duration-pill--selected');
      });
      
      updateToursAndAdvance();
    }
    
    function selectExtras(value) {
      console.log('Extras selected:', value);
      if (value === 'meals') {
        activeFilters.meals = 'true';
      } else if (value === 'equipment') {
        activeFilters.equipment = 'true';
      } else {
        delete activeFilters.meals;
        delete activeFilters.equipment;
      }
      updateToursAndAdvance();
    }
    
    function updateToursAndAdvance() {
      // Update tours with current filters
      const hasFilters = Object.keys(activeFilters).length > 0;
      
      // Check if we're in map view
      const homeMapSection = document.getElementById('home-map-view-section');
      const isInMapView = homeMapSection && homeMapSection.style.display !== 'none';
      
      if (hasFilters) {
        if (isInMapView) {
          // In map view - fetch filtered tours and update map
          console.log('🗺️ Fetching filtered tours for map view');
          fetchFilteredToursForMap();
        } else {
          // In grid view - use normal filter logic
          applyFiltersModern();
        }
      } else {
        // No filters yet
        const subtitle = document.getElementById('home-tours-subtitle');
        if (subtitle) {
          subtitle.textContent = 'Showing all available tours';
        }
        
        // If in map view, show all tours
        if (isInMapView && mapTourData.length > 0) {
          updateHomeMapPins();
          populateHomeCarousel(null);
        }
      }
      
      // Update filter summary
      updateFilterSummaryDisplay();
      
      // Advance to next question
      nextQuestionModern();
    }
    
      // Fetch filtered tours for map view
    async function fetchFilteredToursForMap() {
      console.log('📡 ============ FETCHING FILTERED TOURS FOR MAP ============');
      console.log('   Starting with activeFilters:', JSON.stringify(activeFilters, null, 2));
      
      const params = new URLSearchParams();
      params.append('for_map', 'true');
      params.append('lang', currentLanguage);
      
      // Add all active filters
      let filterCount = 0;
      Object.entries(activeFilters).forEach(([key, value]) => {
        if (value && value !== '') {  // Only add non-empty filters
          // Handle arrays (multi-select)
          if (Array.isArray(value)) {
            console.log(`   Adding filter array: ${key} = [${value.join(', ')}]`);
            value.forEach(item => params.append(key, item));
            filterCount++;
          } else {
          console.log(`   Adding filter: ${key} = ${value}`);
          params.append(key, value);
          filterCount++;
          }
        }
      });
      
      console.log(`   Total filters added: ${filterCount}`);
      console.log('   Final query string:', params.toString());
      console.log('   Full URL:', `/filter-tours?${params.toString()}`);
      
      try {
        const response = await fetch(`/filter-tours?${params.toString()}`);
        const data = await response.json();
        
        console.log(`✅ Fetched ${data.tours.length} filtered tours for map`);
        console.log('   Total found:', data.total_found);
        
        // Update map tour data with filtered results
        mapTourData = data.tours;
        console.log('   ✅ mapTourData updated, length:', mapTourData.length);
        
        // Update map pins and carousel
        updateHomeMapPins();
        populateHomeCarousel(selectedLocation);
        
        // Refresh map size after data is loaded and rendered
        setTimeout(() => {
          if (homeMap) {
            homeMap.invalidateSize();
            console.log('✅ Map size refreshed after data load');
          }
        }, 200);
        
        return true;  // Success
      } catch (error) {
        console.error('❌ Error fetching filtered tours for map:', error);
        return false;  // Failure
      }
    }
    
    function updateFilterSummaryDisplay() {
      const summaryBar = document.getElementById('filter-summary-bar');
      const selectedFiltersDiv = document.getElementById('selected-filters');
      
      if (!summaryBar || !selectedFiltersDiv) return;
      
      // Clear existing tags
      selectedFiltersDiv.innerHTML = '';
      
      // Add filter tags
      const filterLabels = {
        duration: { half_day: 'Half Day', full_day: 'Full Day', multi_day: 'Multi-day' },
        family: { 'true': 'Family with Kids', 'false': 'Adults Only' },
        family_friendly: { 'true': 'Family with Kids', 'false': 'Adults Only' },
        price: { 
          budget: 'Up to $100', 
          mid_range: 'Up to $250', 
          premium: 'Up to $500',
          luxury: 'Up to $1000'
        },
        price_range: { 
          budget: 'Up to $100', 
          mid_range: 'Up to $250', 
          premium: 'Up to $500',
          luxury: 'Up to $1000'
        },
        activity: { 
          great_barrier_reef: 'Great Barrier Reef', 
          whitehaven_beach: 'Whitehaven Beach',
          island_tours: 'Island Tours',
          scenic_adventure: 'Scenic & Adventure'
        },
        meals: { 'true': 'Meals Included' },
        equipment: { 'true': 'Equipment Provided' }
      };
      
      Object.keys(activeFilters).forEach(filterKey => {
        const value = activeFilters[filterKey];
        
        // Handle arrays (multi-select like activity)
        if (Array.isArray(value)) {
          value.forEach(item => {
            const label = filterLabels[filterKey]?.[item] || item;
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.textContent = label;
        selectedFiltersDiv.appendChild(tag);
          });
        } else {
          // Single value
          const label = filterLabels[filterKey]?.[value] || value;
          const tag = document.createElement('div');
          tag.className = 'filter-tag';
          tag.textContent = label;
          selectedFiltersDiv.appendChild(tag);
        }
      });
      
      // Show summary bar if we have filters
      if (Object.keys(activeFilters).length > 0) {
        summaryBar.style.display = 'block';
      } else {
        summaryBar.style.display = 'none';
      }
    }
    
    function goBackQuestion() {
      if (currentQuestion > 1) {
        // FIRST: Remove the filters for the CURRENT question (the one we're leaving)
        const questionFilterMap = {
          1: ['duration'],
          2: ['family'],
          3: ['activity'],
          4: ['meals', 'equipment'],
          5: ['price']
        };
        
        const filtersToRemove = questionFilterMap[currentQuestion] || [];
        filtersToRemove.forEach(filter => {
          delete activeFilters[filter];
        });
        
        // Clear multi-select states for the question we're leaving
        if (currentQuestion === 3) {
          selectedActivities.clear();
        }
        if (currentQuestion === 4) {
          selectedExtras.clear();
        }
        
        // Hide current question
        const currentCard = document.querySelector(`.filter-question-card[data-question="${currentQuestion}"]`);
        if (currentCard) {
          currentCard.style.display = 'none';
        }
        
        // Show previous question
        currentQuestion--;
        const prevCard = document.querySelector(`.filter-question-card[data-question="${currentQuestion}"]`);
        if (prevCard) {
          prevCard.style.display = 'block';
        }
        
        // RESTORE selections for the question we're going BACK TO
        restoreQuestionSelections(currentQuestion);
        
        // Reset pagination
        homePageOffset = 0;
        homePageLoadedKeys = [];
        homePageHasMore = true;
        
        // Update the summary display
        updateFilterSummaryDisplay();
        
        // Check which view we're in
        const homeMapSection = document.getElementById('home-map-view-section');
        const isMapView = homeMapSection && homeMapSection.style.display !== 'none';
        
        // Re-apply filters with REMAINING filters only
        const hasFilters = Object.keys(activeFilters).length > 0;
        if (hasFilters) {
          // Apply the remaining filters
          if (isMapView) {
            console.log('   Fetching filtered tours for map view after back');
            fetchFilteredToursForMap();
          } else {
            applyFiltersModern();
          }
        } else {
          // No filters left, show all tours
          const subtitle = document.getElementById('home-tours-subtitle');
          if (subtitle) {
            subtitle.textContent = 'Showing all available tours';
          }
          
          if (isMapView) {
            console.log('   Fetching all tours for map view after back');
            const params = new URLSearchParams();
            params.append('for_map', 'true');
            params.append('lang', currentLanguage);
            
            fetch(`/filter-tours?${params.toString()}`)
              .then(response => response.json())
              .then(data => {
                mapTourData = data.tours;
                console.log(`   Loaded ${mapTourData.length} tours for map`);
                updateHomeMapPins();
                populateHomeCarousel(null);
              });
          } else {
            loadInitialFeaturedTours();
          }
        }
        
        console.log(`Back to question ${currentQuestion}, active filters:`, activeFilters);
      }
    }
    
    function startOverFilters() {
      console.log('🔄 Starting over - clearing all filters');
      
      // Reset everything
      currentQuestion = 1;
      activeFilters = {};
      homePageOffset = 0;
      homePageLoadedKeys = [];
      homePageHasMore = true;
      
      // Clear location filter too
      selectedLocation = null;
      
      // Clear multi-select states
      selectedActivities.clear();
      selectedExtras.clear();
      
      // Clear visual selections
      document.querySelectorAll('[data-activity]').forEach(btn => {
        btn.classList.remove('duration-pill--selected');
      });
      document.querySelectorAll('[data-extra]').forEach(btn => {
        btn.classList.remove('duration-pill--selected');
      });
      
      // Hide all question cards
      document.querySelectorAll('.filter-question-card').forEach(card => {
        card.style.display = 'none';
      });
      
      // Show question 1
      const firstCard = document.querySelector('.filter-question-card[data-question="1"]');
      if (firstCard) {
        firstCard.style.display = 'block';
      }
      
      // Hide summary bar
      const summaryBar = document.getElementById('filter-summary-bar');
      if (summaryBar) {
        summaryBar.style.display = 'none';
      }
      
      // Reset and reload ALL tours
      const subtitle = document.getElementById('home-tours-subtitle');
      if (subtitle) {
        subtitle.textContent = 'Showing all available tours';
      }
      
      // Update title
      const title = document.getElementById('home-tours-title');
      if (title) {
        title.textContent = 'Tap Any Card For Booking and More Info';
      }
      
      // Check which view we're in and refresh accordingly
      const homeMapSection = document.getElementById('home-map-view-section');
      const featuredSection = document.getElementById('featured-tours-section');
      
      if (homeMapSection && homeMapSection.style.display !== 'none') {
        // In map view - fetch ALL tours and update
        console.log('   Fetching all tours for map view');
        const params = new URLSearchParams();
        params.append('for_map', 'true');
        params.append('lang', currentLanguage);
        
        fetch(`/filter-tours?${params.toString()}`)
          .then(response => response.json())
          .then(data => {
            mapTourData = data.tours;
            console.log(`   Loaded ${mapTourData.length} tours for map`);
            updateHomeMapPins();
            populateHomeCarousel(null);
          });
      } else if (featuredSection && featuredSection.style.display !== 'none') {
        // In grid view - load all tours
        console.log('   Loading all tours for grid view');
        loadInitialFeaturedTours();
      }
      
      console.log('✅ Filters reset - showing all tours');
    }
    
    function nextQuestionModern() {
      if (currentQuestion < totalQuestions) {
        // Hide current question
        const currentCard = document.querySelector(`.filter-question-card[data-question="${currentQuestion}"]`);
        if (currentCard) {
          currentCard.style.display = 'none';
        }
        
        // Show next question
        currentQuestion++;
        const nextCard = document.querySelector(`.filter-question-card[data-question="${currentQuestion}"]`);
        if (nextCard) {
          nextCard.style.display = 'block';
        }
        
        console.log(`Showing question ${currentQuestion} of ${totalQuestions}`);
      } else {
        // All questions answered - hide the last question card
        const currentCard = document.querySelector(`.filter-question-card[data-question="${currentQuestion}"]`);
        if (currentCard) {
          currentCard.style.display = 'none';
        }
        
        console.log('All questions answered!');
        
        // Update title to show filtering is complete
        const title = document.getElementById('home-tours-title');
        if (title) {
          title.textContent = 'Your Personalized Tours';
        }
      }
    }
    
    // Modern filter application (updates featured grid AND switches to tour list page)
    function applyFiltersModern() {
      console.log('🔍 applyFiltersModern called with filters:', activeFilters);
      
      // Build query string from active filters
      const params = new URLSearchParams();
      params.append('lang', currentLanguage);
      
      Object.entries(activeFilters).forEach(([key, value]) => {
        if (value && value !== '') {  // Only add non-empty filters
          // Handle arrays (multi-select)
          if (Array.isArray(value)) {
            value.forEach(item => params.append(key, item));
          } else {
          params.append(key, value);
          }
        }
      });
      
      console.log('📡 Grid view fetching with query:', params.toString());
      
      // Reset pagination
      homePageOffset = 0;
      homePageLoadedKeys = [];
      
      // Fetch filtered tours
      fetch(`/filter-tours?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          console.log('✅ Filter response:', data);
          const tours = data.tours || [];
          const totalCount = data.total_found || tours.length;
          
          // Update home page state
          homePageTotalCount = totalCount;
          homePageOffset = tours.length;
          // homePageLoadedKeys will be set by displayFeaturedTours
          
          // Update subtitle to reflect active filters
          const subtitle = document.getElementById('home-tours-subtitle');
          const title = document.getElementById('home-tours-title');
          
          const hasFilters = Object.keys(activeFilters).length > 0;
          
          if (hasFilters) {
            const filterLabels = [];
            if (activeFilters.duration) {
              const durationLabel = activeFilters.duration === 'half_day' ? 'Half Day' :
                                    activeFilters.duration === 'full_day' ? 'Full Day' :
                                    activeFilters.duration === 'multi_day' ? 'Multi-day' : '';
              if (durationLabel) filterLabels.push(durationLabel);
            }
            
            if (filterLabels.length > 0) {
              subtitle.textContent = `Showing ${totalCount} ${filterLabels.join(', ')} tour${totalCount !== 1 ? 's' : ''}`;
            } else {
              subtitle.textContent = `Showing ${totalCount} tour${totalCount !== 1 ? 's' : ''}`;
            }
            title.textContent = 'Filtered Tours';
          } else {
            subtitle.textContent = `Showing ${totalCount} tour${totalCount !== 1 ? 's' : ''}`;
            title.textContent = 'Tap Any Card For Booking and More Info';
          }
          
          // Store filtered tours in mapTourData for map view
          // We need to fetch with for_map=true to get location data
          const mapParams = new URLSearchParams();
          mapParams.append('for_map', 'true');
          mapParams.append('lang', currentLanguage);
          
          Object.entries(activeFilters).forEach(([key, value]) => {
            if (value && value !== '') {
              // Handle arrays (multi-select)
              if (Array.isArray(value)) {
                value.forEach(item => mapParams.append(key, item));
              } else {
              mapParams.append(key, value);
              }
            }
          });
          
          console.log('📡 Also fetching for map with query:', mapParams.toString());
          
          fetch(`/filter-tours?${mapParams.toString()}`)
            .then(response => response.json())
            .then(mapData => {
              mapTourData = mapData.tours || [];
              console.log(`✅ Stored ${mapTourData.length} tours in mapTourData for map view`);
            })
            .catch(error => {
              console.error('❌ Error fetching map data:', error);
            });
          
          // Display tours
          displayFeaturedTours(tours, false); // false = replace
          
          // Update has more flag
          homePageHasMore = tours.length < totalCount;
          
          console.log(`Displayed ${tours.length} filtered tours`);
        })
        .catch(error => {
          console.error('Filter error:', error);
        });
    }
    
    // Load more tours on home page (called by infinite scroll)
    function loadMoreHomePageTours() {
      if (isLoadingMoreTours || !homePageHasMore) {
        console.log('Already loading or no more tours');
        return;
      }
      
      isLoadingMoreTours = true;
      
      // Show loading indicator
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
      }
      
      console.log('Loading more tours... offset:', homePageOffset);
      
      // Build query with active filters
      const params = new URLSearchParams();
      params.append('lang', currentLanguage);
      params.append('offset', homePageOffset);
      params.append('count', 12);
      params.append('exclude', homePageLoadedKeys.join(','));
      
      Object.entries(activeFilters).forEach(([key, value]) => {
        params.append(key, value);
      });
      
      // Determine endpoint
      const hasFilters = Object.keys(activeFilters).length > 0;
      const endpoint = hasFilters ? '/filter-tours' : '/more-tours';
      
      fetch(`${endpoint}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          const tours = hasFilters ? (data.tours || []) : data;
          
          console.log('Loaded', tours.length, 'more tours');
          
          if (tours.length > 0) {
            homePageOffset += tours.length;
            // homePageLoadedKeys will be updated by displayFeaturedTours
            displayFeaturedTours(tours, true); // true = append
          }
          
          // Check if there are more tours
          if (tours.length < 12 || (hasFilters && homePageOffset >= homePageTotalCount)) {
            homePageHasMore = false;
            console.log('No more tours to load');
          }
          
          // Hide loading indicator
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
          
          isLoadingMoreTours = false;
        })
        .catch(error => {
          console.error('Error loading more tours:', error);
          
          // Hide loading indicator
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
          
          isLoadingMoreTours = false;
        });
    }
    
    // Show tour list page with filtered results
    function showTourListPage(tours, totalCount) {
      // Hide home page
      const homePage = document.querySelector('.home-page');
      if (homePage) {
        homePage.style.display = 'none';
      }
      
      // Show tour list page
      const tourListPage = document.getElementById('tour-list-page');
      if (tourListPage) {
        tourListPage.style.display = 'block';
      }
      
      // Update header chips
      updateListPageHeaderChips();
      
      // Populate filter chips
      populateFilterChips();
      
      // Update results info
      const resultsInfo = document.getElementById('results-info');
      if (resultsInfo) {
        resultsInfo.textContent = `Found ${totalCount} tour${totalCount !== 1 ? 's' : ''} matching your preferences`;
      }
      
      // Fetch ALL tours for "Other Tours You Might Like" section
      if (!window.allTours || window.allTours.length === 0) {
        fetch(`/filter-tours?lang=${currentLanguage}`)
          .then(response => response.json())
          .then(data => {
            window.allTours = data.tours || [];
            console.log(`✅ Stored ${window.allTours.length} total tours for recommendations`);
            // Display tours in the grid (after we have all tours)
            displayToursInGrid(tours);
          })
          .catch(error => {
            console.error('❌ Error fetching all tours:', error);
            // Display filtered tours anyway
            displayToursInGrid(tours);
          });
      } else {
        // Display tours in the grid
        displayToursInGrid(tours);
      }
    }
    
    // Update header chips on tour list page
    function updateListPageHeaderChips() {
      const langBtn = document.getElementById('list-language-btn');
      const currBtn = document.getElementById('list-currency-btn');
      
      if (langBtn) {
        langBtn.textContent = currentLanguage ? currentLanguage.toUpperCase() : 'EN';
      }
      if (currBtn) {
        currBtn.textContent = currentCurrency || 'AUD';
      }
    }
    
    // Populate filter chips in the filters summary section
    function populateFilterChips() {
      const container = document.getElementById('filters-chips-container');
      const summarySection = document.getElementById('filters-summary-section');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Hide summary section if no active filters
      if (Object.keys(activeFilters).length === 0) {
        if (summarySection) summarySection.style.display = 'none';
        return;
      } else {
        if (summarySection) summarySection.style.display = 'flex';
      }
      
      // Add chips for each active filter
      Object.entries(activeFilters).forEach(([key, value]) => {
        const chip = document.createElement('button');
        chip.className = 'chip chip-solid';
        
        // Format the filter text
        let text = '';
        if (key === 'duration') {
          if (value === 'half_day') text = 'Half Day';
          else if (value === 'full_day') text = 'Full Day';
          else if (value === 'multi_day') text = 'Multi-day';
        } else if (key === 'activity') {
          if (value === 'great_barrier_reef') text = 'Great Barrier Reef';
          else if (value === 'whitehaven_beach') text = 'Whitehaven Beach';
          else if (value === 'island_tours') text = 'Island Tours';
          else if (value === 'scenic_adventure') text = 'Scenic & Adventure';
        } else if (key === 'family') {
          text = value === 'true' ? 'Family-friendly' : 'Adults only';
        } else if (key === 'price') {
          if (value === 'budget') text = 'Up to $100';
          else if (value === 'mid_range') text = 'Up to $250';
          else if (value === 'premium') text = 'Up to $500';
          else if (value === 'luxury') text = 'Up to $1000';
        } else if (key === 'meals') {
          text = 'Meals included';
        } else if (key === 'equipment') {
          text = 'Equipment provided';
        }
        
        chip.textContent = text;
        container.appendChild(chip);
      });
    }
    
    // Display tours in the 2-column grid
    function displayToursInGrid(tours) {
      const grid = document.getElementById('tour-placeholder-row');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      const filteredTourKeys = new Set();
      
      // Display filtered tours
      tours.forEach(tour => {
        // Exclude Ocean Dynamics
        if (shouldHideTour(tour)) return;
        
        filteredTourKeys.add(tour.key);
        
        const hasBooking = hasWorkingBooking(tour);
        const card = document.createElement('article');
        card.className = 'tour-card-large';
        card.setAttribute('data-key', tour.key);
        card.setAttribute('data-departure', tour.departure_location || '');
        card.onclick = () => openTourDetail(tour.key);
        
        // Rating display
        let ratingHtml = '';
        if (tour.review_rating && tour.review_rating > 0 && tour.review_count > 0) {
          ratingHtml = `<span class="rating">★ ${tour.review_rating.toFixed(1)} (${tour.review_count})</span>`;
        }
        
        const starHtml = hasBooking ? '<div class="tour-card-star">★</div>' : '';
        card.innerHTML = `
          <div class="tour-card-image" style="background-image: url('${tour.thumbnail || '/static/placeholder.jpg'}');"></div>
          ${starHtml}
          <div class="tour-card-overlay">
            <span class="operator-chip">${(tour.company_name || 'Tour Operator').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
            <h2 class="tour-name">${tour.name}</h2>
            <div class="tour-meta">
              ${ratingHtml}
              <span class="price-badge">From ${tour.price_adult || 'Contact for price'}</span>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      // Add "Other Tours You Might Like" section with remaining tours (if filters are active)
      if (Object.keys(activeFilters).length > 0 && window.allTours && window.allTours.length > tours.length) {
        // Get tours that weren't in the filtered results
        const otherTours = window.allTours.filter(tour => 
          !filteredTourKeys.has(tour.key) && !shouldHideTour(tour)
        );
        
        if (otherTours.length > 0) {
          // Add divider
          const divider = document.createElement('div');
          divider.className = 'other-tours-divider';
          divider.style.cssText = 'grid-column: 1/-1; margin: 40px 0 30px 0; text-align: center;';
          divider.innerHTML = `
            <h2 style="color: white; font-size: 2.2em; font-weight: 700; margin: 0 0 10px 0;">Other Tours You Might Like</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 1.1em; margin: 0;">Continue scrolling to explore all available tours</p>
          `;
          grid.appendChild(divider);
          
          // Shuffle and display other tours
          const shuffled = otherTours.sort(() => Math.random() - 0.5);
          shuffled.forEach(tour => {
            const hasBooking = hasWorkingBooking(tour);
            const card = document.createElement('article');
            card.className = 'tour-card-large';
            card.setAttribute('data-key', tour.key);
            card.setAttribute('data-departure', tour.departure_location || '');
            card.onclick = () => openTourDetail(tour.key);
            
            let ratingHtml = '';
            if (tour.review_rating && tour.review_rating > 0 && tour.review_count > 0) {
              ratingHtml = `<span class="rating">★ ${tour.review_rating.toFixed(1)} (${tour.review_count})</span>`;
            }
            
            const starHtml = hasBooking ? '<div class="tour-card-star">★</div>' : '';
            card.innerHTML = `
              <div class="tour-card-image" style="background-image: url('${tour.thumbnail || '/static/placeholder.jpg'}');"></div>
              ${starHtml}
              <div class="tour-card-overlay">
                <span class="operator-chip">${(tour.company_name || 'Tour Operator').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
                <h2 class="tour-name">${tour.name}</h2>
                <div class="tour-meta">
                  ${ratingHtml}
                  <span class="price-badge">From ${tour.price_adult || 'Contact for price'}</span>
                </div>
              </div>
            `;
            
            grid.appendChild(card);
          });
        }
      }
    }
    
    // Clear filters and go back to home page
    function clearFiltersAndGoHome() {
      // Clear all filters
      activeFilters = {};
      
      // Remove map view class
      document.body.classList.remove('map-view-active');
      
      // Clear selected states
      document.querySelectorAll('.duration-pill').forEach(p => p.classList.remove('selected'));
      
      // Hide tour detail page
      const tourDetailPage = document.querySelector('.page.tour-detail-page');
      if (tourDetailPage) {
        tourDetailPage.classList.remove('active');
        setTimeout(() => {
          tourDetailPage.style.display = 'none';
          tourDetailPage.style.visibility = 'hidden';
          tourDetailPage.style.opacity = '0';
          tourDetailPage.style.pointerEvents = 'none';
        }, 300);
      }
      
      // Hide tour list page
      const tourListPage = document.getElementById('tour-list-page');
      if (tourListPage) {
        tourListPage.style.display = 'none';
      }
      
      // Hide old layout elements
      const mainLayout = document.getElementById('main-layout');
      const filterPanel = document.getElementById('filter-panel');
      const mapContainer = document.getElementById('map-container');
      const contentArea = document.getElementById('content-area');
      if (mainLayout) mainLayout.style.display = 'none';
      if (filterPanel) filterPanel.style.display = 'none';
      if (mapContainer) mapContainer.style.display = 'none';
      if (contentArea) contentArea.style.display = 'none';
      
      // Show home page
      const homePage = document.querySelector('.home-page');
      if (homePage) {
        homePage.style.display = 'flex';
      }
      
      // Reset featured tours to initial state
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Helper: should hide tour (e.g., exclude third-party resellers)
    function shouldHideTour(tour) {
      const company = (tour.company || tour.company_name || '').toLowerCase();
      return company.includes('ocean dynamics');
    }
    
    // Helper: does this tour have a working booking mapping (Rezdy or explicit link)?
    function hasWorkingBooking(tour) {
      // PRIMARY CHECK: Explicit flag from CSV (1 = connected, 0 = not connected)
      const bookingConnected = tour.booking_connected || tour.bookingConnected;
      if (bookingConnected) {
        const val = String(bookingConnected).toLowerCase();
        if (val === '1' || val === 'yes' || val === 'true') return true;
      }
      
      // SECONDARY CHECK: Explicit booking URL fields
      const bookingUrl = tour.link_booking || tour.booking_link || tour.booking_url || tour.rezdy_url || tour.rezdy_booking_url;
      if (bookingUrl) return true;
      
      // TERTIARY CHECK: Try to match against known Rezdy products
      const rezdyMapped = getRezdyUrlForTour(tour.name, tour.company || tour.company_name);
      if (rezdyMapped) {
        // persist the booking link so downstream flows can use it
        if (!tour.link_booking) tour.link_booking = rezdyMapped;
        return true;
      }
      
      return false;
    }
    
    // Display tours in the featured grid (for modern home page)
    function displayFeaturedTours(tours, append = false) {
      const grid = document.getElementById('featured-grid');
      if (!grid) {
        console.log('Featured grid not found');
        return;
      }
      
      // Clear grid if not appending
      if (!append) {
        grid.innerHTML = '';
        homePageLoadedKeys = []; // Clear loaded keys when replacing
      }
      
      // Remove unwanted tours
      const filteredTours = tours.filter(tour => !shouldHideTour(tour));
      
      // Prioritize tours with working booking buttons
      const prioritized = [];
      const regular = [];
      filteredTours.forEach(tour => {
        if (hasWorkingBooking(tour)) {
          prioritized.push(tour);
        } else {
          regular.push(tour);
        }
      });
      const orderedTours = [...prioritized, ...regular];
      
      console.log('Displaying featured tours:', orderedTours.length, 'append:', append);
      
      if (orderedTours.length === 0 && !append) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: white; font-size: 1.5em;">No tours found matching your criteria. Please try different filters.</p>';
        return;
      }
      
      // Filter out duplicates based on keys we've already loaded
      const uniqueTours = orderedTours.filter(tour => {
        if (homePageLoadedKeys.includes(tour.key)) {
          console.log('Skipping duplicate tour:', tour.key);
          return false;
        }
        homePageLoadedKeys.push(tour.key);
        return true;
      });
      
      console.log(`Displaying ${uniqueTours.length} unique tours out of ${orderedTours.length} returned`);
      
      uniqueTours.forEach(tour => {
        const bookingUrl = tour.link_booking || tour.booking_link || tour.booking_url || tour.rezdy_url || tour.rezdy_booking_url || '';
        const mappedUrl = getRezdyUrlForTour(tour.name, tour.company || tour.company_name);
        const hasBooking = hasWorkingBooking(tour);
        // Debug: log booking detection for first batch
        if (homePageLoadedKeys.length < 40) {
          console.log(`⭐ bookingCheck hasBooking=${hasBooking}`, {
            key: tour.key,
            name: tour.name,
            company: tour.company || tour.company_name,
            bookingUrl,
            mappedUrl
          });
        }
        const card = document.createElement('article');
        card.className = 'tour-card-large';
        card.setAttribute('data-key', tour.key);
        card.onclick = () => openTourDetail(tour.key);
        
        // Rating display
        let ratingHtml = '';
        if (tour.review_rating && tour.review_rating > 0 && tour.review_count > 0) {
          ratingHtml = `<span class="rating">★ ${tour.review_rating.toFixed(1)} (${tour.review_count})</span>`;
        }
        
        const starHtml = hasBooking ? '<div class="tour-card-star">★</div>' : '';
        card.innerHTML = `
          <div class="tour-card-image" style="background-image: url('${tour.thumbnail || '/static/placeholder.jpg'}');"></div>
          ${starHtml}
          <div class="tour-card-overlay">
            <span class="operator-chip">${(tour.company_name || 'Tour Operator').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
            <h3 class="tour-name">${tour.name}</h3>
            <div class="tour-meta">
              ${ratingHtml}
              <span class="price-badge">From ${tour.price_adult || 'Contact for price'}</span>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    /* Chat logic - Commented out for now
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const spinner = document.getElementById('spinner');
    function addMessage(text, isUser) {
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser ? 'chat-message user-message' : 'chat-message assistant-message';
      messageDiv.textContent = text;
      chatbox.appendChild(messageDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }
    function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;
      addMessage(message, true);
      userInput.value = '';
      sendBtn.style.display = 'none';
      spinner.style.display = 'block';
      fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      })
      .then(response => response.json())
      .then(data => {
        addMessage(data.response, false);
      })
      .catch(error => {
        addMessage('Sorry, there was an error. Please try again.', false);
      })
      .finally(() => {
        sendBtn.style.display = 'block';
        spinner.style.display = 'none';
      });
    }
    */
    // Load more tours logic - automatic loading when button becomes visible
    const initialShownKeys = JSON.parse(document.getElementById('initial-shown-keys').textContent || '[]');
    let loadedCount = initialShownKeys.length;
    let shownKeys = new Set(initialShownKeys);
    let isLoadingMore = false; // Prevent multiple simultaneous loads
    
    async function loadMoreTours() {
      if (isLoadingMore) return; // Prevent duplicate loads
      isLoadingMore = true;
      
      const exclude = Array.from(shownKeys).join(',');
      const res = await fetch(`/more-tours?offset=${loadedCount}&count=12&exclude=${exclude}&lang=${currentLanguage}`);
      const tours = await res.json();
      loadedCount += tours.length;
      const grid = document.getElementById('tour-placeholder-row');
      
      // Check if we're on the modern tour list page
      const tourListPage = document.getElementById('tour-list-page');
      const isModernLayout = tourListPage && tourListPage.style.display !== 'none';
      
      for (const tour of tours) {
        if (isModernLayout) {
          // Use modern tour-card-large format
          const card = document.createElement('article');
          card.className = 'tour-card-large';
          card.setAttribute('data-key', tour.key);
          card.setAttribute('data-departure', tour.departure_location || '');
          card.onclick = () => openTourDetail(tour.key);
          
          // Rating display
          let ratingHtml = '';
          if (tour.review_rating && tour.review_rating > 0 && tour.review_count > 0) {
            ratingHtml = `<span class="rating">★ ${tour.review_rating.toFixed(1)} (${tour.review_count})</span>`;
          }
          
          card.innerHTML = `
            <div class="tour-card-image" style="background-image: url('${tour.thumbnail}');"></div>
            <div class="tour-card-overlay">
              <span class="operator-chip">${(tour.company_name || 'Tour Operator').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
              <h2 class="tour-name">${tour.name}</h2>
              <div class="tour-meta">
                ${ratingHtml}
                <span class="price-badge">From ${tour.price_adult || 'Contact for price'}</span>
              </div>
            </div>
          `;
          
          grid.appendChild(card);
          shownKeys.add(tour.key);
        } else {
          // Old format (for backward compatibility)
        const card = document.createElement('div');
        card.className = 'tour-card';
        card.setAttribute('data-key', tour.key);
        card.setAttribute('data-departure', tour.departure_location || '');
        
        // Generate rating display
        let ratingHtml = '';
        if (tour.review_rating && tour.review_rating > 0 && tour.review_count && tour.review_count > 0) {
          ratingHtml = `
            <div class="tour-rating">
              <span class="stars">${generateStars(tour.review_rating)}</span>
              <span class="review-count">(${tour.review_count})</span>
            </div>
          `;
        }
        
        // Check if mobile
        if (window.innerWidth <= 768) {
          // Mobile: Set innerHTML first
          card.innerHTML = `
            <div>
              <div class="tour-company">${tour.company_name ? tour.company_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}</div>
              <h3>${tour.name}</h3>
              ${ratingHtml}
              <div>
                ${tour.duration ? `<span class="tour-duration">⏱️ ${tour.duration}</span>` : ''}
                ${tour.departure_location ? `<span class="tour-location">📍 ${tour.departure_location}</span>` : ''}
              </div>
              <div class="tour-price">${tour.price_adult || 'Contact for price'}</div>
            </div>
          `;
          
          // Then set background image AFTER innerHTML
          const thumbnailUrl = tour.thumbnail || '/static/placeholder.jpg';
          card.style.backgroundImage = `url('${thumbnailUrl}')`;
          card.style.backgroundSize = 'cover';
          card.style.backgroundPosition = 'center';
          card.style.backgroundRepeat = 'no-repeat';
        } else {
          // Desktop
          card.innerHTML = `
            <img src="${tour.thumbnail}" alt="${tour.name}" class="tour-image">
            <div class="tour-overlay">
              <div class="tour-type">${(tour.company_name || 'Tour Operator').replaceAll('_',' ').replace(/\b\w/g, c => c.toUpperCase())}</div>
              <div class="tour-title">${tour.name}</div>
              ${ratingHtml}
            </div>
          `;
        }
        
        card.onclick = () => openTourDetail(tour.key);
        grid.appendChild(card);
        shownKeys.add(tour.key);
        }
      }
      
      if (tours.length < 12) {
        document.getElementById('load-more-btn').style.display = 'none';
        if (observer) observer.disconnect(); // Stop observing when no more tours
      }
      
      isLoadingMore = false;
    }
    
    // Set up automatic loading when button becomes visible (infinite scroll)
    const loadMoreBtn = document.getElementById('load-more-btn');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        // If button is visible and we're not already loading, load more tours
        if (entry.isIntersecting && !isLoadingMore) {
          loadMoreTours();
        }
      });
    }, {
      root: null, // viewport
      threshold: 0.1 // Trigger when 10% of button is visible
    });
    
    // Store observer globally so AI recommendations can stop it
    window.tourObserver = observer;
    
    // Start observing the load more button
    observer.observe(loadMoreBtn);
    
    // Also allow manual clicks as backup
    loadMoreBtn.onclick = loadMoreTours;
    // Add click handler to initial cards
    document.querySelectorAll('.tour-card').forEach(card => {
      const key = card.getAttribute('data-key');
      card.onclick = () => openTourDetail(key);
    });
    
    // Track if user was in map view before opening detail
    let wasInMapView = false;
    
    // Check if current date is in Cruise Whitsundays high season
    function isHighSeason() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // 0-indexed
      const day = now.getDate();
      
      // High Season Dates (inclusive):
      // 14/12-31/12/2024, 01/01-06/02/2025, 05/04-27/04/2025, 
      // 28/06-20/07/2025, 20/09-12/10/2025, 13/12-31/12/2025
      const highSeasonRanges = [
        { start: new Date(2024, 11, 14), end: new Date(2024, 11, 31) }, // 14 Dec - 31 Dec 2024
        { start: new Date(2025, 0, 1), end: new Date(2025, 1, 6) },      // 1 Jan - 6 Feb 2025
        { start: new Date(2025, 3, 5), end: new Date(2025, 3, 27) },     // 5 Apr - 27 Apr 2025
        { start: new Date(2025, 5, 28), end: new Date(2025, 6, 20) },    // 28 Jun - 20 Jul 2025
        { start: new Date(2025, 8, 20), end: new Date(2025, 9, 12) },    // 20 Sep - 12 Oct 2025
        { start: new Date(2025, 11, 13), end: new Date(2025, 11, 31) }   // 13 Dec - 31 Dec 2025
      ];
      
      // Check if current date falls within any high season range
      for (const range of highSeasonRanges) {
        if (now >= range.start && now <= range.end) {
          console.log('🌟 HIGH SEASON: Showing premium pricing for Cruise Whitsundays');
          return true;
        }
      }
      
      console.log('📅 Standard Season: Showing standard pricing for Cruise Whitsundays');
      return false;
    }
    
    // Filter pricing tiers based on season (for Cruise Whitsundays)
    function filterPricingBySeason(priceTiers, companyKey) {
      // Only apply seasonal filtering for Cruise Whitsundays
      if (companyKey !== 'cruisewhitsundays') {
        return priceTiers;
      }
      
      const highSeason = isHighSeason();
      const tiers = priceTiers.split('|').map(t => t.trim()).filter(t => t);
      const filteredTiers = [];
      
      console.log(`Processing ${tiers.length} pricing tiers...`);
      
      for (const tier of tiers) {
        const lowerTier = tier.toLowerCase();
        
        // Check if this tier has a season label (check for word anywhere in string)
        const hasStandard = lowerTier.includes('standard');
        const hasPremium = lowerTier.includes('premium') || lowerTier.includes('high season');
        
        if (highSeason) {
          // HIGH SEASON: Show premium/high season prices, or unlabeled prices
          if (hasPremium) {
            // Remove the season label - handle multiple formats:
            // "Adult (Premium)" -> "Adult"
            // "Child (4-14, Premium)" -> "Child (4-14)"
            // "Adult (High Season)" -> "Adult"
            let cleanTier = tier
              .replace(/,?\s*(premium|high season)\s*\)/gi, ')') // Remove ", Premium)" or ", High Season)"
              .replace(/\(\s*(premium|high season)\s*\)/gi, '')  // Remove standalone "(Premium)" or "(High Season)"
              .replace(/\s+\(\s*\)/g, ''); // Remove empty parentheses "()"
            filteredTiers.push(cleanTier);
            console.log(`  ✅ Included (premium): ${cleanTier}`);
          } else if (!hasStandard) {
            // No season label means it applies to all seasons
            filteredTiers.push(tier);
            console.log(`  ✅ Included (unlabeled): ${tier}`);
          } else {
            console.log(`  ❌ Skipped (standard): ${tier}`);
          }
        } else {
          // STANDARD SEASON: Show standard prices, or unlabeled prices
          if (hasStandard) {
            // Remove the season label - handle multiple formats:
            // "Adult (Standard)" -> "Adult"
            // "Child (4-14, Standard)" -> "Child (4-14)"
            let cleanTier = tier
              .replace(/,?\s*standard\s*\)/gi, ')') // Remove ", Standard)"
              .replace(/\(\s*standard\s*\)/gi, '')  // Remove standalone "(Standard)"
              .replace(/\s+\(\s*\)/g, ''); // Remove empty parentheses "()"
            filteredTiers.push(cleanTier);
            console.log(`  ✅ Included (standard): ${cleanTier}`);
          } else if (!hasPremium) {
            // No season label means it applies to all seasons
            filteredTiers.push(tier);
            console.log(`  ✅ Included (unlabeled): ${tier}`);
          } else {
            console.log(`  ❌ Skipped (premium): ${tier}`);
          }
        }
      }
      
      console.log(`Final filtered pricing: ${filteredTiers.length} tiers`);
      return filteredTiers.join('|');
    }
    
    // Reorganize detail page content for modern kiosk layout
    function reorganizeDetailPageContent(data, key) {
      // Update header chips
      const langBtn = document.getElementById('detail-language-btn');
      const currBtn = document.getElementById('detail-currency-btn');
      if (langBtn) langBtn.textContent = currentLanguage ? currentLanguage.toUpperCase() : 'EN';
      if (currBtn) currBtn.textContent = currentCurrency || 'AUD';
      
      // Extract and reorganize pricing
      const detailInfo = document.getElementById('detail-info');
      const pricingContainer = document.getElementById('pricing-tiers-container');
      
      if (detailInfo && pricingContainer) {
        // Find existing pricing tiers and convert them to price-row format
        const pricingTiers = detailInfo.querySelectorAll('.pricing-tier-option');
        if (pricingTiers.length > 0) {
          pricingContainer.innerHTML = '';
          pricingTiers.forEach((tier, index) => {
            const tierText = tier.textContent.trim();
            // Split on colon or dash to separate label and price
            const parts = tierText.split(/:\s*|\s+-\s+/);
            const label = parts[0] || tierText;
            const price = parts[1] || '';
            
            const priceRow = document.createElement('button');
            priceRow.className = 'price-row';
            if (index === 0) priceRow.classList.add('selected');
            priceRow.setAttribute('data-tier', tier.getAttribute('data-tier'));
            priceRow.setAttribute('data-original-price', tier.getAttribute('data-original-price'));
            
            priceRow.innerHTML = `
              <span>${label}</span>
              <span>${price}</span>
            `;
            
            priceRow.onclick = function() {
              document.querySelectorAll('.price-row').forEach(r => r.classList.remove('selected'));
              this.classList.add('selected');
              selectedPricingTier = this.getAttribute('data-tier');
            };
            
            pricingContainer.appendChild(priceRow);
          });
          
          // Remove pricing from detail-info
          const pricingSection = detailInfo.querySelector('div[style*="border-left:5px solid #0077b6"]');
          if (pricingSection) pricingSection.remove();
        }
      }
      
      // Create info-grid cards for What's Included and Highlights
      const infoGrid = document.getElementById('info-grid');
      if (infoGrid && detailInfo) {
        infoGrid.innerHTML = '';
        
        // Find includes and highlights sections by border color (works in any language)
        const includesSection = detailInfo.querySelector('div[style*="border-left:5px solid #4caf50"]');
        const highlightsSection = detailInfo.querySelector('div[style*="border-left:5px solid #ff9800"]');
        
        if (includesSection || highlightsSection) {
          // Create What's Included card
          if (includesSection) {
            const includesCard = document.createElement('article');
            includesCard.className = 'info-card';
            const heading = includesSection.querySelector('h3');
            const headingText = heading ? heading.textContent : 'What\'s Included';
            includesCard.innerHTML = `
              <h3>${headingText}</h3>
              <ul>
                ${extractListItems(includesSection.innerHTML)}
              </ul>
            `;
            infoGrid.appendChild(includesCard);
            includesSection.remove();
          }
          
          // Create Highlights card
          if (highlightsSection) {
            const highlightsCard = document.createElement('article');
            highlightsCard.className = 'info-card';
            const heading = highlightsSection.querySelector('h3');
            const headingText = heading ? heading.textContent : 'Highlights';
            highlightsCard.innerHTML = `
              <h3>${headingText}</h3>
              <ul>
                ${extractListItems(highlightsSection.innerHTML)}
              </ul>
            `;
            infoGrid.appendChild(highlightsCard);
            highlightsSection.remove();
          }
        }
      }
      
      // Move remaining info sections to fine-print section (works in any language)
      const finePrint = document.getElementById('fine-print');
      if (finePrint && detailInfo) {
        const finePrintContent = [];
        
        // Find all sections with colored borders (these are info sections)
        const sections = detailInfo.querySelectorAll('div[style*="border-left"]');
        sections.forEach(section => {
          const heading = section.querySelector('h3');
          if (heading) {
            // Skip pricing (#0077b6), includes (#4caf50), and highlights (#ff9800) - they're handled elsewhere
            const style = section.getAttribute('style') || '';
            if (!style.includes('#0077b6') && !style.includes('#4caf50') && !style.includes('#ff9800')) {
              finePrintContent.push(section.outerHTML);
              section.remove();
            }
          }
        });
        
        if (finePrintContent.length > 0) {
          finePrint.innerHTML = finePrintContent.join('');
          finePrint.style.display = 'block';
        } else {
          finePrint.style.display = 'none';
        }
      }
      
      // Departure and reviews are now handled in the info variable, hide these template sections
      const departureSection = document.getElementById('departure-section');
      if (departureSection) {
        departureSection.style.display = 'none';
      }
      
      const reviewsSectionDetail = document.getElementById('reviews-section-detail');
      if (reviewsSectionDetail) {
        reviewsSectionDetail.style.display = 'none';
      }
      
      // Set up footer button handlers
      setupFooterButtons(key, data);
    }
    
    // Clean up bracket-formatted strings and convert to readable lists
    function cleanBracketFormatting(text) {
      if (!text) return '';
      
      // Check if text looks like a Python list: ['item1', 'item2', ...]
      if (text.trim().startsWith('[') && text.trim().endsWith(']')) {
        try {
          // Remove brackets and split by comma
          let items = text.trim()
            .slice(1, -1)  // Remove [ and ]
            .split(',')
            .map(item => {
              // Remove quotes and extra whitespace
              return item.trim().replace(/^['"]|['"]$/g, '');
            })
            .filter(item => item.length > 0);
          
          // Return as bullet list
          if (items.length > 0) {
            return '<ul style="margin:0;padding-left:20px;">' + 
              items.map(item => `<li style="margin-bottom:8px;">${item}</li>`).join('') +
              '</ul>';
          }
        } catch (e) {
          // If parsing fails, continue with normal formatting
          console.log('Failed to parse list:', e);
        }
      }
      
      // Normal text formatting
      return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }
    
    // Extract list items from HTML content
    function extractListItems(html) {
      // Remove h3 tags and extract text content as list items
      const div = document.createElement('div');
      div.innerHTML = html;
      
      // Remove h3
      const h3 = div.querySelector('h3');
      if (h3) h3.remove();
      
      // Split by <br> or line breaks to create list items
      const text = div.innerHTML
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<\/div><div>/gi, '\n')
        .replace(/<[^>]+>/g, '')
        .split('\n')
        .filter(line => line.trim())
        .map(line => `<li>${line.trim()}</li>`)
        .join('');
      
      return text || '<li>Details included</li>';
    }
    
    // Normalize strings for fuzzy matching
    function normalizeStr(str) {
      return (str || '')
        .toLowerCase()
        .replace(/[\u2010-\u2015\u2212]/g, '-') // normalize various dashes
        .replace(/[^a-z0-9\s\-]/g, ' ')        // remove punctuation
        .replace(/\s+/g, ' ')                  // collapse spaces
        .trim();
    }
    
    // Map specific tours to Rezdy mobile booking URLs (for QR flow)
    function getRezdyUrlForTour(name, company) {
      const n = normalizeStr(name);
      const c = normalizeStr(company);
      
      // Ocean Rafting (standard + fly/raft combos + scenic flight)
      if (c.includes('ocean rafting')) {
        if (n.includes('southern lights') && n.includes('fly')) return 'https://whitsundayskiosk.rezdy.com/269177/fly-raft-southern-lights-package';
        if (n.includes('northern exposure') && n.includes('fly')) return 'https://whitsundayskiosk.rezdy.com/266833/fly-raft-northern-exposure-package';
        if (n.includes('southern lights')) return 'https://whitsundayskiosk.rezdy.com/265683/southern-lights-tour';
        if (n.includes('northern exposure')) return 'https://whitsundayskiosk.rezdy.com/265139/northern-exposure-tour';
        if (n.includes('1 hour scenic flight') || n.includes('one hour scenic flight') || n.includes('scenic flight')) return 'https://whitsundayskiosk.rezdy.com/269193/ocean-rafting-1-hour-scenic-flight';
      }
      
      // Whitsunday Jetski Tours
      if (c.includes('jetski') || c.includes('jet ski') || n.includes('jetski') || n.includes('jet ski')) {
        if (n.includes('airlie adventure')) return 'https://whitsundayskiosk.rezdy.com/221593/airlie-adventure-jetski-tour';
        if (n.includes('two island safari')) return 'https://whitsundayskiosk.rezdy.com/111977/two-island-safari-jetski-tour';
        if (n.includes('ultimate island trek') || n.includes('island trek')) return 'https://whitsundayskiosk.rezdy.com/271543/ultimate-island-trek-jetski-tour';
      }
      
      return null;
    }
    
    // Setup footer button handlers
    function setupFooterButtons(key, data) {
      console.log('🔘 Setting up footer buttons for tour:', key);
      
      const bookNowBtn = document.getElementById('book-now-btn');
      const continuePhoneBtn = document.getElementById('continue-phone-btn');
      const shareTourBtn = document.getElementById('share-tour-btn');
      
      console.log('   Book Now button found:', !!bookNowBtn);
      console.log('   Continue Phone button found:', !!continuePhoneBtn);
      console.log('   Share Tour button found:', !!shareTourBtn);
      
      if (bookNowBtn) {
        bookNowBtn.onclick = () => {
          // Try to map to a Rezdy product by name/company
          const rezdyUrl = getRezdyUrlForTour(data.name, data.company);
          
          if (rezdyUrl) {
            console.log('🚤 Rezdy mapping found, showing QR for:', rezdyUrl);
            showQRPaymentModal(rezdyUrl, data.name || 'Book Now');
            
            // Remove any existing injected script
            const existingRezdy = document.getElementById('rezdy-mobile-booking');
            if (existingRezdy) existingRezdy.remove();
            
            // Inject Rezdy mobile booking script as backup
            const rezdyScript = document.createElement('script');
            rezdyScript.id = 'rezdy-mobile-booking';
            rezdyScript.defer = true;
            rezdyScript.type = 'text/javascript';
            rezdyScript.setAttribute('data-redirect-url', rezdyUrl);
            rezdyScript.src = '//static.rezdy-production.com/0e7e54892b517064fb581c52789a2b1b37389d491470/themes/rezdyv2/js/mobile-booking-form.min.js';
            document.body.appendChild(rezdyScript);
            return;
          }
          
          // Fallback: use provided booking link or open inquiry modal
          if (data.link_booking) {
            showQRPaymentModal(data.link_booking, data.name);
            return;
          }
          
            const modal = document.getElementById('booking-modal');
            if (modal) {
              document.getElementById('booking-tour-name').textContent = data.name;
              modal.style.display = 'flex';
              
              // Store current tour data for booking form
              window.currentTourForBooking = {
                name: data.name,
                company: data.company,
                key: key,
                pricing: selectedPricingTier
              };
          }
        };
      }
      
      if (continuePhoneBtn) {
        continuePhoneBtn.onclick = () => {
          console.log('📱 Continue on Phone button clicked!');
          // Generate QR code or show share modal
          generateQRCodeForTour(key, data);
        };
        console.log('   ✓ Continue Phone button click handler attached');
      } else {
        console.error('   ❌ Continue Phone button not found!');
      }
      
      if (shareTourBtn) {
        shareTourBtn.onclick = () => {
          console.log('🔗 Share Tour button clicked!');
          const tourUrl = `https://www.filtour.com/tour/${key}?lang=${currentLanguage}`;
          shareTour(tourUrl, data.name);
        };
        console.log('   ✓ Share Tour button click handler attached');
      }
    }
    
    // Show QR Payment Modal
    function showQRPaymentModal(checkoutUrl, tourName) {
      const modal = document.getElementById('qr-payment-modal');
      const qrContainer = document.getElementById('qr-code-container');
      const continueBtn = document.getElementById('qr-continue-btn');
      
      if (!modal || !qrContainer) return;
      
      // Show modal immediately
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.pointerEvents = 'auto';
      document.body.style.overflow = 'hidden';
      
      // Show loading state
      qrContainer.innerHTML = '<div style="font-size: 1.2em; color: #0077b6;">Generating QR code...</div>';
      
      // Generate QR code using multiple fallback methods
      try {
        // Try method 1: QRCode.toDataURL (most reliable)
        if (typeof QRCode !== 'undefined' && QRCode.toDataURL) {
          QRCode.toDataURL(checkoutUrl, {
            width: 280,
            margin: 2,
            color: {
              dark: '#0077b6',
              light: '#ffffff'
            },
            errorCorrectionLevel: 'M'
          })
          .then(url => {
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'QR Code';
            img.style.maxWidth = '280px';
            img.style.display = 'block';
              qrContainer.innerHTML = '';
            qrContainer.appendChild(img);
            console.log('✅ QR Code generated successfully');
          })
          .catch(err => {
            console.error('QR Code generation error:', err);
            // Fallback to external API
            useFallbackQR(checkoutUrl, qrContainer);
          });
        } else {
          // Fallback to external API
          useFallbackQR(checkoutUrl, qrContainer);
        }
      } catch (error) {
        console.error('QR Code error:', error);
        // Fallback to external API
        useFallbackQR(checkoutUrl, qrContainer);
      }
      
      // Set up "Continue on this screen" button
      if (continueBtn) {
        continueBtn.onclick = () => {
          closeQRModal();
          // Open Rezdy checkout in the same window
          window.open(checkoutUrl, '_blank');
        };
      }
      
      // Set up Cancel button
      const cancelBtn = document.getElementById('qr-cancel-btn');
      if (cancelBtn) {
        cancelBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('🚫 Cancel button clicked');
          closeQRModal();
        };
      }
      
      // Store checkout URL for reference
      window.currentCheckoutUrl = checkoutUrl;
      
      console.log('QR Payment Modal opened for:', checkoutUrl);
    }
    
    // Fallback QR code generator using external API
    function useFallbackQR(url, container) {
      console.log('Using fallback QR API');
      const encodedUrl = encodeURIComponent(url);
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodedUrl}&color=0077b6&bgcolor=ffffff`;
      const img = document.createElement('img');
      img.src = qrApiUrl;
      img.alt = 'QR Code';
      img.style.maxWidth = '280px';
      img.style.display = 'block';
      img.onerror = () => {
        container.innerHTML = '<p style="color: #d32f2f; font-size: 1.1em;">Unable to generate QR code.<br>Please use "Continue on this screen" button.</p>';
      };
      container.innerHTML = '';
      container.appendChild(img);
    }
    
    // Close QR Payment Modal
    function closeQRModal() {
      console.log('🚫 Closing QR modal');
      const modal = document.getElementById('qr-payment-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
        
        // Clear the QR container to allow regeneration
        const qrContainer = document.getElementById('qr-code-container');
        if (qrContainer) {
          qrContainer.innerHTML = '';
        }
        
        // Re-enable body scroll
        document.body.style.overflow = '';
        console.log('   ✅ Modal closed and cleared');
      }
      
      // Also close the share QR modal if it's open
      const shareModal = document.getElementById('qr-modal');
      if (shareModal) {
        shareModal.style.display = 'none';
      }
    }
    
    // Setup keyboard handlers for QR modal
    document.addEventListener('keydown', function(e) {
      const qrModal = document.getElementById('qr-payment-modal');
      if (qrModal && qrModal.style.display === 'flex' && e.key === 'Escape') {
        closeQRModal();
      }
    });
    
    // Prevent clicks inside the QR card from closing the modal
    document.addEventListener('DOMContentLoaded', function() {
      const qrCard = document.querySelector('.qr-card');
      if (qrCard) {
        qrCard.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
    });
    
    // Generate QR code for continuing on phone
    function generateQRCodeForTour(key, data) {
      console.log('📱 generateQRCodeForTour called with key:', key);
      
      const modal = document.getElementById('qr-payment-modal');
      const qrContainer = document.getElementById('qr-code-container');
      
      console.log('   Modal found:', !!modal);
      console.log('   QR Container found:', !!qrContainer);
      
      if (!modal) {
        console.error('❌ QR modal not found!');
        return;
      }
      
      if (!qrContainer) {
        console.error('❌ QR container not found!');
        return;
      }
      
      if (modal && qrContainer) {
        // Update modal title
        const modalTitle = modal.querySelector('h2');
        if (modalTitle) {
          modalTitle.textContent = 'Continue on Your Phone';
          console.log('   ✓ Updated modal title');
        }
        
        const modalSubtitle = modal.querySelector('.qr-subtitle');
        if (modalSubtitle) {
          modalSubtitle.textContent = 'Scan this code to open this tour on your mobile device';
          console.log('   ✓ Updated modal subtitle');
        }
        
        const modalHelpText = modal.querySelector('.qr-help-text');
        if (modalHelpText) {
          modalHelpText.textContent = 'View full details and book on your phone';
          console.log('   ✓ Updated modal help text');
        }
        
        // Generate QR code using the shareable tour URL
        const qrCodeUrl = `/api/generate-tour-qr/${key}?lang=${currentLanguage}`;
        console.log('   QR Code URL:', qrCodeUrl);
        qrContainer.innerHTML = `<img src="${qrCodeUrl}" alt="Tour QR Code" style="width:100%;max-width:300px;height:auto;" />`;
        
        // Show modal with forced visibility
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        document.body.style.overflow = 'hidden';
        console.log('   ✅ Modal shown!');
        console.log('   Modal display:', modal.style.display);
        console.log('   Modal z-index:', window.getComputedStyle(modal).zIndex);
        
        // Update the continue button to copy the link
        const continueBtn = document.getElementById('qr-continue-btn');
        if (continueBtn) {
          continueBtn.textContent = 'Copy Link';
          continueBtn.onclick = () => {
            // Use filtour.com domain for shareable links
            const baseUrl = window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1') 
              ? window.location.origin 
              : 'https://www.filtour.com';
            const tourUrl = `${baseUrl}/tour/${key}?lang=${currentLanguage}`;
            console.log('   Copying tour URL:', tourUrl);
            navigator.clipboard.writeText(tourUrl).then(() => {
              continueBtn.textContent = '✓ Copied!';
              setTimeout(() => {
                continueBtn.textContent = 'Copy Link';
              }, 2000);
            }).catch(err => {
              console.error('Failed to copy:', err);
              alert('Link: ' + tourUrl);
            });
          };
          console.log('   ✓ Copy button configured');
        }
        
        // Setup cancel button
        const cancelBtn = document.getElementById('qr-cancel-btn');
        if (cancelBtn) {
          cancelBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('🚫 Cancel button clicked');
            closeQRModal();
          };
          console.log('   ✓ Cancel button configured');
        }
      }
    }
    
    // Tour detail logic
    function openTourDetail(key) {
      console.log('🎯 openTourDetail called with key:', key);
      console.log('   isInVideoFlow:', isInVideoFlow);
      console.log('   video-bg-active class present:', document.body.classList.contains('video-bg-active'));
      
      // Add to navigation history
      addToNavigationHistory('tour-' + key);
      
      // Remember if we were in map view
      wasInMapView = isMapView;
      
      // Hide map container if it's visible
      if (isMapView) {
        document.getElementById('map-container').style.display = 'none';
        document.getElementById('tour-placeholder-row').style.display = 'grid';
      }
      
      // Reset selected pricing tier when opening a new tour
      selectedPricingTier = null;
      
      // Update URL hash for routing (allows language change restoration and direct linking)
      window.location.hash = `tour/${key}`;
      console.log('🔗 Hash updated to:', window.location.hash);
      
      console.log('🌐 Fetching tour data...');
      fetch(`/tour-detail/${key}?lang=${currentLanguage}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('detail-title').textContent = data.name;
          
          // Make company name clickable to filter by company
          const companyElement = document.getElementById('detail-company');
          const slugFromCompany = (data.company || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
          const derivedCompanyKey = data.company_key || data.company_slug || key.split('__')[0] || slugFromCompany;
          companyElement.textContent = '🏢 ' + data.company + ' ›';
          companyElement.setAttribute('data-company-key', derivedCompanyKey); // Store company key for filtering
          companyElement.title = 'Click to see all tours by ' + data.company;
          
          document.getElementById('detail-summary').textContent = data.summary;
          
          // Enhanced description with markdown-style formatting
          const descriptionDiv = document.getElementById('detail-description');
          let formattedDesc = (data.description || 'N/A')
            .replace(/\*\*(.+?)\*\*/g, '<strong style="color:#0077b6;font-weight:600;">$1</strong>')  // **bold** -> colored bold
            .replace(/\n/g, '<br>');  // newlines -> <br>
          descriptionDiv.innerHTML = formattedDesc;
          descriptionDiv.style.whiteSpace = 'normal';
          descriptionDiv.style.lineHeight = '1.8';
          descriptionDiv.style.color = '#1a1a1a';
          
          let info = '';
          
          // Extract company key for pricing features
          const companyKey = key.split('__')[0];
          
          // POPULATE PRICING SECTION (in template, not in info)
          const pricingContainer = document.getElementById('pricing-tiers-container');
          if (pricingContainer) {
            let pricingHTML = '';
          
          if (data.price_tiers && data.price_tiers.trim()) {
            // Apply seasonal pricing filter for Cruise Whitsundays
            const filteredPriceTiers = filterPricingBySeason(data.price_tiers, companyKey);
            
              // Parse price tiers - use PIPE (|) as separator
            const tiers = filteredPriceTiers.split('|').filter(t => t.trim());
            
            tiers.forEach((tier, index) => {
              if (tier.trim()) {
                  const isFirst = index === 0;
                  const bgColor = isFirst ? '#0077b6' : (index % 2 === 0 ? '#f0f4f8' : '#f5f8fa');
                  const textColor = isFirst ? '#ffffff' : '#2c3e50';
                const priceMatch = tier.match(/A\$\d+/);
                const originalPrice = priceMatch ? priceMatch[0] : '';
                const convertedTier = originalPrice ? tier.replace(originalPrice, convertPrice(originalPrice)) : tier.trim();
                  const selectedClass = isFirst ? ' pricing-selected' : '';
                
                  pricingHTML += `<div class="pricing-tier-option${selectedClass}" data-tier="${tier.trim()}" data-original-price="${originalPrice}" style="background:${bgColor};padding:16px 24px;border-radius:8px;font-size:1.2em;font-weight:500;color:${textColor};border:3px solid #e0e7ee;cursor:pointer;transition:all 0.3s ease;user-select:none;">${convertedTier}</div>`;
              }
            });
          } else {
              // Fallback to adult/child prices
              let priceIndex = 0;
            if (data.price_adult && data.price_adult !== 'N/A') {
              const convertedAdultPrice = convertPrice(data.price_adult);
                const isFirst = priceIndex === 0;
                const bgColor = isFirst ? '#0077b6' : '#f0f4f8';
                const textColor = isFirst ? '#ffffff' : '#2c3e50';
                const selectedClass = isFirst ? ' pricing-selected' : '';
                pricingHTML += `<div class="pricing-tier-option${selectedClass}" data-tier="${t('adult')}: ${data.price_adult}" data-original-price="${data.price_adult}" style="background:${bgColor};padding:16px 24px;border-radius:8px;font-size:1.2em;border:3px solid #e0e7ee;color:${textColor};cursor:pointer;transition:all 0.3s ease;user-select:none;"><b>${t('adult')}:</b> ${convertedAdultPrice}</div>`;
                priceIndex++;
            }
            if (data.price_child && data.price_child !== 'N/A') {
              const convertedChildPrice = convertPrice(data.price_child);
                const isFirst = priceIndex === 0;
                const bgColor = isFirst ? '#0077b6' : '#f5f8fa';
                const textColor = isFirst ? '#ffffff' : '#2c3e50';
                const selectedClass = isFirst ? ' pricing-selected' : '';
                pricingHTML += `<div class="pricing-tier-option${selectedClass}" data-tier="${t('child')}: ${data.price_child}" data-original-price="${data.price_child}" style="background:${bgColor};padding:16px 24px;border-radius:8px;font-size:1.2em;border:3px solid #e0e7ee;color:${textColor};cursor:pointer;transition:all 0.3s ease;user-select:none;"><b>${t('child')}:</b> ${convertedChildPrice}</div>`;
              }
            }
            
            pricingContainer.innerHTML = pricingHTML;
          }
          
          // QUICK INFO SECTION - Smart layout based on content length
          const quickInfoItems = [];
          
          // Validate duration: must contain time words like "hour", "day", "night", "week"
          const validDuration = data.duration && /\b(hour|day|night|week|month|full|half)\b/i.test(data.duration);
          if (validDuration) {
            quickInfoItems.push({
              icon: '⏱️',
              title: t('duration'),
              content: data.duration,
              color: 'rgba(255,255,255,0.95)',
              titleColor: '#0077b6',
              length: data.duration.length
            });
          }
          
          if (data.departure_times && data.departure_times.trim()) {
            quickInfoItems.push({
              icon: '🕐',
              title: t('times'),
              content: data.departure_times,
              color: 'rgba(255,255,255,0.95)',
              titleColor: '#0077b6',
              length: data.departure_times.length
            });
          }
          
          // Validate age requirements: should not be vague or confusing
          const validAges = data.age_requirements && data.age_requirements.trim() && 
                           !/\band\s+under\b/i.test(data.age_requirements); // Don't show "and under" phrases
          if (validAges) {
            quickInfoItems.push({
              icon: '👥',
              title: t('ages'),
              content: data.age_requirements,
              color: 'rgba(255,255,255,0.95)',
              titleColor: '#0077b6',
              length: data.age_requirements.length
            });
          }
          
          if (data.ideal_for && data.ideal_for.trim()) {
            quickInfoItems.push({
              icon: '🎯',
              title: t('ideal_for'),
              content: data.ideal_for,
              color: 'rgba(255,255,255,0.95)',
              titleColor: '#0077b6',
              length: data.ideal_for.length
            });
          }
          
          // Render quick info items - use grid for 2-3 items, full width for 1 or 4+
          if (quickInfoItems.length > 0) {
            // If we have exactly 2 or 3 items, render in a grid for better symmetry
            if (quickInfoItems.length === 2 || quickInfoItems.length === 3) {
              const gridCols = quickInfoItems.length === 2 ? '1fr 1fr' : '1fr 1fr 1fr';
              info += `<div class="detail-section-grid" style="display:grid;grid-template-columns:${gridCols};gap:30px;margin:0 2px 30px 2px;">`;
              quickInfoItems.forEach((item) => {
                info += `<div style="background:${item.color};backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);">`;
                info += `<h3 style="font-size:2.2em;font-weight:700;color:${item.titleColor};margin:0 0 25px 0;">${item.icon} ${item.title}</h3>`;
                info += `<div style="font-size:1.25em;color:#2c3e50;line-height:1.6;">${item.content}</div>`;
                info += '</div>';
              });
              info += '</div>';
            } else {
              // For 1 or 4+ items, render full width
              quickInfoItems.forEach((item) => {
                info += `<div style="background:${item.color};backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;">`;
                info += `<h3 style="font-size:2.2em;font-weight:700;color:${item.titleColor};margin:0 0 25px 0;">${item.icon} ${item.title}</h3>`;
                info += `<div style="font-size:1.25em;color:#2c3e50;line-height:1.6;">${item.content}</div>`;
                info += '</div>';
              });
            }
          }
          
          // ITINERARY & MENU - Side by side like Includes/Highlights, EXACT same styling
          const hasItinerary = data.itinerary && data.itinerary.trim() && data.itinerary !== 'N/A';
          const hasMenu = data.menu && data.menu.trim() && data.menu !== 'N/A';
          
          if (hasItinerary || hasMenu) {
            // If both exist, use side-by-side grid; if single, apply margin directly
            if (hasItinerary && hasMenu) {
              info += '<div class="detail-section-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin:0 2px 30px 2px;">';
            }
            
            if (hasItinerary) {
              // Match .info-card styling EXACTLY
              const itineraryMargin = !hasMenu ? 'margin:0 2px 30px 2px;' : '';
              info += '<div style="' + itineraryMargin + 'background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);">';
              info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">📅 ' + t('itinerary') + '</h3>';
              let formattedItinerary = cleanBracketFormatting(data.itinerary);
              // Convert to list items with blue checkmarks
              formattedItinerary = formattedItinerary
                .replace(/<ul[^>]*>/gi, '<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:15px;">')
                .replace(/<li[^>]*>/gi, '<li style="font-size:1.25em;color:#2c3e50;padding-left:40px;position:relative;line-height:1.6;"><span style="content:\'\';position:absolute;left:0;color:#00b4d8;font-weight:900;font-size:1.4em;top:1px;">✓</span> ')
                .replace(/<\/li>/gi, '</li>');
              info += formattedItinerary;
            info += '</div>';
            }
            
            if (hasMenu) {
              // Match .info-card styling EXACTLY
              const menuMargin = !hasItinerary ? 'margin:0 2px 30px 2px;' : '';
              info += '<div style="' + menuMargin + 'background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);">';
              info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">🍽️ ' + t('menu') + '</h3>';
              let formattedMenu = cleanBracketFormatting(data.menu);
              // Convert to list items with blue checkmarks
              formattedMenu = formattedMenu
                .replace(/<ul[^>]*>/gi, '<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:15px;">')
                .replace(/<li[^>]*>/gi, '<li style="font-size:1.25em;color:#2c3e50;padding-left:40px;position:relative;line-height:1.6;"><span style="content:\'\';position:absolute;left:0;color:#00b4d8;font-weight:900;font-size:1.4em;top:1px;">✓</span> ')
                .replace(/<\/li>/gi, '</li>');
              info += formattedMenu;
              info += '</div>';
            }
            
            // Close grid if both exist
            if (hasItinerary && hasMenu) {
              info += '</div>';
            }
          }
          
          // INCLUDES & HIGHLIGHTS - Smart layout based on content length
          if (data.includes || data.highlights) {
            // Calculate content lengths to determine layout
            const includesLength = data.includes ? data.includes.length : 0;
            const highlightsLength = data.highlights ? data.highlights.length : 0;
            const bothExist = data.includes && data.highlights;
            const avgLength = bothExist ? (includesLength + highlightsLength) / 2 : (includesLength || highlightsLength);
            
            // Use 2 columns (squares) if both exist and content is moderate length
            // Otherwise use 1 column (full-width rectangles)
            const useSquares = bothExist && avgLength < 400;
            const columns = useSquares ? '1fr 1fr' : '1fr';
            
            info += `<div style="display:grid;grid-template-columns:${columns};gap:30px;margin:0 2px 30px 2px;">`;
            
            if (data.includes) {
              info += '<div style="background:#e8f5e9;padding:25px;border-radius:12px;border-left:5px solid #4caf50;box-shadow:0 8px 20px rgba(0,0,0,0.15);">';
              info += '<h3 style="margin:0 0 15px 0;color:#2e7d32;font-size:1.6em;">✅ ' + t('whats_included') + '</h3>';
              let formattedIncludes = (data.includes || '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
              info += `<div style="font-size:1.15em;line-height:1.8;color:#2c3e50;">${formattedIncludes}</div>`;
              info += '</div>';
            }
            if (data.highlights) {
              info += '<div style="background:#fff3e0;padding:25px;border-radius:12px;border-left:5px solid #ff9800;box-shadow:0 8px 20px rgba(0,0,0,0.15);">';
              info += '<h3 style="margin:0 0 15px 0;color:#f57c00;font-size:1.6em;">⭐ ' + t('highlights') + '</h3>';
              let formattedHighlights = (data.highlights || '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
              info += `<div style="font-size:1.15em;line-height:1.8;color:#2c3e50;">${formattedHighlights}</div>`;
              info += '</div>';
            }
            info += '</div>';
          }
          
          // IMPORTANT INFORMATION SECTION (Separate card - full width, new white style)
          if (data.important_information && data.important_information.trim() && data.important_information !== 'N/A' && data.important_information !== 'null') {
            info += '<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;">';
            info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">⚠️ ' + t('important_information') + '</h3>';
            let formattedInfo = cleanBracketFormatting(data.important_information);
            info += `<div style="font-size:1.25em;color:#2c3e50;line-height:1.6;">${formattedInfo}</div>`;
            info += '</div>';
          }
          
          // WHAT TO BRING & WHAT'S EXTRA - Side by side like Includes/Highlights, EXACT same styling
          const hasBring = data.what_to_bring && data.what_to_bring.trim() && data.what_to_bring !== 'N/A' && data.what_to_bring !== 'null';
          const hasExtra = data.whats_extra && data.whats_extra.trim() && data.whats_extra !== 'N/A' && data.whats_extra !== 'null';
          
          if (hasBring || hasExtra) {
            // If both exist, use side-by-side grid; if single, apply margin directly
            if (hasBring && hasExtra) {
              info += '<div class="detail-section-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin:0 2px 30px 2px;">';
            }
            
            if (hasBring) {
              // Match .info-card styling EXACTLY
              const bringMargin = !hasExtra ? 'margin:0 2px 30px 2px;' : '';
              info += '<div style="' + bringMargin + 'background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);">';
              info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">🎒 ' + t('what_to_bring') + '</h3>';
            let formattedBring = cleanBracketFormatting(data.what_to_bring);
              // Convert to list items with blue checkmarks
              formattedBring = formattedBring
                .replace(/<ul[^>]*>/gi, '<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:15px;">')
                .replace(/<li[^>]*>/gi, '<li style="font-size:1.25em;color:#2c3e50;padding-left:40px;position:relative;line-height:1.6;"><span style="content:\'\';position:absolute;left:0;color:#00b4d8;font-weight:900;font-size:1.4em;top:1px;">✓</span> ')
                .replace(/<\/li>/gi, '</li>');
              info += formattedBring || '<div style="color:#666;font-size:1.15em;">No items specified</div>';
            info += '</div>';
          }
          
            if (hasExtra) {
              // Match .info-card styling EXACTLY
              const extraMargin = !hasBring ? 'margin:0 2px 30px 2px;' : '';
              info += '<div style="' + extraMargin + 'background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);">';
              info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">💰 ' + t('whats_extra') + '</h3>';
            let formattedExtra = cleanBracketFormatting(data.whats_extra);
              // Convert to list items with blue checkmarks
              formattedExtra = formattedExtra
                .replace(/<ul[^>]*>/gi, '<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:15px;">')
                .replace(/<li[^>]*>/gi, '<li style="font-size:1.25em;color:#2c3e50;padding-left:40px;position:relative;line-height:1.6;"><span style="content:\'\';position:absolute;left:0;color:#00b4d8;font-weight:900;font-size:1.4em;top:1px;">✓</span> ')
                .replace(/<\/li>/gi, '</li>');
              info += formattedExtra || '<div style="color:#666;font-size:1.15em;">No extra costs specified</div>';
            info += '</div>';
          }
          
            // Close grid if both exist
            if (hasBring && hasExtra) {
              info += '</div>';
            }
          }
          
          // CANCELLATION POLICY SECTION (Separate card - full width, new white style)
          if (data.cancellation_policy && data.cancellation_policy.trim() && data.cancellation_policy !== 'N/A' && data.cancellation_policy !== 'null') {
            info += '<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;">';
            info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">📋 ' + t('cancellation_policy') + '</h3>';
            let formattedPolicy = cleanBracketFormatting(data.cancellation_policy);
            info += `<div style="font-size:1.25em;color:#2c3e50;line-height:1.6;">${formattedPolicy}</div>`;
            info += '</div>';
          }
          
          // Add Cruise Whitsundays disclaimer (only for their tours)
          if (data.company && data.company.toLowerCase().includes('cruise whitsundays')) {
            info += '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-top:30px;margin-bottom:15px;border-left:3px solid #0077b6;">';
            info += '<p style="font-size:0.85em;line-height:1.6;color:#555;margin:0;"><em>';
            info += '*Infants 0-3 years travel free of charge on all tours, however no infant meals are included. Rates applicable for bookings made from 15/1/2024.<br><br>';
            info += 'STANDARD/HIGH SEASON: High season dates are applicable for Great Barrier Reef Adventure & Whitehaven Beach products. High Season Dates (inclusive) 14/12-31/12/2024, 01/01-06/02/2025, 05/04-27/04/2025, 28/06-20/07/2025, 20/09-12/10/2025 & 13/12-31/12/2025.<br><br>';
            info += 'Great Barrier Reef Environmental Management Charge (EMC): Included in your cruise fare is a per head fee which goes to the Government. The money collected is used by the Great Barrier Reef Marine Park Authority (GBRMPA) for the management and protection of the Great Barrier Reef Marine Park.';
            info += '</em></p></div>';
          }
          
          // DEPARTURE LOCATION SECTION (Full width)
          if (data.departure_location && data.departure_location.trim()) {
            info += '<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;">';
            info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">📍 Departure Location</h3>';
            info += `<div style="font-size:1.4em;font-weight:600;color:#2c3e50;margin-bottom:15px;">${data.departure_location}</div>`;
            info += '<div style="font-size:1.1em;color:#666;line-height:1.7;margin-bottom:20px;">This tour departs from the location shown below. Please arrive at least 15 minutes before departure time.</div>';
            
            // Add mini map if coordinates are available
            const coords = getCoordinatesForLocation(data.departure_location);
            if (coords) {
              info += `<div id="detail-mini-map-${key.replace(/[^a-zA-Z0-9]/g, '_')}" style="width:100%;height:500px;margin-top:20px;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.15);"></div>`;
              // Store coords for map initialization
              window.pendingMiniMap = { elementId: `detail-mini-map-${key.replace(/[^a-zA-Z0-9]/g, '_')}`, coords: coords };
            }
            
            info += '</div>';
          }
          
          // REVIEWS SECTION - Header in floating box, each review in its own box
          if (data.reviews && data.reviews.overall_rating > 0 && data.reviews.review_count > 0) {
            // Reviews header box - matching other section styles
            info += '<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;">';
            info += '<h3 style="font-size:2.2em;font-weight:700;color:#0077b6;margin:0 0 25px 0;">⭐ Customer Reviews</h3>';
            info += '<div class="reviews-summary" style="display:flex;gap:15px;align-items:center;">';
            info += `<div class="overall-rating" style="font-size: 2.5em; font-weight: 700;color:#0077b6;">${data.reviews.overall_rating.toFixed(1)}</div>`;
            info += '<div>';
            info += `<div class="stars-large" style="font-size: 1.5em; display: flex; gap: 4px;">${generateStars(data.reviews.overall_rating, true)}</div>`;
            info += `<div class="review-source" style="font-size: 1.1em;color:#666;">Based on ${data.reviews.review_count} ${data.reviews.source || ''} review${data.reviews.review_count !== 1 ? 's' : ''}</div>`;
            info += '</div>';
            info += '</div>';
            info += '</div>'; // Close header box
            
            // Individual reviews - each in its own white floating box
            if (data.reviews.reviews && data.reviews.reviews.length > 0) {
              data.reviews.reviews.forEach(review => {
                info += '<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:40px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;">';
                info += '<div class="review-header" style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;">';
                info += '<div>';
                info += `<div class="review-author" style="font-size: 1.3em; font-weight: 600;color:#2c3e50;">${review.author || 'Anonymous'}</div>`;
                if (review.date) {
                  info += `<div class="review-date" style="font-size: 1.1em;color:#666;margin-top:5px;">${review.date}</div>`;
                }
                info += '</div>';
                if (review.rating) {
                  info += `<div class="review-stars" style="font-size: 1.3em;">${generateStars(review.rating, true)}</div>`;
                }
                info += '</div>';
                if (review.title) {
                  info += `<div class="review-title" style="font-size: 1.25em; font-weight: 600; margin-bottom: 12px;color:#0077b6;">${review.title}</div>`;
                }
                if (review.text) {
                  info += `<div class="review-text" style="font-size: 1.15em; line-height: 1.6;color:#2c3e50;">${review.text}</div>`;
                }
                info += '</div>'; // Close review box
              });
            }
            
            // Link to more reviews if available - in its own small box
            if (data.reviews.source_url) {
              info += '<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:25px 45px;border-radius:22px;box-shadow:0 15px 50px rgba(0,0,0,0.25);margin:0 2px 30px 2px;text-align:center;">';
              info += `<a href="${data.reviews.source_url}" target="_blank" style="color:#0077b6;text-decoration:none;font-weight:600;font-size:1.1em;">Read all ${data.reviews.review_count} reviews on ${data.reviews.source} →</a>`;
              info += '</div>';
            }
          }
          
          document.getElementById('detail-info').innerHTML = info;
          
          // Initialize mini map if location exists - wait longer for DOM to be ready
          if (window.pendingMiniMap) {
            const mapInfo = window.pendingMiniMap;
            window.pendingMiniMap = null; // Clear immediately to prevent re-initialization
            
            setTimeout(() => {
              const { elementId, coords } = mapInfo;
              const mapElement = document.getElementById(elementId);
              
              console.log('🗺️ Initializing mini map for:', elementId);
              console.log('   Coords:', coords);
              console.log('   Map element found:', !!mapElement);
              
              if (mapElement) {
                try {
                  // Ensure element has proper dimensions before initializing
                  if (mapElement.offsetHeight === 0) {
                    console.warn('   ⚠️ Map element has no height, forcing dimensions');
                    mapElement.style.height = '500px';
                    mapElement.style.width = '100%';
                  }
                  
                // Create mini map
                  const miniMap = L.map(elementId, {
                    scrollWheelZoom: false,
                    dragging: true,
                    touchZoom: true
                  }).setView([coords.lat, coords.lng], 17);
                
                // Add map tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '© OpenStreetMap contributors',
                  maxZoom: 18
                }).addTo(miniMap);
                
                // Add marker for departure location
                const marker = L.marker([coords.lat, coords.lng]).addTo(miniMap);
                marker.bindPopup(`
                  <div style="font-size:1.4em;line-height:1.6;padding:8px;">
                    <b style="font-size:1.3em;color:#0077b6;">${coords.display}</b><br>
                    <span style="font-size:1.1em;color:#666;">Departure Point</span>
                  </div>
                `).openPopup();
                  
                  // Force map to recalculate size
                  setTimeout(() => miniMap.invalidateSize(), 100);
                  
                  console.log('   ✅ Mini map initialized successfully');
                } catch (error) {
                  console.error('   ❌ Error initializing map:', error);
                }
              } else {
                console.error('   ❌ Map element not found in DOM:', elementId);
              }
            }, 500);
          }
          
          // Add click handlers for pricing tier selection
          setTimeout(() => {
            document.querySelectorAll('.pricing-tier-option').forEach(tierElement => {
              tierElement.addEventListener('click', function() {
                // Remove selected state from all pricing options
                document.querySelectorAll('.pricing-tier-option').forEach((el, idx) => {
                  el.classList.remove('pricing-selected');
                  el.style.border = '3px solid #e0e7ee';
                  el.style.boxShadow = 'none';
                  el.style.transform = 'none';
                  // Restore original background color
                  const bgColor = idx % 2 === 0 ? '#f0f4f8' : '#f5f8fa';
                  el.style.backgroundColor = bgColor;
                  el.style.color = '#2c3e50';
                });
                
                // Add selected state to clicked option
                this.classList.add('pricing-selected');
                this.style.border = '3px solid #0077b6';
                this.style.backgroundColor = '#0077b6';
                this.style.color = '#ffffff';
                this.style.boxShadow = '0 4px 15px rgba(0,119,182,0.3)';
                this.style.transform = 'scale(1.02)';
                
                // Store selected tier
                selectedPricingTier = this.getAttribute('data-tier');
                console.log('Selected pricing tier:', selectedPricingTier);
              });
              
              // Add hover effect
              tierElement.addEventListener('mouseenter', function() {
                if (!this.classList.contains('pricing-selected')) {
                  this.style.backgroundColor = '#e3f2fd';
                }
              });
              
              tierElement.addEventListener('mouseleave', function() {
                if (!this.classList.contains('pricing-selected')) {
                  // Restore original background
                  const tierIndex = Array.from(document.querySelectorAll('.pricing-tier-option')).indexOf(this);
                  const bgColor = tierIndex % 2 === 0 ? '#f0f4f8' : '#f5f8fa';
                  this.style.backgroundColor = bgColor;
                  this.style.color = '#2c3e50';
                }
              });
            });
            
            // Pre-select the first pricing option
            const pricingOptions = document.querySelectorAll('.pricing-tier-option');
            if (pricingOptions.length > 0) {
              pricingOptions[0].click();
            }
          }, 100);
          // Swipe-style 3-image spread gallery (same as swipe section)
          let gallery = data.gallery || [];
          let galleryHtml = '';
          
          if (gallery.length > 0) {
            let images = [];
            if (gallery.length >= 3) {
              images = [gallery[0], gallery[1], gallery[2]];
            } else if (gallery.length === 2) {
              images = [gallery[0], gallery[1], gallery[0]];
            } else {
              images = [gallery[0], gallery[0], gallery[0]];
            }
            
            let detailGalleryIndex = 0;
            
            galleryHtml = `
              <div class="swipe-gallery-wrapper">
                <button class="gallery-nav-arrow left" onclick="event.stopPropagation(); rotateDetailGallery('left')">‹</button>
                <div class="swipe-gallery-spread" id="detail-gallery-spread">
                  <div class="swipe-gallery-image left"><img src="${images[0]}" alt="Gallery 1"></div>
                  <div class="swipe-gallery-image center"><img src="${images[1]}" alt="${data.name}"></div>
                  <div class="swipe-gallery-image right"><img src="${images[2]}" alt="Gallery 3"></div>
                </div>
                <button class="gallery-nav-arrow right" onclick="event.stopPropagation(); rotateDetailGallery('right')">›</button>
              </div>
            `;
            
            window.rotateDetailGallery = function(direction) {
              if (gallery.length <= 1) return;
              const spread = document.getElementById('detail-gallery-spread');
              if (!spread) return;
              spread.classList.add(direction === 'right' ? 'rotating-right' : 'rotating-left');
              setTimeout(() => {
                detailGalleryIndex = direction === 'right' 
                  ? (detailGalleryIndex + 1) % gallery.length
                  : (detailGalleryIndex - 1 + gallery.length) % gallery.length;
                const nextImages = [
                  gallery[(detailGalleryIndex - 1 + gallery.length) % gallery.length],
                  gallery[detailGalleryIndex],
                  gallery[(detailGalleryIndex + 1) % gallery.length]
                ];
                const imgElements = spread.querySelectorAll('.swipe-gallery-image img');
                imgElements[0].src = nextImages[0];
                imgElements[1].src = nextImages[1];
                imgElements[2].src = nextImages[2];
                spread.classList.remove('rotating-right', 'rotating-left');
              }, 150);
            };
          }
          
          document.getElementById('detail-gallery').innerHTML = galleryHtml;
          // Reorganize content for modern kiosk layout
          reorganizeDetailPageContent(data, key);
          
          // Show the NEW modern tour detail page (it will overlay on top)
          console.log('🎬 Showing tour detail page...');
          const tourDetailPage = document.querySelector('.page.tour-detail-page');
          console.log('📍 Tour detail page element:', tourDetailPage);
          
          if (tourDetailPage) {
            // Set display and visibility
            tourDetailPage.style.display = 'flex';
            tourDetailPage.style.visibility = 'visible';
            tourDetailPage.style.opacity = '1';
            tourDetailPage.style.pointerEvents = 'auto';
            tourDetailPage.style.zIndex = '999999';
            
            // Use setTimeout to ensure display change happens before transform
            setTimeout(() => {
          tourDetailPage.classList.add('active');
              console.log('✅ Active class added');
              
              // Debug: Check computed styles
              const computed = window.getComputedStyle(tourDetailPage);
              console.log('🔍 COMPUTED STYLES:');
              console.log('  - display:', computed.display);
              console.log('  - visibility:', computed.visibility);
              console.log('  - opacity:', computed.opacity);
              console.log('  - z-index:', computed.zIndex);
              console.log('  - position:', computed.position);
              console.log('  - width:', computed.width);
              console.log('  - height:', computed.height);
              console.log('  - background:', computed.backgroundColor);
              console.log('  - top:', computed.top);
              console.log('  - left:', computed.left);
              
              // Check if home page is still visible
              const homePage = document.querySelector('.page.home-page');
              if (homePage) {
                const homeComputed = window.getComputedStyle(homePage);
                console.log('🏠 HOME PAGE STYLES:');
                console.log('  - display:', homeComputed.display);
                console.log('  - z-index:', homeComputed.zIndex);
              }
            }, 50);
            
          tourDetailPage.setAttribute('data-current-tour-key', key);
            console.log('✅ Tour detail page styles set - display:', tourDetailPage.style.display);
            console.log('✅ Tour detail page visibility:', tourDetailPage.style.visibility);
          } else {
            console.log('❌ ERROR: Tour detail page element not found!');
          }
          document.body.style.overflow = 'hidden';
          document.body.classList.add('tour-detail-open');
          console.log('✅ Body overflow hidden');
          
          // Add click handler to company name to filter by company
          const companyClickElement = document.getElementById('detail-company');
          companyClickElement.onclick = function() {
            const companyKey = this.getAttribute('data-company-key');
            const companyName = this.textContent.replace('🏢 ', '').replace(' ›', '');
            if (!companyKey) {
              console.warn('No company key found for company filter click');
              return;
            }
            filterByCompany(companyKey, companyName, key); // Pass the current tour key
          };
        });
    }
    
    function filterByCompany(companyKey, companyName, fromTourKey = null) {
      // Fallback: derive slug if missing
      const fallbackKey = companyName ? companyName.toLowerCase().replace(/[^a-z0-9]+/g, '') : '';
      const finalKey = companyKey || fallbackKey;
      
      // Store the tour we came from
      previousTourKey = fromTourKey;
      
      // Exit video flow if active
      isInVideoFlow = false;
      document.body.classList.remove('video-bg-active');
      
      // Hide video page and swipe overlay if active
      const videoPage = document.querySelector('.video-question-page');
      if (videoPage) videoPage.classList.remove('active');
      
      const swipeOverlay = document.getElementById('swipe-results-overlay');
      if (swipeOverlay) swipeOverlay.classList.remove('active');
      
      // Make sure home page is visible
      const homePage = document.querySelector('.home-page');
      if (homePage) {
        homePage.classList.add('active');
        homePage.style.display = 'block';
      }
      
      // Save current state to history before navigating
      navigationHistory.push({
        view: currentView,
        filters: {...activeFilters},
        question: currentQuestion,
        header: document.getElementById('tour-grid-header').textContent,
        resultsInfo: document.getElementById('results-info').innerHTML
      });
      
      // Close the detail page
      const tourDetailPage = document.querySelector('.page.tour-detail-page');
      if (tourDetailPage) {
        tourDetailPage.classList.remove('active');
        setTimeout(() => {
          tourDetailPage.style.display = 'none';
          tourDetailPage.style.visibility = 'hidden';
          tourDetailPage.style.opacity = '0';
          tourDetailPage.style.pointerEvents = 'none';
        }, 300);
      }
      document.body.style.overflow = '';
      document.body.classList.remove('tour-detail-open');
      
      // Scroll to top of page
      window.scrollTo({ top: 0, behavior: 'auto' });
      
      // Hide the hero section and show company filter nav
      const heroSection = document.getElementById('hero-section');
      const companyFilterNav = document.getElementById('company-filter-nav');
      if (heroSection) heroSection.style.display = 'none';
      if (companyFilterNav) companyFilterNav.style.display = 'block';
      
      // UPDATE HOME PAGE INSTEAD OF SWITCHING PAGES
      console.log('🏢 Filtering home page by company:', companyName, 'finalKey:', finalKey);
      
      // Update subtitle on home page
      const subtitle = document.getElementById('home-tours-subtitle');
      const title = document.getElementById('home-tours-title');
      if (title) title.textContent = `Tours by ${companyName}`;
      if (subtitle) subtitle.textContent = 'Loading...';
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Fetch tours by company
      const params = new URLSearchParams();
      params.set('company', finalKey);
      params.set('lang', currentLanguage);
      
      fetch(`/filter-tours?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          console.log(`✅ Loaded ${data.tours.length} tours for ${companyName}`);
          
          // Display company tours first (this will filter duplicates internally)
          displayFeaturedTours(data.tours, false);
          
          // Count how many were actually displayed (only count tour-card-large elements)
          const grid = document.getElementById('featured-grid');
          const displayedCount = grid ? grid.querySelectorAll('.tour-card-large').length : 0;
          
          // Update subtitle with actual displayed count
          if (subtitle) {
            subtitle.textContent = `Showing ${displayedCount} tour${displayedCount !== 1 ? 's' : ''}`;
          }
          
          // Now fetch and append ALL other tours
          fetch(`/filter-tours?lang=${currentLanguage}`)
            .then(response => response.json())
            .then(allData => {
              console.log(`✅ Loaded ${allData.tours.length} total tours, filtering out ${companyName}`);
              
              // Filter out tours from the selected company
              // Check multiple variations of company key/name
              const companyVariations = [
                finalKey,
                companyName,
                companyName.toLowerCase(),
                companyName.toLowerCase().replace(/\s+/g, ''),
                companyName.toLowerCase().replace(/[^a-z0-9]+/g, '')
              ];
              
              const otherTours = allData.tours.filter(tour => {
                const tourCompanyKey = tour.company_key || (tour.company || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
                const tourCompany = (tour.company || '').toLowerCase();
                const tourCompanyName = (tour.company_name || '').toLowerCase();
                
                // Exclude if any variation matches
                return !companyVariations.some(variation => 
                  tourCompanyKey === variation || 
                  tourCompany === variation || 
                  tourCompanyName === variation ||
                  tourCompany.includes(variation) ||
                  variation.includes(tourCompany)
                );
              });
              
              console.log(`   Filtered to ${otherTours.length} non-${companyName} tours`);
              
              // Insert divider and append other tours
              if (otherTours.length > 0) {
                const grid = document.getElementById('featured-grid');
                if (grid) {
                  // Create and insert divider
                  const divider = document.createElement('div');
                  divider.id = 'other-tours-divider';
                  divider.style.cssText = 'grid-column: 1/-1; margin: 60px 0 40px 0; text-align: center;';
                  divider.innerHTML = `
                    <h2 style="color: white; font-size: 3em; font-weight: 700; margin: 0;">Other Tours You Might Like</h2>
                    <p style="color: rgba(255,255,255,0.9); font-size: 1.5em; margin: 15px 0 0 0;">Continue scrolling to explore all available tours</p>
                  `;
                  grid.appendChild(divider);
                }
                
                displayFeaturedTours(otherTours, true); // append = true
              }
              
              homePageHasMore = false; // Disable further infinite scroll
            });
        })
        .catch(error => {
          console.error('❌ Filter error:', error);
          if (subtitle) subtitle.textContent = 'Error loading tours';
        });
    }
    
    function goBackToTourDetail() {
      if (previousTourKey) {
        // Show the hero section again and hide company filter nav
        const heroSection = document.getElementById('hero-section');
        const companyFilterNav = document.getElementById('company-filter-nav');
        if (heroSection) heroSection.style.display = 'block';
        if (companyFilterNav) companyFilterNav.style.display = 'none';
        
        // Open the tour detail
        openTourDetail(previousTourKey);
        previousTourKey = null;
      }
    }
    
    function goBack() {
      if (navigationHistory.length === 0) return;
      
      // Pop the last state from history
      const previousState = navigationHistory.pop();
      
      // Restore previous state
      currentView = previousState.view;
      activeFilters = {...previousState.filters};
      currentQuestion = previousState.question;
      
      // Hide nav buttons if going back to home
      if (navigationHistory.length === 0) {
        document.getElementById('nav-buttons').classList.remove('active');
      }
      
      // Restore header and info
      document.getElementById('tour-grid-header').textContent = previousState.header;
      document.getElementById('results-info').innerHTML = previousState.resultsInfo;
      
      // Reapply filters to restore tours
      if (Object.keys(activeFilters).length > 0) {
        applyFilters();
      } else {
        // Go back to initial random tours
        location.reload();
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function goHome() {
      // Clear history and state
      navigationHistory = [];
      currentView = 'home';
      activeFilters = {};
      currentQuestion = 1;
      
      // Hide nav buttons
      document.getElementById('nav-buttons').classList.remove('active');
      
      // Reset to home
      location.reload();
    }
    
    document.getElementById('back-arrow').onclick = function() {
      console.log('⬅️ Back button clicked');
      console.log('   isInVideoFlow:', isInVideoFlow);
      
      // URL stays on home page - no need to change it
      
      const tourDetailPage = document.querySelector('.page.tour-detail-page');
      if (tourDetailPage) {
        tourDetailPage.classList.remove('active');
        // Wait for slide animation to complete before hiding
        setTimeout(() => {
          tourDetailPage.style.display = 'none';
          tourDetailPage.style.visibility = 'hidden';
          tourDetailPage.style.opacity = '0';
          tourDetailPage.style.pointerEvents = 'none';
          console.log('✅ Tour detail page hidden');
        }, 300);
      }
      document.body.style.overflow = '';
      document.body.classList.remove('tour-detail-open');
      
      // If we're in the video flow, return to swipe results
      if (isInVideoFlow) {
        console.log('🔙 Returning to swipe results');
        
        // Keep video background active
        document.body.classList.add('video-bg-active');
        
        // Hide home page
        const homePage = document.querySelector('.home-page');
        if (homePage) homePage.classList.remove('active');
        
        // Show video page
        const videoPage = document.querySelector('.video-question-page');
        if (videoPage) videoPage.classList.add('active');
        
        // Show swipe overlay
        const swipeOverlay = document.getElementById('swipe-results-overlay');
        if (swipeOverlay) swipeOverlay.classList.add('active');
        
        return; // Exit early, don't do the map view stuff
      }
      
      // Not in video flow - hide video background
      document.body.classList.remove('video-bg-active');
      
      // If we were in map view before opening the detail, switch back to map view
      if (wasInMapView) {
        // Restore map view
        document.getElementById('tour-placeholder-row').style.display = 'none';
        document.getElementById('map-container').style.display = 'block';
        
        // Make sure the map view state is correct
        if (!isMapView) {
          isMapView = true;
          document.getElementById('view-toggle-icon').textContent = '📋';
          document.getElementById('view-toggle-text').textContent = 'Grid View';
          document.getElementById('tour-grid-header').textContent = 'Tour Locations';
          document.getElementById('results-info').innerHTML = '<strong>📍 Click a pin to see tours departing from that location</strong><br><em style="color: #666;">💡 Tip: Click the map to enable scroll zoom • Use + / - buttons or pinch to zoom</em>';
          
          // Refresh map size
          setTimeout(() => {
            if (map) map.invalidateSize();
          }, 100);
        }
      }
      // Home page is already visible underneath, no need to show it
    };
    
    // Booking Modal Functions
    let currentTourForBooking = null;
    let selectedPricingTier = null;
    
    // Rezdy booking function - opens in smaller borderless popup window
    function openRezdyBooking(rezdyUrl) {
      // Smaller popup size (80% of screen or 900x700, whichever is smaller)
      const width = Math.min(900, screen.width * 0.8);
      const height = Math.min(700, screen.height * 0.8);
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;
      
      // Open Rezdy in a borderless, non-resizable popup window
      const popup = window.open(
        rezdyUrl,
        'RezdyBooking',
        `width=${width},height=${height},left=${left},top=${top},resizable=no,scrollbars=yes,status=no,toolbar=no,menubar=no,location=no,titlebar=no,directories=no`
      );
      
      // Focus the popup window
      if (popup) {
        popup.focus();
      }
    }
    
    function openBookingModal(tourKey, tourName, tourCompany) {
      currentTourForBooking = { key: tourKey, name: tourName, company: tourCompany };
      document.getElementById('booking-tour-name').textContent = tourName;
      
      // Update booking tour name with selected pricing tier if available
      if (selectedPricingTier) {
        document.getElementById('booking-tour-name').textContent = `${tourName} - ${selectedPricingTier}`;
      }
      
      document.getElementById('booking-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('guest-date').setAttribute('min', today);
    }
    
    function closeBookingModal() {
      document.getElementById('booking-modal').classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('booking-form').reset();
      document.getElementById('booking-form').style.display = 'block';
      document.getElementById('booking-success').style.display = 'none';
      currentTourForBooking = null;
      // Note: We don't reset selectedPricingTier here so user can still see their selection
    }
    
    // Close modal when clicking X or outside
    document.getElementById('close-booking-modal').onclick = closeBookingModal;
    document.getElementById('booking-modal').onclick = function(e) {
      if (e.target === this) {
        closeBookingModal();
      }
    };
    
    // Handle booking form submission
    document.getElementById('booking-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-booking-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      
      const formData = {
        tour_key: currentTourForBooking.key,
        tour_name: currentTourForBooking.name,
        tour_company: currentTourForBooking.company,
        selected_pricing: selectedPricingTier || 'Not specified',
        guest_name: document.getElementById('guest-name').value,
        guest_email: document.getElementById('guest-email').value,
        guest_phone: document.getElementById('guest-phone').value,
        adults: document.getElementById('guest-adults').value,
        children: document.getElementById('guest-children').value,
        preferred_date: document.getElementById('guest-date').value,
        message: document.getElementById('guest-message').value
      };
      
      try {
        const response = await fetch('/submit-booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Show success screen
          document.getElementById('booking-form').style.display = 'none';
          document.getElementById('booking-success').style.display = 'block';
        } else {
          alert('There was an error sending your inquiry. Please try again or contact us directly.');
        }
      } catch (error) {
        console.error('Booking error:', error);
        alert('There was an error sending your inquiry. Please try again or contact us directly.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Inquiry ✉️';
      }
    });
  </script>
  
  <!-- QR Code Modal -->
  <div id="qr-modal">
    <div class="qr-modal-content">
      <button class="qr-modal-close" onclick="closeQRModal()">×</button>
      <div class="qr-modal-title">📱 Scan to Book</div>
      <div class="qr-modal-subtitle" id="qr-tour-name"></div>
      <div class="qr-code-container">
        <img id="qr-code-image" src="" alt="QR Code">
      </div>
      <div class="qr-modal-instruction">
        Open your phone's camera and point it at the QR code.<br>
        Tap the notification to view full details and book directly.
      </div>
    </div>
  </div>
  
  <script>
    // QR Code functionality
    function showQRCode(tourUrl, tourName) {
      const modal = document.getElementById('qr-modal');
      const qrImage = document.getElementById('qr-code-image');
      const tourNameEl = document.getElementById('qr-tour-name');
      
      // Use a free QR code API to generate the QR code
      // tourUrl is now the link_more_info (tour company's page)
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(tourUrl)}`;
      
      qrImage.src = qrApiUrl;
      tourNameEl.textContent = tourName;
      modal.style.display = 'flex';
    }
    
    function closeQRModal() {
      document.getElementById('qr-modal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.getElementById('qr-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQRModal();
      }
    });
    
    // =====================================================================
    // MAP VIEW FUNCTIONALITY
    // =====================================================================
    
    // Location coordinates mapping
    const LOCATION_COORDINATES = {
      'coral sea marina meeting point c': { lat: -20.266375233566162, lng: 148.71177988752422, display: 'Coral Sea Marina - Point C' },
      'coral sea marina meeting point b': { lat: -20.264414180361367, lng: 148.71311646731866, display: 'Coral Sea Marina - Point B' },
      'coral sea marina meeting point d': { lat: -20.26750141568915, lng: 148.71088264806792, display: 'Coral Sea Marina - Point D' },
      'coral sea marina resort': { lat: -20.26444379610819, lng: 148.71311063152888, display: 'Coral Sea Marina' },
      'coral sea marina': { lat: -20.26444379610819, lng: 148.71311063152888, display: 'Coral Sea Marina' },
      'port of airlie': { lat: -20.272656890736457, lng: 148.72502638971474, display: 'Port of Airlie' },
      'shop 9 33 port dr port of airlie': { lat: -20.271337780653436, lng: 148.72325262537308, display: 'Shop 9/33 Port Dr' },
      'shop 9 33 port dr': { lat: -20.271337780653436, lng: 148.72325262537308, display: 'Shop 9/33 Port Dr' },
      'shute harbor': { lat: -20.292954469621723, lng: 148.7859086471698, display: 'Shute Harbor' },
      'shute harbour airlie beach': { lat: -20.292954469621723, lng: 148.7859086471698, display: 'Shute Harbor' },
      'shute harbour': { lat: -20.292954469621723, lng: 148.7859086471698, display: 'Shute Harbor' },
      'shingley beach': { lat: -20.26939746783185, lng: 148.70840354266912, display: 'Shingley Beach' },
      'airlie beach dive centre': { lat: -20.268869, lng: 148.716667, display: 'Airlie Beach Dive Centre' },
      'shop 11 293 shute harbour road airlie beach qld 4802': { lat: -20.268869, lng: 148.716667, display: 'Airlie Beach Dive Centre' },
      'shop 11 293 shute harbour road': { lat: -20.268869, lng: 148.716667, display: 'Airlie Beach Dive Centre' },
      'courtesy bus pickup': { lat: -20.27, lng: 148.72, display: 'Courtesy Bus (Various Locations)' }
    };
    
    let map = null;
    let homeMap = null;  // Separate map for home page
    let markers = {};  // Store markers by location name
    let isMapView = false;
    let mapTourData = [];  // Store tour data fetched for the map
    let selectedLocation = null;  // Track which location is selected
    let toursByLocationData = {};  // Store tours grouped by location
    
    // Normalize location names for matching
    function normalizeLocation(location) {
      if (!location) return '';
      return location.toLowerCase()
        .trim()
        .replace(/[,\.\/&]/g, ' ')  // Replace punctuation with spaces
        .replace(/\s+/g, ' ')        // Collapse multiple spaces
        .trim();
    }
    
    // Find coordinates for a departure location
    function getCoordinatesForLocation(departureLocation) {
      const normalized = normalizeLocation(departureLocation);
      
      // Try exact match first
      if (LOCATION_COORDINATES[normalized]) {
        return LOCATION_COORDINATES[normalized];
      }
      
      // Try partial matches
      for (const [key, coords] of Object.entries(LOCATION_COORDINATES)) {
        if (normalized.includes(key) || key.includes(normalized)) {
          return coords;
        }
      }
      
      return null;
    }
    
    // Initialize the map
    function initializeMap() {
      if (map) return; // Already initialized
      
      console.log('Initializing map...');
      
      // Center map on Airlie Beach area
      map = L.map('map', {
        scrollWheelZoom: false,  // Disable scroll wheel zoom by default
        zoomSnap: 0.5,           // Allow half-step zooming for smoother control
        zoomDelta: 0.5           // Zoom in/out by 0.5 levels per click
      }).setView([-20.27, 148.72], 13);
      
      // Enable scroll zoom with reduced sensitivity when map is clicked
      map.on('click', function() {
        map.scrollWheelZoom.enable();
        // Make scroll zoom MUCH less sensitive (default is 60, tripling makes it 3x less sensitive)
        map.options.wheelPxPerZoomLevel = 180;
      });
      
      // Disable scroll zoom when mouse leaves map
      map.on('mouseout', function() {
        map.scrollWheelZoom.disable();
      });
      
      // Add OpenStreetMap tiles with higher max zoom
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 20,  // Increased from 18 to allow more detailed street view
        maxNativeZoom: 19  // OSM's native max zoom level
      }).addTo(map);
      
      // Fetch ALL tours from the server to populate the map
      fetch(`/filter-tours?for_map=true&lang=${currentLanguage}`)
        .then(response => response.json())
        .then(data => {
          console.log(`Fetched ${data.tours.length} tours from server (total found: ${data.total_found})`);
          
          // Store the full tour data for carousel use
          mapTourData = data.tours;
          console.log('✅ Stored', mapTourData.length, 'tours for map/carousel');
          
          // Group tours by location
          const toursByLocation = {};
          
          data.tours.forEach(tour => {
            const departureLocation = tour.departure_location || '';
            
            console.log(`Tour: ${tour.name}, Departure: ${departureLocation}`);
            
            // Only add tours that have a name and departure location
            if (departureLocation && tour.name) {
              const coords = getCoordinatesForLocation(departureLocation);
              if (coords) {
                console.log(`  -> Matched to ${coords.display}`);
                const locKey = coords.display;
                if (!toursByLocation[locKey]) {
                  toursByLocation[locKey] = {
                    coords: coords,
                    tours: []
                  };
                }
                toursByLocation[locKey].tours.push({
                  key: tour.key,
                  name: tour.name,
                  company: tour.company_name,
                  thumbnail: tour.thumbnail,
                  review_rating: tour.review_rating,
                  review_count: tour.review_count,
                  price_adult: tour.price_adult,
                  departure_location: tour.departure_location
                });
              } else {
                console.log(`  -> No coordinates found for: ${departureLocation}`);
              }
            }
          });
          
          console.log('Tours by location:', toursByLocation);
          
          // Store for global access
          toursByLocationData = toursByLocation;
          
          createMapMarkers(toursByLocation);
          
          // If we're already in map view, populate the carousel
          if (isMapView) {
            populateCarousel(selectedLocation);
          }
        })
        .catch(error => {
          console.error('Error fetching tours for map:', error);
        });
    }
    
    // Separate function to create markers
    function createMapMarkers(toursByLocation, targetMap = null) {
      // Use the appropriate map
      const mapToUse = targetMap || map || homeMap;
      if (!mapToUse) {
        console.error('No map available to add markers to');
        return;
      }
      
      // Create markers for each location
      Object.entries(toursByLocation).forEach(([locationName, data]) => {
        const { coords, tours } = data;
        
        // Create custom icon with tour count - larger and more visible
        const icon = L.divIcon({
          className: 'custom-marker-container',
          html: `<div class="custom-marker" style="background:#0077b6;color:white;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.4em;border:3px solid white;box-shadow:0 3px 15px rgba(0,0,0,0.4);transition:all 0.3s ease;">${tours.length}</div>`,
          iconSize: [50, 50],
          iconAnchor: [25, 25]
        });
        
        const marker = L.marker([coords.lat, coords.lng], { icon: icon }).addTo(mapToUse);
        
        // Create popup content
        let popupContent = `<div class="map-popup-header">${locationName} (${tours.length} tours)</div>`;
        popupContent += '<div class="map-popup-tours">';
        
        tours.forEach(tour => {
          popupContent += `
            <div class="map-tour-item" onclick="openTourFromMap('${tour.key}')">
              <div class="map-tour-name">${tour.name}</div>
              <div class="map-tour-company">${tour.company}</div>
            </div>
          `;
        });
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {
          maxWidth: 450,  // Wider popup for larger text
          minWidth: 350,
          className: 'custom-popup'
        });
        
        // When marker is clicked, filter carousel to this location
        marker.on('click', () => {
          // Check if map view is active (either tour-list-page or home page)
          const homeMapSection = document.getElementById('home-map-view-section');
          const isHomeMapActive = homeMapSection && homeMapSection.style.display !== 'none';
          
          if (isMapView || isHomeMapActive) {
            selectLocationOnMap(locationName);
          }
        });
        
        // Store marker by location name for later reference
        markers[locationName] = marker;
      });
      
      const markerCount = Object.keys(markers).length;
      console.log(`Created ${markerCount} markers`);
      
      // If no tours have locations, show all location pins anyway
      if (markerCount === 0) {
        console.log('No tours matched to locations, showing all known locations');
        Object.entries(LOCATION_COORDINATES).forEach(([key, coords]) => {
          const marker = L.marker([coords.lat, coords.lng]).addTo(map);
          marker.bindPopup(`<b>${coords.display}</b><br>No tours currently departing from here.`);
          markers[coords.display] = marker;
        });
      }
    }
    
    // This function is now at the end of createMapMarkers
    
    // Toggle mobile menu
    function toggleMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('active');
      // Close submenus when closing main menu
      if (!menu.classList.contains('active')) {
        document.getElementById('mobile-lang-submenu').style.display = 'none';
        document.getElementById('mobile-currency-submenu').style.display = 'none';
      }
    }
    
    // Toggle language submenu in mobile menu
    function toggleMobileLanguageMenu() {
      const submenu = document.getElementById('mobile-lang-submenu');
      const currencySubmenu = document.getElementById('mobile-currency-submenu');
      const isVisible = submenu.style.display === 'block';
      
      // Close currency menu if open
      currencySubmenu.style.display = 'none';
      
      // Toggle language menu
      submenu.style.display = isVisible ? 'none' : 'block';
    }
    
    // Toggle currency submenu in mobile menu
    function toggleMobileCurrencyMenu() {
      const submenu = document.getElementById('mobile-currency-submenu');
      const langSubmenu = document.getElementById('mobile-lang-submenu');
      const isVisible = submenu.style.display === 'block';
      
      // Close language menu if open
      langSubmenu.style.display = 'none';
      
      // Toggle currency menu
      submenu.style.display = isVisible ? 'none' : 'block';
    }
    
    // Wrapper function for mobile menu language change
    function changeLanguage(langCode) {
      switchLanguage(langCode);
    }
    
    // Wrapper function for mobile menu currency change
    function changeCurrency(currencyCode) {
      // Update display
      currentCurrency = currencyCode;
      if (document.getElementById('currency-btn-text')) {
        document.getElementById('currency-btn-text').textContent = currencyCode;
      }
      if (document.getElementById('mobile-menu-currency-text')) {
        document.getElementById('mobile-menu-currency-text').textContent = currencyCode;
      }
      
      // Update header chip (modern home page)
      if (typeof updateHeaderChips === 'function') {
        updateHeaderChips();
      }
      
      // Close currency menu
      const menu = document.getElementById('currency-menu');
      if (menu) menu.classList.remove('active');
      
      // Re-render tour cards with new currency
      applyFilters();
    }
    
    // Close mobile menu if clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('mobile-menu');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      if (menu && menuBtn && !menu.contains(event.target) && !menuBtn.contains(event.target)) {
        menu.classList.remove('active');
        // Close submenus
        document.getElementById('mobile-lang-submenu').style.display = 'none';
        document.getElementById('mobile-currency-submenu').style.display = 'none';
      }
    });
    
    // Wrapper for modern home page map view toggle
    async function toggleMapView() {
      await toggleView();
    }
    
    // Toggle between grid and map view
    async function toggleView() {
      isMapView = !isMapView;
      
      const gridContainer = document.getElementById('tour-placeholder-row');
      const mapContainer = document.getElementById('map-container');
      const carouselContainer = document.getElementById('map-carousel-container');
      const loadMoreBtn = document.querySelector('.load-more-container');
      const mapToggleBtn = document.getElementById('map-toggle-btn');
      const header = document.getElementById('tour-grid-header');
      const resultsInfo = document.getElementById('results-info');
      
      console.log('🔄 toggleView called, isMapView:', isMapView);
      console.log('   Current activeFilters:', activeFilters);
      
      if (isMapView) {
        // Switch to map view
        gridContainer.style.display = 'none';
        loadMoreBtn.style.display = 'none';
        mapContainer.classList.add('active');
        mapContainer.style.display = 'block';
        carouselContainer.classList.add('active');
        
        // Update button text
        if (mapToggleBtn) mapToggleBtn.textContent = 'Grid view';
        
        // Update header text
        header.textContent = 'Tour Locations';
        resultsInfo.innerHTML = '<strong>📍 Answer the questions above, click a map pin, or scroll the carousel below</strong>';
        
        // DON'T reset questionnaire - keep current filters!
        // Instead, ensure map shows the same filtered tours as grid view
        
        // If we have active filters, fetch the filtered tours for map view
        const hasFilters = Object.keys(activeFilters).length > 0;
        
        if (hasFilters) {
          console.log('   🔍 Fetching filtered tours for map view...');
          const params = new URLSearchParams();
          
          // Add ALL active filters to the request
          if (activeFilters.activity) {
            if (Array.isArray(activeFilters.activity)) {
              activeFilters.activity.forEach(act => params.append('activity', act));
            } else {
              params.append('activity', activeFilters.activity);
            }
          }
          if (activeFilters.duration) params.append('duration', activeFilters.duration);
          if (activeFilters.family) params.append('family', activeFilters.family);
          if (activeFilters.price) params.append('price', activeFilters.price);
          if (activeFilters.equipment) params.append('equipment', activeFilters.equipment);
          if (activeFilters.meals) params.append('meals', activeFilters.meals);
          if (activeFilters.inclusions) params.append('inclusions', activeFilters.inclusions);
          params.append('for_map', 'true');
          params.append('lang', currentLanguage);
          
          console.log('   📋 Sending filters to server:', Object.fromEntries(params));
          
          const response = await fetch(`/filter-tours?${params}`);
          const data = await response.json();
          const tours = data.tours || data;  // Handle both response formats
          
          console.log(`   ✅ Fetched ${tours.length} filtered tours for map view`);
          
          // Update mapTourData with filtered tours
          mapTourData = tours;
        } else {
          console.log('   📍 No filters - loading all tours for map view');
          // If no filters, load all tours
          const response = await fetch(`/filter-tours?for_map=true&lang=${currentLanguage}`);
          const data = await response.json();
          const tours = data.tours || data;  // Handle both response formats
          mapTourData = tours;
        }
        
        // Initialize map if not already done
        initializeMap();
        
        // Update map pins and carousel with current filtered data
        updateHomeMapPins();
        populateCarousel();
        
        // Refresh map size
        setTimeout(() => {
          if (map) map.invalidateSize();
        }, 100);
      } else {
        // Switch to grid view
        gridContainer.style.display = 'grid';
        loadMoreBtn.style.display = 'flex';
        mapContainer.classList.remove('active');
        mapContainer.style.display = 'none';
        carouselContainer.classList.remove('active');
        
        // Update button text
        if (mapToggleBtn) mapToggleBtn.textContent = 'Map view';
        
        header.textContent = 'Tap Any Card For Booking and More Info';
        resultsInfo.textContent = 'Tap an option above to start filtering';
        
        // Clear location filter from map view
        if (selectedLocation) {
          selectedLocation = null;
        }
        
        // Refresh grid view with current filters
        const hasFilters = Object.keys(activeFilters).length > 0;
        
        if (hasFilters) {
          console.log('   🔍 Refreshing grid view with filters...');
          const params = new URLSearchParams();
          
          if (activeFilters.activity) {
            if (Array.isArray(activeFilters.activity)) {
              activeFilters.activity.forEach(act => params.append('activity', act));
            } else {
              params.append('activity', activeFilters.activity);
            }
          }
          if (activeFilters.duration) params.append('duration', activeFilters.duration);
          if (activeFilters.family) params.append('family', activeFilters.family);
          if (activeFilters.price) params.append('price', activeFilters.price);
          if (activeFilters.equipment) params.append('equipment', activeFilters.equipment);
          if (activeFilters.meals) params.append('meals', activeFilters.meals);
          params.append('lang', currentLanguage);
          
          console.log('   📋 Sending filters to server:', Object.fromEntries(params));
          
          const response = await fetch(`/filter-tours?${params}`);
          const data = await response.json();
          const tours = data.tours || data;
          
          console.log(`   ✅ Fetched ${tours.length} filtered tours for grid view`);
          
          // Update grid display
          displayFeaturedTours(tours);
        } else {
          console.log('   📍 No filters - showing featured tours');
          loadInitialFeaturedTours();
        }
      }
    }
    
    // Populate carousel with tours (optionally filtered by location and filters)
    function populateCarousel(filterLocation = null, carouselId = 'map-carousel', headerTextId = 'carousel-header-text', clearBtnId = 'carousel-clear-btn') {
      const carousel = document.getElementById(carouselId);
      const headerText = document.getElementById(headerTextId);
      const clearBtn = document.getElementById(clearBtnId);
      
      console.log('🎠 Populating carousel...');
      console.log('   Carousel ID:', carouselId);
      console.log('   Filter location:', filterLocation);
      console.log('   Active filters:', JSON.stringify(activeFilters));
      console.log('   mapTourData length:', mapTourData.length);
      console.trace('   Call stack:');
      
      if (!carousel) {
        console.error('❌ Carousel element not found:', carouselId);
        return;
      }
      
      carousel.innerHTML = '';
      
      if (mapTourData.length === 0) {
        carousel.innerHTML = '<div style="padding: 20px; color: #666; text-align: center; width: 100%;">Loading tours... If this persists, the map may still be initializing.</div>';
        if (headerText) headerText.innerHTML = 'Loading tours...';
        if (clearBtn) clearBtn.style.display = 'none';
        return;
      }
      
      // Start with mapTourData (already filtered by server if in home page map view)
      let toursToShow = mapTourData;
      
      // Check if we're on home page map (server already filtered the data)
      const homeMapSection = document.getElementById('home-map-view-section');
      const isHomePageMap = homeMapSection && homeMapSection.style.display !== 'none';
      
      // Don't re-filter on client side - server already did it
      if (false && isHomePageMap && activeFilters && Object.keys(activeFilters).length > 0) {
        console.log('   Applying home page filters:', activeFilters);
        toursToShow = toursToShow.filter(tour => {
          // Duration filter (home page uses "duration" key)
          if (activeFilters.duration && activeFilters.duration !== '') {
            const tourDuration = tour.duration_category || '';
            if (tourDuration !== activeFilters.duration) return false;
          }
          
          // Family filter (check both "family" and "family_friendly" keys)
          const familyFilter = activeFilters.family_friendly || activeFilters.family;
          if (familyFilter && familyFilter !== '') {
            const isFamilyFriendly = tour.family_friendly === true || tour.family_friendly === 'true';
            if (familyFilter === 'true' && !isFamilyFriendly) return false;
            if (familyFilter === 'false' && isFamilyFriendly) return false;
          }
          
          // Price filter (check both "price_range" and "price" keys)
          const priceFilter = activeFilters.price_range || activeFilters.price;
          if (priceFilter && priceFilter !== '') {
            // Extract numeric price from price_adult string (e.g., "From A$150" -> 150)
            const priceMatch = tour.price_adult?.match(/[\d,]+/);
            if (priceMatch) {
              const price = parseFloat(priceMatch[0].replace(/,/g, ''));
              if (priceFilter === 'budget' && price > 100) return false;
              if (priceFilter === 'mid_range' && price > 250) return false;
              if (priceFilter === 'premium' && price > 500) return false;
              if (priceFilter === 'luxury' && price > 1000) return false;
            }
          }
          
          // Activity filter (home page uses "activity" key)
          if (activeFilters.activity && activeFilters.activity !== '') {
            const tourTags = (tour.tags || '').toLowerCase();
            const tourName = (tour.name || '').toLowerCase();
            const tourDescription = (tour.description || '').toLowerCase();
            const searchText = tourTags + ' ' + tourName + ' ' + tourDescription;
            
            // Handle multi-select (array) or single select (string)
            const activities = Array.isArray(activeFilters.activity) ? activeFilters.activity : [activeFilters.activity];
            
            // Tour must match at least ONE of the selected activities
            let matchesAny = false;
            for (const activity of activities) {
              if (activity === 'great_barrier_reef' && searchText.includes('reef')) matchesAny = true;
              if (activity === 'whitehaven_beach' && searchText.includes('whitehaven')) matchesAny = true;
              if (activity === 'island_tours' && searchText.includes('island')) matchesAny = true;
              if (activity === 'scenic_adventure' && (searchText.includes('scenic') || searchText.includes('adventure'))) matchesAny = true;
            }
            
            if (!matchesAny) return false;
          }
          
          // Extras filters (meals, equipment) - OR logic if both selected
          const needsMeals = activeFilters.meals === 'true';
          const needsEquipment = activeFilters.equipment === 'true';
          
          if (needsMeals || needsEquipment) {
            const inclusions = (tour.inclusions || '').toLowerCase();
            const hasMeals = inclusions.includes('meal');
            const hasEquipment = inclusions.includes('equipment') || 
                                inclusions.includes('snorkel') || 
                                inclusions.includes('gear');
            
            // If both filters selected, match if tour has EITHER one (OR logic)
            if (needsMeals && needsEquipment) {
              if (!hasMeals && !hasEquipment) return false;
            }
            // If only meals selected
            else if (needsMeals) {
              if (!hasMeals) return false;
            }
            // If only equipment selected
            else if (needsEquipment) {
            if (!hasEquipment) return false;
            }
          }
          
          return true;
        });
      }
      
      // Then filter by location if specified
      if (filterLocation) {
        toursToShow = toursToShow.filter(tour => {
          const coords = getCoordinatesForLocation(tour.departure_location);
          return coords && coords.display === filterLocation;
        });
        console.log('   Filtered to', toursToShow.length, 'tours from', filterLocation);
      }
      
      console.log('   After all filters:', toursToShow.length, 'tours');
      
      // Update header
      if (filterLocation) {
        if (headerText) headerText.innerHTML = `Showing <span class="count">${toursToShow.length}</span> tour${toursToShow.length !== 1 ? 's' : ''} from <span class="location">${filterLocation}</span>`;
        if (clearBtn) clearBtn.style.display = 'block';
      } else {
        if (headerText) headerText.innerHTML = `Showing <span class="count">${toursToShow.length}</span> tour${toursToShow.length !== 1 ? 's' : ''}`;
        if (clearBtn) clearBtn.style.display = 'none';
      }
      
      console.log('   After filtering:', toursToShow.length, 'tours to show');
      
      if (toursToShow.length === 0) {
        // Show prominent empty state message with start over button
        carousel.innerHTML = `
          <div style="padding: 60px 20px; text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <div style="font-size: 3em; color: #666;">😕</div>
            <h3 style="font-size: 1.8em; color: #333; margin: 0;">No Tours Match Your Filters</h3>
            <p style="font-size: 1.2em; color: #666; margin: 0;">Try adjusting your search criteria to see more options</p>
            <button onclick="startOverFilters()" style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              padding: 16px 32px;
              border-radius: 50px;
              font-size: 1.2em;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
              transition: transform 0.2s;
            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              🔄 Start Over
            </button>
          </div>
        `;
        
        // Clear map pins when no tours
        if (homeMap) {
          Object.values(markers).forEach(marker => marker.remove());
          markers = {};
          console.log('   ✅ Cleared map pins (no tours to show)');
        }
        
        return;
      }
      
      toursToShow.forEach((tour) => {
        const key = tour.key;
        const departure = tour.departure_location;
        const thumbnail = tour.thumbnail || '';
        const name = tour.name || 'Unnamed Tour';
        const rating = tour.review_rating && tour.review_rating > 0 ? tour.review_rating.toFixed(1) : '';
        const reviewCount = tour.review_count || 0;
        const price = tour.price_adult || '';
        
        const carouselCard = document.createElement('div');
        carouselCard.className = 'carousel-card';
        carouselCard.dataset.key = key;
        carouselCard.dataset.departure = departure;
        
        // Simplified: click anywhere on card opens tour detail
        carouselCard.onclick = () => openTourDetail(key);
        
        carouselCard.innerHTML = `
          <div class="carousel-card-image" style="background-image: url('${thumbnail}');"></div>
          <div class="carousel-card-info">
            <h3 class="carousel-card-name">${name}</h3>
            <div class="carousel-card-meta">
              ${rating ? `<span class="carousel-card-rating">★ ${rating}${reviewCount > 0 ? ` (${reviewCount})` : ''}</span>` : '<span></span>'}
              <span class="carousel-card-price">${price}</span>
            </div>
          </div>
        `;
        
        carousel.appendChild(carouselCard);
      });
      
      console.log('✅ Carousel populated with', toursToShow.length, 'tours');
    }
    
    // Select a location on the map (filters carousel to that location)
    function selectLocationOnMap(locationName) {
      console.log('📍 Selected location:', locationName);
      selectedLocation = locationName;
      
      // NO size manipulation here - size is locked by CSS/inline styles with !important
      
      // Highlight the selected marker
      Object.entries(markers).forEach(([name, marker]) => {
        const markerElement = marker.getElement();
        if (markerElement) {
          if (name === locationName) {
            markerElement.querySelector('.custom-marker')?.classList.add('highlighted');
          } else {
            markerElement.querySelector('.custom-marker')?.classList.remove('highlighted');
            markerElement.style.opacity = '0.5';  // Dim non-selected markers
          }
        }
      });
      
      // Filter carousel to show only tours from this location
      // Check which page we're on and update the right carousel
      const homeMapSection = document.getElementById('home-map-view-section');
      if (homeMapSection && homeMapSection.style.display !== 'none') {
        // We're on the home page map view
        populateHomeCarousel(locationName);
        
        // Just refresh map size without changing dimensions
        if (homeMap) {
          setTimeout(() => {
            homeMap.invalidateSize();
            console.log('   Map refreshed (size unchanged)');
          }, 10);
        }
      } else {
        // We're on the tour list page map view
        populateCarousel(locationName);
        
        // Refresh tour list page map if it exists
        if (map) {
          setTimeout(() => {
            map.invalidateSize();
          }, 10);
        }
      }
    }
    
    // Clear location filter
    function clearLocationFilter() {
      console.log('🔄 Clearing location filter');
      selectedLocation = null;
      
      // Remove all marker highlights and restore opacity
      Object.entries(markers).forEach(([name, marker]) => {
        const markerElement = marker.getElement();
        if (markerElement) {
          markerElement.querySelector('.custom-marker')?.classList.remove('highlighted');
          markerElement.style.opacity = '1';
        }
      });
      
      // Show all tours in carousel - check which page we're on
      const homeMapSection = document.getElementById('home-map-view-section');
      if (homeMapSection && homeMapSection.style.display !== 'none') {
        populateHomeCarousel(null);
      } else {
        populateCarousel(null);
      }
      
      // Reset map view (use whichever map is active)
      const activeMap = homeMap || map;
      if (activeMap) {
        activeMap.setView([-20.27, 148.72], 13, {
          animate: true,
          duration: 0.5
        });
      }
    }
    
    // Handle clicks on carousel background (not on cards)
    function handleCarouselBackgroundClick(event) {
      // Only clear filter if clicking directly on the carousel background
      if (event.target.id === 'map-carousel' && selectedLocation) {
        clearLocationFilter();
      }
    }
    
    // Initialize map on home page
    function initializeHomeMap() {
      if (homeMap) {
        // Map already exists, just refresh size
        console.log('Home map already initialized, refreshing size...');
        homeMap.invalidateSize();
        // Don't populate carousel here - let the calling function handle it
        return;
      }
      
      console.log('🗺️ Initializing home page map...');
      
      // Check if Leaflet is loaded
      if (typeof L === 'undefined') {
        console.error('❌ Leaflet is not loaded!');
        return;
      }
      
      // Check if map container exists
      const mapContainer = document.getElementById('home-map');
      if (!mapContainer) {
        console.error('❌ Map container #home-map not found!');
        return;
      }
      
      console.log('✅ Map container found:', mapContainer);
      console.log('   Container size:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
      
      try {
        // Center map on Airlie Beach area
        homeMap = L.map('home-map', {
          scrollWheelZoom: false,
          zoomSnap: 0.5,
          zoomDelta: 0.5
        }).setView([-20.27, 148.72], 13);
        
        console.log('✅ Leaflet map created');
      } catch (error) {
        console.error('❌ Error creating map:', error);
        return;
      }
      
      // Enable scroll zoom when clicked
      homeMap.on('click', function() {
        homeMap.scrollWheelZoom.enable();
        homeMap.options.wheelPxPerZoomLevel = 180;
      });
      
      homeMap.on('mouseout', function() {
        homeMap.scrollWheelZoom.disable();
      });
      
      // Add OpenStreetMap tiles
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 20,
        maxNativeZoom: 19
      });
      
      tiles.on('loading', () => console.log('🗺️ Tiles loading...'));
      tiles.on('load', () => console.log('✅ Tiles loaded'));
      tiles.on('tileerror', (e) => console.error('❌ Tile error:', e));
      
      tiles.addTo(homeMap);
      console.log('✅ Tile layer added to map');
      
      // Size is now locked by inline styles with !important - no monitoring needed
      
      // Fetch ALL tours from the server (unfiltered)
      const params = new URLSearchParams();
      params.append('for_map', 'true');
      params.append('lang', currentLanguage);
      
      console.log('📡 Fetching tours from:', `/filter-tours?${params.toString()}`);
      
      fetch(`/filter-tours?${params.toString()}`)
        .then(response => {
          console.log('📡 Response received:', response.status);
          return response.json();
        })
        .then(data => {
          console.log(`✅ Fetched ${data.tours.length} tours for map`);
          
          // Store the full tour data for carousel use
          mapTourData = data.tours;
          
          // Group tours by location
          const toursByLocation = {};
          data.tours.forEach(tour => {
            const departureLocation = tour.departure_location || '';
            if (departureLocation && tour.name) {
              const coords = getCoordinatesForLocation(departureLocation);
              if (coords) {
                const locKey = coords.display;
                if (!toursByLocation[locKey]) {
                  toursByLocation[locKey] = {
                    coords: coords,
                    tours: []
                  };
                }
                toursByLocation[locKey].tours.push({
                  key: tour.key,
                  name: tour.name,
                  company: tour.company_name,
                  thumbnail: tour.thumbnail,
                  review_rating: tour.review_rating,
                  review_count: tour.review_count,
                  price_adult: tour.price_adult,
                  departure_location: tour.departure_location
                });
              }
            }
          });
          
          toursByLocationData = toursByLocation;
          createMapMarkers(toursByLocation, homeMap);
          
          // Populate carousel with filtered tours based on current active filters
          populateHomeCarousel(null);
        })
        .catch(error => {
          console.error('❌ Error fetching tours for map:', error);
        });
    }
    
    // Populate home page carousel and update map pins
    function populateHomeCarousel(filterLocation = null) {
      // Update carousel
      populateCarousel(filterLocation, 'home-map-carousel', 'home-carousel-header-text', 'home-carousel-clear-btn');
      
      // Also update map pins to match filtered tours
      updateHomeMapPins();
    }
    
    // Update map pins based on current mapTourData (already filtered by server)
    function updateHomeMapPins() {
      if (!homeMap) return;
      
      console.log('🗺️ Updating map pins');
      console.log('   Tours to display:', mapTourData ? mapTourData.length : 0);
      
      // Clear existing markers
      Object.values(markers).forEach(marker => marker.remove());
      markers = {};
      
      // If no tour data, stop here (pins are cleared)
      if (!mapTourData || mapTourData.length === 0) {
        console.log('   ✅ Map pins cleared (no tour data)');
        return;
      }
      
      // Use mapTourData directly (it's already filtered by the server)
      const filteredTours = mapTourData;
      
      // Regroup filtered tours by location
      const toursByLocation = {};
      filteredTours.forEach(tour => {
        const departureLocation = tour.departure_location || '';
        if (departureLocation && tour.name) {
          const coords = getCoordinatesForLocation(departureLocation);
          if (coords) {
            const locKey = coords.display;
            if (!toursByLocation[locKey]) {
              toursByLocation[locKey] = {
                coords: coords,
                tours: []
              };
            }
            toursByLocation[locKey].tours.push({
              key: tour.key,
              name: tour.name,
              company: tour.company_name,
              thumbnail: tour.thumbnail,
              review_rating: tour.review_rating,
              review_count: tour.review_count,
              price_adult: tour.price_adult,
              departure_location: tour.departure_location
            });
          }
        }
      });
      
      console.log(`   Creating pins for ${Object.keys(toursByLocation).length} locations`);
      
      // Create new markers with filtered tours
      createMapMarkers(toursByLocation, homeMap);
    }
    
    // Open tour detail from map
    function openTourFromMap(key) {
      // Close any open popups
      if (map) {
        map.closePopup();
      }
      
      // Don't switch to grid view - stay in map view
      // The back button will return us to map view
      
      // Open the tour detail directly
      openTourDetail(key);
    }
    
    // =====================================================================
    // MULTI-LANGUAGE SYSTEM
    // =====================================================================
    
    let translations = {};
    
    // Store the tour key we came from when filtering by company
    let previousTourKey = null;
    
    // Load translations from JSON file
    async function loadTranslations() {
      try {
        const response = await fetch("{{ url_for('static', filename='translations.json') }}");
        translations = await response.json();
        console.log('✓ Translations loaded for', Object.keys(translations).length, 'languages');
        
        // Apply saved language or default to English
        applyLanguage(currentLanguage);
      } catch (error) {
        console.error('Failed to load translations:', error);
      }
    }
    
    // Translation helper function
    function t(key) {
      if (translations && translations[currentLanguage] && translations[currentLanguage][key]) {
        return translations[currentLanguage][key];
      }
      // Fallback to English if translation not found
      if (translations && translations['en'] && translations['en'][key]) {
        return translations['en'][key];
      }
      return key; // Return key if no translation found
    }
    
    // Home page language menu
    function toggleHomeLanguageMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('home-language-menu');
      menu.classList.toggle('active');
      
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeHomeLanguageMenuOutside);
        }, 100);
      }
    }
    
    function closeHomeLanguageMenuOutside(e) {
      const menu = document.getElementById('home-language-menu');
      const selector = menu.closest('.language-selector');
      
      if (selector && !selector.contains(e.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeHomeLanguageMenuOutside);
      }
    }
    
    function selectHomeLanguage(lang) {
      switchLanguage(lang);
      document.getElementById('home-language-menu').classList.remove('active');
    }
    
    // Toggle language menu
    function toggleLanguageMenu() {
      const menu = document.getElementById('language-menu');
      menu.classList.toggle('active');
      
      // Close menu when clicking outside
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeLanguageMenuOutside);
        }, 100);
      }
    }
    
    function closeLanguageMenuOutside(e) {
      const menu = document.getElementById('language-menu');
      const selector = document.querySelector('.language-selector');
      
      if (!selector.contains(e.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeLanguageMenuOutside);
      }
    }
    
    // Toggle language menu on detail page
    function toggleDetailLanguageMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('detail-language-menu');
      const currencyMenu = document.getElementById('detail-currency-menu');
      
      // Close currency menu if open
      if (currencyMenu) currencyMenu.classList.remove('active');
      
      menu.classList.toggle('active');
      
      // Close menu when clicking outside
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeDetailLanguageMenuOutside);
        }, 100);
      }
    }
    
    function closeDetailLanguageMenuOutside(e) {
      const menu = document.getElementById('detail-language-menu');
      const btn = document.getElementById('detail-language-btn');
      
      if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeDetailLanguageMenuOutside);
      }
    }
    
    function selectLanguageFromDetail(langCode) {
      switchLanguage(langCode);
      const menu = document.getElementById('detail-language-menu');
      if (menu) menu.classList.remove('active');
    }
    
    // Switch language
    // Global header language/currency functions
    function toggleGlobalLanguageMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('global-language-menu');
      const currencyMenu = document.getElementById('global-currency-menu');
      
      // Close currency menu if open
      if (currencyMenu) currencyMenu.classList.remove('active');
      
      if (menu) {
        menu.classList.toggle('active');
      }
    }
    
    function toggleGlobalCurrencyMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('global-currency-menu');
      const languageMenu = document.getElementById('global-language-menu');
      
      // Close language menu if open
      if (languageMenu) languageMenu.classList.remove('active');
      
      if (menu) {
        menu.classList.toggle('active');
      }
    }
    
    function selectGlobalLanguage(langCode) {
      console.log('🌐 Global language changed to:', langCode);
      switchLanguage(langCode);
      const menu = document.getElementById('global-language-menu');
      if (menu) menu.classList.remove('active');
    }
    
    function selectGlobalCurrency(currencyCode) {
      console.log('💰 Global currency changed to:', currencyCode);
      changeCurrency(currencyCode);
      const menu = document.getElementById('global-currency-menu');
      if (menu) menu.classList.remove('active');
    }
    
    // Close global menus when clicking outside
    document.addEventListener('click', (e) => {
      const languageMenu = document.getElementById('global-language-menu');
      const currencyMenu = document.getElementById('global-currency-menu');
      const languageBtn = document.getElementById('global-language-btn');
      const currencyBtn = document.getElementById('global-currency-btn');
      
      if (languageMenu && !languageMenu.contains(e.target) && e.target !== languageBtn) {
        languageMenu.classList.remove('active');
      }
      
      if (currencyMenu && !currencyMenu.contains(e.target) && e.target !== currencyBtn) {
        currencyMenu.classList.remove('active');
      }
    });
    
    // Update global header language/currency display
    function updateGlobalHeaderChips() {
      const langBtn = document.getElementById('global-language-btn');
      const currBtn = document.getElementById('global-currency-btn');
      
      if (langBtn) {
        langBtn.textContent = currentLanguage.toUpperCase();
      }
      
      if (currBtn) {
        currBtn.textContent = currentCurrency;
      }
    }
    
    // Initial language selection from the first screen
    function selectInitialLanguage(langCode) {
      console.log('🌐 Initial language selected:', langCode);
      
      // Save language preference
      localStorage.setItem('preferred_language', langCode);
      
      // Update URL with language parameter
      const url = new URL(window.location.href);
      url.searchParams.set('lang', langCode);
      
      // Hide language selection screen
      const langScreen = document.getElementById('language-selection-screen');
      if (langScreen) {
        langScreen.classList.add('hidden');
      }
      
      // Remove body class to show header
      document.body.classList.remove('showing-language-selection');
      
      // Update back button visibility
      updateBackButtonVisibility();
      
      // Show video start screen (Tap to Start)
      const videoStartScreen = document.getElementById('video-start-screen');
      if (videoStartScreen) {
        videoStartScreen.style.display = 'flex';
      }
      
      // Add to navigation history
      addToNavigationHistory('video-start');
      
      // Set hash to video-start
      window.location.hash = 'video-start';
      
      // Reload page with language parameter to get translations
      setTimeout(() => {
        window.location.href = url.toString();
      }, 300);
    }
    
    function switchLanguage(langCode) {
      console.log('🌐 Switching language to:', langCode);
      console.log('🔗 Current URL before change:', window.location.href);
      console.log('🔗 Current hash before change:', window.location.hash);
      
      // Save preference
      localStorage.setItem('preferred_language', langCode);
      
      // Build URL with current page hash (for automatic restoration)
      const url = new URL(window.location.href);
      url.searchParams.set('lang', langCode);
      
      // Detect which page is active and set hash
      const tourDetailPage = document.querySelector('.tour-detail-page.active');
      const swipeOverlay = document.getElementById('swipe-results-overlay');
      const isSwipeActive = swipeOverlay && swipeOverlay.classList.contains('active');
      const homePage = document.querySelector('.home-page.active');
      const videoPage = document.querySelector('.video-question-page.active');
      
      console.log('📊 Page detection:', {
        tourDetailPage: !!tourDetailPage,
        isSwipeActive,
        homePage: !!homePage,
        videoPage: !!videoPage
      });
      
      if (isSwipeActive && window.currentSwipeIndex !== undefined) {
        // On swipe results - use hash #swipe/INDEX
        url.hash = `swipe/${window.currentSwipeIndex}`;
        console.log('📍 Setting hash for swipe:', url.hash);
      } else if (tourDetailPage && tourDetailPage.classList.contains('active')) {
        // On tour detail page - use hash #tour/KEY
        const tourKey = tourDetailPage.getAttribute('data-current-tour-key');
        console.log('📍 Tour key found:', tourKey);
        if (tourKey) {
          url.hash = `tour/${tourKey}`;
          console.log('📍 Setting hash for tour detail:', url.hash);
        }
      } else if (homePage && homePage.classList.contains('active')) {
        // On home page
        url.hash = 'home';
        console.log('📍 Setting hash for home page');
      } else if (videoPage) {
        // On video page
        url.hash = 'video-start';
        console.log('📍 Setting hash for video page');
      }
      
      // Reload page with language parameter - hash will automatically restore page
      const finalUrl = url.toString();
      console.log('🔄 Reloading with URL:', finalUrl);
      window.location.href = finalUrl;
    }
    
    // Apply language to UI
    function applyLanguage(langCode) {
      const lang = translations[langCode];
      if (!lang) {
        console.error('Language not found:', langCode);
        return;
      }
      
      // Update language selector button
      document.getElementById('current-language-flag').textContent = lang.flag;
      document.getElementById('current-language-code').textContent = lang.code.toUpperCase();
      
      // Update header chip (modern home page)
      if (typeof updateHeaderChips === 'function') {
        updateHeaderChips();
      }
      
      // Update mobile menu language display
      const mobileLangFlag = document.getElementById('mobile-menu-lang-flag');
      const mobileLangText = document.getElementById('mobile-menu-lang-text');
      if (mobileLangFlag) mobileLangFlag.textContent = lang.flag;
      if (mobileLangText) mobileLangText.textContent = lang.code.toUpperCase();
      
      // Update filter panel elements
      const heading = document.querySelector('#filter-panel h1');
      if (heading) {
        // Keep the palm tree emoji if it exists, just replace the text
        heading.innerHTML = '🏝️ ' + lang.find_perfect_tour;
      }
      
      // Update Start Over button
      const startOverBtn = document.querySelector('.clear-filters-btn span:last-child');
      if (startOverBtn) startOverBtn.textContent = lang.start_over;
      
      // Update Map View / Grid View button
      const viewToggleText = document.getElementById('view-toggle-text');
      if (viewToggleText) {
        viewToggleText.textContent = isMapView ? lang.grid_view : lang.map_view;
      }
      
      // Update navigation buttons
      const backBtn = document.getElementById('back-btn');
      if (backBtn) backBtn.textContent = '← ' + lang.back;
      
      // Update content area header
      const tourGridHeader = document.getElementById('tour-grid-header');
      if (tourGridHeader && tourGridHeader.textContent === 'Available Tours') {
        tourGridHeader.textContent = lang.available_tours;
      }
      
      // Update results info if it's the default text
      const resultsInfo = document.getElementById('results-info');
      if (resultsInfo && resultsInfo.textContent.includes('Tap an option')) {
        resultsInfo.textContent = lang.tap_to_filter;
      }
      
      // Update filter questions and options
      // Question 0: Duration
      updateFilterQuestion(0, lang.duration_question, {
        'half_day': `${lang.half_day}<br><span style="font-size:0.9em;opacity:0.9;">${lang.half_day_hours}</span>`,
        'full_day': `${lang.full_day}<br><span style="font-size:0.9em;opacity:0.9;">${lang.full_day_hours}</span>`,
        'multi_day': `${lang.multi_day}<br><span style="font-size:0.9em;opacity:0.9;">${lang.multi_day_adventure}</span>`,
        '': lang.no_preference
      });
      
      // Question 1: Budget slider - skip (no options to translate, uses slider)
      
      // Question 2: Activity
      updateFilterQuestion(2, lang.activity_question, {
        'whitehaven_beach': lang.activity_whitehaven,
        'great_barrier_reef': lang.activity_gbr,
        'scenic_adventure': lang.activity_scenic,
        'island_tours': lang.activity_island,
        '': lang.activity_other
      });
      
      // Question 3: Family
      updateFilterQuestion(3, lang.family_question, {
        'true': lang.family_with_kids,
        'false': lang.adults_only,
        '': lang.no_preference
      });
      
      // Question 4: Inclusions
      updateFilterQuestion(4, lang.extras_question, {
        'meals': lang.extras_meals,
        'equipment': lang.extras_equipment,
        '': lang.no_preference
      });
      
      // Update all elements with data-translate attribute
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (lang[key]) {
          el.textContent = lang[key];
        }
      });
      
      // Update progress text with current question
      const progressEl = document.getElementById('filter-progress');
      if (progressEl && currentQuestion) {
        const progressText = lang.question_of.replace('{current}', currentQuestion).replace('{total}', totalQuestions);
        progressEl.textContent = progressText;
      }
      
      // Update filter summary to use translations
      updateFilterSummary();
      
      console.log('✓ Language applied:', lang.name);
    }
    
    // Helper function to update filter question and options
    function updateFilterQuestion(questionIndex, questionText, optionTexts) {
      const questions = document.querySelectorAll('.filter-question');
      if (questions[questionIndex]) {
        const questionElement = questions[questionIndex].querySelector('.question-text');
        if (questionElement) {
          questionElement.textContent = questionText;
        }
        
        const options = questions[questionIndex].querySelectorAll('.filter-option');
        options.forEach(option => {
          const value = option.getAttribute('data-value');
          if (optionTexts[value] !== undefined) {
            option.innerHTML = optionTexts[value];
          }
        });
      }
    }
    
    // Initialize language selector
    document.addEventListener('DOMContentLoaded', () => {
      // Load translations
      loadTranslations();
      
      // Add click handlers to language options
      document.querySelectorAll('.language-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const langCode = option.getAttribute('data-lang');
          switchLanguage(langCode);
        });
      });
      
      console.log('✓ Multi-language system initialized');
    });
    
    // =====================================================================
    // INACTIVITY TIMER - Auto reset after period of inactivity (for home page)
    // =====================================================================
    
    const INACTIVITY_TIMEOUT = 120000; // 2 minutes in milliseconds
    
    function resetInactivityTimerHomePage() {
      // Clear existing timer
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
      }
      
      // Set new timer
      inactivityTimer = setTimeout(() => {
        console.log('⏰ Inactivity detected - resetting kiosk...');
        
        // Clear all saved state to prevent interference between users
        localStorage.removeItem('page_state_before_language_change');
        localStorage.removeItem('preferred_language');
        localStorage.removeItem('preferred_currency');
        console.log('🧹 Cleared all saved user data');
        
        // Reset to language selection screen (no language parameter, no hash)
        const url = new URL(window.location.origin + window.location.pathname);
        window.location.href = url.toString();
      }, INACTIVITY_TIMEOUT);
    }
    
    // Track user activity
    function initInactivityMonitor() {
      const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
      
      events.forEach(event => {
        document.addEventListener(event, resetInactivityTimerHomePage, true);
      });
      
      // Start the timer
      resetInactivityTimerHomePage();
      console.log('✓ Inactivity monitor initialized (2 minute timeout)');
    }
    
    // =====================================================================
    // MULTI-CURRENCY SYSTEM
    // =====================================================================
    
    let exchangeRates = {
      AUD: 1.0,
      USD: 0.65,
      EUR: 0.60,
      GBP: 0.51,
      CNY: 4.68,
      JPY: 96.50,
      KRW: 876.00,
      INR: 54.20
    };
    
    const currencySymbols = {
      AUD: 'A$',
      USD: '$',
      EUR: '€',
      GBP: '£',
      CNY: '¥',
      JPY: '¥',
      KRW: '₩',
      INR: '₹'
    };
    
    // Language to default currency mapping
    const languageCurrencyMap = {
      'en': 'AUD',
      'zh': 'CNY',
      'ja': 'JPY',
      'ko': 'KRW',
      'de': 'EUR',
      'fr': 'EUR',
      'es': 'EUR',
      'hi': 'INR'
    };
    
    function initCurrency() {
      // Set default currency based on language
      const savedCurrency = localStorage.getItem('preferred_currency');
      if (savedCurrency && exchangeRates[savedCurrency]) {
        currentCurrency = savedCurrency;
      } else {
        currentCurrency = languageCurrencyMap[currentLanguage] || 'AUD';
      }
      
      updateCurrencyDisplay();
      console.log('✓ Currency system initialized:', currentCurrency);
    }
    
    function convertPrice(audPrice, targetCurrency = currentCurrency) {
      if (!audPrice || audPrice === 'N/A' || audPrice === 'POA') return audPrice;
      
      // Extract numeric value from price string
      const numericValue = parseFloat(audPrice.replace(/[^0-9.]/g, ''));
      if (isNaN(numericValue)) return audPrice;
      
      // Convert to target currency
      const converted = numericValue * exchangeRates[targetCurrency];
      const symbol = currencySymbols[targetCurrency];
      
      // Format based on currency
      if (targetCurrency === 'JPY' || targetCurrency === 'KRW') {
        return `${symbol}${Math.round(converted).toLocaleString()}`;
      } else {
        return `${symbol}${converted.toFixed(0)}`;
      }
    }
    
    function switchCurrency(newCurrency) {
      currentCurrency = newCurrency;
      localStorage.setItem('preferred_currency', newCurrency);
      updateCurrencyDisplay();
      
      // Update all visible prices
      document.querySelectorAll('[data-original-price]').forEach(el => {
        const originalPrice = el.getAttribute('data-original-price');
        const convertedPrice = convertPrice(originalPrice);
        
        // Check if this is a pricing tier option (has data-tier attribute)
        if (el.classList.contains('pricing-tier-option')) {
          const originalTier = el.getAttribute('data-tier');
          // Replace the price in the tier text
          const updatedTier = originalTier.replace(/A\$\d+/, convertedPrice);
          el.textContent = updatedTier;
        } else {
          // For simple price elements, just replace the text
          el.textContent = convertedPrice;
        }
      });
      
      console.log('✓ Switched to', newCurrency);
    }
    
    function updateCurrencyDisplay() {
      const currencyBtn = document.getElementById('currency-btn-text');
      if (currencyBtn) {
        currencyBtn.textContent = currentCurrency;
      }
    }
    
    // Home page currency menu
    function toggleHomeCurrencyMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('home-currency-menu');
      menu.classList.toggle('active');
      
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeHomeCurrencyMenuOutside);
        }, 100);
      }
    }
    
    function closeHomeCurrencyMenuOutside(e) {
      const menu = document.getElementById('home-currency-menu');
      const selector = menu.closest('.currency-selector');
      
      if (selector && !selector.contains(e.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeHomeCurrencyMenuOutside);
      }
    }
    
    function selectHomeCurrency(curr) {
      switchCurrency(curr);
      document.getElementById('home-currency-menu').classList.remove('active');
      
      // Update home currency button
      const btn = document.getElementById('header-currency-btn');
      if (btn) btn.textContent = curr;
    }
    
    function toggleCurrencyMenu() {
      const menu = document.getElementById('currency-menu');
      menu.classList.toggle('active');
      
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeCurrencyMenuOutside);
        }, 100);
      }
    }
    
    function closeCurrencyMenuOutside(e) {
      const menu = document.getElementById('currency-menu');
      const selector = document.querySelector('.currency-selector');
      
      if (selector && !selector.contains(e.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeCurrencyMenuOutside);
      }
    }
    
    // Toggle currency menu on detail page
    function toggleDetailCurrencyMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('detail-currency-menu');
      const languageMenu = document.getElementById('detail-language-menu');
      
      // Close language menu if open
      if (languageMenu) languageMenu.classList.remove('active');
      
      menu.classList.toggle('active');
      
      // Close menu when clicking outside
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeDetailCurrencyMenuOutside);
        }, 100);
      }
    }
    
    function closeDetailCurrencyMenuOutside(e) {
      const menu = document.getElementById('detail-currency-menu');
      const btn = document.getElementById('detail-currency-btn');
      
      if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeDetailCurrencyMenuOutside);
      }
    }
    
    function selectCurrencyFromDetail(currency) {
      switchCurrency(currency);
      const menu = document.getElementById('detail-currency-menu');
      if (menu) menu.classList.remove('active');
      
      // Update detail currency button
      const btn = document.getElementById('detail-currency-btn');
      if (btn) btn.textContent = currency;
    }
    
    // =====================================================================
    // WEATHER WIDGET
    // =====================================================================
    
    let weatherData = null;
    const AIRLIE_BEACH_LAT = -20.2675;
    const AIRLIE_BEACH_LON = 148.7141;
    
    async function loadWeatherData() {
      try {
        // Using Open-Meteo API (free, no API key required)
        const currentWeatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${AIRLIE_BEACH_LAT}&longitude=${AIRLIE_BEACH_LON}&current=temperature_2m,weathercode,windspeed_10m&timezone=Australia/Brisbane`;
        const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${AIRLIE_BEACH_LAT}&longitude=${AIRLIE_BEACH_LON}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Australia/Brisbane&forecast_days=7`;
        
        const [currentResponse, forecastResponse] = await Promise.all([
          fetch(currentWeatherUrl),
          fetch(forecastUrl)
        ]);
        
        const currentData = await currentResponse.json();
        const forecastData = await forecastResponse.json();
        
        weatherData = {
          current: {
            temp: Math.round(currentData.current.temperature_2m),
            weatherCode: currentData.current.weathercode,
            windSpeed: Math.round(currentData.current.windspeed_10m)
          },
          forecast: forecastData.daily.time.map((date, index) => ({
            date: date,
            tempMax: Math.round(forecastData.daily.temperature_2m_max[index]),
            tempMin: Math.round(forecastData.daily.temperature_2m_min[index]),
            weatherCode: forecastData.daily.weathercode[index],
            precipProb: forecastData.daily.precipitation_probability_max[index]
          }))
        };
        
        updateWeatherDisplay();
        console.log('✓ Weather data loaded');
      } catch (error) {
        console.error('Failed to load weather:', error);
        // Hide weather widget on error
        const widget = document.getElementById('weather-widget');
        if (widget) widget.style.display = 'none';
      }
    }
    
    function getWeatherEmoji(weatherCode) {
      // WMO Weather codes
      if (weatherCode === 0) return '☀️';
      if (weatherCode <= 3) return '⛅';
      if (weatherCode <= 49) return '🌫️';
      if (weatherCode <= 59) return '🌧️';
      if (weatherCode <= 69) return '🌧️';
      if (weatherCode <= 79) return '❄️';
      if (weatherCode <= 84) return '🌧️';
      if (weatherCode <= 99) return '⛈️';
      return '🌤️';
    }
    
    function getWeatherDescription(weatherCode) {
      if (weatherCode === 0) return 'Clear';
      if (weatherCode <= 3) return 'Partly Cloudy';
      if (weatherCode <= 49) return 'Foggy';
      if (weatherCode <= 59) return 'Light Rain';
      if (weatherCode <= 69) return 'Rain';
      if (weatherCode <= 79) return 'Snow';
      if (weatherCode <= 84) return 'Showers';
      if (weatherCode <= 99) return 'Thunderstorm';
      return 'Cloudy';
    }
    
    function getDayName(dateStr) {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const date = new Date(dateStr);
      return days[date.getDay()];
    }
    
    function getBestTimeToVisit() {
      const month = new Date().getMonth(); // 0-11
      
      // Airlie Beach / Whitsundays best times
      if (month >= 3 && month <= 10) { // Apr-Nov
        return {
          status: 'excellent',
          icon: '✨',
          message: 'Perfect time to visit! Dry season with calm waters and great visibility.'
        };
      } else if (month === 2 || month === 11) { // Mar or Dec
        return {
          status: 'good',
          icon: '🌤️',
          message: 'Good time to visit. Pleasant weather with occasional showers.'
        };
      } else { // Jan-Feb (wet season)
        return {
          status: 'caution',
          icon: '🌧️',
          message: 'Wet season. Check for marine stingers and possible rain.'
        };
      }
    }
    
    function updateWeatherDisplay() {
      if (!weatherData) return;
      
      const widget = document.getElementById('weather-widget');
      if (!widget) return;
      
      const current = weatherData.current;
      const forecast = weatherData.forecast;
      const bestTime = getBestTimeToVisit();
      
      // Current weather
      document.getElementById('current-temp').textContent = `${current.temp}°C`;
      document.getElementById('current-weather-icon').textContent = getWeatherEmoji(current.weatherCode);
      document.getElementById('current-weather-desc').textContent = getWeatherDescription(current.weatherCode);
      document.getElementById('current-wind').textContent = `Wind: ${current.windSpeed} km/h`;
      
      // 7-day forecast
      const forecastContainer = document.getElementById('forecast-days');
      forecastContainer.innerHTML = forecast.slice(0, 7).map((day, index) => {
        const dayName = index === 0 ? 'Today' : getDayName(day.date);
        return `
          <div class="forecast-day">
            <div class="forecast-day-name">${dayName}</div>
            <div class="forecast-icon">${getWeatherEmoji(day.weatherCode)}</div>
            <div class="forecast-temps">
              <span class="temp-max">${day.tempMax}°</span>
              <span class="temp-min">${day.tempMin}°</span>
            </div>
            ${day.precipProb > 30 ? `<div class="forecast-rain">${day.precipProb}%</div>` : ''}
          </div>
        `;
      }).join('');
      
      // Best time to visit
      document.getElementById('best-time-icon').textContent = bestTime.icon;
      document.getElementById('best-time-message').textContent = bestTime.message;
      const bestTimeSection = document.getElementById('best-time-section');
      bestTimeSection.className = `best-time-section ${bestTime.status}`;
      
      widget.style.display = 'block';
    }
    
    function toggleWeatherWidget() {
      const widget = document.getElementById('weather-widget');
      widget.classList.toggle('collapsed');
    }
    
    // =====================================================================
    // AI CHAT ASSISTANT
    // =====================================================================
    
    let chatHistory = [];
    let isChatting = false;
    let hasSpokenWelcome = false; // Track if we've spoken the welcome message
    
    function toggleChat() {
      console.log('💬 toggleChat() called');
      const chatInterface = document.getElementById('chat-interface');
      const chatButton = document.getElementById('chat-button');
      
      console.log('   Chat interface:', chatInterface);
      console.log('   Chat button:', chatButton);
      console.log('   Currently active?', chatInterface?.classList.contains('active'));
      
      chatInterface.classList.toggle('active');
      
      if (chatInterface.classList.contains('active')) {
        console.log('   Opening chat...');
        // Hide entire button with shrink animation
        chatButton.classList.remove('show');
        chatButton.classList.add('hidden');
        
        // Open chat ENLARGED immediately
        chatInterface.classList.add('enlarged');
        
        // Force display to flex
        chatInterface.style.display = 'flex';
        
        console.log('   Chat display:', window.getComputedStyle(chatInterface).display);
        console.log('   Chat z-index:', window.getComputedStyle(chatInterface).zIndex);
        console.log('   Chat visibility:', window.getComputedStyle(chatInterface).visibility);
        
        // DON'T auto-focus input to prevent keyboard popup on mobile
        // const input = document.getElementById('chat-input');
        // input.focus();
        
        // Speak welcome message on first open - only if chat is actually visible
        if (!hasSpokenWelcome && window.voiceChat && window.voiceChat.autoSpeak) {
          hasSpokenWelcome = true;
          
          // Wait a moment for chat to open, then check if visible before speaking
          setTimeout(() => {
            const computedStyle = window.getComputedStyle(chatInterface);
            const isVisible = computedStyle.display !== 'none' && 
                             computedStyle.visibility !== 'hidden' && 
                             computedStyle.opacity !== '0';
            
            if (isVisible && chatInterface.classList.contains('active')) {
              const welcomeText = "Hi! I'm your AI tour assistant. I'll help you find the perfect Whitsundays tour! Let's start simple - what would you like to experience? Great Barrier Reef, Whitehaven Beach, Sailing and Cruises, Diving and Snorkeling, or something else?";
              window.voiceChat.speak(welcomeText);
            }
          }, 500);
        }
      } else {
        console.log('   Closing chat...');
        
        // Stop any playing voice
        if (window.voiceChat) {
          window.voiceChat.stopSpeaking();
        }
        
        // Hide chat interface
        chatInterface.style.display = 'none';
        
        // Show button with grow animation
        chatButton.classList.remove('hidden');
        chatButton.classList.add('show');
        
        // Reset size when closing
        chatInterface.classList.remove('enlarged');
        
        console.log('   Chat closed');
      }
    }
    
    function closeChat() {
      console.log('❌ closeChat() called - forcing close');
      const chatInterface = document.getElementById('chat-interface');
      const chatButton = document.getElementById('chat-button');
      
      // Stop any playing voice
      if (window.voiceChat) {
        window.voiceChat.stopSpeaking();
      }
      
      // Force remove all classes and hide
      chatInterface.classList.remove('active');
      chatInterface.classList.remove('enlarged');
      chatInterface.style.display = 'none';
      
      // Show button with grow animation
      chatButton.classList.remove('hidden');
      chatButton.classList.add('show');
      
      console.log('   Chat force closed');
    }
    
    function restartChat() {
      console.log('🔄 Restarting chat...');
      
      // Stop any ongoing text-to-speech immediately
      if (window.voiceChat) {
        window.voiceChat.stopSpeaking();
      }
      
      // Clear conversation history
      chatHistory = [];
      
      // Reset chat state flags
      isChatting = false;
      
      // Get the messages container
      const messagesContainer = document.getElementById('chat-messages');
      
      // Clear all messages
      messagesContainer.innerHTML = '';
      
      // Re-add only the initial starter messages (NOT spoken again)
      const systemMessage = document.createElement('div');
      systemMessage.className = 'chat-message system';
      systemMessage.textContent = '👋 Hi! I\'m your AI tour assistant. I\'ll help you find the perfect Whitsundays tour!';
      messagesContainer.appendChild(systemMessage);
      
      const assistantMessage = document.createElement('div');
      assistantMessage.className = 'chat-message assistant';
      assistantMessage.innerHTML = `Let's start simple - what would you like to experience? 🌊<br><br>1. Great Barrier Reef<br>2. Whitehaven Beach<br>3. Sailing & Cruises<br>4. Diving & Snorkeling<br>5. Something else?`;
      messagesContainer.appendChild(assistantMessage);
      
      // Re-enable input
      const input = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send');
      input.disabled = false;
      sendBtn.disabled = false;
      input.value = '';
      input.focus();
      
      console.log('✅ Chat restarted successfully');
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message || isChatting) return;
      
      // Enlarge chat interface
      const chatInterface = document.getElementById('chat-interface');
      chatInterface.classList.add('enlarged');
      
      // Clear input
      input.value = '';
      
      // Add user message to chat
      addChatMessage(message, 'user');
      
      // Add to history
      chatHistory.push({role: 'user', content: message});
      
      // Show loading
      const messagesContainer = document.getElementById('chat-messages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'chat-message assistant';
      loadingDiv.innerHTML = '<div class="chat-loading"><div class="chat-loading-dot"></div><div class="chat-loading-dot"></div><div class="chat-loading-dot"></div></div>';
      messagesContainer.appendChild(loadingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      isChatting = true;
      document.getElementById('chat-send').disabled = true;
      
      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            language: currentLanguage,
            history: chatHistory.slice(-6)  // Last 3 exchanges
          })
        });
        
        const data = await response.json();
        
        // Debug logging
        console.log('==================== AI RESPONSE ====================');
        console.log('Success:', data.success);
        console.log('Mode:', data.used_filters ? '🎯 FILTER-BASED SEARCH' : '🤖 AI MANUAL PICKS');
        if (data.used_filters && data.filter_count) {
          console.log('Total matches:', data.filter_count);
        }
        console.log('Message:', data.message);
        console.log('Recommended tours:', data.recommended_tours);
        console.log('Tour count:', data.recommended_tours ? data.recommended_tours.length : 0);
        console.log('====================================================');
        
        if (data.success) {
          // Remove loading animation
          messagesContainer.removeChild(loadingDiv);
          
          // Add AI message and start speech at the same time
          addChatMessage(data.message, 'assistant');
          
          // Add quick reply buttons if provided
          if (data.quick_reply_options && data.quick_reply_options.length > 0) {
            console.log('📋 Adding quick reply buttons:', data.quick_reply_options);
            addQuickReplyButtons(data.quick_reply_options);
          }
          
          // Display recommended tours in main grid if any
          console.log('🔍 Checking for tours to display...');
          console.log('   data.recommended_tours:', data.recommended_tours);
          console.log('   Is array?', Array.isArray(data.recommended_tours));
          console.log('   Length:', data.recommended_tours ? data.recommended_tours.length : 'N/A');
          
          if (data.recommended_tours && data.recommended_tours.length > 0) {
            console.log('✅ Displaying tours in main grid...');
            console.log('Tours to display:', data.recommended_tours);
            
            try {
              displayAIRecommendedTours(data.recommended_tours, message, data);
              console.log('✅ displayAIRecommendedTours() completed successfully');
            } catch (error) {
              console.error('❌ Error in displayAIRecommendedTours():', error);
              console.error('Error stack:', error.stack);
            }
            
            // Also add compact tour cards in chat
            try {
              addTourCards(data.recommended_tours);
              console.log('✅ addTourCards() completed successfully');
            } catch (error) {
              console.error('❌ Error in addTourCards():', error);
            }
            
            // Add "Send to Phone" button
            try {
              addSendToPhoneButton(data.recommended_tours, message, data);
              console.log('✅ Send to Phone button added');
            } catch (error) {
              console.error('❌ Error adding Send to Phone button:', error);
            }
          } else {
            console.log('⚠️ No tours to display - AI did not include tour keys');
          }
          
          // Add to history
          chatHistory.push({role: 'assistant', content: data.message});
        } else {
          addChatMessage("Sorry, I'm having trouble right now. Please try again or use the filter questions above!", 'assistant');
        }
      } catch (error) {
        console.error('Chat error:', error);
        messagesContainer.removeChild(loadingDiv);
        addChatMessage("Oops! Something went wrong. Please try again.", 'assistant');
      } finally {
        isChatting = false;
        document.getElementById('chat-send').disabled = false;
        input.focus();
      }
    }
    
    function displayAIRecommendedTours(tours, userQuery, responseData = null) {
      console.log('🎯 displayAIRecommendedTours() called with', tours.length, 'tours');
      console.log('   User query:', userQuery);
      console.log('   Response data:', responseData);
      
      // Store response data for results info
      window.lastAIResponse = responseData;
      
      // Check which page we're on
      const homePage = document.querySelector('.page.home-page');
      console.log('   homePage element:', homePage);
      console.log('   homePage classes:', homePage ? homePage.className : 'NOT FOUND');
      
      const isHomePage = homePage && homePage.classList.contains('active');
      
      console.log('   Is home page ACTIVE?', isHomePage);
      
      if (isHomePage) {
        // NEW HOME PAGE - Check if in grid or map view
        const homeMapSection = document.getElementById('home-map-view-section');
        console.log('   homeMapSection:', homeMapSection);
        console.log('   homeMapSection display:', homeMapSection ? homeMapSection.style.display : 'NOT FOUND');
        
        const isMapView = homeMapSection && homeMapSection.style.display !== 'none' && homeMapSection.style.display !== '';
        
        console.log('   Is map view?', isMapView);
        
        if (isMapView) {
          // MAP VIEW - Update map and carousel
          console.log('🗺️ Displaying recommendations in MAP VIEW');
          displayAIRecommendationsInMapView(tours, userQuery, responseData);
        } else {
          // GRID VIEW - Update featured tours
          console.log('📋 Displaying recommendations in GRID VIEW');
          displayAIRecommendationsInGridView(tours, userQuery, responseData);
        }
        
        console.log('✅ AI recommendations handled on home page');
        return; // Exit early, we handled it
      }
      
      // OLD LAYOUT - Use original logic
      console.log('📊 Using OLD LAYOUT logic');
      
      // Hide filter panel and show results
      const filterPanel = document.getElementById('filter-panel');
      const toursGrid = document.getElementById('tour-placeholder-row');  // FIXED: correct ID
      
      console.log('Filter panel:', filterPanel);
      console.log('Tours grid:', toursGrid);
      
      if (filterPanel) filterPanel.style.display = 'none';
      if (toursGrid) toursGrid.style.display = 'grid';
      console.log('✓ Panel hidden, grid shown');
      
      // Update the main header
      const tourGridHeader = document.getElementById('tour-grid-header');
      console.log('Tour grid header:', tourGridHeader);
      
      if (tourGridHeader) {
        tourGridHeader.innerHTML = '🤖 Recommended by our Tour-Bot based on your preferences';
        tourGridHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        tourGridHeader.style.color = 'white';
        tourGridHeader.style.padding = '30px 40px';
        console.log('✓ Header updated');
      }
      
      // Update results info
      const resultsInfo = document.getElementById('results-info');
      console.log('Results info:', resultsInfo);
      
      if (resultsInfo) {
        let infoText = '';
        
        // Add indication if this was a filter-based search showing all results
        if (window.lastAIResponse && window.lastAIResponse.used_filters && window.lastAIResponse.filter_count) {
          infoText = `<span style="color:#667eea;font-weight:600;">Found ${window.lastAIResponse.filter_count} tours matching your preferences</span>`;
        }
        
        resultsInfo.innerHTML = infoText + ` &nbsp;&nbsp; <button onclick="clearAIResults()" style="
          background: rgba(102, 126, 234, 0.2);
          border: 2px solid #667eea;
          color: #667eea;
          padding: 6px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.2s;
          font-size: 0.95em;
        " onmouseover="this.style.background='rgba(102, 126, 234, 0.3)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'">
          Clear & Start Over
        </button>`;
        resultsInfo.style.display = 'block';
        console.log('✓ Results info updated');
      }
      
      // Display tours in grid
      loadedTours = [...tours];
      toursGrid.innerHTML = ''; // Clear existing tours
      console.log('✓ Grid cleared, adding', tours.length, 'tour cards...');
      
      tours.forEach((tour, index) => {
        console.log(`Creating card ${index + 1}:`, tour.name);
        const card = createTourCard(tour);
        toursGrid.appendChild(card);
      });
      
      console.log('✓ All tour cards added to grid');
      
      // CRITICAL: Hide "Load More" button and stop auto-loading more tours
      const loadMoreBtn = document.getElementById('load-more-btn');
      if (loadMoreBtn) {
        loadMoreBtn.style.display = 'none';
        console.log('✓ Load More button hidden');
      }
      
      // Stop the IntersectionObserver from auto-loading more tours
      if (window.tourObserver) {
        window.tourObserver.disconnect();
        console.log('✓ Auto-load observer stopped');
      }
      
      // Scroll to results
      setTimeout(() => {
        console.log('✓ Scrolling to header...');
        tourGridHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      console.log('✅ displayAIRecommendedTours() complete!');
    }
    
    // Display AI recommendations in HOME PAGE GRID VIEW
    function displayAIRecommendationsInGridView(tours, userQuery, responseData) {
      console.log('📋 ============ GRID VIEW AI RECOMMENDATIONS ============');
      console.log('   Tours to display:', tours.length);
      console.log('   User query:', userQuery);
      console.log('   Tours data:', tours);
      
      // STEP 1: Hide the questionnaire
      const questionCards = document.querySelectorAll('.filter-question-card');
      questionCards.forEach(card => {
        card.style.display = 'none';
      });
      console.log('   ✓ Hid', questionCards.length, 'question cards');
      
      // STEP 2: Hide the filter summary if it was showing
      const filterSummary = document.getElementById('filter-summary-bar');
      if (filterSummary) {
        filterSummary.style.display = 'none';
      }
      
      // STEP 3: Update the title and subtitle
      const title = document.getElementById('home-tours-title');
      const subtitle = document.getElementById('home-tours-subtitle');
      
      console.log('   Title element:', title);
      console.log('   Subtitle element:', subtitle);
      
      if (title) {
        title.textContent = '🤖 Tours Handpicked by Our AI Assistant';
        title.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        title.style.webkitBackgroundClip = 'text';
        title.style.webkitTextFillColor = 'transparent';
        title.style.backgroundClip = 'text';
        console.log('   ✓ Title updated');
      }
      
      if (subtitle) {
        subtitle.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <span style="font-style: italic; color: #667eea;">${tours.length} tour${tours.length !== 1 ? 's' : ''} matching: "${userQuery}"</span>
            <button onclick="clearAIResults()" style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border: none;
              color: white;
              padding: 8px 20px;
              border-radius: 8px;
              cursor: pointer;
              font-weight: 600;
              box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
              transition: transform 0.2s;
            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              ← Back to Questionnaire
            </button>
          </div>
        `;
        console.log('   ✓ Subtitle updated with back button');
      }
      
      // STEP 4: Make sure the featured grid section is visible
      const featuredSection = document.getElementById('featured-tours-section');
      if (featuredSection) {
        featuredSection.style.display = 'block';
        console.log('   ✓ Featured section visible');
      }
      
      // STEP 5: Display tours in the featured tours grid
      console.log('   Calling displayFeaturedTours()...');
      displayFeaturedTours(tours, false); // false = replace
      console.log('   ✓ displayFeaturedTours() called');
      
      // STEP 6: Update mapTourData so if user switches to map view, they see these tours
      mapTourData = tours;
      
      // STEP 7: Scroll to the tours
      setTimeout(() => {
        if (title) {
          title.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
      
      console.log('✅ Grid view recommendations displayed');
    }
    
    // Display AI recommendations in HOME PAGE MAP VIEW
    function displayAIRecommendationsInMapView(tours, userQuery, responseData) {
      console.log('🗺️ displayAIRecommendationsInMapView:', tours.length, 'tours');
      
      // Update mapTourData with recommended tours
      mapTourData = tours;
      
      // Update map pins to show only recommended tours
      updateHomeMapPins();
      
      // Update carousel with recommended tours
      populateHomeCarousel(null);
      
      // Update the map title
      const listTitle = document.querySelector('.list-title');
      if (listTitle) {
        listTitle.textContent = '🤖 AI Recommended Locations';
        listTitle.style.textShadow = '3px 3px 15px rgba(102, 126, 234, 0.8)';
      }
      
      // Update carousel header
      const carouselHeader = document.getElementById('home-carousel-header-text');
      if (carouselHeader) {
        carouselHeader.innerHTML = `🤖 AI Recommended: "${userQuery}" <button onclick="clearAIResults()" style="
          background: rgba(102, 126, 234, 0.2);
          border: 2px solid #667eea;
          color: white;
          padding: 4px 12px;
          margin-left: 10px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 0.9em;
        ">Clear</button>`;
      }
      
      // Refresh map to ensure it displays correctly
      if (homeMap) {
        setTimeout(() => {
          homeMap.invalidateSize();
        }, 100);
      }
      
      console.log('✅ Map view recommendations displayed');
    }
    
    function clearAIResults() {
      console.log('🔄 Clearing AI results...');
      
      // Check which page we're on
      const homePage = document.querySelector('.page.home-page');
      const isHomePage = homePage && homePage.classList.contains('active');
      
      if (isHomePage) {
        // NEW HOME PAGE - Reset to normal view
        console.log('   Clearing on HOME PAGE');
        
        // Check if in map or grid view
        const homeMapSection = document.getElementById('home-map-view-section');
        const isMapView = homeMapSection && homeMapSection.style.display !== 'none';
        
        if (isMapView) {
          // MAP VIEW - Reload all tours for map
          console.log('   Clearing MAP VIEW');
          
          const listTitle = document.querySelector('.list-title');
          if (listTitle) {
            listTitle.textContent = 'Tour Locations';
            listTitle.style.textShadow = '3px 3px 15px rgba(0, 0, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.3)';
          }
          
          // Reload all tours for map
          fetch(`/filter-tours?for_map=true&lang=${currentLanguage}`)
            .then(response => response.json())
            .then(data => {
              mapTourData = data.tours;
              updateHomeMapPins();
              populateHomeCarousel(null);
              console.log('✅ Map view cleared, showing all tours');
            });
        } else {
          // GRID VIEW - Reload all tours for grid
          console.log('   Clearing GRID VIEW');
          
          const title = document.getElementById('home-tours-title');
          const subtitle = document.getElementById('home-tours-subtitle');
          
          if (title) {
            title.textContent = 'Tap Any Card For Booking and More Info';
            title.style.background = '';
            title.style.webkitBackgroundClip = '';
            title.style.webkitTextFillColor = '';
          }
          
          if (subtitle) {
            subtitle.textContent = 'Showing all available tours';
            subtitle.style.fontStyle = '';
            subtitle.style.color = '';
          }
          
          // Hide filter summary
          const filterSummary = document.getElementById('filter-summary-bar');
          if (filterSummary) {
            filterSummary.style.display = 'none';
          }
          
          // Reload all tours
          loadInitialFeaturedTours();
        }
        
        // Close chat
        const chatInterface = document.getElementById('chat-interface');
        if (chatInterface) {
          chatInterface.classList.remove('active', 'enlarged');
        }
        
        // Clear chat history
        chatHistory = [];
        
        console.log('✅ AI results cleared on home page');
        return;
      }
      
      // OLD LAYOUT - Use original logic
      console.log('   Clearing on OLD LAYOUT');
      
      // Reset the main header
      const tourGridHeader = document.getElementById('tour-grid-header');
      if (tourGridHeader) {
        tourGridHeader.textContent = translations[currentLanguage]?.available_tours || 'Available Tours';
        tourGridHeader.style.background = '';
        tourGridHeader.style.color = '';
        tourGridHeader.style.padding = '';
      }
      
      // Reset results info
      const resultsInfo = document.getElementById('results-info');
      if (resultsInfo) {
        resultsInfo.textContent = translations[currentLanguage]?.tap_to_filter || 'Tap an option above to start filtering';
        resultsInfo.style.display = 'block';
      }
      
      // Show filter panel again
      const filterPanel = document.getElementById('filter-panel');
      if (filterPanel) {
        filterPanel.style.display = 'block';
      }
      
      // Reset to all tours
      loadedTours = [];
      
      // Re-enable the "Load More" button and observer
      const loadMoreBtn = document.getElementById('load-more-btn');
      if (loadMoreBtn) {
        loadMoreBtn.style.display = 'block';
      }
      
      // Restart the observer
      if (window.tourObserver && loadMoreBtn) {
        window.tourObserver.observe(loadMoreBtn);
      }
      
      // Close chat
      const chatInterface = document.getElementById('chat-interface');
      if (chatInterface) {
      chatInterface.classList.remove('active', 'enlarged');
      }
      
      // Clear chat history
      chatHistory = [];
      
      // Reload the page to restore initial state with all tours
      window.location.href = window.location.pathname + '?lang=' + currentLanguage;
    }
    
    function createTourCard(tour) {
      const card = document.createElement('div');
      card.className = 'tour-card';
      card.setAttribute('data-key', tour.key);
      card.setAttribute('data-departure', tour.departure_location || '');
      
      // Debug logging
      console.log('Creating tour card:', {
        name: tour.name,
        key: tour.key,
        hasKey: !!tour.key
      });
      
      card.onclick = () => {
        console.log('Tour card clicked! Key:', tour.key);
        openTourDetail(tour.key);  // FIXED: correct function name
      };
      
      // Build star rating if available
      let ratingHtml = '';
      if (tour.review_rating && tour.review_rating > 0 && tour.review_count && tour.review_count > 0) {
        const fullStars = Math.floor(tour.review_rating);
        const hasHalf = (tour.review_rating % 1 >= 0.5);
        const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);
        
        let stars = '★'.repeat(fullStars);
        if (hasHalf) stars += '☆';
        stars += '☆'.repeat(emptyStars);
        
        ratingHtml = `
          <div class="tour-rating">
            <span class="stars">${stars}</span>
            <span class="review-count">(${tour.review_count})</span>
          </div>
        `;
      }
      
      // Set background image directly on mobile
      if (window.innerWidth <= 768) {
        // Mobile: Set innerHTML FIRST
        card.innerHTML = `
          <div>
            <div class="tour-company">${tour.company_name ? tour.company_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}</div>
            <h3>${tour.name}</h3>
            ${ratingHtml}
            <div>
              ${tour.duration ? `<span class="tour-duration">⏱️ ${tour.duration}</span>` : ''}
              ${tour.departure_location ? `<span class="tour-location">📍 ${tour.departure_location}</span>` : ''}
            </div>
            <div class="tour-price">${tour.price_adult || 'Contact for price'}</div>
          </div>
        `;
        
        // Then set background image AFTER innerHTML (so it doesn't get wiped out)
        const thumbnailUrl = tour.thumbnail || '/static/placeholder.jpg';
        console.log(`Setting background for ${tour.name}: ${thumbnailUrl}`);
        card.style.backgroundImage = `url('${thumbnailUrl}')`;
        card.style.backgroundSize = 'cover';
        card.style.backgroundPosition = 'center';
        card.style.backgroundRepeat = 'no-repeat';
      } else {
        // Desktop layout
        card.innerHTML = `
          <img src="${tour.thumbnail}" alt="${tour.name}" class="tour-image">
          <div class="tour-overlay">
            <div class="tour-type">${tour.company_name ? tour.company_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}</div>
            <div class="tour-title">${tour.name}</div>
            ${ratingHtml}
          </div>
        `;
      }
      
      return card;
    }
    
    function addChatMessage(message, role) {
      const messagesContainer = document.getElementById('chat-messages');
      
      // Add message
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;
      messageDiv.textContent = message;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Voice output: speak AI responses
      if (role === 'assistant' && window.voiceChat && window.voiceChat.autoSpeak) {
        window.voiceChat.speak(message);
      }
    }
    
    // Add quick reply buttons for common responses
    function addQuickReplyButtons(options) {
      const messagesContainer = document.getElementById('chat-messages');
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'chat-message assistant';
      buttonsDiv.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; padding: 10px;';
      
      options.forEach(option => {
        const button = document.createElement('button');
        button.textContent = option.text;
        button.style.cssText = `
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 10px 16px;
          border-radius: 20px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
          transition: all 0.2s;
        `;
        button.onmouseover = () => {
          button.style.transform = 'translateY(-2px)';
          button.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
        };
        button.onmouseout = () => {
          button.style.transform = 'translateY(0)';
          button.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
        };
        button.onclick = () => {
          // Remove all quick reply buttons after one is clicked
          document.querySelectorAll('.quick-reply-btn').forEach(btn => btn.remove());
          
          // Send the selected response programmatically
          const messageText = option.value || option.text;
          
          // Put text in input field and trigger send
          const input = document.getElementById('chat-input');
          input.value = messageText;
          sendChatMessage();
        };
        button.className = 'quick-reply-btn';
        buttonsDiv.appendChild(button);
      });
      
      messagesContainer.appendChild(buttonsDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function addTourCards(tours) {
      const messagesContainer = document.getElementById('chat-messages');
      const toursDiv = document.createElement('div');
      toursDiv.className = 'chat-message assistant';
      
      const toursHtml = '<div class="chat-tours">' + tours.map(tour => `
        <div class="chat-tour-card" onclick="openTourDetail('${tour.key}')">
          <h4>${tour.name}</h4>
          <p>💰 ${tour.price_adult || 'Contact for price'} | ⏱️ ${tour.duration || 'N/A'}</p>
        </div>
      `).join('') + '</div>';
      
      toursDiv.innerHTML = toursHtml;
      messagesContainer.appendChild(toursDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // =====================================================================
    // QR CODE / SEND TO PHONE SYSTEM
    // =====================================================================
    
    function addSendToPhoneButton(tours, userMessage, responseData) {
      const messagesContainer = document.getElementById('chat-messages');
      const buttonDiv = document.createElement('div');
      buttonDiv.className = 'chat-message assistant';
      buttonDiv.style.background = 'transparent';
      buttonDiv.style.padding = '10px 0';
      
      buttonDiv.innerHTML = `
        <button onclick="showQRCode()" style="
          width: 100%;
          background: linear-gradient(135deg, #0077b6 0%, #005a8b 100%);
          color: white;
          border: none;
          padding: 15px 20px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          box-shadow: 0 4px 12px rgba(0,119,182,0.3);
          transition: all 0.3s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,119,182,0.4)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,119,182,0.3)'">
          <span style="font-size: 24px;">📱</span>
          <span>Send to My Phone</span>
        </button>
      `;
      
      messagesContainer.appendChild(buttonDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Store tour data globally for QR generation
      window.currentRecommendations = {
        tours: tours,
        userMessage: userMessage,
        responseData: responseData
      };
    }
    
    async function showQRCode() {
      try {
        console.log('📱 Generating QR code session...');
        
        const recommendations = window.currentRecommendations;
        if (!recommendations) {
          alert('No recommendations to send. Please try again.');
          return;
        }
        
        // Extract preferences from response data or user message
        const preferences = {};
        if (recommendations.responseData && recommendations.responseData.used_filters) {
          // Filter-based search - try to extract filters
          const data = recommendations.responseData;
          if (data.filter_count) preferences.total_matches = data.filter_count;
        }
        
        // Create session
        const response = await fetch('/api/create-recommendation-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tours: recommendations.tours,
            preferences: preferences,
            chat_summary: recommendations.userMessage,
            language: currentLanguage
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Session created:', data.session_id);
          displayQRModal(data.session_id, data.url);
        } else {
          alert('Failed to generate QR code. Please try again.');
        }
        
      } catch (error) {
        console.error('Error generating QR code:', error);
        alert('Failed to generate QR code. Please try again.');
      }
    }
    
    function displayQRModal(sessionId, url) {
      // Create modal HTML
      const modal = document.createElement('div');
      modal.id = 'qr-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 20px;
          padding: 40px;
          max-width: 500px;
          width: 100%;
          text-align: center;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        ">
          <h2 style="margin: 0 0 20px 0; color: #0077b6; font-size: 28px;">
            📱 Scan to View on Your Phone
          </h2>
          
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">
            Scan this QR code with your phone's camera to view these tour recommendations
          </p>
          
          <div style="
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #0077b6;
            display: inline-block;
            margin-bottom: 30px;
          ">
            <img src="/api/generate-qr/${sessionId}" 
                 alt="QR Code" 
                 style="width: 250px; height: 250px; display: block;">
          </div>
          
          <div style="
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
          ">
            <p style="margin: 0;">Or share this link:</p>
            <p style="margin: 10px 0 0 0; word-break: break-all; color: #0077b6; font-weight: 600;">
              ${url}
            </p>
          </div>
          
          <div style="display: flex; gap: 15px;">
            <button onclick="copyRecommendationLink('${url}')" style="
              flex: 1;
              background: white;
              color: #0077b6;
              border: 2px solid #0077b6;
              padding: 12px 20px;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f0f8ff'"
               onmouseout="this.style.background='white'">
              📋 Copy Link
            </button>
            
            <button onclick="closeQRModal()" style="
              flex: 1;
              background: #0077b6;
              color: white;
              border: none;
              padding: 12px 20px;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#005a8b'"
               onmouseout="this.style.background='#0077b6'">
              Done
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeQRModal();
        }
      });
    }
    
    function closeQRModal() {
      // Close booking QR modal
      const paymentModal = document.getElementById('qr-payment-modal');
      if (paymentModal) {
        paymentModal.style.display = 'none';
        paymentModal.style.visibility = 'hidden';
        paymentModal.style.opacity = '0';
        paymentModal.style.pointerEvents = 'none';
        document.body.style.overflow = '';
      }
      
      // Close/share QR modal (if present)
      const shareModal = document.getElementById('qr-modal');
      if (shareModal) {
        shareModal.style.display = 'none';
      }
    }
    
    function copyRecommendationLink(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('✅ Link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy:', err);
        prompt('Copy this link:', url);
      });
    }
    
    // =====================================================================
    // INITIALIZE ALL SYSTEMS
    // =====================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
      initInactivityMonitor();
      initCurrency();
      loadWeatherData();
      updateGlobalHeaderChips();
      updateBackButtonVisibility();
      
      // Check if language has been selected
      const selectedLanguage = localStorage.getItem('preferred_language');
      const hash = window.location.hash;
      
      console.log('🌐 Selected language:', selectedLanguage || '(none - need to select)');
      console.log('🔗 Page loaded with hash:', hash || '(none)');
      console.log('📊 Body classes:', document.body.className);
      
      // If no language selected and no specific hash, show language selection screen
      if (!selectedLanguage && (!hash || hash === '#' || hash === '#video-start')) {
        console.log('🌐 No language selected - showing language selection screen');
        document.body.classList.add('video-bg-active');
        document.body.classList.add('showing-language-selection');
        const langScreen = document.getElementById('language-selection-screen');
        const startScreen = document.getElementById('video-start-screen');
        const video = document.getElementById('bg-video');
        
        if (langScreen) {
          langScreen.classList.remove('hidden');
          langScreen.style.display = 'flex';
        }
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        if (video) {
          video.play();
        }
        console.log('✅ Language selection screen displayed');
        return; // Stop here, wait for user to select language
      }
      
      // Language already selected - proceed with normal routing
      // Hide language selection screen
      const langScreen = document.getElementById('language-selection-screen');
      if (langScreen) {
        langScreen.classList.add('hidden');
        langScreen.style.display = 'none';
      }
      
      // Make sure header is visible
      document.body.classList.remove('showing-language-selection');
      
      // Hash-based routing - check URL hash to determine which page to show
      console.log('🔗 Proceeding with hash routing...');
      
      if (hash && hash !== '#' && hash !== '#video-start') {
        // We have a hash - need to navigate away from video start page
        console.log('🎯 Hash detected, preparing to navigate...');
        
        // IMPORTANT: Remove video-bg-active class so we can see other pages
        document.body.classList.remove('video-bg-active');
        console.log('✅ Removed video-bg-active class');
        
        // Wait longer for all scripts to initialize
        setTimeout(() => {
          console.log('⏰ Timeout fired, checking hash type...');
          
          if (hash.startsWith('#tour/')) {
            // Tour detail page: #tour/KEY
            const tourKey = hash.substring(6); // Remove '#tour/'
            console.log('🎯 Opening tour detail for key:', tourKey);
            
            if (typeof openTourDetail === 'function') {
              openTourDetail(tourKey);
              console.log('✅ Called openTourDetail()');
            } else {
              console.error('❌ openTourDetail function not found!');
            }
          } else if (hash.startsWith('#swipe/')) {
            // Swipe results: #swipe/INDEX (not fully supported yet, just go home)
            console.log('🎯 Navigating to home (swipe not fully restorable)');
            if (typeof window.goToHomePage === 'function') {
              window.goToHomePage();
            }
          } else if (hash === '#home') {
            // Home page with questionnaire
            console.log('🎯 Navigating to home page');
            if (typeof window.goToHomePage === 'function') {
              window.goToHomePage();
            }
          }
        }, 800); // Increased timeout to 800ms to ensure everything is loaded
      } else {
        // No hash or #video-start - ensure video start screen is visible
        console.log('🎯 Default: Showing video start screen (tap to start)');
        document.body.classList.add('video-bg-active');
        const videoPage = document.querySelector('.video-question-page');
        const startScreen = document.getElementById('video-start-screen');
        const video = document.getElementById('bg-video');
        if (videoPage && startScreen) {
          videoPage.classList.add('active');
          startScreen.style.display = 'flex';
          if (video) video.play();
        }
        console.log('✅ Video page initialized with background');
      }
      
      // LEGACY: Check old localStorage-based state restoration (backwards compatibility)
      const savedStateJson = localStorage.getItem('page_state_before_language_change');
      if (savedStateJson && !hash) {
        try {
          const pageState = JSON.parse(savedStateJson);
          localStorage.removeItem('page_state_before_language_change');
          
          // Only restore if less than 10 seconds old (prevent stale state)
          if (Date.now() - pageState.timestamp < 10000) {
            console.log('🔄 [LEGACY] Restoring page state:', pageState);
            
            setTimeout(() => {
              if (pageState.page === 'tour-detail' && pageState.tourKey) {
                openTourDetail(pageState.tourKey);
                console.log('✅ [LEGACY] Restored tour detail:', pageState.tourKey);
              } else if (pageState.page === 'home') {
                window.goToHomePage && window.goToHomePage();
                console.log('✅ [LEGACY] Restored home page');
              }
            }, 300);
          } else {
            console.log('⏰ [LEGACY] Saved state too old, ignoring');
          }
        } catch (e) {
          console.error('❌ [LEGACY] Error restoring page state:', e);
        }
      }
      
      // Add currency selector click handlers
      document.querySelectorAll('.currency-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const currency = option.getAttribute('data-currency');
          switchCurrency(currency);
          document.getElementById('currency-menu').classList.remove('active');
        });
      });
      
      // =====================================================================
      // VOICE CHAT INITIALIZATION
      // =====================================================================
      
      // Initialize voice chat
      setTimeout(() => {
        if (typeof VoiceChat !== 'undefined') {
          window.voiceChat = new VoiceChat();
          
          // Set current language
          window.voiceChat.setLanguage(currentLanguage);
          
          // Handle speech results
          window.voiceChat.onSpeechResult = (transcript) => {
            console.log('✅ Voice input:', transcript);
            
            // Hide interim text
            document.getElementById('interimText').style.display = 'none';
            
            // Put text in input and send
            if (transcript.trim()) {
              const input = document.getElementById('chat-input');
              input.value = transcript;
              sendChatMessage();
            }
          };
          
          // Show interim transcription
          window.voiceChat.showInterimText = (text) => {
            const interimEl = document.getElementById('interimText');
            interimEl.textContent = `"${text}"`;
            interimEl.style.display = 'block';
          };
          
          // Update UI based on voice state
          window.voiceChat.updateUI = (state) => {
            const micBtn = document.getElementById('micButton');
            const voiceStatus = document.getElementById('voiceStatus');
            const statusText = voiceStatus.querySelector('.status-text');
            
            micBtn.classList.remove('listening', 'speaking');
            voiceStatus.classList.remove('speaking');
            
            switch(state) {
              case 'listening':
                micBtn.classList.add('listening');
                micBtn.querySelector('.mic-text').innerHTML = '🎤 Listening...';
                voiceStatus.style.display = 'flex';
                statusText.textContent = 'Listening...';
                statusText.style.color = '#f5576c';
                break;
                
              case 'speaking':
                micBtn.classList.add('speaking');
                micBtn.querySelector('.mic-text').innerHTML = '🔊 Speaking...';
                voiceStatus.style.display = 'flex';
                voiceStatus.classList.add('speaking');
                statusText.textContent = 'Speaking...';
                statusText.style.color = '#00a8b5';
                break;
                
              case 'idle':
              default:
                micBtn.querySelector('.mic-text').innerHTML = '🎤 Tap to Speak';
                voiceStatus.style.display = 'none';
                document.getElementById('interimText').style.display = 'none';
                break;
            }
          };
          
          // Show voice errors in chat
          window.voiceChat.showError = (message) => {
            addChatMessage(`⚠️ ${message}`, 'assistant');
          };
          
          // Wire up mic button
          const micButton = document.getElementById('micButton');
          if (micButton) {
            micButton.addEventListener('click', () => {
              // IMPORTANT: Stop any ongoing TTS to prevent feedback into microphone
              if (window.voiceChat.isSpeaking) {
                console.log('🔇 Stopping TTS to prevent feedback');
                window.voiceChat.stopSpeaking();
              }
              
              if (!window.voiceChat.isListening) {
                window.voiceChat.startListening();
              } else {
                window.voiceChat.stopListening();
              }
            });
          }
          
          // Wire up auto-speak toggle
          const autoSpeakToggle = document.getElementById('autoSpeakToggle');
          if (autoSpeakToggle) {
            autoSpeakToggle.addEventListener('change', (e) => {
              window.voiceChat.setAutoSpeak(e.target.checked);
              console.log(`🔊 Auto-speak ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
          }
          
          console.log('✅ Voice chat initialized and integrated!');
        } else {
          console.warn('⚠️ VoiceChat class not found - voice features disabled');
        }
      }, 500);
    });
    
    // Quick search function
    let searchTimer = null;
    async function quickSearch(query) {
      clearTimeout(searchTimer);
      
      // If empty search, restore all tours
      if (!query || query.trim().length === 0) {
        const title = document.getElementById('home-tours-title');
        const subtitle = document.getElementById('home-tours-subtitle');
        if (title) title.textContent = 'Featured Tours';
        if (subtitle) subtitle.textContent = 'Discover amazing experiences';
        loadInitialFeaturedTours();
        return;
      }
      
      // If search is too short, wait for more input
      if (query.trim().length < 2) return;
      
      searchTimer = setTimeout(async () => {
        console.log('🔍 Quick search:', query);
        
        console.log('🔍 Searching:', query);
        
        // Update home page title/subtitle
        const title = document.getElementById('home-tours-title');
        const subtitle = document.getElementById('home-tours-subtitle');
        if (title) title.textContent = 'Search Results';
        if (subtitle) subtitle.textContent = 'Searching...';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Fetch and filter tours
        try {
          const response = await fetch(`/filter-tours?lang=${currentLanguage}`);
          const data = await response.json();
          
          const searchLower = query.toLowerCase();
          const filtered = data.tours.filter(tour => {
            return (tour.name || '').toLowerCase().includes(searchLower) ||
                   (tour.company_name || '').toLowerCase().includes(searchLower);
          });
          
          console.log(`✅ Found ${filtered.length} tours matching "${query}"`);
          
          // Update subtitle
          if (subtitle) {
            subtitle.textContent = `Found ${filtered.length} tour${filtered.length !== 1 ? 's' : ''} matching "${query}"`;
          }
          
          // Disable infinite scroll (we're showing filtered results)
          homePageHasMore = false;
          homePageTotalCount = filtered.length;
          
          // Display in featured grid (home page grid)
          displayFeaturedTours(filtered, false);
        } catch (error) {
          console.error('❌ Search error:', error);
          if (subtitle) subtitle.textContent = 'Error searching tours';
        }
      }, 500);
    }
    
  </script>
  
  <!-- Voice Chat System -->
  <script src="{{ url_for('static', filename='voice-chat.js') }}"></script>
</body>
</html>
</html>